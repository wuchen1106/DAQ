\subsubsection{odbedit: The ODB Editor and Run Control utility}\label{RC_odbedit}
\par
 

\par


The \hyperlink{RC_odbedit_utility}{odbedit utility} is both an \hyperlink{F_MainElements_F_Online_Database_overview}{Online Database (ODB)} Editor and a {\bfseries Run Control} program. \par
 This is one of the main applications to interact with the different components of the MIDAS system. It is a simpler alternative to the web-\/based run control program \hyperlink{RC_mhttpd_utility}{mhttpd}. There are many occasions where {\bfseries odbedit} is more convenient and faster to use than mhttpd. {\bfseries odbedit} is used to create the initial ODB, and is a powerful editing tool. It is often used for debugging and troubleshooting. \par



\begin{DoxyItemize}
\item \hyperlink{RC_odbedit_utility}{odbedit -\/ ODB Editor and run control utility}
\item \hyperlink{RC_odbedit_utility_RC_odbedit_help}{odbedit command list}
\item \hyperlink{RC_odbedit_examples}{Using odbedit}
\end{DoxyItemize}

\par
 

\par
 \label{index_end}
\hypertarget{index_end}{}
 \paragraph{odbedit -\/ ODB Editor and run control utility}\label{RC_odbedit_utility}
\label{RC_odbedit_utility_idx_odbedit-utility}
\hypertarget{RC_odbedit_utility_idx_odbedit-utility}{}
 \par
 

\par


\label{RC_odbedit_utility_idx_edit_ODB_using-odbedit}
\hypertarget{RC_odbedit_utility_idx_edit_ODB_using-odbedit}{}
 {\bfseries odbedit} is primarily an \hyperlink{F_MainElements_F_Online_Database_overview}{Online Database (ODB)} Editor. It also acts as a run control and has limited run monitoring features. It is an alternative to the web-\/based run control program \hyperlink{RC_mhttpd_utility}{The mhttpd daemon}.


\begin{DoxyItemize}
\item {\bfseries  Arguments }
\begin{DoxyItemize}
\item \mbox{[}-\/h hostname \mbox{]} :Specifies host to connect to. See \hyperlink{F_Utilities_List_F_utilities_params}{hostname} for details.
\item \mbox{[}-\/e exptname \mbox{]} :Specifies the experiment to connect to. See \hyperlink{F_Utilities_List_F_utilities_params}{experiment} for details.
\item \mbox{[}-\/c command \mbox{]} :Perform a single command
\item \mbox{[}-\/c @commandFile \mbox{]} :Perform commands in sequence found in the commandFile. Can be used to perform operations in script files. See \hyperlink{RC_odbedit_examples_RC_odbedit_extcommand}{examples}.
\item \mbox{[}-\/s size \mbox{]} : size in bytes (for \hyperlink{RC_odbedit_examples_RC_odbedit_create_ODB}{ODB creation}). Specify the size of the ODB file to be created when no shared file is present in the experiment directory (default 128KB).
\item \mbox{[}-\/d ODB Subtree\mbox{]} :Specify the initial entry ODB path to go to.
\item \mbox{[}-\/g\mbox{]} debug
\item \mbox{[}-\/C \mbox{]} connect to corrupted ODB
\end{DoxyItemize}
\end{DoxyItemize}


\begin{DoxyItemize}
\item {\bfseries  Usage } ODBedit has a simple command line interface with command line editing similar to the UNIX tcsh shell. The following edit keys are implemented:
\begin{DoxyItemize}
\item \mbox{[}Backspace\mbox{]} Erase the character left from cursor
\item \mbox{[}Delete/Ctrl-\/D\mbox{]} Erase the character under cursor
\item \mbox{[}Ctrl-\/W/Ctrl-\/U\mbox{]} Erase the current line
\item \mbox{[}Ctrl-\/K\mbox{]} Erase the line from cursor to end
\item \mbox{[}Left arrow/Ctrl-\/B\mbox{]} Move cursor left
\item \mbox{[}Right arrow/Ctrl-\/F\mbox{]} Move cursor right
\item \mbox{[}Home/Ctrl-\/A\mbox{]} Move cursor to beginning of line
\item \mbox{[}End/Ctrl-\/E\mbox{]} Move cursor to end of line
\item \mbox{[}Up arrow/Ctrl-\/P\mbox{]} Recall previous command
\item \mbox{[}Down arrow/Ctrl-\/N\mbox{]} Recall next command
\item \mbox{[}Ctrl-\/F\mbox{]} Find most recent command which starts with current line
\item \mbox{[}Tab/Ctrl-\/I\mbox{]} Complete directory. The command {\bfseries ls} /Sy $<$tab$>$ yields to {\bfseries ls} /System.
\end{DoxyItemize}
\end{DoxyItemize}


\begin{DoxyItemize}
\item {\bfseries  Remarks }
\begin{DoxyItemize}
\item ODBedit treats the hierarchical online database very much like a file system. Most commands are similar to UNIX file commands like ls, cd, chmod, ln etc. The help command displays a short description of all commands.
\end{DoxyItemize}
\end{DoxyItemize}

The odbedit commands and mode of operation are described fully in the following sections.

\label{RC_odbedit_utility_idx_odbedit-utility_command_list}
\hypertarget{RC_odbedit_utility_idx_odbedit-utility_command_list}{}
 \hypertarget{RC_odbedit_utility_RC_odbedit_help}{}\paragraph{odbedit command list}\label{RC_odbedit_utility_RC_odbedit_help}
Running \hyperlink{RC_odbedit_utility}{odbedit} and issuing the command \char`\"{}help\char`\"{} displays the list of commands: 
\begin{DoxyCode}
$ odbedit

[local:pol:S]/>help
Database commands ([] are options, <> are placeholders):

alarm                   - reset all alarms
cd <dir>                - change current directory
chat                    - enter chat mode
chmod <mode> <key>      - change access mode of a key
                          1=read | 2=write | 4=delete
cleanup [client] [-f]   - delete hanging clients [force]
copy <src> <dest>       - copy a subtree to a new location
create <type> <key>     - create a key of a certain type
create <type> <key>[n]  - create an array of size [n]
del/rm [-l] [-f] <key>  - delete a key and its subkeys
  -l                      follow links
  -f                      force deletion without asking
exec <key>/<cmd>        - execute shell command (stored in key) on server
export <key> <filename> - export key into ASCII file
find <pattern>          - find a key with wildcard pattern
help/? [command]        - print this help [for a specific command]
hi [analyzer] [id]      - tell analyzer to clear histos
import <filename> [key] - import ASCII file into string key
ln <source> <linkname>  - create a link to <source> key
load <file>             - load database from .ODB file at current position
ls/dir [-lhvrp] [<pat>] - show database entries which match pattern
  -l                      detailed info
  -h                      hex format
  -v                      only value
  -r                      show database entries recursively
  -p                      pause between screens
make [analyzer name]    - create experim.h
mem [-v]                - show memeory usage [verbose]
mkdir <subdir>          - make new <subdir>
move <key> [top/bottom/[n]] - move key to position in keylist
msg [type] [user] <msg> - compose user message
old [n]                 - display old n messages
passwd                  - change MIDAS password
pause                   - pause current run
pwd                     - show current directory
resume                  - resume current run
rename <old> <new>      - rename key
rewind [channel]        - rewind tapes in logger
save [-c -s -x -cs] <file>  - save database at current position
                          in ASCII format
  -c                      as a C structure
  -s                      as a #define'd string
  -x                      as a XML file
set <key> <value>       - set the value of a key
set <key>[i] <value>    - set the value of index i
set <key>[*] <value>    - set the value of all indices of a key
set <key>[i..j] <value> - set the value of all indices i..j
scl [-w]                - show all active clients [with watchdog info]
shutdown <client>/all   - shutdown individual or all clients
sor                     - show open records in current subtree
start [number][now][-v] - start a run [with a specific number],
                          [now] w/o asking parameters, [-v] debug output
stop [-v]               - stop current run, [-v] debug output
trunc <key> <index>     - truncate key to [index] values
ver                     - show MIDAS library version
webpasswd               - change WWW password for mhttpd
wait <key>              - wait for key to get modified
quit/exit               - exit
\end{DoxyCode}


\par
 

\label{index_end}
\hypertarget{index_end}{}
 \paragraph{Using odbedit}\label{RC_odbedit_examples}
\label{RC_odbedit_examples_idx_odbedit-utility_examples}
\hypertarget{RC_odbedit_examples_idx_odbedit-utility_examples}{}
 \par
 


\begin{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_odbedit_prompt}{Setting odbedit's prompt} 
\begin{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_odbedit_prompt_examples}{Examples of changing the odbedit prompt:} 
\end{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_odbedit_create_ODB}{ODB Creation} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_keynames}{ODB Key names: UPPER/lower case, spaces in key names} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_corrupted}{Corrupted ODB} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_extcommand}{Using the external command (the -\/c argument)} 
\begin{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_odbedit_script_examples}{Examples of scripts sending odbedit commands} 
\begin{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_example_script_1}{Shell script run at end-\/of-\/run} 
\item \hyperlink{RC_odbedit_examples_RC_example_script_2}{Shell script run at beginning of run} 
\end{DoxyItemize}
\end{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_odbedit_cmd_examples}{Examples using odbedit commands} 
\begin{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_odbedit_cd}{cd -\/ change current directory} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_chat}{chat -\/ enter chat mode} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_chmod}{chmod -\/ change access mode} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_cr}{create -\/ create a key of a certain type} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_export}{export -\/ export ASCII file} 
\item \hyperlink{RC_odbedit_utility_RC_odbedit_help}{help -\/ list of commands} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_import}{import -\/ import ASCII file} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_ln}{ln -\/ create a link} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_load}{load -\/ load database from a saved file} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_ls}{ls -\/ list the database entries} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_make}{make -\/ create experim.h} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_mkdir}{mkdir -\/ make new subdirectory} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_move}{move -\/ move a key to a new position} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_msg}{msg -\/ send a user message} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_old}{old -\/ display old messages} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_passwd}{passwd -\/ change/set up the MIDAS password} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_pwd}{pwd -\/ show current directory} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_rename}{rename -\/ rename a key} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_rm}{rm/del -\/ delete a key and its subkeys} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_set}{set -\/ set the value of a key} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_sor}{sor -\/ show open records} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_save}{save -\/ save database at current position} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_scl}{scl -\/ show active clients} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_sh}{sh -\/ shutdown a client} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_start}{start -\/ start a run} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_stop}{stop -\/ stop a run} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_trunc}{trunc -\/ truncate a key} 
\item \hyperlink{RC_odbedit_examples_RC_odbedit_webpasswd}{webpasswd -\/ change/set up the web password for mhttpd} 
\end{DoxyItemize}
\end{DoxyItemize}



\hypertarget{RC_odbedit_examples_RC_odbedit_prompt}{}\paragraph{Setting odbedit's prompt}\label{RC_odbedit_examples_RC_odbedit_prompt}
When \char`\"{}odbedit\char`\"{} is entered on the command line, it returns a prompt, e.g. 
\begin{DoxyCode}
odbedit
[local:midas:S]/>
\end{DoxyCode}
 The format of the {\bfseries prompt} (in the above example {\bfseries  \mbox{[}local:midas:S\mbox{]}/$>$ } ) is controlled in the ODB by the key {\bfseries  /System/Prompt }. The default value is shown below: 
\begin{DoxyCode}
odbedit
[local:midas:S]/>cd /System/
[local:midas:S]/System>ls
Clients                         
Tmp                             
Client Notify                   0
Prompt                          [%h:%e:%s]%p>
\end{DoxyCode}
 \par
 where the meanings of the Prompt symbols are shown below:

\begin{table}[h]\begin{TabularC}{2}
\hline
{\bfseries Symbol}  &{\bfseries Substitute}   \\\cline{1-2}
\%{\bfseries h} &Host name  \\\cline{1-2}
\%{\bfseries e}  &Experiment name  \\\cline{1-2}
\%{\bfseries s}  &Run state symbols (U,S,P,R)  \\\cline{1-2}
\%{\bfseries S}  &Run state long form (Unknown,Stopped,Pause,Running)  \\\cline{1-2}
\%{\bfseries p}  &Current ODB Path  \\\cline{1-2}
\%{\bfseries t}  &Current time  \\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Meaning of Prompt symbols }
\end{table}
\hypertarget{RC_odbedit_examples_RC_odbedit_prompt_examples}{}\subparagraph{Examples of changing the odbedit prompt:}\label{RC_odbedit_examples_RC_odbedit_prompt_examples}

\begin{DoxyEnumerate}
\item Set the prompt to show the {\bfseries  long-\/form of the run state } 
\begin{DoxyCode}
  [local:midas:S]/System>set Prompt "[%h:%e:%S]%p>"
  [local:midas:Stopped]/System>
\end{DoxyCode}
 
\item Set the prompt to the phrase {\bfseries my\_\-prompt} 
\begin{DoxyCode}
    [local:midas:Stopped]/System>set Prompt my_prompt>
    my_prompt>
\end{DoxyCode}



\item Set the prompt to {\bfseries  name the fields } (i.e. Host, Expt, State, Path) 
\begin{DoxyCode}
    my_prompt>set Prompt [Host:%h-Expt:%e:State:%s]Path:%p>
    [Host:local-Expt:midas-State:S]Path:/System>
\end{DoxyCode}



\item Set the prompt to the {\bfseries current} {\bfseries time} 
\begin{DoxyCode}
    [Host:local-Expt:midas-State:S]Path:/System>set Prompt "%t>"
    13:29:08>
\end{DoxyCode}






\label{RC_odbedit_examples_idx_ODB_create}
\hypertarget{RC_odbedit_examples_idx_ODB_create}{}
 
\end{DoxyEnumerate}\hypertarget{RC_odbedit_examples_RC_odbedit_create_ODB}{}\paragraph{ODB Creation}\label{RC_odbedit_examples_RC_odbedit_create_ODB}
After installation of MIDAS, before any other tasks are started, the ODB is created for the first time by starting the \hyperlink{RC_odbedit_utility}{odbedit utility}. This automatically creates all the shared-\/memory files needed for the experiment. By default, these files will be created in the area indicated in the \hyperlink{Q_Linux_Q_Linux_Exptab}{exptab file} for your experiment. \par
 If MIDAS\_\-EXPT\_\-NAME is defined, this experiment will be used, unless superceded by the -\/e option (see \hyperlink{RC_odbedit_utility}{odbedit}). \par
 
\begin{DoxyCode}
[mpet@titan01 ~/online]$ ls .*.SHM
ls: No match.
[mpet@titan01 ~/online] odbedit
[local:mpet:Stopped]/>quit
[mpet@titan01 ~/online]$ ls .*.SHM
.ALARM.SHM  .ELOG.SHM  .HISTORY.SHM  .MSG.SHM  .ODB.SHM  .SYSMSG.SHM  .SYSTEM.SHM
      
\end{DoxyCode}


The default size of the ODB is 128KB. A different size can be specified by using the -\/s option (see \hyperlink{RC_odbedit_utility}{odbedit utility}) e.g. 
\begin{DoxyCode}
odbedit -s 204000
\end{DoxyCode}


The other shared memory files created are the system buffer .SYSTEM.SHM, the \hyperlink{F_Messaging}{system messaging} buffer .SYSMSG.SHM, the message buffer .MSG.SHM, \begin{Desc}
\item[\hyperlink{todo__todo000016}{Todo}]( MSG.SHM what for? )\end{Desc}
the \hyperlink{F_History_logging}{history} buffer .HISTORY.SHM, the \hyperlink{F_Elog}{Elog} buffer .ELOG.SHM, the alarm buffer .ALARM.SHM . \par


{\bfseries Note:} \par
to change the size of the event buffer(s) (e.g. SYSTEM buffer) see \hyperlink{FE_event_buffer_size}{Increase the Event Buffer Size(s)} . \par
  Running odbedit for the first time creates the trees /Runinfo, /Experiment, /System in the ODB.  Each application will then add its own set of \hyperlink{structparameters}{parameters} to the database depending on its requirements. For example, starting the \hyperlink{F_Logging_F_mlogger_utility}{MIDAS logger} will cause the tree /Logger to be created.



 \par
 \label{RC_odbedit_examples_idx_ODB_key_names}
\hypertarget{RC_odbedit_examples_idx_ODB_key_names}{}
 \hypertarget{RC_odbedit_examples_RC_odbedit_keynames}{}\paragraph{ODB Key names: UPPER/lower case, spaces in key names}\label{RC_odbedit_examples_RC_odbedit_keynames}
{\bfseries ODB Key names are case-\/independent,} 
\begin{DoxyCode}
[mpet@titan01 ~/online] odbedit
[local:mpet:Stopped]/>ls
PerlRC
[local:mpet:Stopped]/>ls perlrc
ControlVariables
RunControl
Tunes
[local:mpet:Stopped]/>ls PERLRC
ControlVariables
RunControl
Tunes
\end{DoxyCode}
 {\bfseries Key names containing spaces must be enclosed in quotes} 
\begin{DoxyCode}
[local:mpet:Stopped]/>ls "/Equipment/TITAN_ACQ/ppg cycle/"
transition_HV
stdpulse_START
begin_scan
stdpulse_3
\end{DoxyCode}
 If the quotes are omitted 
\begin{DoxyCode}
[local:mpet:Stopped]/>ls /Equipment/TITAN_ACQ/ppg cycle
key /Equipment/TITAN_ACQ/ppg not found
\end{DoxyCode}
 Using {\bfseries TAB completion,} one could write 
\begin{DoxyCode}
[local:mpet:Stopped]/>ls /Equipment/TITAN_ACQ/ppg  
\end{DoxyCode}
 then pressing the TAB key would replace the line above with that below 
\begin{DoxyCode}
[local:mpet:Stopped]/>ls "/Equipment/TITAN_ACQ/ppg cycle/ 
\end{DoxyCode}
 then press ENTER key to see the list 
\begin{DoxyCode}
transition_HV
stdpulse_START
begin_scan
stdpulse_3
\end{DoxyCode}


\label{RC_odbedit_examples_idx_ODB_corrupted}
\hypertarget{RC_odbedit_examples_idx_ODB_corrupted}{}
 

\hypertarget{RC_odbedit_examples_RC_odbedit_corrupted}{}\paragraph{Corrupted ODB}\label{RC_odbedit_examples_RC_odbedit_corrupted}
If the \hyperlink{F_MainElements_F_Online_Database_overview}{Online Database} becomes corrupted, \hyperlink{RC_odbedit_utility}{odbedit} may no longer work, and other clients will also fail to open the database. In this case, the old ODB should be deleted and a new one created. The contents of the ODB can be reloaded from a \hyperlink{RC_odbedit_examples_RC_odbedit_save}{saved file}. Since the ODB may become corrupted, it is advisable to \hyperlink{F_Logging_Data_F_Logger_ODB_Dump}{save a copy automatically} at the end of each run. \par
 To delete the corrupted ODB, delete the $\ast$.SHM files created in the area indicated in the \hyperlink{Q_Linux_Q_Linux_Exptab}{exptab file} for your experiment. 
\begin{DoxyCode}
[mpet@titan01 ~/online]$ ls .*.SHM
.ALARM.SHM  .ELOG.SHM  .HISTORY.SHM  .MSG.SHM  .ODB.SHM  .SYSMSG.SHM  .SYSTEM.SHM
      
[mpet@titan01 ~/online]$ rm .*.SHM
\end{DoxyCode}
 Create new $\ast$.SHM files by running odbedit (see \hyperlink{RC_odbedit_examples_RC_odbedit_create_ODB}{ODB Creation}), then load a \hyperlink{RC_odbedit_examples_RC_odbedit_save}{saved file} containing the latest copy of the odb contents. 
\begin{DoxyCode}
[mpet@titan01 ~/online] odbedit
[local:mpet:Stopped]/>load mpet.odb
\end{DoxyCode}


\par
 

 \par


\label{RC_odbedit_examples_idx_script_odbedit}
\hypertarget{RC_odbedit_examples_idx_script_odbedit}{}
 \label{RC_odbedit_examples_idx_odbedit_scripts}
\hypertarget{RC_odbedit_examples_idx_odbedit_scripts}{}
\hypertarget{RC_odbedit_examples_RC_odbedit_extcommand}{}\subparagraph{Using the external command (the  -\/c argument)}\label{RC_odbedit_examples_RC_odbedit_extcommand}
\hyperlink{RC_odbedit_utility}{odbedit -\/ ODB Editor and run control utility} -\/c argument In the simplest case, a single odbedit command can be entered on the command line, 
\begin{DoxyCode}
[pol@isdaq01 src]$ odbedit -c start
Starting run #401
Run #401 started
[pol@isdaq01 src]$ odbedit -c stop
Run #401 stopped
\end{DoxyCode}
 or a value can be set (note the use of the \hyperlink{RC_odbedit_utility}{odbedit} {\bfseries -\/d} argument) 
\begin{DoxyCode}
[pol@isdaq01 pol]$ odbedit -d /test -c "set testval 3"
[pol@isdaq01 pol]$ odb
[local:pol:S]/>ls test
testval                         3

[pol@isdaq01 pol]$ odbedit -d /test -c "ls testval"
testval 
\end{DoxyCode}


Note that the syntax to create an ODB STRING array using the \char`\"{}-\/c\char`\"{} command is 
\begin{DoxyCode}
odbedit -c "create STRING Test[1][40]"
odbedit -c "create STRING Test[8][40]"
\end{DoxyCode}


A filename containing a number of odbedit commands can also be entered, using the \hyperlink{RC_odbedit_utility}{odbedit} -\/c @commandfile argument e.g. 
\begin{DoxyCode}
[pol@isdaq01 pol]$ odbedit -d /test <b> -c @testfile.com </b>
testval                         4
Starting run #403
Run #403 started
Run #403 paused
Run #403 stopped
[pol@isdaq01 pol]$ 
\end{DoxyCode}
 where the file \char`\"{}testfile\char`\"{} contains odbedit commands, such as 
\begin{DoxyCode}
set testval 4
ls testval
start
stop
\end{DoxyCode}
 This external command feature of odbedit allows for sophisticated scripts to be created that can manipulate the odb. \par
Such scripts can for example
\begin{DoxyItemize}
\item check ODB \hyperlink{structparameters}{parameters} prior to beginning of run
\item send run \hyperlink{structparameters}{parameters} to the electronic logbook
\item act as a run controller, starting and stopping a series of runs with varying \hyperlink{structparameters}{parameters}
\end{DoxyItemize}

Some examples are shown below.\hypertarget{RC_odbedit_examples_RC_odbedit_script_examples}{}\subparagraph{Examples of scripts sending odbedit commands}\label{RC_odbedit_examples_RC_odbedit_script_examples}

\begin{DoxyItemize}
\item \hyperlink{RC_odbedit_examples_RC_example_script_1}{Shell script run at end-\/of-\/run}
\item \hyperlink{RC_odbedit_examples_RC_example_script_2}{Shell script run at beginning of run}
\end{DoxyItemize}

See also \hyperlink{RC_mhttpd_defining_script_buttons_RC_odb_script_ex2_perlscript}{MPET perlscripts to perform run control} .

\label{RC_odbedit_examples_idx_script_end-of-run}
\hypertarget{RC_odbedit_examples_idx_script_end-of-run}{}
 \hypertarget{RC_odbedit_examples_RC_example_script_1}{}\subparagraph{Shell script run at end-\/of-\/run}\label{RC_odbedit_examples_RC_example_script_1}
This script runs at the end of run, and reads some \hyperlink{structparameters}{parameters} from the odb and sends them to the elog by using the \hyperlink{F_Elog_F_melog_utility}{melog -\/ submits an entry to the Elog}. To make the script run at end of run, the name of the script is entered in the \char`\"{}Execute on stop run\char`\"{} key in the \hyperlink{RC_customize_ODB_RC_ODB_Programs_Tree}{The ODB /Programs tree} .


\begin{DoxyCode}
#!/bin/tcsh

# This script is started at the end of each run. It takes some parameters
# from the odb and creates an entry in the elog 
#
# Match to at_start_run.csh script
# Check for input files
if ($#argv == 1) then
  if (-e $1) then
    echo "Processing from file"
    set cmd = `echo 'load '$1`
    odb -e $MIDAS_EXPT_NAME -c "$cmd"
  endif
endif
echo "exp:   $MIDAS_EXPT_NAME"

# This is the file where the elog entry is saved temporarily
set fin = "/home/$MIDAS_EXPT_NAME/tmp/info_for_elog.txt"
if (-e $fin) then
  rm -f $fin
endif
touch $fin

# set port for mhttpd
set port='8080'

# Start collecting information from ODB first
set Run_number = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Runinfo/Run number"'`
set number = `echo $Run_number | awk '{print $3}'`
set sample = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Experiment/Edit on Start/sample"'`
      
set Sample = `echo $sample | awk '{print $2}'`
set temperature = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Experiment/Edit on Start/temp
      erature"'`
set T = `echo $temperature | awk '{print $2}'`
set field = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Experiment/Edit on Start/field"'`
set H = `echo $field | awk '{print $2}'`
set RF = '??'
set experimenter = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Experiment/Edit on Start/exp
      erimenter"'`
set author = `echo $experimenter | awk '{print $2}'`
set run_title = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Experiment/Edit on Start/run_ti
      tle"'`
set title = `echo $run_title | awk -F'run_title' '{print $2}'`
set experiment_number = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Experiment/Edit on Star
      t/experiment number"'`
set exp_num = `echo $experiment_number | awk '{print $3}'`
set Experiment_name = `odb -e $MIDAS_EXPT_NAME -c 'ls "/Equipment/FIFO_acq/sis mc
      s/Input/Experiment name"'`
set type = `echo $Experiment_name | awk '{print $3}'`
set type_dir = `echo 'ls -r /PPG/PPG'$type`

# Now create the temporary file to be sent to the elog
echo "Run # $number" >> $fin
odb -e $MIDAS_EXPT_NAME -c 'ls "/Runinfo/Start time"' >> $fin
odb -e $MIDAS_EXPT_NAME -c 'ls "/Runinfo/Stop time"' >> $fin
echo "$Sample at T = $T K, H = $H T and RF = $RF mW">> $fin
echo "Run Title   : $title" >> $fin
echo "Experimenter: $author" >> $fin
echo "Experiment #: $exp_num" >> $fin
echo "-------------------------------------------------------------" >>$fin
odb -e $MIDAS_EXPT_NAME -c "$type_dir" >> $fin
echo "-------------------------------------------------------------" >>$fin

if ("x$Sample" == "x") then 
   set Sample = 'none'
endif

if ("x$author" == "x") then 
   set author = 'Auto'
endif

# Send information to the elog

echo "about to send elog (expt $MIDAS_EXPT_NAME, port $port)"
melog -h isdaq01 -p $port -l $MIDAS_EXPT_NAME -a author=$author -a Type="Automati
      c Elog" -a System="Elog" -a Subject="$Sample"  -m $fin
cat $fin

# done
\end{DoxyCode}
 \label{RC_odbedit_examples_idx_script_start-of-run}
\hypertarget{RC_odbedit_examples_idx_script_start-of-run}{}
 

\hypertarget{RC_odbedit_examples_RC_example_script_2}{}\subparagraph{Shell script run at beginning of run}\label{RC_odbedit_examples_RC_example_script_2}
The following example is part of a shell script run at the beginning of run for the TRIUMF BNMR experiment to check the status of various slow controls required for logging during the run. To make the script run at beginning of run, the name of the script is entered in the \char`\"{}Execute on start run\char`\"{} key in the \hyperlink{RC_customize_ODB_RC_ODB_Programs_Tree}{The ODB /Programs tree} .


\begin{DoxyCode}
#!/bin/csh
#

# Add an input parameter
#  0 default
#  1 (for redo camp slow controls from custom page) to stop statistics being zero
      ed
#  2 (redo epics slow controls from custom page)
#
#
# NOTE: msg [type] [user] <msg> - compose user message
#
#  odb msg 1 -> error msg  (in black/red)
#  odb msg 2 -> info msg   (in black/white)

#echo "argv: $argv ; number of args: $#argv"
set param = 0
if  ($#argv > 0) then
    set param = $argv[1];
   endif
#echo "param: $param ;  $MIDAS_EXPT_NAME"

set my_path = "/home/$MIDAS_EXPT_NAME/online/$MIDAS_EXPT_NAME/bin"
#echo "my_path:$my_path"

odb -e $MIDAS_EXPT_NAME -c "msg 'at_start_run'  '(at start) starting with param= 
      $param' "

# clear elog (camp log) alarm flag
odb -e $MIDAS_EXPT_NAME -c 'set "/equipment/fifo_acq/client flags/elog alarm" 0'
# clear epicslog alarm flag
odb -e $MIDAS_EXPT_NAME -c 'set "/equipment/fifo_acq/client flags/epicslog alarm"
       0'

if ($param == 1) then
# redo CAMP only
   odb -e $MIDAS_EXPT_NAME -c "msg 'at_start_run'  '(at start) sets camp ok to 4'
      "
   odb -e $MIDAS_EXPT_NAME -c "set '/equipment/camp/settings/camp ok' 4" # camp_o
      k = 4 indicates redoing CAMP only
else if  ($param == 2) then
# redo EPICS only
   odb -e $MIDAS_EXPT_NAME -c "msg 'at_start_run'  '(at start) sets epics ok to4'
      "
   odb -e $MIDAS_EXPT_NAME -c "set '/equipment/epicslog/settings/epics ok' 4" #ep
      ics_ok =4 indicates redoing EPICS only
else
# run start - redo EPICS and CAMP
   odb -e $MIDAS_EXPT_NAME  -c "msg 'at_start_run'  '(at start) sets epics ok and
       camp ok to 2' "
   odb -e $MIDAS_EXPT_NAME -c "set '/equipment/camp/settings/camp ok' 2"      #ca
      mp_ok=2 indicates redoing CAMP
   odb -e $MIDAS_EXPT_NAME -c "set '/equipment/epicslog/settings/epics ok' 2" #ep
      ics_ok=2 indicates redoing EPICS
endif

if ($param == 0 || $param == 2) then
#
#  Check epics logged variables
#
   odb -e $MIDAS_EXPT_NAME -c "msg 'at_start_run' 'calling check_epics.csh' "
   $my_path/check_epics.csh
    set stat = $status
    if ($stat != 0) then
       echo "error return from check_epics.csh"
       odb -e $MIDAS_EXPT_NAME -c "msg '1' 'at_start_run' 'error return from chec
      k_epics.csh' "
       odb -e $MIDAS_EXPT_NAME -c "set '/equipment/epicslog/settings/epics ok' 0
" # EPICS failure
    else
       odb -e $MIDAS_EXPT_NAME -c "msg 'at_start_run' 'after check_epics.csh (suc
      cess)' "
       odb -e $MIDAS_EXPT_NAME -c "set '/equipment/epicslog/settings/epics ok' 1"
       # EPICS success
    endif

else
   odb -e $MIDAS_EXPT_NAME -c "msg 'at_start_run' '(at start) NOT calling check_e
      pics.csh ($param)' "
endif

if ($param == 2) then  # checks epics only ; no camp
  exit
endif

 ..............
    etc.
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_cmd_examples}{}\paragraph{Examples using odbedit commands}\label{RC_odbedit_examples_RC_odbedit_cmd_examples}
Here are some examples of the most commonly used \hyperlink{RC_odbedit_utility}{odbedit} commands:\hypertarget{RC_odbedit_examples_RC_odbedit_pwd}{}\subparagraph{pwd -\/ show current directory}\label{RC_odbedit_examples_RC_odbedit_pwd}

\footnotesize  One of the \hyperlink{RC_odbedit_utility}{odbedit} \hyperlink{RC_odbedit_utility_RC_odbedit_help}{commands} 
\normalsize \par
\par
 
\begin{DoxyCode}
$ odbedit
[local:mpet:Stopped]/>
[local:mpet:Stopped]/>pwd
/
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_cd}{}\subparagraph{cd -\/ change current directory}\label{RC_odbedit_examples_RC_odbedit_cd}

\footnotesize  One of the \hyperlink{RC_odbedit_utility}{odbedit} \hyperlink{RC_odbedit_utility_RC_odbedit_help}{commands} 
\normalsize \par
\par



\begin{DoxyCode}
cd <dir>                - change current directory
\end{DoxyCode}
 For example, 
\begin{DoxyCode}
[local:mpet:Stopped]/>cd system
[local:mpet:Stopped]/>pwd
/System
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_chat}{}\subparagraph{chat  -\/ enter chat mode}\label{RC_odbedit_examples_RC_odbedit_chat}
This mode is used to communicate with another person also running odbedit on the same experiment. It is useful where a telephone connection is not available. e.g. \par
 \begin{table}[h]\begin{TabularC}{2}
\hline
Anna's console &Fred's console \\\cline{1-2}

\begin{DoxyCode}
[anna@isdaq01 ~]$ odb -e bnmr -h dasdevpc
[dasdevpc:bnmr:S]/>chat
Your name> anna
Exit chat mode with empty line.
> hi
12:46:12 [anna] hi
12:46:51 [ODBEdit2] Program ODBEdit on host dasdevpc started
12:47:21 [fred] hi
> hi
12:47:34 [anna] hi fred
12:48:12 [fred] please cycle crate power now
> done - all lights green
12:48:21 [anna] done - all lights green
> bye
12:50:27 [anna] bye
>
[dasdevpc:bnmr:S]/>
\end{DoxyCode}
  &
\begin{DoxyCode}
odbedit -e bnmr
[fred@dasdevpc ~]$ odb -e bnmr
[local:bnmr:S]/>chat
Your name> fred
Exit chat mode with empty line.
> hi
12:47:21 [fred] hi
12:47:34 [anna] hi fred
> please cycle crate power now
12:48:12 [fred] please cycle crate power now
12:48:21 [anna] done - all lights green
12:50:27 [anna] bye
>
[local:bnmr:S]/>  
\end{DoxyCode}
   \\\cline{1-2}
\end{TabularC}
\centering
\caption{Two users communicate using {\bfseries chat} mode}
\end{table}


The chat conversation can also be heard over the speakers if \hyperlink{F_Messaging_F_mspeaker_utility}{m\mbox{[}lx\mbox{]}speaker -\/ audible messaging} is running.

\label{RC_odbedit_examples_idx_access-control_ODB_keys}
\hypertarget{RC_odbedit_examples_idx_access-control_ODB_keys}{}
 

\hypertarget{RC_odbedit_examples_RC_odbedit_chmod}{}\subparagraph{chmod -\/ change access mode}\label{RC_odbedit_examples_RC_odbedit_chmod}
The access mode can be changed with the chmod command between


\begin{DoxyItemize}
\item 1 read R
\item 2 write W
\item 4 delete D
\end{DoxyItemize}

By default the access mode of ODB keys are RWD i.e. the permission is to Read, Write or Delete them. To avoid them being inadvertently changed or deleted the mode can be set to read-\/only, e.g 
\begin{DoxyCode}
[local:t2kgas:S]GasMain.gif>chmod 1 background
Are you sure to change the mode of key
  /Custom/Images/GasMain.gif/background
and all its subkeys
to mode [R]? (y/[n]) y
[local:t2kgas:S]GasMain.gif>ls -lt
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
refresh time (s)                DWORD   1     4     13h  0   RWD  10
background                      STRING  1     256   13h  0   R    /home/suz/onlin
      e/t2kgas/images/GasMain.gif
labels                          DIR
fills                           DIR
\end{DoxyCode}
 After setting the mode to read-\/only, the key cannot be written to: 
\begin{DoxyCode}
[local:t2kgas:S]GasMain.gif>set background dddd
Write access not allowed
\end{DoxyCode}
 or deleted 
\begin{DoxyCode}
[local:t2kgas:S]GasMain.gif>rm background
Are you sure to delete the key
"/Custom/Images/GasMain.gif/background"
(y/[n]) y
deletion of key not allowed
[local:t2kgas:S]GasMain.gif> 
\end{DoxyCode}


To restore the key to mode RWD, 
\begin{DoxyCode}
[local:t2kgas:S]GasMain.gif>chmod 7 background
Are you sure to change the mode of key
  /Custom/Images/GasMain.gif/background
and all its subkeys
to mode [RWD]? (y/[n]) y
[local:t2kgas:S]GasMain.gif>ls -lt
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
refresh time (s)                DWORD   1     4     13h  0   RWD  10
background                      STRING  1     256   13h  0   RWD  /home/suz/onlin
      e/t2kgas/images/GasMain.gif
labels                          DIR
fills                           DIR
[local:t2kgas:S]GasMain.gif>
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_ls}{}\subparagraph{ls -\/ list the database entries}\label{RC_odbedit_examples_RC_odbedit_ls}

\begin{DoxyCode}
ls/dir [-lhvrp] [<pat>] - show database entries which match pattern
  -l                      detailed info
  -h                      hex format
  -v                      only value
  -r                      show database entries recursively
  -p                      pause between screens
\end{DoxyCode}
 \par
List the keys (\char`\"{}dir\char`\"{} is an alternative to \char`\"{}ls\char`\"{}). 
\begin{DoxyCode}
[local:mpet:Stopped]/System>ls
Clients
Tmp
Client Notify                   0
Prompt                          [%h:%e:%S]%p>
[local:mpet:Stopped]/System>     
\end{DoxyCode}
 \par
The \char`\"{}-\/l\char`\"{} option gives detailed information, such as the key type and size 
\begin{DoxyCode}
[local:mpet:Stopped]/>ls /experiment
Name                            mpet
Buffer sizes
Variables
Edit on start
[local:mpet:Stopped]/>ls -lt  /experiment
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
Name                            STRING  1     32    3m   0   RWD  mpet
Buffer sizes                    DIR
Variables                       DIR
Edit on start                   DIR
\end{DoxyCode}
 \par
The recursive option \char`\"{}-\/r\char`\"{} shows the database entries recursively 
\begin{DoxyCode}
[local:pol:S]/>ls -r ppg
PPG
    PPGcommon
        Experiment name -> /Equipment/FIFO_acq/sis mcs/Input/Experiment name
                                1h
        CFG path -> /Equipment/FIFO_acq/sis mcs/Input/CFG path
                                /home/pol/online/pol/ppcobj
        PPG path -> /Equipment/FIFO_acq/sis mcs/Input/PPG path
                                /home/pol/online/ppg-templates
        Time slice (ms) -> /Equipment/FIFO_acq/sis mcs/Input/Time slice (ms)
                                1e-04
        Minimal delay (ms) -> /Equipment/FIFO_acq/sis mcs/Input/Minimal delay (ms
      )
                                0.0005
        DAQ service time (ms) -> /Equipment/FIFO_acq/sis mcs/Input/DAQ service ti
      me (ms)
                                3000
\end{DoxyCode}
 \par
The values can be displayed in hexadecimal using the \char`\"{}-\/h\char`\"{} option 
\begin{DoxyCode}
[local:pol:S]/>ls  "/Equipment/FIFO_acq/sis mcs/Input/e00 rf frequency (Hz)"
e00 rf frequency (Hz)           22064585
[local:pol:S]/>ls  -h "/Equipment/FIFO_acq/sis mcs/Input/e00 rf frequency (Hz)"
e00 rf frequency (Hz)           0x150ADC9
\end{DoxyCode}
 \par
or the value only displayed with the \char`\"{}-\/v\char`\"{} option 
\begin{DoxyCode}
[local:pol:S]/test>ls
val                             5
[local:pol:S]/test>ls -v
5
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_mkdir}{}\subparagraph{mkdir -\/ make new subdirectory}\label{RC_odbedit_examples_RC_odbedit_mkdir}

\begin{DoxyCode}
mkdir <subdir>          - make new <subdir>
\end{DoxyCode}
 \par
This example shows how to make a new subdirectory \char`\"{}/custom\char`\"{}. 
\begin{DoxyCode}
[mpet@titan01 ~/online] odbedit
[local:mpet:Stopped]/>ls
System
Programs
Experiment
Runinfo
Alarms

[local:mpet:Stopped]/>mkdir custom
[local:mpet:Stopped]/>ls
System
Programs
Experiment
Runinfo
Alarms
Custom
\end{DoxyCode}


More than one level of subdirectory can be made with one command 
\begin{DoxyCode}
[local:pol:S]/>mkdir /Equipment/test/settings
[local:pol:S]/>ls /Equipment
test
[local:pol:S]/>ls /Equipment/test
[local:pol:S]/>
settings
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_msg}{}\subparagraph{msg -\/ send a user message}\label{RC_odbedit_examples_RC_odbedit_msg}
This command can be used to send a message to any client that is receiving MIDAS messages, including the MIDAS message logger, e.g 
\begin{DoxyCode}
[local:cg:S]/>
16:30:48 [fred] hi
[local:cg:S]/>msg george "is there a problem?"
[george,USER] is there a problem?
16:30:48 [fred] power supply has failed
\end{DoxyCode}


The messages have gone into the MIDAS log (see \hyperlink{RC_odbedit_examples_RC_odbedit_old}{below}).



\hypertarget{RC_odbedit_examples_RC_odbedit_old}{}\subparagraph{old -\/ display old messages}\label{RC_odbedit_examples_RC_odbedit_old}
This command displays the last N MIDAS messages, e.g. 
\begin{DoxyCode}
[local:customgas:S]/>old 9
Fri May 21 13:36:27 2010 [ODBEdit,INFO] Program ODBEdit on host dasdevpc2 started
      
Fri May 21 13:36:40 2010 [ODBEdit,INFO] Program ODBEdit on host dasdevpc2 stopped
      
Mon May 31 15:56:28 2010 [ODBEdit,INFO] Program ODBEdit on host dasdevpc2 started
      
Wed Jun  9 20:49:42 2010 [mhttpd] Program mhttpd on host dasdevpc2 stopped
Wed Jun  9 20:49:42 2010 [mhttpd] Program mhttpd on host dasdevpc2 started
Wed Jun 16 16:27:51 2010 [fred] hi
Wed Jun 16 16:29:15 2010 [fred] hi
Wed Jun 16 16:30:10 2010 [george] is there a problem?
Wed Jun 16 16:30:48 2010 [fred] power supply has failed
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_passwd}{}\subparagraph{passwd -\/ change/set up the MIDAS password}\label{RC_odbedit_examples_RC_odbedit_passwd}
Example is shown \hyperlink{RC_customize_ODB_RC_Setup_Security}{here}.



\hypertarget{RC_odbedit_examples_RC_odbedit_webpasswd}{}\subparagraph{webpasswd -\/ change/set up the web password for mhttpd}\label{RC_odbedit_examples_RC_odbedit_webpasswd}
Example is shown \hyperlink{RC_customize_ODB_RC_Setup_Web_Security}{here}.



\hypertarget{RC_odbedit_examples_RC_odbedit_move}{}\subparagraph{move -\/ move a key to a new position}\label{RC_odbedit_examples_RC_odbedit_move}

\begin{DoxyCode}
move <key> [top/bottom/[n]] - move key to position in keylist
\end{DoxyCode}


The \char`\"{}move\char`\"{} command provides a means of re-\/ordering the keys. 
\begin{DoxyCode}
[local:mpet:Stopped]/>ls
System
Programs
Experiment
Runinfo
Alarms
Custom
\end{DoxyCode}


The key \char`\"{}custom\char`\"{} can be moved to the top (or bottom) of the list, e.g. 
\begin{DoxyCode}
[local:mpet:Stopped]/>move custom top
[local:mpet:Stopped]/>ls
Custom
System
Programs
Experiment
Runinfo
Alarms
\end{DoxyCode}


or to any position, e.g. 
\begin{DoxyCode}
[local:mpet:Stopped]/>move custom 1
[local:mpet:Stopped]/>ls
System
Custom
Programs
Experiment
Runinfo
Alarms
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_rename}{}\subparagraph{rename -\/ rename a key}\label{RC_odbedit_examples_RC_odbedit_rename}

\begin{DoxyCode}
rename <old> <new>      - rename key
\end{DoxyCode}
 \par
 
\begin{DoxyCode}
[local:pol:S]/>ls "my string"
my string                       this is a test string
[local:pol:S]/>rename "my string" "your string"
[local:pol:S]/>ls
your string                       this is a test string
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_copy}{}\subparagraph{copy -\/ copy a subtree}\label{RC_odbedit_examples_RC_odbedit_copy}

\begin{DoxyCode}
copy <src> <dest>       - copy a subtree to a new location
\code
To make a copy of a subtree:
\code
[local:pol:S]/>ls test
testval                         4
[local:pol:S]/>copy test test1
[local:pol:S]/>ls
test
test1
[local:pol:S]/>ls test1
testval       
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_import}{}\subparagraph{import -\/  import ASCII file}\label{RC_odbedit_examples_RC_odbedit_import}

\begin{DoxyCode}
import  <filename> [key]    - import ASCII file into string key 
\end{DoxyCode}


e.g. import an \hyperlink{RC_mhttpd_Internal}{Internal custom page} into a key, 
\begin{DoxyCode}
Tue> odbedit
[local:midas:Stopped]>cd custom
[local:midas:Stopped]/Custom>import mcustom.html   <-- import an html file
  Key name: Test&  
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_export}{}\subparagraph{export -\/  export ASCII file}\label{RC_odbedit_examples_RC_odbedit_export}

\begin{DoxyCode}
export  <filename> [key]    - import ASCII file into string key 
\end{DoxyCode}


e.g. export an \hyperlink{RC_mhttpd_Internal}{Internal custom page} into a key,


\begin{DoxyCode}
  [local:midas:Stopped]/>cd Custom/
  [local:midas:Stopped]/Custom>export test&
  File name: mcustom.html
  [local:midas:Stopped]/Custom>
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_ln}{}\subparagraph{ln -\/ create a link}\label{RC_odbedit_examples_RC_odbedit_ln}

\begin{DoxyCode}
ln <source> <linkname>  - create a link to <source> key
\end{DoxyCode}


The \hyperlink{RC_customize_ODB_RC_Edit_On_Start}{Edit on start} area often contains links to ODB \hyperlink{structparameters}{parameters} e.g. 
\begin{DoxyCode}
[local:mpet:Stopped]/Experiment>cd "/Experiment/Edit on start/
[local:mpet:Stopped]Edit on start>ls
num ppg cycles                  /Equipment/TITAN_acq/ppg cycle/begin_scan/loop co
      unt -> 50
Pedestals run                   n
Write Data                      /Logger/Write data -> y
Capture delay (ms)              /Equipment/TITAN_acq/ppg cycle/evset_2/time offse
      t (ms) -> 0.0955
PLT pulsedown delay (ms)        /Equipment/TITAN_acq/ppg cycle/pulse_1/time offse
      t (ms) -> 0.0922
Start Frequency in MHz          /Experiment/Variables/StartFreq (MHz) -> 1.458877
      5
End Frequency in MHz            /Experiment/Variables/EndFreq (MHz) -> 1.4588815
Number of frequency steps       /Experiment/Variables/NFreq -> 41
Feedbackfilename                /Feedback/fbfilename -> /home/mpet/online/mpetfee
      dbackfnv1.txt
\end{DoxyCode}


These links were made using the \char`\"{}ln\char`\"{} command, e.g. 
\begin{DoxyCode}
[local:mpet:Stopped]Edit on start>ln  "/Equipment/TITAN_acq/ppg cycle/evset_2/tim
      e offset (ms)" "Capture delay (ms)"
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_cr}{}\subparagraph{create -\/ create a key of a certain type}\label{RC_odbedit_examples_RC_odbedit_cr}

\begin{DoxyCode}
create <type> <key>     - create a key of a certain type
create <type> <key>[n]  - create an array of size [n]
\end{DoxyCode}


Keys can be created of the types supported by MIDAS i.e. \par
 INT DWORD BOOL FLOAT DOUBLE STRING


\begin{DoxyCode}
[local:pol:S]/test>create dword my_dword
[local:pol:S]/test>create int my_int
[local:pol:S]/test>create float my_float
[local:pol:S]/test>create double my_double
[local:pol:S]/test>create bool my_bool
[local:pol:S]/>create string "my string"
String length [32]: 64

[local:pol:S]/test>ls
my_dword                        0
my_int                          0
my_float                        0
my_double                       0
my_bool                         n
my_string

[local:pol:S]/test>ls -lt
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
my_dword                        DWORD   1     4     >99d 0   RWD  0
my_int                          INT     1     4     >99d 0   RWD  0
my_float                        FLOAT   1     4     >99d 0   RWD  0
my_double                       DOUBLE  1     8     >99d 0   RWD  0
my_bool                         BOOL    1     4     >99d 0   RWD  n
my_string                       STRING  1     62    9s   0   RWD
[local:pol:S]/test>
\end{DoxyCode}


Arrays of all these types can also be created, e.g. 
\begin{DoxyCode}
[local:pol:S]/test>create int fred[5]
[local:pol:S]/test>ls
fred
                                0
                                0
                                0
                                0
                                0
\end{DoxyCode}


The \hyperlink{RC_odbedit_examples_RC_odbedit_set}{set} command is used to assign values to the keys.



\hypertarget{RC_odbedit_examples_RC_odbedit_set}{}\subparagraph{set -\/ set the value of a key}\label{RC_odbedit_examples_RC_odbedit_set}

\begin{DoxyCode}
set <key> <value>       - set the value of a key
set <key>[i] <value>    - set the value of index i
set <key>[*] <value>    - set the value of all indices of a key
set <key>[i..j] <value> - set the value of all indices i..j
\end{DoxyCode}


After keys are \hyperlink{RC_odbedit_examples_RC_odbedit_cr}{created}, they can be assigned values with the {\bfseries set} command: 
\begin{DoxyCode}
[pol@isdaq01 src]$ odb
[local:pol:S]/>create string "my string"
String length [32]: 64
[local:pol:S]/>ls -lt "my string"
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
my string                       STRING  1     64    9s   0   RWD
[local:pol:S]/>set "my string" "this is a test string"
[local:pol:S]/>ls "my string"
my string                       this is a test string
[local:pol:S]/>create INT ival
[local:pol:S]/>set ival 8
[local:pol:S]/>ls -lt ival
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
ival                            INT     1     4     3s   0   RWD  8
[local:pol:S]/>ls ival
ival                            8
[local:pol:S]/>   
\end{DoxyCode}


Values of {\bfseries arrays} can also be set:


\begin{DoxyCode}
[local:pol:S]/test>set fred[4] 6
[local:pol:S]/test>ls
fred
                                0
                                0
                                0
                                0
                                6
[local:pol:S]/test>set fred 2
[local:pol:S]/test>ls
fred
                                2
                                0
                                0
                                0
                                6
[local:pol:S]/test>set fred[*] 5
[local:pol:S]/test>ls
fred
                                5
                                5
                                5
                                5
                                5
[local:pol:S]/test>set fred[1..3] 6
[local:pol:S]/test>ls
fred
                                5
                                6
                                6
                                6
                                5
[local:pol:S]/test>           
\end{DoxyCode}


The array can easily be expanded (see also \hyperlink{RC_odbedit_examples_RC_odbedit_trunc}{trunc}) :


\begin{DoxyCode}
[local:pol:S]/test>set fred[8] 9
[local:pol:S]/test>ls
fred
                                5
                                6
                                6
                                6
                                5
                                0
                                0
                                0
                                9
\end{DoxyCode}


\label{RC_odbedit_examples_RC_odbedit_set_wp}
\hypertarget{RC_odbedit_examples_RC_odbedit_set_wp}{}
 {\bfseries NOTE} that the \char`\"{}set\char`\"{} command may not work if the ODB parameter is {\bfseries write-\/protected}. See \hyperlink{RC_odbedit_examples_RC_odbedit_chmod}{chmod -\/ change access mode} and \hyperlink{RC_customize_ODB_RC_Lock_when_Running}{Lock when Running}.



\hypertarget{RC_odbedit_examples_RC_odbedit_chmod}{}\subparagraph{chmod -\/ change access mode}\label{RC_odbedit_examples_RC_odbedit_chmod}

\begin{DoxyCode}
chmod <mode> <key>       change access mode of a key
                          1=read | 2=write | 3=RWD | 4=delete
\end{DoxyCode}


By default, a key is created in mode 3 (i.e. RWD read/write/delete). The {\bfseries chmod} command may be used to change the protection of the key. 
\begin{DoxyCode}
[local:bnmr:S]/>create int my_test
[local:bnmr:S]/>set my_test 3
[local:bnmr:S]/>ls -lt my_test
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
my_test                         INT     1     4     20s  0   RWD  3
[local:bnmr:S]/>chmod 1 my_test
Are you sure to change the mode of key
  /my_test
and all its subkeys
to mode [R]? (y/[n]) y
[local:bnmr:S]/>ls -lt my_test
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
my_test                         INT     1     4     46s  0   R    3
[local:bnmr:S]/>set my_test 6
Write access not allowed
[local:bnmr:S]/> 
\end{DoxyCode}


{\bfseries NOTE:} \par
 \par
Write protection when running can also be performed -\/ see \hyperlink{RC_customize_ODB_RC_Lock_when_Running}{Lock when Running}.



\hypertarget{RC_odbedit_examples_RC_odbedit_trunc}{}\subparagraph{trunc  -\/ truncate a key}\label{RC_odbedit_examples_RC_odbedit_trunc}

\begin{DoxyCode}
trunc <key> <index>     - truncate key to [index] values
\end{DoxyCode}


This command is used to truncate or expand an array. 
\begin{DoxyCode}
[local:pol:S]/>ls fred 
fred
                                5
                                6
                                6
                                6
                                5
                                0
                                0
                                0
                                9
[local:pol:S]/>trunc fred 4
[local:pol:S]/>ls fred
fred
                                5
                                6
                                6
                                6
[local:pol:S]/>trunc fred 9
[local:pol:S]/>ls fred
fred
                                5
                                6
                                6
                                6
                                0
                                0
                                0
                                0
                                0
\end{DoxyCode}


\par
 

\hypertarget{RC_odbedit_examples_RC_odbedit_rm}{}\subparagraph{rm/del -\/ delete a key and its subkeys}\label{RC_odbedit_examples_RC_odbedit_rm}

\begin{DoxyCode}
del/rm [-l] [-f] <key>  - delete a key and its subkeys
  -l                      follow links
  -f                      force deletion without asking
\end{DoxyCode}
 \par



\begin{DoxyCode}
[local:pol:S]/>rm ival
Are you sure to delete the key
"/ival"
(y/[n]) y
 
[local:pol:S]/>rm test/try
Are you sure to delete the key "/test/try"
and all its subkeys? (y/[n]) y
[local:pol:S]/> 
\end{DoxyCode}


If you answer \char`\"{}n\char`\"{} the key will not be deleted.



\hypertarget{RC_odbedit_examples_RC_odbedit_sor}{}\subparagraph{sor -\/ show open records}\label{RC_odbedit_examples_RC_odbedit_sor}
This shows which records are open, i.e. \hyperlink{RC_Hot_Link_RC_Hot_Link_Intro}{hot-\/linked} . 
\begin{DoxyCode}
[local:mpet:Stopped]/>sor
/Runinfo/Requested transition open 1 times by fempet
/Equipment/Trigger/Common open 1 times by fempet
/Equipment/Trigger/Statistics open 1 times by fempet
/Equipment/Trigger/Statistics/Events per sec. open 1 times by Logger
/Equipment/Trigger/Statistics/kBytes per sec. open 1 times by Logger
/Equipment/Trigger/Settings open 1 times by fempet
/Equipment/Scaler/Common open 1 times by fempet
/Equipment/Scaler/Statistics open 1 times by fempet
/Equipment/SlowDac/Variables open 1 times by Logger
/Equipment/SlowDac/Variables/Demand open 1 times by fesdac
/Equipment/SlowDac/Common open 1 times by fesdac
/Equipment/SlowDac/Statistics open 1 times by fesdac
/Equipment/Beamline/Settings/Names open 1 times by scEpics
/Equipment/Beamline/Settings/Update Threshold Measured open 1 times by scEpics
/Equipment/Beamline/Common open 1 times by scEpics
/Equipment/Beamline/Variables open 1 times by Logger
/Equipment/Beamline/Variables/Demand open 1 times by scEpics
/Equipment/Beamline/Statistics open 1 times by scEpics
/Equipment/RF/Variables open 1 times by Logger
/Equipment/TITAN_ACQ/Common open 1 times by fempet
/Equipment/TITAN_ACQ/Statistics open 1 times by fempet
[local:mpet:Stopped]/>    
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_save}{}\subparagraph{save -\/ save database at current position}\label{RC_odbedit_examples_RC_odbedit_save}

\begin{DoxyCode}
save [-c -s -x -cs] <file>  - save database at current position
                          in ASCII format
  -c                      as a C structure
  -s                      as a #define'd string
  -x                      as a XML file
\end{DoxyCode}
 Saving the database regularly is essential in case the database becomes corrupted (see \hyperlink{RC_odbedit_examples_RC_odbedit_corrupted}{Corrupted ODB}). To save the complete database into an ASCII file, 
\begin{DoxyCode}
[mpet@titan01 ~/online] odbedit
[local:mpet:Stopped]/>save mpet.odb
\end{DoxyCode}
 \par
 This example shows how to save part of the database in an {\bfseries ASCII} file 
\begin{DoxyCode}
[local:pol:S]>cd "/Equipment/Info ODB/"
[local:pol:S]Info ODB>save info.odb
\end{DoxyCode}
 {\bfseries Contents} of info.odb : 
\begin{DoxyCode}
[/Equipment/Info ODB/Common]
Event ID = WORD : 10
Trigger mask = WORD : 0
Buffer = STRING : [32] 
Type = INT : 1
Source = INT : 0
Format = STRING : [8] FIXED
Enabled = BOOL : y
Read on = INT : 273
Period = INT : 500
Event limit = DOUBLE : 0
Num subevents = DWORD : 0
Log history = INT : 0
Frontend host = STRING : [32] vwisac2
Frontend name = STRING : [32] fePOL
Frontend file name = STRING : [256] febnmr.c

[/Equipment/Info ODB/Variables]
helicity = DWORD : 0
current cycle = DWORD : 2
cancelled cycle = DWORD : 1
current scan = DWORD : 1
Ref P+ thr = DOUBLE : 0
Ref Laser thr = DOUBLE : 10138
Ref Fcup thr = DOUBLE : 0
Current P+ thr = DOUBLE : 0
Current Laser thr = DOUBLE : 10138
Current Fcup thr = DOUBLE : 0
RF state = DWORD : 0
Fluor monitor counts = DWORD : 50010
EpicsDev Set(V) = FLOAT : 0
EpicsDev Read(V) = FLOAT : 0
Campdev set = FLOAT : 0
Campdev read = FLOAT : 0
Pol DAC set = DOUBLE : 0
Pol DAC read = DOUBLE : 0
last failed thr test = DWORD : 0
cycle when last failed thr = DWORD : 0

[/Equipment/Info ODB/Statistics]
Events sent = DOUBLE : 0
Events per sec. = DOUBLE : 0
kBytes per sec. = DOUBLE : 0
\end{DoxyCode}


\begin{TabularC}{2}
\hline
{\bfseries Save as a C structure} 
\begin{DoxyCode}
[local:pol:S]Info ODB>save  -c cfile.c
\end{DoxyCode}
  &{\bfseries Save as a \#defined structure } 
\begin{DoxyCode}
[local:pol:S]Info ODB>save  -s cfile.h
\end{DoxyCode}
  

\\\cline{1-2}
{\bfseries Contents} of cfile.c : &{\bfseries Contents} of cfile.h :   \\\cline{1-2}

\begin{DoxyCode}
typedef struct {
  struct {
    WORD      event_id;
    WORD      trigger_mask;
    char      buffer[32];
    INT       type;
    INT       source;
    char      format[8];
    BOOL      enabled;
    INT       read_on;
    INT       period;
    double    event_limit;
    DWORD     num_subevents;
    INT       log_history;
    char      frontend_host[32];
    char      frontend_name[32];
    char      frontend_file_name[256];
  } common;
  struct {
    DWORD     helicity;
    DWORD     current_cycle;
    DWORD     cancelled_cycle;
    DWORD     current_scan;
    double    ref_p__thr;
    double    ref_laser_thr;
    double    ref_fcup_thr;
    double    current_p__thr;
 double    current_laser_thr;
    double    current_fcup_thr;
    DWORD     rf_state;
    DWORD     fluor_monitor_counts;
    float     epicsdev_set_v_;
    float     epicsdev_read_v_;
    float     campdev_set;
    float     campdev_read;
    double    pol_dac_set;
    double    pol_dac_read;
    DWORD     last_failed_thr_test;
    DWORD     cycle_when_last_failed_thr;
  } variables;
  struct {
    double    events_sent;
    double    events_per_sec_;
    double    kbytes_per_sec_;
  } statistics;
} INFO_ODB;
\end{DoxyCode}
 

&
\begin{DoxyCode}
#define INFO_ODB(_name) char *_name[] = {\
"[Common]",\
"Event ID = WORD : 10",\
"Trigger mask = WORD : 0",\
"Buffer = STRING : [32] ",\
"Type = INT : 1",\
"Source = INT : 0",\
"Format = STRING : [8] FIXED",\
"Enabled = BOOL : y",\
"Read on = INT : 273",\
"Period = INT : 500",\
"Event limit = DOUBLE : 0",\
"Num subevents = DWORD : 0",\
"Log history = INT : 0",\
"Frontend host = STRING : [32] vwisac2",\
"Frontend name = STRING : [32] fePOL",\
"Frontend file name = STRING : [256] febnmr.c",\
"",\
"[Variables]",\
"helicity = DWORD : 0",\
"current cycle = DWORD : 2",\
"cancelled cycle = DWORD : 1",\
"current scan = DWORD : 1",\
"Ref P+ thr = DOUBLE : 0",\
"Ref Laser thr = DOUBLE : 10138",\
"Ref Fcup thr = DOUBLE : 0",\
"Current P+ thr = DOUBLE : 0",\
"Current Laser thr = DOUBLE : 10138",\
"Current Fcup thr = DOUBLE : 0",\
"RF state = DWORD : 0",\
"Fluor monitor counts = DWORD : 50010",\
"EpicsDev Set(V) = FLOAT : 0",\
"EpicsDev Read(V) = FLOAT : 0",\
"Campdev set = FLOAT : 0",\
"Campdev read = FLOAT : 0",\
"Pol DAC set = DOUBLE : 0",\
"Pol DAC read = DOUBLE : 0",\
"last failed thr test = DWORD : 0",\
"cycle when last failed thr = DWORD : 0",\
"",\
"[Statistics]",\
"Events sent = DOUBLE : 0",\
"Events per sec. = DOUBLE : 0",\
"kBytes per sec. = DOUBLE : 0",\
"",\
NULL }
\end{DoxyCode}
  \\\cline{1-2}
\end{TabularC}


{\bfseries  Save as an XML structure } 
\begin{DoxyCode}
[local:pol:S]Info ODB>save  -x xinfo.xml
\end{DoxyCode}
 {\bfseries Contents} of xinfo.xml : 
\begin{DoxyCode}
<?xml version="1.0" encoding="ISO-8859-1"?>
<!-- created by MXML on Wed Sep 23 13:27:05 2009 -->
<odb root="/Equipment/Info ODB" filename="xinfo.xml" xmlns:xsi="http://www.w3.org
      /2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="/home/pol/packages/midas
      /odb.xsd">
  <dir name="Common">
    <key name="Event ID" type="WORD">10</key>
    <key name="Trigger mask" type="WORD">0</key>
    <key name="Buffer" type="STRING" size="32"></key>
    <key name="Type" type="INT">1</key>
    <key name="Source" type="INT">0</key>
    <key name="Format" type="STRING" size="8">FIXED</key>
    <key name="Enabled" type="BOOL">y</key>
    <key name="Read on" type="INT">273</key>
    <key name="Period" type="INT">500</key>
    <key name="Event limit" type="DOUBLE">0</key>
    <key name="Num subevents" type="DWORD">0</key>
    <key name="Log history" type="INT">0</key>
    <key name="Frontend host" type="STRING" size="32">vwisac2</key>
    <key name="Frontend name" type="STRING" size="32">fePOL</key>
    <key name="Frontend file name" type="STRING" size="256">febnmr.c</key>
  </dir>
  <dir name="Variables">
    <key name="helicity" type="DWORD">0</key>
    <key name="current cycle" type="DWORD">2</key>
    <key name="cancelled cycle" type="DWORD">1</key>
    <key name="current scan" type="DWORD">1</key>
    <key name="Ref P+ thr" type="DOUBLE">0</key>
    <key name="Ref Laser thr" type="DOUBLE">10138</key>
    <key name="Ref Fcup thr" type="DOUBLE">0</key>
    <key name="Current P+ thr" type="DOUBLE">0</key>
    <key name="Current Laser thr" type="DOUBLE">10138</key>
    <key name="Current Fcup thr" type="DOUBLE">0</key>
    <key name="RF state" type="DWORD">0</key>
    <key name="Fluor monitor counts" type="DWORD">50010</key>
    <key name="EpicsDev Set(V)" type="FLOAT">0</key>
    <key name="EpicsDev Read(V)" type="FLOAT">0</key>
    <key name="Campdev set" type="FLOAT">0</key>
    <key name="Campdev read" type="FLOAT">0</key>
    <key name="Pol DAC set" type="DOUBLE">0</key>
    <key name="Pol DAC read" type="DOUBLE">0</key>
    <key name="last failed thr test" type="DWORD">0</key>
    <key name="cycle when last failed thr" type="DWORD">0</key>
  </dir>
  <dir name="Statistics">
    <key name="Events sent" type="DOUBLE">0</key>
    <key name="Events per sec." type="DOUBLE">0</key>
    <key name="kBytes per sec." type="DOUBLE">0</key>
  </dir>
</odb>
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_load}{}\subparagraph{load -\/ load database from a saved file}\label{RC_odbedit_examples_RC_odbedit_load}

\begin{DoxyCode}
load <file>             - load database from .ODB file at current position
\end{DoxyCode}
 To load the {\bfseries complete} database from an ASCII file containing a previously \hyperlink{RC_odbedit_examples_RC_odbedit_save}{saved} database: 
\begin{DoxyCode}
[mpet@titan01 ~/online] odbedit
[local:mpet:Stopped]/>load mpet.odb
\end{DoxyCode}
 The entire database need not be loaded. \hyperlink{RC_odbedit_examples_RC_odbedit_save}{Saved ASCII files} can be made of just a part of the database, and these can be reloaded into the database. Since the full path is given in the saved file, the file can be loaded from any position in the database. The saved ASCII file may of course be edited prior to loading, if keynames or values need to be changed. If the keys in the load file do not exist, they will be created. If they do exist, the values from the file will be loaded. 
\begin{DoxyCode}
[mpet@titan01 ~/online] odbedit
[local:mpet:Stopped]/>load awg0.odb
\end{DoxyCode}
 \par


\label{RC_odbedit_examples_idx_experim-dot-h_make}
\hypertarget{RC_odbedit_examples_idx_experim-dot-h_make}{}
 

\hypertarget{RC_odbedit_examples_RC_odbedit_make}{}\subparagraph{make -\/ create experim.h}\label{RC_odbedit_examples_RC_odbedit_make}

\begin{DoxyCode}
make [analyzer name]    - create experim.h
\end{DoxyCode}
 The {\bfseries make} command creates in the current directory {\bfseries \hyperlink{experim_8h}{experim.h}}, a file containing C structures which can be included into frontend and analyzer code to enable easy access to the odb \hyperlink{structparameters}{parameters} (see also RC\_\-experim\_\-dot\_\-h \char`\"{}using experim.h with hot-\/links\char`\"{} \par
 In order to include the \hyperlink{DataAnalysis_DA_analyzer_utility}{analyzer section}, the ODB key {\bfseries /$<$Analyzer$>$/Parameters} has to be present, where $<$Analyzer$>$ is the name of the analyzer. The command used is then \char`\"{}make $<$Analyzer$>$ \char`\"{} \par
 The following example does not have an Analyzer key. 
\begin{DoxyCode}
[pol@isdaq01 pol]$ odbedit
[local:pol:S]/>make
Analyzer "Analyzer" not found in ODB, skipping analyzer parameters
"experim.h" has been written to /home/pol/online/pol
\end{DoxyCode}
 Here is an part of \hyperlink{experim_8h}{experim.h} for an experiment, showing the \char`\"{}Experiment\char`\"{} tree and one of the \char`\"{}Equipment\char`\"{} trees 
\begin{DoxyCode}
/********************************************************************\

  Name:         experim.h
  Created by:   ODBedit program

  Contents:     This file contains C structures for the "Experiment"
                tree in the ODB and the "/Analyzer/Parameters" tree.


                Additionally, it contains the "Settings" subtree for
                all items listed under "/Equipment" as well as their
                event definition.

                It can be used by the frontend and analyzer to work
                with these information.

                All C structures are accompanied with a string represen-
                tation which can be used in the db_create_record function
                to setup an ODB structure which matches the C structure.

  Created on:   Wed Sep 23 13:10:52 2009

\********************************************************************/

#define EXP_EDIT_DEFINED

typedef struct {
  char      run_title[88];
  DWORD     experiment_number;
  char      experimenter[32];
  char      sample[15];
  char      orientation[15];
  char      temperature[15];
  char      field[15];
  char      element[24];
  INT       mass;
  INT       dc_offset_v_;
  double    ion_source__kv_;
  double    laser_wavelength__nm_;
  BOOL      active;
  INT       num_scans;
  char      source_hv_bias[12];
  BOOL      edit_run_number;
} EXP_EDIT;

#define EXP_EDIT_STR(_name) char *_name[] = {\
"[.]",\
"run_title = STRING : [88] test",\
"experiment number = DWORD : 1",\
"experimenter = STRING : [32] Matt ",\
"sample = STRING : [15] test",\
"orientation = STRING : [15] ",\
"temperature = STRING : [15] ",\
"field = STRING : [15] ",\
"Element = STRING : [24] li",\
"Mass = INT : 7",\
"DC offset(V) = INT : 0",\
"Ion source (kV) = DOUBLE : 30",\
"Laser wavelength (nm) = DOUBLE : 123456789",\
"write data = LINK : [35] /Logger/Channels/0/Settings/Active",\
"Number of scans = LINK : [47] /Equipment/FIFO_acq/sis mcs/hardware/num scans",\
"Source HV Bias = STRING : [12] OLIS",\
"Edit run number = BOOL : y",\
"",\
NULL }




#ifndef EXCL_CYCLE_SCALERS

#define CYCLE_SCALERS_COMMON_DEFINED

typedef struct {
  WORD      event_id;
  WORD      trigger_mask;
  char      buffer[32];
  INT       type;
  INT       source;
  char      format[8];
  BOOL      enabled;
  INT       read_on;
  INT       period;
  double    event_limit;
  DWORD     num_subevents;
  INT       log_history;
  char      frontend_host[32];
  char      frontend_name[32];
  char      frontend_file_name[256];
} CYCLE_SCALERS_COMMON;

#define CYCLE_SCALERS_COMMON_STR(_name) char *_name[] = {\
"[.]",\
"Event ID = WORD : 3",\
"Trigger mask = WORD : 1",\
"Buffer = STRING : [32] SYSTEM",\
"Type = INT : 1",\
"Source = INT : 0",\
"Format = STRING : [8] MIDAS",\
"Enabled = BOOL : y",\
"Read on = INT : 257",\
"Period = INT : 100",\
"Event limit = DOUBLE : 0",\
"Num subevents = DWORD : 0",\
"Log history = INT : 0",\
"Frontend host = STRING : [32] vwisac2",\
"Frontend name = STRING : [32] fePOL",\
"Frontend file name = STRING : [256] febnmr.c",\
"",\
NULL }

#define CYCLE_SCALERS_SETTINGS_DEFINED

typedef struct {
  char      names[6][32];
} CYCLE_SCALERS_SETTINGS;

#define CYCLE_SCALERS_SETTINGS_STR(_name) char *_name[] = {\
"[.]",\
"Names = STRING[6] :",\
"[32] Scaler_B%SIS Ref pulse",\
"[32] Scaler_B%Fluor. mon",\
"[32] Scaler_B%P+ beam",\
"[32] Scaler_B%Laser power",\
"[32] Scaler_B%Faraday Cup 15",\
"[32] Scaler_B%Locking Feedback",\
"",\
NULL }

#endif

...................

etc.
\end{DoxyCode}


\label{RC_odbedit_examples_idx_clients_active_odbedit}
\hypertarget{RC_odbedit_examples_idx_clients_active_odbedit}{}
 

\hypertarget{RC_odbedit_examples_RC_odbedit_scl}{}\subparagraph{scl -\/ show active clients}\label{RC_odbedit_examples_RC_odbedit_scl}

\begin{DoxyCode}
scl [-w]                - show all active clients [with watchdog info]
\end{DoxyCode}
 \par
 
\begin{DoxyCode}
[local:mpet:Stopped]/>scl
Name                Host
rucompet            titan01.triumf.ca
Logger              titan01.triumf.ca
scEpics             titan01.triumf.ca
fesdac              lxmpet.triumf.ca
fempet              lxmpet.triumf.ca
mhttpd              titan01.triumf.ca
ODBEdit             titan01.triumf.ca
\end{DoxyCode}




\hypertarget{RC_odbedit_examples_RC_odbedit_sh}{}\subparagraph{sh -\/ shutdown a client}\label{RC_odbedit_examples_RC_odbedit_sh}

\begin{DoxyCode}
shutdown <client>/all   - shutdown individual or all clients
\end{DoxyCode}
 \par
 
\begin{DoxyCode}
[local:mpet:Stopped]/>sh rucompet
[local:mpet:Stopped]/>scl
Name                Host
Logger              titan01.triumf.ca
scEpics             titan01.triumf.ca
fesdac              lxmpet.triumf.ca
fempet              lxmpet.triumf.ca
mhttpd              titan01.triumf.ca
ODBEdit             titan01.triumf.ca
\end{DoxyCode}


\label{RC_odbedit_examples_idx_run_start}
\hypertarget{RC_odbedit_examples_idx_run_start}{}
 

\hypertarget{RC_odbedit_examples_RC_odbedit_start}{}\subparagraph{start -\/ start a run}\label{RC_odbedit_examples_RC_odbedit_start}

\begin{DoxyCode}
start [number][now][-v] - start a run [with a specific number],
                          [now] w/o asking parameters, [-v] debug output
\end{DoxyCode}
 \par


The odbedit {\bfseries start} command is used to start a run.

\par
 \hypertarget{RC_odbedit_examples_RC_EOS_example1}{}\subparagraph{Run start examples}\label{RC_odbedit_examples_RC_EOS_example1}
In the following example, the run number of the new run is supplied. 
\begin{DoxyCode}
[local:Default:S]/Experiment>start 503
\end{DoxyCode}
 \par


In the example below, the run number is not specified. The system will start the next consecutive run. 
\begin{DoxyCode}
[local:Default:S]/Experiment>start
Run number [30004]: 
Are the above parameters correct? ([y]/n/q): y
\end{DoxyCode}
 The user may edit the run number before continuing by typing \char`\"{}n\char`\"{}. Typing \char`\"{}y\char`\"{} will start the run, and typing \char`\"{}q\char`\"{} will abort the run start. \par


In the above example, there are no \hyperlink{RC_customize_ODB_RC_Edit_On_Start}{edit-\/on-\/start paramaters} defined by the user. If any are defined, the command \char`\"{}start\char`\"{} will display the \char`\"{}edit on start\char`\"{} \hyperlink{structparameters}{parameters} e.g.\hypertarget{RC_odbedit_examples_RC_EOS_example2}{}\subparagraph{Run Start example with \char`\"{}Edit on Start\char`\"{} parameters}\label{RC_odbedit_examples_RC_EOS_example2}
Note that when using odbedit, Parameter comments are NOT visible, and the run number IS editable. 
\begin{DoxyCode}
[local:bnmr:S]/>start 
run_title : 2e test
experiment number : 9999
experimenter : gdm
sample : NA
orientation : 
temperature : 285.12K
field : 0G
Number of scans : 0
write data : y
Run number [30004]:
\end{DoxyCode}


\par
 \hypertarget{RC_odbedit_examples_RC_EOS_example3}{}\subparagraph{Run Start Example with \char`\"{}start now\char`\"{}}\label{RC_odbedit_examples_RC_EOS_example3}
\label{RC_odbedit_examples_RC_odbedit_start_now}
\hypertarget{RC_odbedit_examples_RC_odbedit_start_now}{}
 By entering the command {\bfseries \char`\"{}start now\char`\"{}}, all defined \hyperlink{RC_customize_ODB_RC_Edit_On_Start}{Edit-\/on-\/Start parameters} can be skipped. 
\begin{DoxyCode}
[local:bnmr:S]/>start now
Starting run #30129
Run #30129 started
\end{DoxyCode}
\hypertarget{RC_odbedit_examples_RC_EOS_example4}{}\subparagraph{Run Start Example with \char`\"{}-\/v\char`\"{} verbose option}\label{RC_odbedit_examples_RC_EOS_example4}
\label{RC_odbedit_examples_RC_odbedit_start_v}
\hypertarget{RC_odbedit_examples_RC_odbedit_start_v}{}
 Using the {\bfseries \char`\"{}-\/v\char`\"{}} (verbose) option is useful for debugging. It prints messages as each client is started. 
\begin{DoxyCode}
[local:bnmr:S]/>start -v
run_title : test
experiment number : 1165
experimenter : gdm
sample : GaAs
orientation : 100
temperature : 286.01K
field : 0.00G
Number of cycles : 0
write data : y
Run number [30128]:
Are the above parameters correct? ([y]/n/q): y
\end{DoxyCode}
 \label{RC_odbedit_examples_RC_transition_start}
\hypertarget{RC_odbedit_examples_RC_transition_start}{}
 
\begin{DoxyCode}
Starting run #30128
Setting run number 30128 in ODB
---- Transition START started ----

==== Found client "Logger" with sequence number 200
Connecting to client "Logger" on host isdaq01...
Connection established to client "Logger" on host isdaq01
Executing RPC transition client "Logger" on host isdaq01...
RPC transition finished client "Logger" on host isdaq01 with status 1

==== Found client "mheader" with sequence number 200
Connecting to client "mheader" on host isdaq01...
Connection established to client "mheader" on host isdaq01
Executing RPC transition client "mheader" on host isdaq01...
RPC transition finished client "mheader" on host isdaq01 with status 1

==== Found client "rf_config" with sequence number 350
Connecting to client "rf_config" on host isdaq01...
Connection established to client "rf_config" on host isdaq01
Executing RPC transition client "rf_config" on host isdaq01...
RPC transition finished client "rf_config" on host isdaq01 with status 1

==== Found client "rf_config" with sequence number 400
Connecting to client "rf_config" on host isdaq01...
Connection established to client "rf_config" on host isdaq01
Executing RPC transition client "rf_config" on host isdaq01...
RPC transition finished client "rf_config" on host isdaq01 with status 1

==== Found client "Mdarc" with sequence number 450
Connecting to client "Mdarc" on host isdaq01...
Connection established to client "Mdarc" on host isdaq01
Executing RPC transition client "Mdarc" on host isdaq01...
RPC transition finished client "Mdarc" on host isdaq01 with status 1

==== Found client "Epics" with sequence number 500
Connecting to client "Epics" on host isdaq01...
Connection established to client "Epics" on host isdaq01
Executing RPC transition client "Epics" on host isdaq01...
RPC transition finished client "Epics" on host isdaq01 with status 1

==== Found client "mheader" with sequence number 500
Connecting to client "mheader" on host isdaq01...
Connection established to client "mheader" on host isdaq01
Executing RPC transition client "mheader" on host isdaq01...
RPC transition finished client "mheader" on host isdaq01 with status 1

==== Found client "Mdarc" with sequence number 500
Connecting to client "Mdarc" on host isdaq01...
Connection established to client "Mdarc" on host isdaq01
Executing RPC transition client "Mdarc" on host isdaq01...
RPC transition finished client "Mdarc" on host isdaq01 with status 1

==== Found client "feBNMR" with sequence number 500
Connecting to client "feBNMR" on host bnmrhmvw...
Connection established to client "feBNMR" on host bnmrhmvw
Executing RPC transition client "feBNMR" on host bnmrhmvw...
RPC transition finished client "feBNMR" on host bnmrhmvw with status 1
\end{DoxyCode}




 \label{RC_odbedit_examples_idx_run_stop}
\hypertarget{RC_odbedit_examples_idx_run_stop}{}
 \hypertarget{RC_odbedit_examples_RC_odbedit_stop}{}\subparagraph{stop -\/ stop a run}\label{RC_odbedit_examples_RC_odbedit_stop}

\begin{DoxyCode}
stop [-v]               - stop current run, [-v] debug output
\end{DoxyCode}
 \par
 
\begin{DoxyCode}
[local:pol:R]/>stop
Run #399 stopped
[local:pol:S]/>  
\end{DoxyCode}
 \label{RC_odbedit_examples_idx_run_stop_immediately}
\hypertarget{RC_odbedit_examples_idx_run_stop_immediately}{}
 \char`\"{}Stop now\char`\"{} can be used to force a stop if there is a deferred transition. If there is no deferred transition, the \char`\"{}stop now\char`\"{} is the same as \char`\"{}stop\char`\"{}. 
\begin{DoxyCode}
local:bnmr:R]/>stop now
Run #30129 stopped
\end{DoxyCode}
 Using the \char`\"{}-\/v\char`\"{} (verbose) option is useful for debugging. It prints a message as each client is stopped.

\label{RC_odbedit_examples_RC_transition_stop}
\hypertarget{RC_odbedit_examples_RC_transition_stop}{}



\begin{DoxyCode}
[local:bnmr:R]/>stop -v
---- Transition STOP started ----

==== Found client "mheader" with sequence number 200
Connecting to client "mheader" on host isdaq01...
Connection established to client "mheader" on host isdaq01
Executing RPC transition client "mheader" on host isdaq01...
RPC transition finished client "mheader" on host isdaq01 with status 1

==== Found client "Epics" with sequence number 500
Connecting to client "Epics" on host isdaq01...
Connection established to client "Epics" on host isdaq01
Executing RPC transition client "Epics" on host isdaq01...
RPC transition finished client "Epics" on host isdaq01 with status 1

==== Found client "rf_config" with sequence number 500
Connecting to client "rf_config" on host isdaq01...
Connection established to client "rf_config" on host isdaq01
Executing RPC transition client "rf_config" on host isdaq01...
RPC transition finished client "rf_config" on host isdaq01 with status 1

==== Found client "mheader" with sequence number 500
Connecting to client "mheader" on host isdaq01...
Connection established to client "mheader" on host isdaq01
Executing RPC transition client "mheader" on host isdaq01...
RPC transition finished client "mheader" on host isdaq01 with status 1

==== Found client "feBNMR" with sequence number 500
Connecting to client "feBNMR" on host bnmrhmvw...
Connection established to client "feBNMR" on host bnmrhmvw
Executing RPC transition client "feBNMR" on host bnmrhmvw...
RPC transition finished client "feBNMR" on host bnmrhmvw with status 1

==== Found client "mheader" with sequence number 600
Connecting to client "mheader" on host isdaq01...
Connection established to client "mheader" on host isdaq01
Executing RPC transition client "mheader" on host isdaq01...
RPC transition finished client "mheader" on host isdaq01 with status 1

==== Found client "Mdarc" with sequence number 600
Connecting to client "Mdarc" on host isdaq01...
Connection established to client "Mdarc" on host isdaq01
Executing RPC transition client "Mdarc" on host isdaq01...
RPC transition finished client "Mdarc" on host isdaq01 with status 1

==== Found client "feBNMR" with sequence number 750
Connecting to client "feBNMR" on host bnmrhmvw...
Connection established to client "feBNMR" on host bnmrhmvw
Executing RPC transition client "feBNMR" on host bnmrhmvw...
RPC transition finished client "feBNMR" on host bnmrhmvw with status 1

==== Found client "Logger" with sequence number 800
Connecting to client "Logger" on host isdaq01...
Connection established to client "Logger" on host isdaq01
Executing RPC transition client "Logger" on host isdaq01...
RPC transition finished client "Logger" on host isdaq01 with status 1

---- Transition STOP finished ----
Run #30128 stopped
\end{DoxyCode}


\par
 

\label{index_end}
\hypertarget{index_end}{}
 \paragraph{The mhttpd daemon}\label{RC_mhttpd_utility}
\label{RC_mhttpd_utility_idx_mhttpd-utility}
\hypertarget{RC_mhttpd_utility_idx_mhttpd-utility}{}


\par
 \hypertarget{RC_mhttpd_utility_RC_mhttpd_Usage}{}\paragraph{Start the mhttpd daemon}\label{RC_mhttpd_utility_RC_mhttpd_Usage}
The mhttpd utility requires the TCP/IP port number as an argument in order to listen to the web-\/based request.


\begin{DoxyItemize}
\item {\bfseries  Arguments }
\end{DoxyItemize}


\begin{DoxyItemize}
\item \mbox{[}-\/h\mbox{]} : connect to midas server (mserver) on given host
\item \mbox{[}-\/e\mbox{]} : experiment to connect to
\item \mbox{[}-\/p port \mbox{]} : port number e.g. 8081 (no default)
\item \mbox{[}-\/v\mbox{]} : display verbose HTTP communication
\item \mbox{[}-\/D\mbox{]} : starts program as a {\bfseries daemon} 
\item \mbox{[}-\/E\mbox{]} : only display ELog system
\item \mbox{[}-\/H\mbox{]} : only display history plots
\item \mbox{[}-\/a\mbox{]} : only allow access for specific host(s). Several \mbox{[}-\/a Hostname\mbox{]} statements might be given
\item \mbox{[}-\/help\mbox{]} : display usage information
\end{DoxyItemize}


\begin{DoxyItemize}
\item {\bfseries  Usage } \par
 mhttpd \mbox{[}-\/h Hostname\mbox{]} \mbox{[}-\/e Experiment\mbox{]} \mbox{[}-\/p port\mbox{]} \mbox{[}-\/v\mbox{]} \mbox{[}-\/D\mbox{]} \mbox{[}-\/c\mbox{]} \mbox{[}-\/a Hostname\mbox{]} \par
e.g. \par
 {\bfseries mhttpd -\/p 8081 -\/D }
\end{DoxyItemize}

\begin{DoxyNote}{Note}

\begin{DoxyItemize}
\item Several copies of mhttpd can run on a single host, as long as they are {\bfseries started on different ports}.
\item If {\bfseries more than one experiment} runs on the same host, a server for each experiment must be started on a {\bfseries different} port, e.g.
\begin{DoxyItemize}
\item mhttpd -\/e midas -\/p 8081 -\/D
\item mhttpd -\/e midgas -\/p 8082 -\/D
\end{DoxyItemize}
\end{DoxyItemize}
\end{DoxyNote}
\par


\par


\label{RC_mhttpd_utility_idx_mhttpd-utility_connect}
\hypertarget{RC_mhttpd_utility_idx_mhttpd-utility_connect}{}
 \hypertarget{RC_mhttpd_utility_RC_mhttpd_connect}{}\subparagraph{Connect to the mhttpd webserver}\label{RC_mhttpd_utility_RC_mhttpd_connect}
To connect to a mhttpd webserver running on port {\itshape $<$nnnn$>$\/} on host {\itshape $<$hostname$>$\/} and experiment {\itshape $<$exptname$>$\/}, {\bfseries enter the URL in your web browser location box} in the form


\begin{DoxyCode}
 http://<hostname>:<nnnn>/?exp=<exptname>
\end{DoxyCode}
 e.g. 
\begin{DoxyCode}
 http://midtis09:8081/?exp=midas
\end{DoxyCode}
 \par


\label{RC_mhttpd_utility_RC_mhttpd_msp_default}
\hypertarget{RC_mhttpd_utility_RC_mhttpd_msp_default}{}


Once the \hyperlink{RC_mhttpd_utility_RC_mhttpd_connect}{connection} to a given experiment is established, the {\bfseries Main Status Page} of the MIDAS webserver is displayed in the web browser window. \par
 An error page will appear instead if the \hyperlink{RC_mhttpd_utility}{mhttpd daemon} has NOT been started on the specified port (or has not been started at all). \par


\label{RC_mhttpd_utility_RC_mhttpd_minimal_status_page}
\hypertarget{RC_mhttpd_utility_RC_mhttpd_minimal_status_page}{}
 \begin{center} mhttpd main status page (no clients are running) \par
\par
\par
   \end{center}  \par


Once clients are started (e.g. frontend, logger etc.) the main status page will look more like \hyperlink{RC_mhttpd_Main_Status_page_RC_mhttpd_msp_customized}{this}.

the image above shows a pre-\/ \hyperlink{NDF_ndf_dec_2009}{Dec 2009} version of mhttpd (see \hyperlink{RC_mhttpd_status_page_redesign}{Redesign of mhttpd Main Status Page}).

\par
 

 \par


\label{RC_mhttpd_utility_idx_mhttpd_proxy-access}
\hypertarget{RC_mhttpd_utility_idx_mhttpd_proxy-access}{}
 \label{RC_mhttpd_utility_idx_access-control_mhttpd-proxy}
\hypertarget{RC_mhttpd_utility_idx_access-control_mhttpd-proxy}{}
 \label{RC_mhttpd_utility_idx_Apache}
\hypertarget{RC_mhttpd_utility_idx_Apache}{}
 \hypertarget{RC_mhttpd_utility_RC_mhttpd_proxy}{}\paragraph{Proxy Access to mhttpd}\label{RC_mhttpd_utility_RC_mhttpd_proxy}
A major change was made to mhttpd in \hyperlink{NDF_ndf_feb_2008}{Feb 2008} , changing all internal URLs to relative paths. This allows {\bfseries proxy access} to mhttpd via an \href{http://apache.org/}{\tt Apache} server for example, which might be needed to securely access an experiment from outside the lab through a firewall. Apache can also be configured to allow a secure SSL connection to the proxy.

In order to add SSL encryption to mhttpd, the following settings can be placed into an {\bfseries Apache configuration} : \par
 Assuming
\begin{DoxyItemize}
\item the experiment runs on machine {\itshape online1.your.domain\/}, and
\item apache is running on a publically available machine {\itshape www.your.domain\/} \par

\end{DoxyItemize}


\begin{DoxyCode}
Redirect permanent /online1 http://www.your.domain/online1
ProxyPass /online1/  http://online1.your.domain/

<Location "/online1">
  AuthType Basic
  AuthName ...
  AuthUserFile ...
  Require user ...
</Location>
\end{DoxyCode}


If the URL 
\begin{DoxyCode}
http://www.your.domain/online1
\end{DoxyCode}
 is accessed, it will be redirected (after optional authentication) to 
\begin{DoxyCode}
http://online1.your.domain/
\end{DoxyCode}
 \par
 If you click on the mhttpd \hyperlink{RC_mhttpd_History_page}{History page} for example, mhttpd would normally redirect this to 
\begin{DoxyCode}
http://online1.your.domain/HS/
\end{DoxyCode}
 but this is not correct since you want to go through the proxy {\itshape www.your.domain\/}. The new relative redirection inside mhttpd now redirects the history page correctly to 
\begin{DoxyCode}
http://www.your.domain/online1/HS/
\end{DoxyCode}


\label{index_end}
\hypertarget{index_end}{}
 \par
  \paragraph{Main Status Page}\label{RC_mhttpd_Main_Status_page}
\label{RC_mhttpd_status_page_redesign_idx_mhttpd_page_status}
\hypertarget{RC_mhttpd_status_page_redesign_idx_mhttpd_page_status}{}


\par


 \par


\label{RC_mhttpd_Main_Status_page_RC_mhttpd_main_status}
\hypertarget{RC_mhttpd_Main_Status_page_RC_mhttpd_main_status}{}
 \hypertarget{RC_mhttpd_Main_Status_page_RC_mhttpd_msp_customized}{}\paragraph{Status Page for a Running Experiment}\label{RC_mhttpd_Main_Status_page_RC_mhttpd_msp_customized}
The following image shows the main Status Page of one of the experiments at TRIUMF:

\begin{center} MIDAS Status Page for a running experiment \par
\par
\par
  \end{center}  \par


In this case, the experiment has been customized by
\begin{DoxyItemize}
\item creating and starting some frontend(s), which define various equipment(s)
\item defining \char`\"{}script\char`\"{} and \char`\"{}alias\char`\"{} buttons
\item starting some of the MIDAS utilities (e.g. the MIDAS logger \hyperlink{F_Logging_F_mlogger_utility}{mlogger} and the \hyperlink{F_LogUtil_F_lazylogger_utility}{lazylogger} )
\end{DoxyItemize}

Compared with the \hyperlink{RC_mhttpd_utility_RC_mhttpd_minimal_status_page}{minimal status page} (where no clients are running) it's clear that the the Status Page above shows a lot more information.

The main status page will be discussed line-\/by-\/line in the following section ( \hyperlink{RC_mhttpd_status_page_features}{Features of the Main Status Page} ).


\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_status_page_features}{Features of the Main Status Page}
\item \hyperlink{RC_mhttpd_status_page_redesign}{Redesign of mhttpd Main Status Page}
\end{DoxyItemize}



\label{index_end}
\hypertarget{index_end}{}
 \subsubsection{Features of the Main Status Page}\label{RC_mhttpd_status_page_features}
 The Status Page is sub-\/divided in several parts:
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_title}{Experiment/Date/Refresh information}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_menu_buttons}{Menu buttons}
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_RC_buttons}{Run Control buttons}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Page_buttons}{Page Switch buttons}
\end{DoxyItemize}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_script_buttons}{Optional Script buttons}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Manual_Trigger_buttons}{Manual-\/Trigger Buttons}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Alias_buttons}{Alias-\/Buttons}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Run_info}{Run status information}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Equipment_info}{Equipment information and Event rates}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Logger}{Data Logging Information}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_latest_msg}{Last system message}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_clients}{Active Client list}
\end{DoxyItemize}

These will be discussed in detail in the following sections. \par
 \label{RC_mhttpd_status_page_features_RC_mhttpd_main_status_new}
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_main_status_new}{}
 \begin{center} mhttpd main status page showing Menu Buttons \par
\par
\par
  \end{center}  \par
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_title}{}\subparagraph{Experiment/Date/Refresh information}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_title}
The top line on the main status page \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_main_status_new}{above} shows
\begin{DoxyItemize}
\item the Experiment name (\char`\"{}Online\char`\"{})
\item the current date
\item the refresh period (Refr:600) -\/ see note below
\end{DoxyItemize}

It is important to note that the {\bfseries refresh} of the Status Page is not \char`\"{}event driven\char`\"{} but is controlled by a timer whose rate is adjustable through the \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_Config_button}{Config button}. This means the information at any given time may reflect the experiment state of up to n seconds in the past, where n is the timer setting of the refresh parameter.





\label{RC_mhttpd_status_page_features_idx_mhttpd_buttons_menu}
\hypertarget{RC_mhttpd_status_page_features_idx_mhttpd_buttons_menu}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_menu_buttons}{}\subparagraph{Menu buttons}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_menu_buttons}
The top row of buttons on the \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_main_status_new}{main status page} are the
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_RC_buttons}{Run Control buttons}
\item \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Page_buttons}{Page Switch buttons}
\end{DoxyItemize}

\label{RC_mhttpd_status_page_features_idx_mhttpd_buttons_run-control}
\hypertarget{RC_mhttpd_status_page_features_idx_mhttpd_buttons_run-control}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_RC_buttons}{}\subparagraph{Run Control buttons}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_RC_buttons}
Depending on the \hyperlink{RC_Run_States_and_Transitions}{run state}, a single or the two first buttons on the \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_main_status_new}{main status page} will show the possible action that can be taken, i.e.

\label{RC_mhttpd_status_page_features_RC_table_run_state}
\hypertarget{RC_mhttpd_status_page_features_RC_table_run_state}{}


\begin{table}[h]\begin{TabularC}{3}
\hline
Run Control Buttons present\par
(see Note \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_note1}{below})\par
  &Run State\par
  &Action\par
   \\\cline{1-3}
\begin{TabularC}{1}
\hline
Start\par
   \\\cline{1-1}
\end{TabularC}
&STOPPED\par
  &Start the run\par
   \\\cline{1-3}
\begin{TabularC}{1}
\hline
Stop\par
   \\\cline{1-1}
\end{TabularC}
&\multirow{2}{\linewidth}{RUNNING\par
  }&Stop the run\par
   \\\cline{2-3}
\begin{TabularC}{1}
\hline
Pause\par
   \\\cline{1-1}
\end{TabularC}
&Pause the run\par
   \\\cline{1-2}
\begin{TabularC}{1}
\hline
Resume\par
   \\\cline{1-1}
\end{TabularC}
&\multirow{1}{\linewidth}{PAUSED\par
  }&Resume the run\par
   \\\cline{1-3}
\end{TabularC}
\centering
\caption{Run Control buttons visible depending on Run State }
\end{table}


\label{RC_mhttpd_status_page_features_RC_mhttpd_note1}
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_note1}{}
  Since \hyperlink{NDF_ndf_nov_2009}{Nov 2009} , the Run Buttons may be hidden (see \hyperlink{RC_customize_ODB_RC_Experiment_tree_keys}{Hide Run Buttons} ),

\label{RC_mhttpd_status_page_features_idx_mhttpd_buttons_page-switch}
\hypertarget{RC_mhttpd_status_page_features_idx_mhttpd_buttons_page-switch}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_Page_buttons}{}\subparagraph{Page Switch buttons}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_Page_buttons}
The {\bfseries Page Switch buttons} on the mhttpd main status page (see \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_main_status_new}{example above}) change the page to one of the sub-\/pages. The sub-\/pages all provide a button labelled {\bfseries Status}, which returns to the main Status page when clicked. The purpose of each Page Switch button is explained in the following table:

The Page switch buttons can now be \hyperlink{RC_customize_ODB_RC_ODB_Experiment_Tree}{customized} ( since \hyperlink{NDF_ndf_dec_2009}{Dec 2009} ) , so not all the possible Page Switch buttons may be visible on the status page for a particular experiment.

\begin{table}[h]\begin{TabularC}{2}
\hline
Page Switch Button &Explanation 

\\\cline{1-2}
\begin{TabularC}{1}
\hline
 \hyperlink{RC_mhttpd_ODB_page}{ODB}\par
   \\\cline{1-1}
\end{TabularC}
&This button switches to the (see \hyperlink{RC_mhttpd_ODB_page}{ODB page}), which provides access to the Online Data Base. 

\\\cline{1-2}
\begin{TabularC}{1}
\hline
\hyperlink{RC_mhttpd_MSCB_page}{MSCB}\par
   \\\cline{1-1}
\end{TabularC}
&This button switches to the \hyperlink{RC_mhttpd_MSCB_page}{MSCB page} , which gives access to devices in a MIDAS Slow Control Bus system. (Implemented \hyperlink{NDF_ndf_dec_2009}{Dec 2009})



\\\cline{1-2}
\begin{TabularC}{1}
\hline
 \hyperlink{RC_mhttpd_CNAF_page}{CNAF}\par
   \\\cline{1-1}
\end{TabularC}
&In versions since \hyperlink{NDF_ndf_dec_2009}{Dec 2009} the default is that this button has been replaced by the MSCB button. If the CNAF button is needed, it must be added to the list of \hyperlink{RC_customize_ODB_RC_ODB_Experiment_Tree}{menu buttons}. \par
This button switches to the \hyperlink{RC_mhttpd_CNAF_page}{CAMAC Access page} . If one of the equipments is a CAMAC frontend, it is possible to issue CAMAC commands through this button.  \\\cline{1-2}
\begin{TabularC}{1}
\hline
 \hyperlink{RC_mhttpd_Message_page}{Messages}\par
   \\\cline{1-1}
\end{TabularC}
&Clicking this button opens the \hyperlink{RC_mhttpd_Message_page}{message page} and shows the N last entries of the \hyperlink{F_Messaging}{MIDAS system message log}. The last entry is always present in the status page (see \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_latest_msg}{Last system message} ).  \\\cline{1-2}
\begin{TabularC}{1}
\hline
\hyperlink{RC_mhttpd_Elog_page}{ELog}\par
   \\\cline{1-1}
\end{TabularC}
&This button gives access to the Electronic Log book (Elog). The Elog allows the permanent recording (i.e. in a file) of comments, messages, screen captures etc. composed by the users (see \hyperlink{RC_mhttpd_Elog_page}{Elog page}).  \\\cline{1-2}
\begin{TabularC}{1}
\hline
\hyperlink{RC_mhttpd_Alarm_page}{Alarms}\par
   \\\cline{1-1}
\end{TabularC}
&Clicking this button displays the \hyperlink{RC_mhttpd_Alarm_page}{Alarm page} , which shows the current Alarm setting for the entire experiment. The activation of an alarm is done through the ODB under the {\bfseries /Alarms} tree (See \hyperlink{RC_customize_ODB_RC_Alarm_System}{MIDAS Alarm System})  \\\cline{1-2}
\begin{TabularC}{1}
\hline
 \hyperlink{RC_mhttpd_Program_page}{Programs}\par
   \\\cline{1-1}
\end{TabularC}
&This button gives access to the \hyperlink{RC_mhttpd_Program_page}{Programs page}, which displays the status of the current programs (i.e. MIDAS applications/clients) which are or have been running for this experiment. 

\\\cline{1-2}
\begin{TabularC}{1}
\hline
\hyperlink{RC_mhttpd_History_page}{History}\par
   \\\cline{1-1}
\end{TabularC}
&Display History graphs of pre-\/defined variables. The history setting has to be done through ODB under the {\bfseries /History} (see \hyperlink{F_History_logging}{History Logging} , \hyperlink{RC_mhttpd_History_page}{History page}). 

\\\cline{1-2}
\begin{TabularC}{1}
\hline
\label{RC_mhttpd_status_page_features_RC_mhttpd_Config_button}
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_Config_button}{}
 \label{RC_mhttpd_status_page_features_RC_mhttpd_refresh}
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_refresh}{}
 \hyperlink{RC_mhttpd_Config_page}{Config}\par
   \\\cline{1-1}
\end{TabularC}
&Allows the {\bfseries  page refresh rate } to be changed. See \hyperlink{RC_mhttpd_Config_page}{Config page} .



\\\cline{1-2}
\begin{TabularC}{1}
\hline
Help\par
   \\\cline{1-1}
\end{TabularC}
&Help button will link to the main MIDAS web documentation (i.e. this document). 

\\\cline{1-2}
\end{TabularC}
\centering
\caption{Page Switch Buttons on the Main Status Page}
\end{table}


\par


\par
\hypertarget{RC_mhttpd_status_page_features_RC_mhpptd_optional_buttons}{}\subparagraph{Optional Buttons on the main Status page}\label{RC_mhttpd_status_page_features_RC_mhpptd_optional_buttons}
\begin{center} mhttpd main Status page (part) showing optional buttons \par
  \end{center}  \par


 Since \hyperlink{NDF_ndf_dec_2009}{Dec 2009}  there may be up to three rows of buttons below the Menu buttons
\begin{DoxyItemize}
\item Script (User) buttons
\item Manually triggered event buttons
\item Custom Page and Alias buttons
\end{DoxyItemize}

 Prior to \hyperlink{NDF_ndf_dec_2009}{Dec 2009}  the Custom Page and Alias hyperlinks appeared as {\bfseries links} rather than buttons, as shown \hyperlink{RC_mhttpd_status_page_redesign_RC_mhttpd_old_alias_buttons}{here}.

\par


\par
 \label{RC_mhttpd_status_page_features_idx_mhttpd_buttons_script}
\hypertarget{RC_mhttpd_status_page_features_idx_mhttpd_buttons_script}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_script_buttons}{}\subparagraph{Optional Script buttons}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_script_buttons}
Script (or User) buttons that appear on the \hyperlink{RC_mhttpd_status_page_features_RC_mhpptd_optional_buttons}{main status page} are used to execute user-\/defined scripts. These buttons are defined through the optional ODB /script tree.

See
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_defining_script_buttons}{Defining script buttons}
\end{DoxyItemize}

for details.

\par


\par
 \label{RC_mhttpd_status_page_features_idx_manual-trigger_button}
\hypertarget{RC_mhttpd_status_page_features_idx_manual-trigger_button}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_Manual_Trigger_buttons}{}\subparagraph{Manual-\/Trigger Buttons}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_Manual_Trigger_buttons}
See \hyperlink{FE_eq_event_routines_FE_manual_trigger}{Manual Trigger} .

\par


\par
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_Alias_buttons}{}\subparagraph{Alias-\/Buttons}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_Alias_buttons}
User-\/defined {\bfseries Alias-\/buttons} that appear on the \hyperlink{RC_mhttpd_status_page_features_RC_mhpptd_optional_buttons}{main status page} give access to \hyperlink{RC_mhttpd_Alias_page}{Alias pages}.


\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_Alias_page_RC_mhttpd_alias_define}{How to create Alias-\/Buttons}
\end{DoxyItemize}

\par


\par
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_Run_info}{}\subparagraph{Run status information}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_Run_info}
\begin{center} mhttpd status page showing Run Status information  \end{center} \par


The run status information on the \hyperlink{RC_mhttpd_Main_Status_page_RC_mhttpd_main_status}{main status page} shows
\begin{DoxyItemize}
\item current run number
\item \hyperlink{RC_mhttpd_status_page_features_RC_table_run_state}{run state}
\item Alarm status
\item \hyperlink{F_Logging_Data_F_Logger_Auto_Restart}{Restart} (automatically restart run)
\item mlogger status
\item run duration
\end{DoxyItemize}

The appearance and contents of this information changes depending on the conditions. The images below demonstrate how the appearance may change when the run is in transition.

\begin{center} mhttpd status page showing Run Status information when the run is stopping  \end{center} \par


\begin{center} mhttpd status page showing Run Status information when the run is starting  \end{center} \par


\par


\par
 \hypertarget{RC_mhttpd_status_page_features_RC_Edit_RP}{}\subparagraph{Comment and Run Description}\label{RC_mhttpd_status_page_features_RC_Edit_RP}
Optionally, the user can define a \char`\"{}comment\char`\"{} and/or a \char`\"{}Run Description\char`\"{} that will appear on the mhttpd main status page. This is done by creating keys {\bfseries \char`\"{}Comment\char`\"{}} and/or {\bfseries \char`\"{}Run Description\char`\"{}} in the \hyperlink{RC_customize_ODB_RC_Run_Parameters}{Run Parameters subdirectory} under /Experiment. The contents of each key will then be displayed on an extra line on the mhttpd main status page. See \hyperlink{RC_customize_ODB_RC_ODB_Experiment_Tree}{The ODB /Experiment tree} for more information.


\begin{DoxyCode}
[local:t2kgas:S]/>ls -lt "/Experiment/Run Parameters/"
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
Comment                         STRING  1     32    19h  0   RWD   no beam, test 
      only
Run Description                 STRING  1     32    19h  0   RWD  28.2keV resonan
      t energy 7Li
\end{DoxyCode}


\par
 \begin{center} mhttpd main status page showing \char`\"{}Comment\char`\"{} and \char`\"{}Run Description\char`\"{} fields  \end{center}  \par


\par


\label{RC_mhttpd_status_page_features_idx_mhttpd_page_status_equipment}
\hypertarget{RC_mhttpd_status_page_features_idx_mhttpd_page_status_equipment}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_Equipment_info}{}\subparagraph{Equipment information and Event rates}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_Equipment_info}
The mhttpd status page contains a table of \hyperlink{FrontendOperation_FE_sw_equipment}{Equipment} information and event rates. Equipments are usually defined in \hyperlink{FrontendOperation_FE_features}{frontends}. Other MIDAS clients which may define Equipments include slow controls and eventbuilder clients.

\begin{center} mhttpd status page showing Equipment information and Event rate statistics  \end{center} \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_eq_variables}{}\subparagraph{Monitor the Equipment variables}\label{RC_mhttpd_status_page_features_RC_mhttpd_eq_variables}
The \char`\"{}Equipment\char`\"{} column of this table lists the names of any defined \hyperlink{FrontendOperation_FE_sw_equipment}{Equipments}. These appear in the order in which they are listed in the ODB \hyperlink{FE_ODB_equipment_tree}{/Equipment} tree.

The names of the equipment in this column are hyperlinks to their respective /Equipment/$<$equipment-\/name$>$/Variables sub-\/tree. Clicking on any of the equipment links will show an \hyperlink{RC_mhttpd_Equipment_page}{Equipment page} , allowing a shortcut for the user to access the current values of the equipment. \par


\par
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_eq_status}{}\subparagraph{Status display of each Equipment}\label{RC_mhttpd_status_page_features_RC_mhttpd_eq_status}
The \char`\"{}Status\char`\"{} column of the \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Equipment_info}{mhttpd status page} shows the status of each equipment. It usually shows the name of the client defining that equipment, and the host computer on which that client is running, The background colour of each equipment \char`\"{}Status\char`\"{} box will also change depending on the status of the associated frontend. The usual colours are shown in the following table:

\begin{center} \begin{table}[h]\begin{TabularC}{1}
\hline
Frontend is RUNNING and equipment is ENABLED  \\\cline{1-1}
Frontend is MISSING   \\\cline{1-1}
Frontend is RUNNING but equipment is DISABLED \\\cline{1-1}
\end{TabularC}
\centering
\caption{Default colour coding of Equipment status }
\end{table}
\par
 \end{center} 

When a run is in transition, or when a client takes a long time to respond, the status information may change to give a status report on the client. Optionally, users may program a client to send their own status reports that appear in this area of the mhttpd status page by incorporating calls to the routine {\itshape set\_\-equipment\_\-status\/} (see \hyperlink{FE_sequence_FE_frontend_status}{Reporting Equipment status}). This routine allows the message and the status box background colour to be specified. For example, the last client in the image above (HV\_\-SY2527) gives a Status of \char`\"{}OK\char`\"{} rather than the default client and hostname.

In versions prior to \hyperlink{NDF_ndf_dec_2009}{Dec 2009} , the \char`\"{}Status\char`\"{} column was labelled {\bfseries \char`\"{}FE Node\char`\"{}} and the client status information was not shown (see \hyperlink{RC_mhttpd_status_page_redesign}{Redesign of mhttpd Main Status Page} ).

\par


\par
 \label{RC_mhttpd_status_page_features_idx_mhttpd_page_status_event-rate}
\hypertarget{RC_mhttpd_status_page_features_idx_mhttpd_page_status_event-rate}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_Event_Rates}{}\subparagraph{Event Rates}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_Event_Rates}
The event statistics for the current run are also shown on the \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Equipment_info}{main status page} , in the columns labelled {\bfseries \char`\"{}Events\char`\"{}}, {\bfseries \char`\"{}Events\mbox{[}/s\mbox{]}\char`\"{}} and {\bfseries \char`\"{}Data\mbox{[}MB/s\mbox{]}\char`\"{}}.

\par


\par
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_analyzer}{}\subparagraph{Number of events analyzed}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_analyzer}
In versions prior to \hyperlink{NDF_ndf_dec_2009}{Dec 2009} , there is an extra column labelled \char`\"{}analyzer\char`\"{} which shows the number of events analyzed (valid only if the name of the analyzer is \char`\"{}Analyzer\char`\"{}).

\par


\par
\hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_Logger}{}\subparagraph{Data Logging Information}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_Logger}
The image below shows the information on the status page if both \hyperlink{F_Logging_F_mlogger_utility}{mlogger} and \hyperlink{F_LogUtil_F_lazylogger_utility}{lazylogger} are running.

\begin{center} logger information on mhttpd main status page \par
\par
\par
  \end{center}  \par


Compare this example with the \hyperlink{RC_mhttpd_utility_RC_mhttpd_minimal_status_page}{minimal} status page where neither of these clients are running.

\par
 In the image above,
\begin{DoxyItemize}
\item one mlogger channel (Channel 0) is active. \par
Multiple logger channels can be active, in which case a line for each channel would be shown. The hyperlink {\bfseries \char`\"{}0\char`\"{}} opens a \hyperlink{RC_mhttpd_Logger_page}{mhttpd Logger page} showing the settings information.
\item one lazylogger channel ({\bfseries Dcache} ) is also active. Multiple lazy applications can be active, in which case multiple lines of Lazy information would be present. Clicking on the hyperlink {\bfseries \char`\"{}Dcache\char`\"{}} opens a \hyperlink{RC_mhttpd_Logger_page}{mhttpd Logger page} showing the \hyperlink{RC_mhttpd_Logger_page_RC_mhttpd_Logger_lazylogger}{lazylogger settings information} .
\end{DoxyItemize}

\par


\par
 \label{RC_mhttpd_status_page_features_idx_message_last}
\hypertarget{RC_mhttpd_status_page_features_idx_message_last}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_latest_msg}{}\subparagraph{Last system message}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_latest_msg}
\begin{center} Example of last system message on mhttpd main status page \par
\par
\par
  \end{center}  \par


The last system message to be received at the time of the last display refresh is displayed on the \hyperlink{RC_mhttpd_Main_Status_page_RC_mhttpd_main_status}{main status page} (see \hyperlink{F_Messaging}{Messaging}). More messages can be viewed by pressing the \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_Page_buttons}{Message button}. This opens the \hyperlink{RC_mhttpd_Message_page}{Message page}.

\par


\par


\label{RC_mhttpd_status_page_features_idx_clients_active_mhttpd}
\hypertarget{RC_mhttpd_status_page_features_idx_clients_active_mhttpd}{}
 \hypertarget{RC_mhttpd_status_page_features_RC_mhttpd_status_clients}{}\subparagraph{Active Client list}\label{RC_mhttpd_status_page_features_RC_mhttpd_status_clients}
\begin{center} Example of Active client list on mhttpd main status page \par
\par
\par
  \end{center}  \par


At the bottom of the \hyperlink{RC_mhttpd_Main_Status_page_RC_mhttpd_main_status}{main status page} is a list of the MIDAS clients for this experiment that are currently active. The hostname is also shown. This information is derived from the \hyperlink{RC_Run_States_and_Transitions_RC_odb_system_tree}{ODB /System} tree .

\par
\par


 \par
 \label{index_end}
\hypertarget{index_end}{}
 \paragraph{Defining Script Buttons on the main Status Page}\label{RC_mhttpd_defining_script_buttons}
\par




\label{RC_mhttpd_defining_script_buttons_idx_ODB_tree_Script}
\hypertarget{RC_mhttpd_defining_script_buttons_idx_ODB_tree_Script}{}
 \hypertarget{RC_mhttpd_defining_script_buttons_RC_odb_script_tree}{}\subparagraph{The ODB /Script tree}\label{RC_mhttpd_defining_script_buttons_RC_odb_script_tree}
\begin{DoxyNote}{Note}
The /Script tree is applicable to \hyperlink{RC_mhttpd}{mhttpd}, and ignored by \hyperlink{RC_odbedit}{odbedit}.
\end{DoxyNote}
The optional ODB tree /Script provides the user with a way to execute a script when a button on the mhttpd \hyperlink{RC_mhttpd_Main_Status_page_RC_mhttpd_main_status}{main status page} is clicked, including the {\bfseries capability of passing \hyperlink{structparameters}{parameters} from the ODB to the script}.

\par
 If the user defines a new tree in ODB named /Script , then any key created in this tree will appear as a script-\/button of that name on the default mhttpd main status page. Each sub-\/tree ( /Script/$<$button name$>$/) should contain at least one string key which is the script command to be executed. Further keys will be passed as {\bfseries  arguments } to the script. MIDAS symbolic links are permitted.\hypertarget{RC_mhttpd_defining_script_buttons_RC_odb_script_example1}{}\subparagraph{Example 1: creation of a Script-\/button; parameters passed to the associated script}\label{RC_mhttpd_defining_script_buttons_RC_odb_script_example1}
The {\bfseries  example } below shows the ODB /script/dac subdirectory. The script-\/button {\bfseries \char`\"{}dac\char`\"{}} associated with this subdirectory is shown on the example mhttpd status page below.

The first key in the dac subdirectory is the string key cmd which contains the name and path of the script to be executed (in this case, a perl script). This script is located on the local host computer on which the experiment is running. The subsequent keys are \hyperlink{structparameters}{parameters} input to the script. 
\begin{DoxyCode}
[local:pol:R]/>ls "/script/dac"
cmd                             /home/pol/online/perl/change_mode.pl
include path                    /home/pol/online/perl
experiment name -> /experiment/name
                                pol
select mode                     1h

mode file tag                   none
[local:pol:R]/>  
\end{DoxyCode}


This will cause a script-\/button labelled {\bfseries \char`\"{}DAC\char`\"{}} to appear on the mhttpd main status page : \par
 \begin{center} Script button \char`\"{}DAC\char`\"{} on the mhttpd main status page  \end{center} \par


When the {\bfseries \char`\"{}DAC\char`\"{}} script-\/button is pressed, the script {\bfseries \char`\"{}change\_\-mode.pl\char`\"{}} will be executed with the following key contents as \hyperlink{structparameters}{parameters}, equivalent to the command: 
\begin{DoxyCode}
  "/home/pol/online/perl/change_mode.pl  /home/pol/online/perl pol 1h mode"
\end{DoxyCode}
 \par


The following is part of the code of the script {\bfseries \char`\"{}change\_\-mode.pl\char`\"{}} : 
\begin{DoxyCode}
# input parameters :

our ($inc_dir, $expt, $select_mode, $mode_name ) = @ARGV;
our $len = $#ARGV; # array length
our $name = "change_mode" ; # same as filename
our $outfile = "change_mode.txt"; # path will be added by file open function
our $parameter_msg = "include path , experiment , select_new_mode  mode_name";
our $nparam = 4;  # no. of input parameters
our $beamline = $expt; # beamline is not supplied. Same as $expt for bnm/qr, pol
############################################################################
# local variables:
my ($transition, $run_state, $path, $key, $status);

# Inc_dir needed because when script is invoked by browser it can't find the
# code for require

unless ($inc_dir) { die "$name: No include directory path has been supplied\n";}
$inc_dir =~ s/\/$//;  # remove any trailing slash
require "$inc_dir/odb_access.pl";
require "$inc_dir/do_link.pl";

# init_check.pl checks:
#   one copy of this script running
#   no. of input parameters is correct
#   opens output file:
#
require "$inc_dir/init_check.pl"; 

# Output will be sent to file $outfile (file handle FOUT)
# because this is for use with the browser and STDOUT and STDERR get set to null


print FOUT  "$name starting with parameters:  \n";
print FOUT  "Experiment = $expt, select new mode = $select_mode;  load file mode_
      name=$mode_name \n";

unless ($select_mode)
{
    print FOUT "FAILURE: selected mode  not supplied\n";
        odb_cmd ( "msg","$MERROR","","$name", "FAILURE:  selected mode not suppli
      ed " ) ;
        unless ($status) { print FOUT "$name: Failure return after msg \n"; }
        die  "FAILURE:  selected mode  not supplied \n";

}
unless ($select_mode =~/^[12]/)
{
    print_3 ($name,"FAILURE: invalid selected mode ($select_mode)",$MERROR,1);
}

etc.
\end{DoxyCode}
\hypertarget{RC_mhttpd_defining_script_buttons_RC_odb_script_example2}{}\subparagraph{Example 2: MPET experiment run controller}\label{RC_mhttpd_defining_script_buttons_RC_odb_script_example2}
This example is from the MPET experiment at TRIUMF, which uses a sophisticated run controller. This includes perlscripts actived by script buttons. The experiment can be set to perform a number of consecutive runs without user intervention, changing some condition(s) between each run. The results are written to a log file.

It involves the use of large number of script-\/buttons on the Main Status page to activate the perlscripts (see Figure 1). Clicking on one of these buttons causes a user-\/defined shell-\/script to be run with a particular parameter.

\par
\par
\par
 \begin{center} Figure 1 Main Status page of MPET experiment   \end{center}  \par
\par
\par


This experiment is using an older version of mhttpd (see \hyperlink{RC_mhttpd_status_page_redesign}{Redesign of mhttpd Main Status Page} ).

The script-\/buttons are defined in the ODB /Script tree (see Figure 2). All activate the shell-\/script perlrc.sh with the appropriate parameter. The first two script-\/buttons labelled \char`\"{}Start PerlRC\char`\"{} and \char`\"{}Stop PerlRC\char`\"{} start and stop the run control respectively. These access \hyperlink{structparameters}{parameters} read from the ODB to determine the scan type, the number of runs to be performed, etc. The other buttons \char`\"{}Tune...\char`\"{} are used to set up run \hyperlink{structparameters}{parameters} into particular known states or \char`\"{}Tunes\char`\"{}.

\par
 \par
\par
\par
 \begin{center} Figure 2 /Script ODB tree for the MPET experiment   \end{center}  \par
\par
\par


This script calls the perlscript perlrc.pl, passing through the parameter. (Alternatively, this could have been done by \hyperlink{RC_mhttpd_defining_script_buttons_RC_odb_script_tree}{passing the parameter} directly to the perlscript, eliminating the intermediate shell-\/script).

The following image shows the ODB \hyperlink{structparameters}{parameters} associated with the run control script buttons.

\par
\par
\par
 \begin{center} Run Control ODB \hyperlink{structparameters}{parameters} for the MPET experiment   \end{center}  \par
\par
\par
 
\begin{DoxyItemize}
\item Clicking on ODB...PerlRC...RunControl...Scan2D shows the RunControl Parameters 
\item Clicking on ODB...PerlRC...RunControl...TuneSwitch shows the Tuning Parameters 
\end{DoxyItemize}

\par
 

 \par
\hypertarget{RC_mhttpd_defining_script_buttons_RC_odb_script_ex2_perlscript}{}\subparagraph{MPET perlscripts to perform run control}\label{RC_mhttpd_defining_script_buttons_RC_odb_script_ex2_perlscript}

\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_perlrc}{Examples of MPET Perlscripts for run control}
\end{DoxyItemize}

The scripts interact with the ODB through a library \hyperlink{RC_mhttpd_perlrc_RC_mhttpd_perlmidas_script}{perlmidas.pl} . This may be of general interest.



\par
 \label{index_end}
\hypertarget{index_end}{}
 \subparagraph{Examples of MPET Perlscripts for run control}\label{RC_mhttpd_perlrc}
\par


 \label{RC_mhttpd_perlrc_idx_script_perlmidas}
\hypertarget{RC_mhttpd_perlrc_idx_script_perlmidas}{}


Part of the run control perlscripts for MPET experiment at TRIUMF (written by Vladimir Rykov) are reproduced below. The script \hyperlink{RC_mhttpd_perlrc_RC_mhttpd_perlrc_script}{perlrc.pl} calls a script called \hyperlink{RC_mhttpd_perlrc_RC_mhttpd_perlmidas_script}{perlmidas.pl} to access the ODB.

\hyperlink{RC_mhttpd_perlrc_RC_mhttpd_perlmidas_script}{perlmidas.pl} may be of interest to users who wish to interact with the ODB through scripts.\hypertarget{RC_mhttpd_perlrc_RC_mhttpd_perlmidas_script}{}\subparagraph{perlmidas.pl}\label{RC_mhttpd_perlrc_RC_mhttpd_perlmidas_script}

\begin{DoxyCode}
# common subroutines
use strict;
use warnings;
##############################################################
sub MIDAS_env
# set up proper MIDAS environment...
##############################################################
{
    our ($MIDAS_HOSTNAME,$MIDAS_EXPERIMENT,$ODB_SUCCESS,$DEBUG);
    our ($CMDFLAG_HOST, $CMDFLAG_EXPT);

    $ODB_SUCCESS=0;

    $MIDAS_HOSTNAME = $ENV{"MIDAS_SERVER_HOST"};
    if (defined($MIDAS_HOSTNAME) &&   $MIDAS_HOSTNAME ne "")
    {
        $CMDFLAG_HOST = "-h $MIDAS_HOSTNAME";
    }
    else
    {
        $MIDAS_HOSTNAME = "";
        $CMDFLAG_HOST = "";
    }

    $MIDAS_EXPERIMENT = $ENV{"MIDAS_EXPT_NAME"};
    if (defined($MIDAS_EXPERIMENT) &&   $MIDAS_EXPERIMENT ne "")
    {
        $CMDFLAG_EXPT = "-e ${MIDAS_EXPERIMENT}";
    }
    else
    {
        $MIDAS_EXPERIMENT = "";
        $CMDFLAG_EXPT = "";
    }

}


##############################################################
sub MIDAS_sendmsg
##############################################################
{
# send a message to odb message logger
    my ($name, $message) =  @_;

    our ($MIDAS_HOSTNAME,$MIDAS_EXPERIMENT,$ODB_SUCCESS,$DEBUG);
    our ($CMDFLAG_HOST, $CMDFLAG_EXPT);
    our ($COMMAND, $ANSWER);

    my $status;
    my $host="";
    my $dquote='"';
    my $squote="'";
    my $command="${dquote}msg ${name} ${squote}${message}${squote}${dquote}";
    print "name=$name, message=$message\n";
    print "command is: $command \n";

    $COMMAND ="`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c ${command}`";
    $ANSWER=`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c ${command}`;
    $status=$?;
    chomp $ANSWER;  # strip trailing linefeed
    if($DEBUG)
    {
        print "command: $COMMAND\n";
        print " answer: $ANSWER\n";
    }

    if($status != $ODB_SUCCESS) 
    { # this status value is NOT the midas status code
        print "send_message:  Failure status returned from odb msg (status=$statu
      s)\n";
    }
    return;
}

sub strip
{
# removes / from end of string, // becomes /
    my $string=shift;
    $string=~ (s!//!/!g);
    $string=~s!/$!!;
    print "strip: now \"$string\"\n";
    return ($string);
}

sub MIDAS_varset
##############################################################
{
# set a value of an odb key
    my ($key, $value) =  @_;

    our ($MIDAS_HOSTNAME,$MIDAS_EXPERIMENT,$ODB_SUCCESS,$DEBUG);
    our ($CMDFLAG_HOST, $CMDFLAG_EXPT);
    our ($COMMAND, $ANSWER);

    my $status;
    my $host="";
    my $dquote='"';
    my $squote="'";
    my $command="${dquote}set ${squote}${key}${squote} ${squote}${value}${squote}
      ${dquote}";
    print "key=$key, new value=${value}\n";
    print "command is: $command \n";

    $COMMAND ="`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c command`";
    $ANSWER=`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c $command `;
    $status=$?;
    chomp $ANSWER;  # strip trailing linefeed
    if($DEBUG)
    {
        print "command: $COMMAND\n";
        print " answer: $ANSWER\n";
    }

    if($status != $ODB_SUCCESS) 
    { # this status value is NOT the midas status code
        print "send_message:  Failure status returned from odb msg (status=$statu
      s)\n";
    }
    return;
}

sub MIDAS_varget
##############################################################
{
# set a value of an odb key
    my ($key) =  @_;

    our ($MIDAS_HOSTNAME,$MIDAS_EXPERIMENT,$ODB_SUCCESS,$DEBUG);
    our ($CMDFLAG_HOST, $CMDFLAG_EXPT);
    our ($COMMAND, $ANSWER);

    my $status;
    my $host="";
    my $dquote='"';
    my $squote="'";
    my $command="${dquote}ls -v ${squote}${key}${squote}${dquote}";
    print "key=$key\n";
    print "command is: $command \n";
    
    $COMMAND ="`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c command`";
    $ANSWER=`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c $command `;  
    $status=$?;
    chomp $ANSWER;  # strip trailing linefeed
    if($DEBUG)
    {
        print "command: $COMMAND\n";
        print " answer: $ANSWER\n";
    }

    if($status != 0) 
    { # this status value is NOT the midas status code
        print "send_varset  Failure status returned from odb msg (status=$status)
      \n";
    }
    return $ANSWER;
}

sub MIDAS_dirlist
##############################################################
{
# return a directory list of directory given by odb key
    my ($key) =  @_;

    our ($MIDAS_HOSTNAME,$MIDAS_EXPERIMENT,$ODB_SUCCESS,$DEBUG);
    our ($CMDFLAG_HOST, $CMDFLAG_EXPT);
    our ($COMMAND, $ANSWER);

    my $status;
    my $host="";
    my $dquote='"';
    my $squote="'";
    my $command="${dquote}ls ${squote}${key}${squote}${dquote}";
    print "key=$key\n";
    print "command is: $command \n";
    
    $COMMAND ="`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c command`";
    $ANSWER=`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c $command `;  
    $status=$?;
    chomp $ANSWER;  # strip trailing linefeed
    if($DEBUG)
    {
        print "command: $COMMAND\n";
        print " answer: $ANSWER\n";
    }

    if($status != 0) 
    { # this status value is NOT the midas status code
        print "send_varset  Failure status returned from odb msg (status=$status)
      \n";
    }
    return $ANSWER;
}

sub MIDAS_startrun
##############################################################
{
# start MIDAS run
    my ($key) =  @_;

    our ($MIDAS_HOSTNAME,$MIDAS_EXPERIMENT,$ODB_SUCCESS,$DEBUG);
    our ($CMDFLAG_HOST, $CMDFLAG_EXPT);
    our ($COMMAND, $ANSWER);

    our ($SCANLOG_FH);

    my $status;
    my $host="";
    my $dquote='"';
    my $squote="'";
    my $command="${dquote}start now${dquote}";
    print "command is: $command \n";

    #sleep(10);

    $COMMAND ="`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c ${command}`";
    $ANSWER=`odb ${CMDFLAG_EXPT} ${CMDFLAG_HOST} -c ${command}`;
    $status=$?;
    chomp $ANSWER;  # strip trailing linefeed
    if($DEBUG)
    {
        print "command: $COMMAND\n";
        print " answer: $ANSWER\n";

        #print $SCANLOG_FH "status: $status\n";
        #print $SCANLOG_FH "command: $COMMAND\n";
        #print $SCANLOG_FH " answer: $ANSWER\n";

    }

    if($status != 0)
    { # this status value is NOT the midas status code
        print "startrun:  Failure status returned from odb msg (status=$status)\n
      ";
        print $SCANLOG_FH " answer: $ANSWER\n";

    }
    return $ANSWER;
}   
1;
\end{DoxyCode}


\par


\par
\hypertarget{RC_mhttpd_perlrc_RC_mhttpd_perlrc_script}{}\subparagraph{perlrc.pl}\label{RC_mhttpd_perlrc_RC_mhttpd_perlrc_script}

\begin{DoxyCode}
 #!/usr/bin/perl

################################################################
#
#  PerlRC
#
#  MIDAS piggyback perl script that is exectuted upon completion
#  of a run. It checks its parameters, modifies the MIDAS variables
#  as required, and starts a new run. This way it can run through
#  different DAQ settings. Implemented scans:
#  1) Scan1D - scans a set of variables from beginning values
#     to ending values. All valiables are changed simultaneously.
#  2) Scan2D - scans 2 sets of variables.
#  3) SettingsSwitch - switches between different settings sets
#     typically to be used to switch between ion species.
#
#  V. Ryjkov
#  June 2008
#
################################################################

require "/home/mpet/vr/perl/PerlRC/perlmidas.pl";

our $DEBUG = true;
our $PERLSCAN_PREF = "/PerlRC";
our $PERLSCAN_CONTROLVARS = $PERLSCAN_PREF . "/ControlVariables";
our $PERLSCAN_START = $PERLSCAN_PREF . "/RunControl/RCActive";
our $PERLSCAN_NRUNS = $PERLSCAN_PREF . "/RunControl/RCTotalRuns";
our $PERLSCAN_CURRUN = $PERLSCAN_PREF . "/RunControl/RCCurrentRun";
our $SCANLOG_PATH = "/data/mpet/PerlRC.log";
our $SCANLOG_FH;
our $MIDAS_RUNNO = "/Runinfo/Run number";
my  $PERLSCAN_SCANTYPE = $PERLSCAN_PREF . "/RunControl/RCType";

MIDAS_env();
# MIDAS_sendmsg("test","run stop");
my $ScanStart  =MIDAS_varget($PERLSCAN_START);
my $ScanType   =MIDAS_varget($PERLSCAN_SCANTYPE);
my $NRuns      =MIDAS_varget($PERLSCAN_NRUNS);
my $CurrentRun =MIDAS_varget($PERLSCAN_CURRUN);
my $retval;
my $MIDASrunno;

open(SCANLOG,">>${SCANLOG_PATH}");
$SCANLOG_FH=\*SCANLOG;

if(scalar(@ARGV)==1 && $ARGV[0] =~ /start/) {
    MIDAS_varset($PERLSCAN_START,'y');
    $ScanStart = "y";
}
if(scalar(@ARGV)==1 && $ARGV[0] =~ /stop/) {
    MIDAS_varset($PERLSCAN_START,'n');
    $ScanStart = "n";
}
if( $ScanStart eq "y") {
    if( $CurrentRun == 0) {
        print $SCANLOG_FH "=== NEW PerlRC scan. Scan type is \"${ScanType}\" ===\
      n";
        print $SCANLOG_FH "===    Number of runs in this scan is ${NRuns}    ===\
      n";
    }
    if( $CurrentRun == $NRuns) {
        print $SCANLOG_FH "=== Finished PerlRC scan ===\n";
        print $SCANLOG_FH "============================\n";
    }
    if( ++$CurrentRun <= $NRuns ) {
        $MIDASrunno=MIDAS_varget($MIDAS_RUNNO);
        $MIDASrunno++;
        print $SCANLOG_FH "<Run #${MIDASrunno}> ";
        MIDAS_varset($PERLSCAN_CURRUN,$CurrentRun);
        for ($ScanType) {
            if    (/Scan1D/)   {$retval=Scan1D(); }     # do something
            elsif (/Scan2D/)   {$retval=Scan2D(); }     # do something else
            elsif (/TuneSwitch/) {$retval=TuneSwitch(); } # do something else
        }
        if($retval != 0) {
            MIDAS_varset($PERLSCAN_CURRUN,0);
            MIDAS_varset($PERLSCAN_START,"n");
            print $SCANLOG_FH "!!!#### Aborting scan! ####!!!\n";
        }
        else {
            sleep(1);
            #print $SCANLOG_FH "pausing 10 sec...\n";
            MIDAS_startrun();
            #print $SCANLOG_FH "start the run\n";
        }
    }
    else {
        MIDAS_varset($PERLSCAN_CURRUN,0);
        MIDAS_varset($PERLSCAN_START,"n");
    }
}
else {
    if(scalar(@ARGV)==2 && $ARGV[0] =~ /tune/) {
        SwitchToTune($ARGV[1]);
    }
}
close(SCANLOG);

sub Scan1D
{

    ............


}    


sub SetControlVar
{
    our $SCANLOG_FH;
    our $PERLSCAN_CONTROLVARS;
    my ($varname,$varvalue)=@_;
    my $retval;
    my $varpath;

    #print $SCANLOG_FH "variablename: $varname \n";

    $varpath=MIDAS_varget($PERLSCAN_CONTROLVARS . "/" . $varname);
    if($varpath =~ /^key (.*) not found/) {
        print $SCANLOG_FH "! Control variable ${varname}(${1}) is not listed in $
      {PERLSCAN_CONTROLVARS}\n";
        return -4;
    }

    .............
    
    
    val=MIDAS_varset($varpath,$varvalue);
        if($retval =~ /^key not found/) {return -5;}
    }
    return 0;
}

sub SwitchToTune
{
    our $SCANLOG_FH;
    our $PERLSCAN_CONTROLVARS;
    our $PERLSCAN_PREF;
    my $PERLSCAN_TUNEDIR = $PERLSCAN_PREF . "/Tunes";
    my ($tunename)=@_;
    my $retval;
    my $varpath;
    my $varval;
    my $cvarname;

    $retval = MIDAS_dirlist($PERLSCAN_TUNEDIR . "/" . $tunename);
    if($retval =~ /^key not found/){
        print $SCANLOG_FH "! Could not locate tune ${tunename} in the tune direct
      ory ${PERLSCAN_TUNEDIR}\n";
        return -7;
    }
    my @TuneVars=split(/\n/,$retval);
    foreach (@TuneVars) {
        if (/^(.+\S)\s{2,}.*/) {
            $cvarname = $1;
            $varval = MIDAS_varget($PERLSCAN_TUNEDIR . "/" . $tunename . "/" .$cv
      arname);
            $retval = SetControlVar($cvarname, $varval);
            if($retval < 0) {return $retval;}
        }
        else {
            print $SCANLOG_FH "! Cannot decipher tune variable list, offending li
      ne: $_\n";
            return -8;
        }
        sleep(1);
    }
    return 0;
}

sub Scan2D
{
   .................
}


sub TuneSwitch
{   
    our  ($PERLSCAN_PREF, $PERLSCAN_START);
    our $SCANLOG_FH;
    my $PERLSCAN_TUNESWITCHDIR = "/RunControl/TuneSwitch";
    my $PERLSCAN_TUNESLIST = $PERLSCAN_PREF . $PERLSCAN_TUNESWITCHDIR .  "/TunesL
      ist";
    my $PERLSCAN_TUNEIDX = $PERLSCAN_PREF . $PERLSCAN_TUNESWITCHDIR .  "/CurrentT
      uneIndex";
    my $PERLSCAN_TUNENAME = $PERLSCAN_PREF . $PERLSCAN_TUNESWITCHDIR .  "/Current
      TuneName";

    my $TunesList = MIDAS_varget($PERLSCAN_TUNESLIST);
    my $TuneIdx = MIDAS_varget($PERLSCAN_TUNEIDX);
    my $TuneName = MIDAS_varget($PERLSCAN_TUNENAME);
    
    my @tunes = split(/\s*;\s*/,$TunesList);
    print "tunes length= ",scalar(@tunes),"\n";
    if( ++$TuneIdx > scalar(@tunes) ) {
            $TuneIdx=1;
    }
    MIDAS_varset($PERLSCAN_TUNEIDX,$TuneIdx);

    $retval=SwitchToTune($tunes[$TuneIdx-1]);
    if($retval < 0) {return $retval;}
    MIDAS_varset($PERLSCAN_TUNENAME,$tunes[$TuneIdx-1]);
    print $SCANLOG_FH "Tune is \"",$tunes[$TuneIdx-1],"\"\n";
    return 0;
}
\end{DoxyCode}


 \par
 \label{index_end}
\hypertarget{index_end}{}
 \subsubsection{Redesign of mhttpd Main Status Page}\label{RC_mhttpd_status_page_redesign}


\label{RC_mhttpd_status_page_redesign_idx_mhttpd_page_status}
\hypertarget{RC_mhttpd_status_page_redesign_idx_mhttpd_page_status}{}


\par
 \label{RC_mhttpd_status_page_redesign_alias_buttons_status_page}
\hypertarget{RC_mhttpd_status_page_redesign_alias_buttons_status_page}{}
  The appearance of the Main Status Page has been changed (in versions after to \hyperlink{NDF_ndf_dec_2009}{Dec 2009}) . 
\begin{DoxyItemize}
\item the {\bfseries \char`\"{}Analyzed\char`\"{}} column has been dropped 
\item the {\bfseries \char`\"{}FE Node\char`\"{}} column is now labelled {\bfseries \char`\"{}Status\char`\"{}} and may show equipment status information 
\item the user-\/defined \hyperlink{RC_mhttpd_Alias_page_RC_mhttpd_alias_buttons}{alias}, \hyperlink{RC_mhttpd_status_page_features_RC_mhttpd_status_script_buttons}{script} and \char`\"{}custom\char`\"{} hyperlinks now appear as {\bfseries buttons} 
\item there are now four different background colors (\hyperlink{NDF_ndf_jan_2010}{Jan 2010}) for the four rows of buttons, i.e. : 
\begin{DoxyItemize}
\item Main menu buttons, 
\item Script buttons, 
\item Manually triggered events, 
\item Alias \& Custom page buttons. 
\end{DoxyItemize}

This change has been made because the original alias hyperlinks were hard to read if they included spaces. It also gives a more homogeneous look to the page. A status page of the new format is shown here. 
\end{DoxyItemize}

\par
 \begin{center} New format Status page showing four rows of buttons \par
\par
\par
  \end{center}  \par
\par
\par


\label{RC_mhttpd_status_page_redesign_RC_mhttpd_old_alias_buttons}
\hypertarget{RC_mhttpd_status_page_redesign_RC_mhttpd_old_alias_buttons}{}
  Prior to \hyperlink{NDF_ndf_dec_2009}{Dec 2009}  the Custom Page and Alias hyperlinks appeared as {\bfseries links} rather than buttons, as shown below: \par
\par
\par
 \begin{center} Older version of mhttpd main Status page showing Custom Page and Alias {\bfseries Links}  \end{center}  \par
\par
\par




\label{index_end}
\hypertarget{index_end}{}
 \par
 \subsubsection{Custom Page showing ROOT analyzer output}\label{RC_ROOT_analyzer_page}
\label{RC_ROOT_analyzer_page_idx_mhttpd_page_custom_examples_ROOT}
\hypertarget{RC_ROOT_analyzer_page_idx_mhttpd_page_custom_examples_ROOT}{}
 \par
 

Many MIDAS experiments work with ROOT based analyzers today. One problem there is that the graphical output of the root analyzer can only be seen through the X server and not through the web. At the MEG experiment, this problem was solved in an elegant way: The ROOT analyzer runs in the background, using a \char`\"{}virtual\char`\"{} X server called Xvfb. It plots its output (several panels) normally using this X server, then saves this panels every ten seconds into GIF files. These GIF files are then served through mhttpd using a custom page. The output looks like this:

\par
 \begin{center} Custom page showing ROOT Analyzer (MEG Experiment)  \end{center}  \par
 The buttons on the left sides are actually HTML buttons on that custom page overlaid to the GIF image, which in this case shows one of the 800 PMT channels digitized at 1.6 GSPS. With these buttons one can cycle through the different GIF images, which then automatically update ever ten seconds. Of course it is not possible to feed interaction back to the analyzer (i.e. the waveform cannot be fitted interactively) but for monitoring an experiment in production mode this tool is extremely helpful, since it is seamlessly integrated into mhttpd. All the magic is done with JavaScript, and the buttons are overlaid on the graphics using CSS with absolute positioning. The analysis ratio on the top right is also done with JavaScript accessing the required information from the ODB. \par


The custom page file is shown here:


\begin{DoxyItemize}
\item \hyperlink{RC_MEG_ROOT_code}{HTML code for the MEG ROOT Analyzer page}
\end{DoxyItemize}

For details using Xvfb server, please contact Ryu Sawada $<$\href{mailto:sawada@icepp.s.u-tokyo.ac.jp}{\tt sawada@icepp.s.u-\/tokyo.ac.jp}$>$.

\par
 \par
 \label{index_end}
\hypertarget{index_end}{}
  \paragraph{HTML code for the MEG ROOT Analyzer page}\label{RC_MEG_ROOT_code}


The following code is used for the \hyperlink{RC_ROOT_analyzer_page}{Custom Page showing ROOT analyzer output} : 
\begin{DoxyCode}
<html><head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"><!-- $Id:
       analyzer.html 14662 2009-12-05 01:51:33Z ritt $ -->

  
    <title>Crates Status Page</title>
    <style type="text/css">
      <!--
      a:link     {
      text-decoration:none;
      color:#0000A0;
      }
      a:visited  {
      color:#0000A0;
      text-decoration:none;
      }
      body       {
      font-family:verdana,tahome,sans-serif;
      font-size:16px;
      line-height:16px;
      margin: 2px;
      }

      #i { position:relative; }
      #t { position:absolute; left:0px; top:140px; }
      #b { width:130px; }
      -->
    </style>
  <script type="text/javascript" src="MEG_analyzer_files/mhttpd.html"></script>
  <script type="text/javascript">
  
  var image_name = [  
    "eventdisplay2d.gif",
    "trgrate.gif",
    "trgsync.gif",
    "trgdaqrate.gif",
    "trgmonitor.gif",
    "drscount.gif",
    "-",
    "xec2d.gif",
    "xecwaveform.gif",
    "-",
    "dch2d.gif",
    "dch_hitmap.gif",
    "-",
    "tic2d.gif",
    "ticphit.gif",
  ];

  var image_title = [ 
    "Event Display 2D",
    "Trigger Scalers",
    "Trigger Sync",
    "Trigger Rates",
    "Trigger Monitor",
    "DRS Count",
    "-",
    "XEC 2D",
    "XEC Waveforms",
    "-",
    "DCH 2D",
    "DCH Hitmap",
    "-",
    "TIC 2D",
    "TIC Hits",
  ];

  var refreshID = null;

  function disp(i)
  {
    /* update image */
    var image = document.getElementById('img');
    var d = new Date();
    var s = d.toString();
    var t = document.getElementById('title_line');

    image.src = 'monitor/'+image_name[i]+'?'+d.getTime();
    if (navigator.appName == "Netscape")
      t.innerHTML = '<B>'+image_title[i]+'</B>'+'&nbsp;&nbsp;'+s.slice(16, 25)+' 
      CET';
    else
      t.innerHTML = '<B>'+image_title[i]+'</B>'+'&nbsp;&nbsp;'+s.slice(10, 19)+' 
      CET'; // mainly IE

    var n1 = ODBGet('/BGAnalyzer/Trigger/Statistics/Events received');
    var n2 = ODBGet('/Equipment/Trigger/Statistics/Events sent');
    document.getElementById('ratio').innerHTML = 'Analysis ratio: '+n1+'/'+n2;

    if (refreshID != null)
      clearInterval(refreshID);
    refreshID = setTimeout("disp("+i+")", 10000);
  }
  
  </script>
  </head><body onload="disp(0);">
    <form name="form1" method="GET" action="Crates">
      <table border="3" cellpadding="2">
        <tbody><tr>
          <td id="title_line" colspan="2" align="center" bgcolor="#a0a0ff"><b>Eve
      nt Display 2D</b>&nbsp;&nbsp;13:19:21  CET</td>
        </tr>
        <tr>
          <td bgcolor="#c0c0c0">
            <input name="cmd" value="ODB" type="submit">
            <input name="cmd" value="Alarms" type="submit">
            <input name="cmd" value="Status" type="submit">
          </td>
          <td id="ratio" nowrap="nowrap" width="200" align="center" bgcolor="#c0c
      0c0">
            Analysis ratio: 0/0
          </td>
        </tr>  
        <tr>
          <td colspan="2">
            <div id="i">
              <img id="img" src="MEG_analyzer_files/eventdisplay2d.html" alt="Ana
      lyzer Screendump" border="0">
              <table id="t">
                <tbody><tr>
                  <td nowrap="nowrap" valign="top" bgcolor="#c0c0c0">
                    <hr>
<script type="text/javascript">

  for (var i=0 ; i<image_name.length ; i++)
    if (image_name[i] == "-")
       document.writeln("<hr>");
    else
       document.writeln("<button type=\"button\" id=\"b\" onclick=\"disp("+i+");\
      ">"+image_title[i]+"</button><br>");

</script><button type="button" id="b" onclick="disp(0);">Event Display 2D</button
      ><br>
<button type="button" id="b" onclick="disp(1);">Trigger Scalers</button><br>
<button type="button" id="b" onclick="disp(2);">Trigger Sync</button><br>
<button type="button" id="b" onclick="disp(3);">Trigger Rates</button><br>
<button type="button" id="b" onclick="disp(4);">Trigger Monitor</button><br>
<button type="button" id="b" onclick="disp(5);">DRS Count</button><br>
<hr>
<button type="button" id="b" onclick="disp(7);">XEC 2D</button><br>
<button type="button" id="b" onclick="disp(8);">XEC Waveforms</button><br>
<hr>
<button type="button" id="b" onclick="disp(10);">DCH 2D</button><br>
<button type="button" id="b" onclick="disp(11);">DCH Hitmap</button><br>
<hr>
<button type="button" id="b" onclick="disp(13);">TIC 2D</button><br>
<button type="button" id="b" onclick="disp(14);">TIC Hits</button><br>

                  </td>
                </tr>
              </tbody></table>
            </div></td>
          
        </tr>
      </tbody></table>
    </form>
  </body></html>
\end{DoxyCode}


\label{index_end}
\hypertarget{index_end}{}
  \paragraph{Javascript Built-\/In library}\label{RC_mhttpd_js}
 \par


The following code is the Javascript Built-\/in library {\bfseries mhttpd.js} (version 4505)


\begin{DoxyCode}
document.onmousemove = getMouseXY;

function getMouseXY(e)
{
   var x = e.pageX;
   var y = e.pageY;
   var p = 'abs: ' + x + '/' + y;
   i = document.getElementById('refimg');
   if (i == null)
      return false;
   document.body.style.cursor = 'crosshair';
   x -= i.offsetLeft;
   y -= i.offsetTop;
   while (i = i.offsetParent) {
      x -= i.offsetLeft;
      y -= i.offsetTop;
   }
   p += '   rel: ' + x + '/' + y;
   window.status = p;
   return true;
}

function XMLHttpRequestGeneric()
{
   var request;
   try {
      request = new XMLHttpRequest(); // Firefox, Opera 8.0+, Safari
   }
   catch (e) {
      try {
         request = new ActiveXObject('Msxml2.XMLHTTP'); // Internet Explorer
      }
      catch (e) {
         try {
            request = new ActiveXObject('Microsoft.XMLHTTP');
         }
         catch (e) {
           alert('Your browser does not support AJAX!');
           return undefined;
         }
      }
   }
  return request;
}

function ODBSet(path, value, pwdname)
{
   var value, request, url;

   if (pwdname != undefined)
      pwd = prompt('Please enter password', '');
   else
      pwd = '';

   request = XMLHttpRequestGeneric();

   url = '?cmd=jset&odb=' + path + '&value=' + value;

   if (pwdname != undefined)
      url += '&pnam=' + pwdname;

   request.open('GET', url, false);

   if (pwdname != undefined)
     request.setRequestHeader('Cookie', 'cpwd='+pwd);

   request.send(null);

   if (request.status != 200 || request.responseText != 'OK')
      alert('ODBSet error:\nPath: '+path+'\nHTTP Status: '+request.status+'\nMe
ssage: '+request.responseText+'\n'+document.location) ;
}

function ODBGet(path, format, defval, len, type)
{
   request = XMLHttpRequestGeneric();

   var url = '?cmd=jget&odb=' + path;
   if (format != undefined && format != '')
      url += '&format=' + format;
   request.open('GET', url, false);
   request.send(null);

   if (path.match(/[*]/)) {
      if (request.responseText == null)
         return null;
     if (request.responseText == '<DB_NO_KEY>') {
         url = '?cmd=jset&odb=' + path + '&value=' + defval + '&len=' + len + '
&type=' + type;

         request.open('GET', url, false);
         request.send(null);
         return defval;
      } else {
         var array = request.responseText.split('\n');
         return array;
      }
   } else {
      if ((request.responseText == '<DB_NO_KEY>' ||
           request.responseText == '<DB_OUT_OF_RANGE>') && defval != undefined)
 {
         url = '?cmd=jset&odb=' + path + '&value=' + defval + '&len=' + len + '
&type=' + type;

         request.open('GET', url, false);
         request.send(null);
         return defval;
      }
      return request.responseText;
   }
}

function ODBKey(path)
{
   request = XMLHttpRequestGeneric();

   var url = '?cmd=jkey&odb=' + path;
   request.open('GET', url, false);
   request.send(null);
   if (request.responseText == null)
      return null;
   var key = request.responseText.split('\n');
   this.name = key[0];
   this.type = key[1];
   this.num_values = key[2];
   this.item_size = key[3];
}

function ODBRpc_rev0(name, rpc, args)
{
   request = XMLHttpRequestGeneric();

   var url = '?cmd=jrpc_rev0&name=' + name + '&rpc=' + rpc;
   for (var i = 2; i < arguments.length; i++) {
     url += '&arg'+(i-2)+'='+arguments[i];
   };
   request.open('GET', url, false);
   request.send(null);
   if (request.responseText == null)
      return null;
   this.reply = request.responseText.split('\n');
}

function ODBGetMsg(n)
{
   request = XMLHttpRequestGeneric();

   var url = '?cmd=jmsg&n=' + n;
   request.open('GET', url, false);
   request.send(null);

   if (n > 1) {
     var array = request.responseText.split('\n');
      return array;
   } else
      return request.responseText;
}

function ODBEdit(path)
{
   var value = ODBGet(path);
   var new_value = prompt('Please enter new value', value);
   if (new_value != undefined) {
      ODBSet(path, new_value);
      window.location.reload();
   }
}

/* MIDAS type definitions */
var TID_BYTE = 1;
var TID_SBYTE = 2;
var TID_CHAR = 3;
var TID_WORD = 4;
var TID_SHORT = 5;
var TID_DWORD = 6;
var TID_INT = 7;
var TID_BOOL = 8;
var TID_FLOAT = 9;
var TID_DOUBLE = 10;
var TID_BITFIELD = 11;
var TID_STRING = 12;
var TID_ARRAY = 13;
var TID_STRUCT = 14;
var TID_KEY = 15;
var TID_LINK = 16;
\end{DoxyCode}
 \label{index_end}
\hypertarget{index_end}{}
  \par
 \paragraph{Access to the ODB from a Custom page}\label{RC_mhttpd_custom_ODB_access}
\par




\par


Access to the ODB is available \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{using HTML tags} and using \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}{JavaScript functions} with the \hyperlink{RC_mhttpd_custom_js_lib}{JavaScript built-\/in library mhttpd.js} . Both methods are described in the following sections:


\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{ODB access using HTML tags}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}{ODB Access using mhttpd JavaScript built-\/in functions}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples}{Examples of accessing ODB from a Custom page}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features}{Features using ODB access from a Custom page}
\end{DoxyItemize}

\label{RC_mhttpd_custom_ODB_access_idx_odb-HTML-tag}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_odb-HTML-tag}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{}\subparagraph{ODB access using HTML tags}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}
The $<$odb...$>$ tag has been defined for read/write access to the ODB under HTML. Also shown in the table below is the equivalent JavaScript function.

that the $<$odb...$>$ tags and JavaScript equivalent must be declared within enclosing HTML $<$form...$>$....$<$/form$>$  tags (see \hyperlink{RC_mhttpd_custom_features_RC_mhttpd_custom_key_access}{above}).

\begin{table}[h]\begin{TabularC}{3}
\hline
HTML ODB tag  &Meaning  &Equivalent JS function  

\\\cline{1-3}
 $<$odb src=\char`\"{}odb path\char`\"{}$>$   &Display ODB field (read only)  & ODBGet  

\\\cline{1-3}
\label{RC_mhttpd_custom_ODB_access_odb_edit_tag}
\hypertarget{RC_mhttpd_custom_ODB_access_odb_edit_tag}{}
  $<$odb src=\char`\"{}odb path\char`\"{} edit=1 pwd=\char`\"{}CustomPwd\char`\"{}$>$   &Display an Editable ODB field (inline style). Optional \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{password protection} with {\bfseries pwd} .  &\par
 

\\\cline{1-3}
 $<$odb src=\char`\"{}odb path\char`\"{} edit=2 pwd=\char`\"{}CustomPwd\char`\"{} $>$   &Display an Editable ODB field (popup style). Optional \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{password protection} with {\bfseries pwd} .  & ODBEdit   \\\cline{1-3}
\end{TabularC}
\centering
\caption{Above: Access to ODB from HTML }
\end{table}


{\bfseries Usage:} 
\begin{DoxyCode}
Experiment Name: <odb src="/Experiment/Name">
Run Number: <odb src="/runinfo/run number" edit=1>
\end{DoxyCode}


\label{RC_mhttpd_custom_ODB_access_odb_tag_ex1}
\hypertarget{RC_mhttpd_custom_ODB_access_odb_tag_ex1}{}
 {\bfseries Examples} 
\begin{DoxyEnumerate}
\item The following image shows the status of the ODB key /logger/write data:\par
 \begin{center} ODB access using $<$odb..$>$ tag \par
  \end{center} 

The HTML code fragment producing the image above is shown below:


\begin{DoxyCode}
<table style="text-align: center; width: 40%;" border="1" cellpadding="2"
cellspacing="2">
<tr><td style="vertical-align: top; background-color: lightyellow; text-align: ce
      nter;">
Logging data</td>
<td><odb src="/logger/write data">
</td></tr</table>
\end{DoxyCode}



\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent} 
\end{DoxyEnumerate}\par


\par
\hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}{}\subparagraph{ODB Access using mhttpd JavaScript built-\/in functions}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}
The following \hyperlink{RC_mhttpd_custom_js_lib}{mhttpd JS built-\/in functions} are defined for ODB access:
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbget}{ODBGet}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbedit}{ODBEdit}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{ODBSet}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbkey}{ODBKey}
\end{DoxyItemize}

{\bfseries Examples:} 
\begin{DoxyEnumerate}
\item As in the HTML example \hyperlink{RC_mhttpd_custom_ODB_access_odb_tag_ex1}{above}, the status of the ODB key /logger/write data is displayed in the following image, but in this case the background colour is changed (using Javascript) depending on the value of the key:

\begin{center} ODB access using ODBGet showing colour change depending on state of ODB variable  \par
  \end{center}  \par
 The code fragment for the above images is shown below: 
\begin{DoxyCode}
<script>
var wd= ODBGet('/logger/write data')
alert ('wd = '+wd);
</script>
<table style="text-align: center; width: 40%;" border="1" cellpadding="2"
cellspacing="2">
<tr>
<td style="vertical-align: top; background-color:  lightyellow; text-align: cente
      r;">Logging data</td>
<script>
if (wd == "y")
   document.write('<td style="vertical-align: top; background-color: lime; text-a
      lign: center;">'+wd);
else
   document.write('<td style="vertical-align: top; background-color: red; text-al
      ign: center;">'+wd);
</script>
</td></tr></table>
\end{DoxyCode}



\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent} 
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}{Example of ODB access with JavaScript functions ODBSet and ODBKey} 
\end{DoxyEnumerate}

\begin{DoxyNote}{Note}
The built-\/in library must be \hyperlink{RC_mhttpd_custom_js_lib_RC_mhttpd_include_js_library}{included} in your custom page when using any of the JS built-\/in functions.
\end{DoxyNote}
\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBGet-JavaScript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBGet-JavaScript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbget}{}\subparagraph{ODBGet JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbget}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBGet(path, format, defval, len, type)   &Retrieves individual or array values from the ODB.  &

\begin{TabularC}{2}
\hline
path &ODB path  

\\\cline{1-2}
format &optional format to write out value read from ODB. Do not include spaces.  

\\\cline{1-2}
defval &Value to write if creating the key.  

\\\cline{1-2}
len &Key length to use if creating the key.  

\\\cline{1-2}
type &Type to use if creating the key. One of the MIDAS Type definitions (see \hyperlink{F_Midas_Code_and_Libraries_F_Midas_Data_Types}{MIDAS Data Types}).   \\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


{\bfseries Usage:} ODBGet works in a similar way to \hyperlink{group__odbfunctionc_gaf0b052657ba1d4f4a8b6d47dbc70008c}{db\_\-set\_\-value()} . If the path does not exist, it will be created and set to the supplied value (providing the last 3 \hyperlink{structparameters}{parameters} are supplied). \par
 For example, use ODBGet($<${\itshape path\/}$>$) to obtain a value. If $<${\itshape path\/}$>$ points to an array in the ODB, an individual value can be retrieved by using an index, e.g. 
\begin{DoxyCode}
  ODBGet('/Equipment/Environment/Variables/Input[3]');
\end{DoxyCode}
 or the complete array can be obtained with 
\begin{DoxyCode}
  ODBGet('/Equipment/Environment/Variables/Input[*]');
\end{DoxyCode}
 The function then returns a JavaScript array which can be used like 
\begin{DoxyCode}
  var a = ODBGet('/Equipment/Environment/Variables/Input[*]');

  for (i=0 ; i<a.length ; i++)
    alert(a[i]);
\end{DoxyCode}


If no $<${\itshape format\/}$>$ parameter is supplied, a default format is used. The following shows the use of a format parameter: 
\begin{DoxyCode}
path='/runinfo/run number';
rn = ODBGet(path,"%4.4d\n");
\end{DoxyCode}


{\bfseries Example} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent}
\end{DoxyItemize}

\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBEdit-JavaScript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBEdit-JavaScript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbedit}{}\subparagraph{ODBEdit  JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbedit}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBEdit(path)   &Display an Editable ODB field (popup style)

&

\begin{TabularC}{2}
\hline
path &ODB path  

\\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


{\bfseries Usage:} 
\begin{DoxyCode}
document.writeln('Edit Run Number:')
document.writeln('<a href="#" onclick="ODBEdit(path)" >')
document.writeln(rn)
document.writeln('</a>');
\end{DoxyCode}


{\bfseries Example} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent}
\end{DoxyItemize}

\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBSet-Javascript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBSet-Javascript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{}\subparagraph{ODBSet JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBSet(path, value, pwdname)   &Set one ODB value or an array of values (see \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_array_note}{note})  &\begin{TabularC}{2}
\hline
path &ODB path  

\\\cline{1-2}
value &Set value or array of values  

\\\cline{1-2}
pwdname &Password (needed if web security is set up).   \\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_array_note}
\hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_array_note}{}
 Writing arrays with ODBSet has been available since \hyperlink{NDF_ndf_may_2010}{May 2010} . \par
 {\bfseries Usage:} Individual ODB values can be set in the background with ODBSet({\itshape $<$path$>$,$<$value$>$\/} or ODBSet({\itshape $<$path$>$,$<$value$>$,$<$password\_\-name$>$\/})

If using a password, the $<${\itshape password\_\-name\/}$>$ must be defined as an ODB entry (see \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{Password protection of ODB variables accessed from a custom page})

{\bfseries Example} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example3}{Example of ODB access with arrays}
\end{DoxyItemize}

\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBKey-JavaScript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBKey-JavaScript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbkey}{}\subparagraph{ODBKey   JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbkey}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBKey(path)   &Get the structure of an ODB key. Returns the key name,type,number of values and size.  &\begin{TabularC}{2}
\hline
path &ODB path   \\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


{\bfseries Usage:} 
\begin{DoxyCode}
key = ODBKey('/Experiment/Name');
document.write('key array : '+key+'<br>');
\end{DoxyCode}


{\bfseries Example:} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}{Example of ODB access with JavaScript functions ODBSet and ODBKey}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples}{Examples of accessing ODB from a Custom page}
\end{DoxyItemize}

\par
 \label{index_end}
\hypertarget{index_end}{}




\par
 \subparagraph{Examples of accessing ODB from a Custom page}\label{RC_mhttpd_custom_ODB_access_examples}
\par




\par
 \hypertarget{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{}\subparagraph{Example of ODB access with HTML and JavaScript equivalent}\label{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}
The following simple HTML code shows ODB access using JavaScript (ODBGet, ODBEdit) and using the HTML  $<$odb$>$ tag . The output produced by this code is shown below. 
\begin{DoxyCode}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 TRANSITIONAL//EN">
<html><head>
<title> ODBEdit test</title>
<!-- include the mhttpd JS library -->
\htmlonly <script src="/js/mhttpd.js" type="text/javascript"></script> \endhtmlon
      ly

\htmlonly <script type="text/javascript">
var my_action = '"/CS/try&"'
var rn
var path
var my_expt="midas";

document.write('</head><body>')
document.write('<form method="get" name="form2" action='+my_action+'> ')
document.write('<input name="exp" value="'+my_expt+'" type="hidden">');

document.write('Using Javascript and ODBEdit:<br>')
path='/runinfo/run number'
rn = ODBGet(path,"Run Number with format: %d")
document.writeln('Run Number: '+rn+'<br>')
document.writeln('Edit Run Number:')
document.writeln('<a href="#" onclick="ODBEdit(path)" >')
document.writeln(rn)
document.writeln('</a>');
</script> \endhtmlonly
<br>
Using HTML :
<br>
Using edit=2 ...  Run Number:
<odb src="/runinfo/run number" edit=2>
<br>
Using edit=1 ...  Run Number:
<odb src="/runinfo/run number" edit=1>
<br>
</form>
</html>
\end{DoxyCode}
 \par


This code produces the output shown in Figures 1 and 2 below. In Figure 1, a value has been entered using the hyperlink created by the {\bfseries Javascript} function ODBEdit. A {\bfseries popup} box appears in which the user may enter a new value.

\par
\par
\par
 \begin{center} Figure 1: ODB tags under html and javascript -\/ entering an ODB value using Javascript \par
\par
\par
  \end{center}  \par
\par
\par


Figure 2 shows entering a value using the {\bfseries HTML} tags. The two different styles are shown.
\begin{DoxyItemize}
\item {\bfseries edit=2} type produces a pop-\/up box as in the Javascript version
\item {\bfseries edit=1} type produces an in-\/line input box
\end{DoxyItemize}

\par
\par
\par
 \begin{center} Figure 2: ODB tags under html and javascript -\/ entering an ODB value using HTML \par
\par
\par
  \par
\par
\par
 \end{center} \hypertarget{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}{}\subparagraph{Example of ODB access with JavaScript functions ODBSet and ODBKey}\label{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}
The following HTML code shows an example using the JavaScript functions ODBSet and ODBKey. There is no equivalent to these functions available in HTML. The output from this example is shown in Figure 3.


\begin{DoxyCode}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 TRANSITIONAL//EN">
<html><head>
<title> ODBEdit test</title>
\htmlonly <script src="/js/mhttpd.js" type="text/javascript"></script> \endhtmlon
      ly

\htmlonly <script type="text/javascript">
var my_action = '"/CS/try&"'
var rn,ival,irn
var path="/runinfo/run number";
var my_expt="midas";
var message;

function test(path,value)
{
var pattern=/DB_NO_KEY/;
var ival,key

document.write('Function test starting with path: '+path+' value: '+value+'<br>')
      ;
document.write('ODBGet with a format parameter:  <br>');
ival = ODBGet(path,"read:%4.4d");
document.write(ival+'<br>');

document.write('<br>Now using ODBSet to set a value: <br>');
document.write('Setting '+path+' to '+value+' with ODBSet<br>') ;
ODBSet(path,value);
ival = ODBGet(path)
document.writeln('Value: '+ival+'<br>')

document.write('<br>Now using ODBKey to get a key using path: '+path+' <br>');
key = ODBKey(path);
document.write('<br>Testing response for the pattern: '+pattern+'...');
 if ( pattern.test(key))
      document.write('test is TRUE <br>');
 else
      document.write('test is FALSE<br>');
document.write('key array : '+key+'<br>');
document.write('done<br>');
return;
}


document.write('</head><body>')
document.write('<form method="get" name="form2" action='+my_action+'> ')
document.write('<input name="exp" value="'+my_expt+'" type="hidden">');

irn=ODBGet(path); // remember initial run number
ODBSet(path,70); // initialize the run number to 70

document.write('Example showing use of ODBGet, ODBSet, ODBKey, ODBGetMsg <br>');
document.write('First with a good path...<br>');
document.write('<span style= "color: green;">')
test("/runinfo/run number", 76);
document.write('</span>')
document.write('<br>Then with bad path to show the difference....<br>');
document.write('<span style= "color: red;">')
test("/nopath/nokey", 79);
document.write('</span>')
message= ODBGetMsg(1);
document.write('Last message:'+message+'<br>');

ODBSet(path,irn); // rewrite initial run number
</script> \endhtmlonly
</form>
</html>
\end{DoxyCode}


\par
\par
\par
 \begin{center} Figure 3 Output from above example code showing ODB access with JS built-\/in functions \par
\par
\par
  \par
\par
\par
 \end{center} \hypertarget{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example3}{}\subparagraph{Example of ODB access with arrays}\label{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example3}
Accessing ODB values can slow the page update considerably where there are many values to access. The access time can be cut considerably by having most of the input and output data in arrays.

 Note that writing arrays with ODBSet has been supported since \hyperlink{NDF_ndf_may_2010}{May 2010} . 

In the following example, the raw data is provided in two large arrays. Some of this data is used in logical calculations (done in JavaScript) to determine the state of various devices, and the result is output into an array in the ODB in order to colour various items with the use of \char`\"{}fills\char`\"{} on the image pages. \par
 In this example, the arrays PLCR,PLCA in the odb are read into arrays in JavaScript in the function get\_\-PLC\_\-arrays in the file custom\_\-functions.js. Calculated data stored as an array in the odb are read into an array CAL. 
\begin{DoxyCode}
// custom_fuctions.js
// globals
var equipment_path='/Equipment/TpcGasPlc/';
var gascalc_array = equipment_path + 'GasCalc/Variables/Calculated[*]';
var variables_path = equipment_path + 'Variables/';
var plcr_path = variables_path + 'PLCR'; // indices of these PLC arrays are in na
      mes.js
var plca_path = variables_path + 'PLCA';

var PLCR=[];
var PLCA=[];
var CAL=[];

function get_PLC_arrays()
{  // get the arrays in one go
   // returns 0=success or 1=failure
 
  var pattern1=/DB_NO_KEY/;
  var pattern2=/undefined/;

  var i,idx;
    
  PLCR =     ODBGet(plcr_path+ '[*]');
  if ( pattern1.test(PLCR) ||  pattern2.test(PLCR)  )
  {
      alert ('get_PLCR_array: ERROR '+PLCR+' from ODBGet('+plcr_path+'[*])' );
      return 1;
  } 
  
   PLCA = ODBGet(plca_path+ '[*]', "%9.5f"); // the required values are float
   if ( pattern1.test(PLCA) ||  pattern2.test(PLCA)  )
   {
      alert ('get_PLCA_array: ERROR '+PLCA+' from ODBGet('+plca_path+'[*])' );
      return 1;
   }
              
// get Calculated array
   CAL = ODBGet(gascalc_array, "%d"); // the required values are INT
   if ( pattern1.test(CAL) ||  pattern2.test(CAL)  )
   {
      alert ('get_CAL_array: ERROR '+CAL+' from ODBGet('+gascalc_array+')' );
      return 1;
   }

   return 0; // success
}

..........
\end{DoxyCode}


For each of the gas pages, various items are calculated and the CAL array is updated for each item. At the end of all calculations, the CAL array is written back into the ODB.


\begin{DoxyCode}
<!-- GasPage.html -->
.......

<!-- js_functions!   custom_functions.js defined by  ODB key  /custom/js_function
      s!  -->
\htmlonly <script type="text/javascript"  src="js_functions!">
</script> \endhtmlonly
</head><body>


\htmlonly <script>
//Read all the arrays from the ODB
var plc_error = get_PLC_arrays();
.....
calculate_device(G2VA1_STAT,G2VA1,plc_error); // saves result to CAL array
......
calculate_logical(17,PU_Box,plc_error); // saves result to CAL array
......
ODBSet(gascalc_array, CAL); // write CAL array into ODB after all calculations
</script> \endhtmlonly
</body>
</html>
\end{DoxyCode}




\par
 \label{index_end}
\hypertarget{index_end}{}
 \subparagraph{Features using ODB access from a Custom page}\label{RC_mhttpd_custom_ODB_access_features}
\par




\par
 This page describes several features with ODB access on a custom page.


\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_checkboxes}{Including checkboxes on a custom page}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_update_part}{Periodic update of parts of a custom page}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{Password protection of ODB variables accessed from a custom page}
\end{DoxyItemize}\hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_checkboxes}{}\subparagraph{Including checkboxes on a custom page}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_checkboxes}
The function ODBSet can be used when one clicks on an {\bfseries checkbox} for example: 
\begin{DoxyCode}
  <input type="checkbox" onClick="ODBSet('/Logger/Write data',this.checked?'1':'0
      ')">
\end{DoxyCode}


If used as above, the state of the checkbox must be initialized when the page is loaded. This can be done with some JavaScript code called on initialization, which then uses \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{ODBSet JavaScript function} as described above.

Alternatively, the checkbox can be created using an  $<$odb...$>$  \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{tag} as follows: 
\begin{DoxyCode}
  <odb src="/Logger/Write data" type="checkbox" edit="2" onclick="ODBSet('/Logger
      /Write data',this.checked?'1':'0')">
\end{DoxyCode}


The special code {\bfseries edit=\char`\"{}2\char`\"{}} instructs mhttpd not to put any JavaScript code into the checkbox tag, since setting this value in the ODB is now handled by the user-\/supplied ODBSet() code.\hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_example_3}{}\subparagraph{Example of Checkboxes using JavaScript and HTML}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_example_3}

\begin{DoxyCode}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 TRANSITIONAL//EN">
<html><head>
<title> ODBEdit test</title>
<!-- include the mhttpd JS library -->
\htmlonly <script src="/js/mhttpd.js" type="text/javascript"></script> \endhtmlon
      ly

\htmlonly <script type="text/javascript">

var my_action = '"/CS/try&"'
var ival;
var my_expt="midas";
</script> \endhtmlonly
</head><body>
<form method="get" name="form2" action='+my_action+'>
<input name="exp" value="'+my_expt+'" type="hidden">
Write data: <odb src="/Logger/Write data"><br>
JS Checkbox ... Write Data:
<input  name="mybox"  type="checkbox"   onClick="ODBSet('/Logger/Write data',this
      .checked?'1':'0')">
\htmlonly <script>
if( ODBGet('/Logger/Write data') =='y')
  ival=1;
else
  ival=0;
document.write('<br>ival='+ival+'<br>');
document.form2.mybox.checked=ival  // initialize to the correct value
</script> \endhtmlonly

<br>HTML checkbox... Write Data:
  <odb src="/Logger/Write data" type="checkbox" edit="2" onclick="ODBSet('/Logger
      /Write data',this.checked?'1':'0')">
<br>
</form>
</html>
\end{DoxyCode}


\par
\par
\par
 \begin{center} Figure 4 Output from above code: checkboxes \par
\par
\par
  \par
\par
\par
 \end{center} 

\par


\par


\label{RC_mhttpd_custom_ODB_access_features_idx_mhttpd_page_custom_refresh_partial}
\hypertarget{RC_mhttpd_custom_ODB_access_features_idx_mhttpd_page_custom_refresh_partial}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_update_part}{}\subparagraph{Periodic update of parts of a custom page}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_update_part}
The functionality of ODBGet together with the
\begin{DoxyItemize}
\item {\bfseries window.setInterval()} function
\end{DoxyItemize}

can be used to update parts of the web page periodically. \par
 For example the Javascript fragment below contains a function which updates the current run number every 10 seconds in the background : 
\begin{DoxyCode}
  window.setInterval("Refresh()", 10000);

  function Refresh() {
    document.getElementById("run_number").innerHTML = ODBGet('/Runinfo/Run number
      ');
  }
\end{DoxyCode}


The custom page has to contain an element with id=\char`\"{}run\_\-number\char`\"{}, such as 
\begin{DoxyCode}
  <td id="run_number"></td>
\end{DoxyCode}
 \par
\par
\hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{}\subparagraph{Password protection of ODB variables accessed from a custom page}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}
Being able to control an experiment through a web interface of course raises the question of safety. This is not so much about external access (for which there are other protection schemes like host lists etc.) but it's about accidental access by the normal shift crew. If a single click on a web page opens a critical valve, this might be a problem. In order to restrict access to some \char`\"{}experts\char`\"{}, an additional password can be chosen for all or some controls on a custom page.

Password protection is optional, and must be set up by the user. The {\itshape password\/} must be defined as an ODB entry of the form  /Custom/Pwd/$<$password$>$ . If the password is {\itshape CustomPwd\/}, the ODB key /Custom/Pwd/CustomPwd  would be defined.

By using an explicit name, one can use a single password for all controls on a page, or one could use several passwords on the same page. For example, a shift crew password for the less severe controls ({\itshape ShiftPwd\/}), and an \char`\"{}expert\char`\"{} password ({\itshape ExpertPwd\/}) for the critical things.

The ODB would have two passwords defined, i.e.\par
  /Custom/Pwd/ExpertPwd\par
 /Custom/Pwd/ShiftPwd\par


The password is of course not secure in the sense that it's placed in plain text into the ODB, but its purpose is to prevent accidental modification, rather than malicious interference.

\par
 Password protection is available for
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_pw}{Password protection of Edit Boxes}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{ODBSet JavaScript function}
\item \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_imagemap_pw}{Area map with password check}
\end{DoxyItemize}

If password protection {\bfseries is} set up, mhttpd will check the supplied password against the ODB entry, and show an error if they don't match.

\label{index_end}
\hypertarget{index_end}{}


 \subparagraph{Demo of custom image page}\label{RC_mhttpd_custom_demo}
\par




\par


This demo will show you how to make a custom page containing an image, and superimpose edit boxes, clickable areas, labels, fills etc.

The HTML document \hyperlink{myexpt_8html}{myexpt.html} can be found in the examples/custom directory. This code forms part of a custom demo. For the full operation of this demo, you'll need to have the frontend {\bfseries \char`\"{}sample frontend\char`\"{}} (midas/example/experiment/frontend.c), mlogger, mhttpd running.

The code \hyperlink{myexpt_8html}{myexpt.html} is shown below for convenience: 
\begin{DoxyCode}
<html>
  <head>
   <title>MyExperiment Demo Status</title>
   <meta http-equiv="Refresh" content="30">
  </head>
 <body>
  <form name="form1" method="Get" action="/CS/MyExpt&">
     <table border=3 cellpadding=2>
          <tr><th bgcolor="#A0A0FF">Demo Experiment<th bgcolor="#A0A0FF">Custom M
      onitor/Control</tr> 
          <tr><td> <b><font color="#ff 0">Actions: </font></b><input
                      value="Status" name="cmd" type="submit"> <input type="submi
      t"
                      name="cmd" value="Start"><input type="submit" name="cmd" va
      lue="Stop">
           </td><td>
           <center> <a href="http://midas.triumf.ca/doc/html/index.html"> Help </
      a></center>
           </td></tr>
           <td>Current run #: <b><odb src="/Runinfo/run number"></b></td>
           <td>#events: <b><odb src="/Equipment/Trigger/Statistics/Events sent"><
      /b></td>
           </tr><tr>
           <td>Event Rate [/sec]: <b><odb src="/Equipment/Trigger/Statistics/Even
      ts per sec."></b></td>
           <td>Data Rate [kB/s]: <b><odb src="/Equipment/Trigger/Statistics/kByte
      s per sec."></b></td>
            </tr><tr>
            <td>Cell Pressure: <b><odb src="/Equipment/NewEpics/Variables/CellPre
      ssure"></b></td>
           <td>FaradayCup   : <b><odb src="/Equipment/NewEpics/Variables/ChargeFa
      radayCup"></b></td>
           </tr><tr>
           <td>Q1 Setpoint: <b><odb src="/Equipment/NewEpics/Variables/EpicsVars[
      17]" edit=1></b></td>
          <td>Q2 Setpoint: <b><odb src="/Equipment/NewEpics/Variables/EpicsVars[1
      9]" edit=1></b></td>
          </tr><tr>
          <th> <img src="http://localhost:8080/HS/Default/Trigger%20rate.gif?
                          exp=default&amp;scale=12h&amp;width=250">
          </th>
          <th> <img src="http://localhost:8080/HS/Default/Scaler%20rate.gif?
                          exp=default&amp;scale=10m&amp;width=250"></th>
          </tr>
          <tr><td colspan=2>
          <map name="myexpt.map">
          <area shape=rect coords="140,70, 420,170" 
                  href="http://midas.triumf.ca/doc/html/index.html" title="Midas 
      Doc">
          <area shape=rect coords="200,200,400,400"
                  href="http://localhost:8080" title="Switch pump">
       <area shape=rect coords="230,515,325,600"
              href="http://localhost:8080" title="Logger in color level (using Fi
      ll)">
        <img src="myexpt.gif" border=1 usemap="#myexpt.map">
          </map>
          </td></tr>
     </table></form>
   </body>
  </html>  
\end{DoxyCode}


To \hyperlink{RC_mhttpd_Activate}{activate} this HTML document, it has to be defined in the ODB as follow: 
\begin{DoxyCode}
[local:Default:Stopped]/>cd /Custom
[local:Default:Stopped]/Custom>create string Myexpt&
String length [32]: 256
[local:Default:Stopped]/Custom>set Myexpt& /midas/examples/custom/myexpt.html
\end{DoxyCode}
 After refresh, the alias-\/link {\bfseries Myexpt} should be visible on the Main Status Page. If you have not already inserted the image file name {\bfseries myexpt.gif} into the Custom page, do so now by following the instructions to \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_image}{insert the image}.

Once the image is inserted, after refresh the image should be visible by clicking on the alias-\/link {\bfseries Myexpt}, and the mapping active.

\label{RC_mhttpd_custom_demo_mapping_demo}
\hypertarget{RC_mhttpd_custom_demo_mapping_demo}{}
 The mapping based on myexpt.map is active, hovering the mouse over the boxes will display the associated titles (Midas Doc, Switch pump, etc), By clicking on either box the browser will go to the defined html page specified by the map.

\par
\par
\par
 \begin{center}  Figure 1 : Demo Custom web page with external reference to html document. \par
\par
\par
  \end{center}  \par
\par
\par


In addition to these initial features, multiple ODB values can be superimposed at define location on the image. Each entry will have a ODB tree associated to it defining the ODB variable, X/Y position, color, etc...

Make the {\bfseries Rate} label as explained \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_labels}{above}. After refreshing the web page, you will see the error message below:


\begin{DoxyCode}
>>>>>>>> Refresh web page <<<<<<<<

12:32:38 [mhttpd] [mhttpd.c:5508:show_custom_gif] Empty Src key for label "Rate"
\end{DoxyCode}


The keys created in the Labels/Rate subtree are explained \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_labels_tree}{here}. Customize this label by assigning the {\bfseries Src} key to a valid ODB Key variable, and the X,Y fields to position top-\/left corner of the label, e.g. 
\begin{DoxyCode}
[local:Default:Stopped]Rate>set src "/Equipment/Trigger/statistics/kbytes per sec
      ."
[local:Default:Stopped]Rate>set x 330
[local:Default:Stopped]Rate>set y 250 
[local:Default:Stopped]Rate>set format "Rate:%1.1f kB/s"
\end{DoxyCode}


Once the initial label is created, the simplest way to extent to multiple labels is to copy the existing label sub-\/tree and modify the label \hyperlink{structparameters}{parameters}. 
\begin{DoxyCode}
[local:Default:Stopped]Labels>cd .. 
[local:Default:Stopped]Labels>copy Rate Event
[local:Default:Stopped]Labels>cd Events/
[local:Default:Stopped]Event>set src "/Equipment/Trigger/statistics/events per se
      c."
[local:Default:Stopped]Event>set Format "Rate:%1.1f evt/s"
[local:Default:Stopped]Event>set y 170
[local:Default:Stopped]Event>set x 250
\end{DoxyCode}
 You will now have two {\bfseries Labels}, named \char`\"{}Rate\char`\"{} and \char`\"{}Event\char`\"{}, both subtrees under ../Labels.

In the same manner, you can create \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_bars}{bars} used for level representation. The keys in the Bars subdirectory are explained \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_bars_tree}{above}.

This code will setup two ODB values defined by the fields src. 
\begin{DoxyCode}
[local:Default:Stopped]myexpt.gif>pwd
/Custom/Images/myexpt.gif
[local:Default:Stopped]myexpt.gif>mkdir Bars
[local:Default:Stopped]myexpt.gif>cd bars/
[local:Default:Stopped]Labels>mkdir Rate

>>>>>>>> Refresh web page <<<<<<<<

14:05:58 [mhttpd] [mhttpd.c:5508:show_custom_gif] Empty Src key for bars "Rate"
[local:Default:Stopped]Labels>cd Rate/
[local:Default:Stopped]Rate>set src "/Equipment/Trigger/statistics/kbytes per sec
      ."
[local:Default:Stopped]Rate>set x 4640
[local:Default:Stopped]Rate>set y 210 
[local:Default:Stopped]Rate>set max 1e6 
[local:Default:Stopped]Labels>cd .. 
[local:Default:Stopped]Labels>copy Rate Events
[local:Default:Stopped]Labels>cd Events/
[local:Default:Stopped]Event>set src "/logger/channles/0/statistics/events writte
      n"
[local:Default:Stopped]Event>set direction 1
[local:Default:Stopped]Event>set y 240
[local:Default:Stopped]Event>set x 450
[local:Default:Stopped]Rate>set max 1e6 
\end{DoxyCode}


You will now have two {\bfseries Bars}, also named \char`\"{}Rate\char`\"{} and \char`\"{}Event\char`\"{}, both subtrees under ../Bars.

The last feature to be added is a \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_fills}{Fill} (where an area can be filled with different colors depending on the given ODB value). These have to be entered by hand. See instructions in \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_fills}{fills}, which shows you how to create a {\bfseries Filled} area named \char`\"{}Level\char`\"{} (a subtree under ../Fills).

Once all these features have been added, the custom page will look as Figure 2: \label{RC_mhttpd_custom_demo_example_image_all}
\hypertarget{RC_mhttpd_custom_demo_example_image_all}{}


\par
\par
\par
 \begin{center}  Figure 2 : Demo Custom web page with labels,bars,fills and history plots \par
\par
\par
  \end{center}  \par
\par
\par




\label{index_end}
\hypertarget{index_end}{}
 \subparagraph{Internal custom page}\label{RC_mhttpd_Internal}
\par




An {\bfseries internal} custom page (written in HTML and/or JavaScript) may be imported under a given /Custom/ ODB key. The name of this key will appear in the Main Status page as an \hyperlink{RC_mhttpd_Alias_page}{alias-\/links} (or alias-\/button -\/ \hyperlink{NDF_ndf_dec_2009}{Dec 2009}). By clicking on this link/button, the contents of this key is interpreted as html content.

The insertion of a new Custom page requires the following steps:
\begin{DoxyItemize}
\item Create an initial html file using your favorite HTML editor (see \hyperlink{RC_mhttpd_custom_features_RC_mhttpd_custom_create}{How to create a custom page})
\item \hyperlink{RC_mhttpd_Activate_RC_odb_custom_internal_example}{Import} this file
\end{DoxyItemize}

\begin{DoxyNote}{Note}

\begin{DoxyItemize}
\item Once the file is imported into ODB, you can {\bfseries ONLY} edit it through the web (as long as mhttpd is active) by clicking on the {\bfseries ODB(button)} ... Custom(Key) ... Edit (Hyperlink at the bottom of the key).
\end{DoxyItemize}
\end{DoxyNote}

\begin{DoxyItemize}
\item The Custom page can also be exported back to a ASCII file using the odbedit command \hyperlink{RC_odbedit_examples_RC_odbedit_export}{export}, e.g. 
\begin{DoxyCode}
  [local:midas:Stopped]/>cd Custom/
  [local:midas:Stopped]/Custom>export test&
  File name: mcustom.html
  [local:midas:Stopped]/Custom>
\end{DoxyCode}

\end{DoxyItemize}

Figure 1 shows an {\bfseries internal} custom page which has been imported into the ODB at key /Custom/Overview\& as shown in Figure 2.

\par
\par
\par
 \begin{center}  Figure 1 : Internal custom web page with history graph. \par
\par
\par
  \end{center}  \par
\par
\par


\par
\par
\par
 \begin{center}  Figure 2 : Internal custom web page loaded into the ODB. \par
\par
\par
  \end{center}  \par
\par
\par


\par


\par
 \par




\label{index_end}
\hypertarget{index_end}{}
 