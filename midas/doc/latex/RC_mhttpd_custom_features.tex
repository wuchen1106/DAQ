\paragraph{Access to the ODB from a Custom page}\label{RC_mhttpd_custom_ODB_access}
\par




\par


Access to the ODB is available \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{using HTML tags} and using \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}{JavaScript functions} with the \hyperlink{RC_mhttpd_custom_js_lib}{JavaScript built-\/in library mhttpd.js} . Both methods are described in the following sections:


\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{ODB access using HTML tags}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}{ODB Access using mhttpd JavaScript built-\/in functions}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples}{Examples of accessing ODB from a Custom page}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features}{Features using ODB access from a Custom page}
\end{DoxyItemize}

\label{RC_mhttpd_custom_ODB_access_idx_odb-HTML-tag}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_odb-HTML-tag}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{}\subsubsection{ODB access using HTML tags}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}
The $<$odb...$>$ tag has been defined for read/write access to the ODB under HTML. Also shown in the table below is the equivalent JavaScript function.

that the $<$odb...$>$ tags and JavaScript equivalent must be declared within enclosing HTML $<$form...$>$....$<$/form$>$  tags (see \hyperlink{RC_mhttpd_custom_features_RC_mhttpd_custom_key_access}{above}).

\begin{table}[h]\begin{TabularC}{3}
\hline
HTML ODB tag  &Meaning  &Equivalent JS function  

\\\cline{1-3}
 $<$odb src=\char`\"{}odb path\char`\"{}$>$   &Display ODB field (read only)  & ODBGet  

\\\cline{1-3}
\label{RC_mhttpd_custom_ODB_access_odb_edit_tag}
\hypertarget{RC_mhttpd_custom_ODB_access_odb_edit_tag}{}
  $<$odb src=\char`\"{}odb path\char`\"{} edit=1 pwd=\char`\"{}CustomPwd\char`\"{}$>$   &Display an Editable ODB field (inline style). Optional \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{password protection} with {\bfseries pwd} .  &\par
 

\\\cline{1-3}
 $<$odb src=\char`\"{}odb path\char`\"{} edit=2 pwd=\char`\"{}CustomPwd\char`\"{} $>$   &Display an Editable ODB field (popup style). Optional \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{password protection} with {\bfseries pwd} .  & ODBEdit   \\\cline{1-3}
\end{TabularC}
\centering
\caption{Above: Access to ODB from HTML }
\end{table}


{\bfseries Usage:} 
\begin{DoxyCode}
Experiment Name: <odb src="/Experiment/Name">
Run Number: <odb src="/runinfo/run number" edit=1>
\end{DoxyCode}


\label{RC_mhttpd_custom_ODB_access_odb_tag_ex1}
\hypertarget{RC_mhttpd_custom_ODB_access_odb_tag_ex1}{}
 {\bfseries Examples} 
\begin{DoxyEnumerate}
\item The following image shows the status of the ODB key /logger/write data:\par
 \begin{center} ODB access using $<$odb..$>$ tag \par
  \end{center} 

The HTML code fragment producing the image above is shown below:


\begin{DoxyCode}
<table style="text-align: center; width: 40%;" border="1" cellpadding="2"
cellspacing="2">
<tr><td style="vertical-align: top; background-color: lightyellow; text-align: ce
      nter;">
Logging data</td>
<td><odb src="/logger/write data">
</td></tr</table>
\end{DoxyCode}



\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent} 
\end{DoxyEnumerate}\par


\par
\hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}{}\subsubsection{ODB Access using mhttpd JavaScript built-\/in functions}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_js}
The following \hyperlink{RC_mhttpd_custom_js_lib}{mhttpd JS built-\/in functions} are defined for ODB access:
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbget}{ODBGet}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbedit}{ODBEdit}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{ODBSet}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbkey}{ODBKey}
\end{DoxyItemize}

{\bfseries Examples:} 
\begin{DoxyEnumerate}
\item As in the HTML example \hyperlink{RC_mhttpd_custom_ODB_access_odb_tag_ex1}{above}, the status of the ODB key /logger/write data is displayed in the following image, but in this case the background colour is changed (using Javascript) depending on the value of the key:

\begin{center} ODB access using ODBGet showing colour change depending on state of ODB variable  \par
  \end{center}  \par
 The code fragment for the above images is shown below: 
\begin{DoxyCode}
<script>
var wd= ODBGet('/logger/write data')
alert ('wd = '+wd);
</script>
<table style="text-align: center; width: 40%;" border="1" cellpadding="2"
cellspacing="2">
<tr>
<td style="vertical-align: top; background-color:  lightyellow; text-align: cente
      r;">Logging data</td>
<script>
if (wd == "y")
   document.write('<td style="vertical-align: top; background-color: lime; text-a
      lign: center;">'+wd);
else
   document.write('<td style="vertical-align: top; background-color: red; text-al
      ign: center;">'+wd);
</script>
</td></tr></table>
\end{DoxyCode}



\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent} 
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}{Example of ODB access with JavaScript functions ODBSet and ODBKey} 
\end{DoxyEnumerate}

\begin{DoxyNote}{Note}
The built-\/in library must be \hyperlink{RC_mhttpd_custom_js_lib_RC_mhttpd_include_js_library}{included} in your custom page when using any of the JS built-\/in functions.
\end{DoxyNote}
\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBGet-JavaScript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBGet-JavaScript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbget}{}\paragraph{ODBGet JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbget}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBGet(path, format, defval, len, type)   &Retrieves individual or array values from the ODB.  &

\begin{TabularC}{2}
\hline
path &ODB path  

\\\cline{1-2}
format &optional format to write out value read from ODB. Do not include spaces.  

\\\cline{1-2}
defval &Value to write if creating the key.  

\\\cline{1-2}
len &Key length to use if creating the key.  

\\\cline{1-2}
type &Type to use if creating the key. One of the MIDAS Type definitions (see \hyperlink{F_Midas_Code_and_Libraries_F_Midas_Data_Types}{MIDAS Data Types}).   \\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


{\bfseries Usage:} ODBGet works in a similar way to \hyperlink{group__odbfunctionc_gaf0b052657ba1d4f4a8b6d47dbc70008c}{db\_\-set\_\-value()} . If the path does not exist, it will be created and set to the supplied value (providing the last 3 \hyperlink{structparameters}{parameters} are supplied). \par
 For example, use ODBGet($<${\itshape path\/}$>$) to obtain a value. If $<${\itshape path\/}$>$ points to an array in the ODB, an individual value can be retrieved by using an index, e.g. 
\begin{DoxyCode}
  ODBGet('/Equipment/Environment/Variables/Input[3]');
\end{DoxyCode}
 or the complete array can be obtained with 
\begin{DoxyCode}
  ODBGet('/Equipment/Environment/Variables/Input[*]');
\end{DoxyCode}
 The function then returns a JavaScript array which can be used like 
\begin{DoxyCode}
  var a = ODBGet('/Equipment/Environment/Variables/Input[*]');

  for (i=0 ; i<a.length ; i++)
    alert(a[i]);
\end{DoxyCode}


If no $<${\itshape format\/}$>$ parameter is supplied, a default format is used. The following shows the use of a format parameter: 
\begin{DoxyCode}
path='/runinfo/run number';
rn = ODBGet(path,"%4.4d\n");
\end{DoxyCode}


{\bfseries Example} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent}
\end{DoxyItemize}

\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBEdit-JavaScript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBEdit-JavaScript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbedit}{}\paragraph{ODBEdit  JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbedit}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBEdit(path)   &Display an Editable ODB field (popup style)

&

\begin{TabularC}{2}
\hline
path &ODB path  

\\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


{\bfseries Usage:} 
\begin{DoxyCode}
document.writeln('Edit Run Number:')
document.writeln('<a href="#" onclick="ODBEdit(path)" >')
document.writeln(rn)
document.writeln('</a>');
\end{DoxyCode}


{\bfseries Example} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent}
\end{DoxyItemize}

\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBSet-Javascript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBSet-Javascript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{}\paragraph{ODBSet JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBSet(path, value, pwdname)   &Set one ODB value or an array of values (see \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_array_note}{note})  &\begin{TabularC}{2}
\hline
path &ODB path  

\\\cline{1-2}
value &Set value or array of values  

\\\cline{1-2}
pwdname &Password (needed if web security is set up).   \\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_array_note}
\hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_array_note}{}
 Writing arrays with ODBSet has been available since \hyperlink{NDF_ndf_may_2010}{May 2010} . \par
 {\bfseries Usage:} Individual ODB values can be set in the background with ODBSet({\itshape $<$path$>$,$<$value$>$\/} or ODBSet({\itshape $<$path$>$,$<$value$>$,$<$password\_\-name$>$\/})

If using a password, the $<${\itshape password\_\-name\/}$>$ must be defined as an ODB entry (see \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{Password protection of ODB variables accessed from a custom page})

{\bfseries Example} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{Example of ODB access with HTML and JavaScript equivalent}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example3}{Example of ODB access with arrays}
\end{DoxyItemize}

\par


\par


\label{RC_mhttpd_custom_ODB_access_idx_ODBKey-JavaScript-function}
\hypertarget{RC_mhttpd_custom_ODB_access_idx_ODBKey-JavaScript-function}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbkey}{}\paragraph{ODBKey   JavaScript function}\label{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbkey}
\begin{table}[h]\begin{TabularC}{3}
\hline
JavaScript Function  &Purpose  &Parameters  

\\\cline{1-3}
 ODBKey(path)   &Get the structure of an ODB key. Returns the key name,type,number of values and size.  &\begin{TabularC}{2}
\hline
path &ODB path   \\\cline{1-2}
\end{TabularC}
\\\cline{1-2}
\end{TabularC}
\centering
\caption{Above: Access to ODB from JavaScript }
\end{table}


{\bfseries Usage:} 
\begin{DoxyCode}
key = ODBKey('/Experiment/Name');
document.write('key array : '+key+'<br>');
\end{DoxyCode}


{\bfseries Example:} 
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}{Example of ODB access with JavaScript functions ODBSet and ODBKey}
\item \hyperlink{RC_mhttpd_custom_ODB_access_examples}{Examples of accessing ODB from a Custom page}
\end{DoxyItemize}

\par
 \label{index_end}
\hypertarget{index_end}{}




\par
 \subparagraph{Examples of accessing ODB from a Custom page}\label{RC_mhttpd_custom_ODB_access_examples}
\par




\par
 \hypertarget{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}{}\paragraph{Example of ODB access with HTML and JavaScript equivalent}\label{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example1}
The following simple HTML code shows ODB access using JavaScript (ODBGet, ODBEdit) and using the HTML  $<$odb$>$ tag . The output produced by this code is shown below. 
\begin{DoxyCode}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 TRANSITIONAL//EN">
<html><head>
<title> ODBEdit test</title>
<!-- include the mhttpd JS library -->
\htmlonly <script src="/js/mhttpd.js" type="text/javascript"></script> \endhtmlon
      ly

\htmlonly <script type="text/javascript">
var my_action = '"/CS/try&"'
var rn
var path
var my_expt="midas";

document.write('</head><body>')
document.write('<form method="get" name="form2" action='+my_action+'> ')
document.write('<input name="exp" value="'+my_expt+'" type="hidden">');

document.write('Using Javascript and ODBEdit:<br>')
path='/runinfo/run number'
rn = ODBGet(path,"Run Number with format: %d")
document.writeln('Run Number: '+rn+'<br>')
document.writeln('Edit Run Number:')
document.writeln('<a href="#" onclick="ODBEdit(path)" >')
document.writeln(rn)
document.writeln('</a>');
</script> \endhtmlonly
<br>
Using HTML :
<br>
Using edit=2 ...  Run Number:
<odb src="/runinfo/run number" edit=2>
<br>
Using edit=1 ...  Run Number:
<odb src="/runinfo/run number" edit=1>
<br>
</form>
</html>
\end{DoxyCode}
 \par


This code produces the output shown in Figures 1 and 2 below. In Figure 1, a value has been entered using the hyperlink created by the {\bfseries Javascript} function ODBEdit. A {\bfseries popup} box appears in which the user may enter a new value.

\par
\par
\par
 \begin{center} Figure 1: ODB tags under html and javascript -\/ entering an ODB value using Javascript \par
\par
\par
  \end{center}  \par
\par
\par


Figure 2 shows entering a value using the {\bfseries HTML} tags. The two different styles are shown.
\begin{DoxyItemize}
\item {\bfseries edit=2} type produces a pop-\/up box as in the Javascript version
\item {\bfseries edit=1} type produces an in-\/line input box
\end{DoxyItemize}

\par
\par
\par
 \begin{center} Figure 2: ODB tags under html and javascript -\/ entering an ODB value using HTML \par
\par
\par
  \par
\par
\par
 \end{center} \hypertarget{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}{}\paragraph{Example of ODB access with JavaScript functions ODBSet and ODBKey}\label{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example2}
The following HTML code shows an example using the JavaScript functions ODBSet and ODBKey. There is no equivalent to these functions available in HTML. The output from this example is shown in Figure 3.


\begin{DoxyCode}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 TRANSITIONAL//EN">
<html><head>
<title> ODBEdit test</title>
\htmlonly <script src="/js/mhttpd.js" type="text/javascript"></script> \endhtmlon
      ly

\htmlonly <script type="text/javascript">
var my_action = '"/CS/try&"'
var rn,ival,irn
var path="/runinfo/run number";
var my_expt="midas";
var message;

function test(path,value)
{
var pattern=/DB_NO_KEY/;
var ival,key

document.write('Function test starting with path: '+path+' value: '+value+'<br>')
      ;
document.write('ODBGet with a format parameter:  <br>');
ival = ODBGet(path,"read:%4.4d");
document.write(ival+'<br>');

document.write('<br>Now using ODBSet to set a value: <br>');
document.write('Setting '+path+' to '+value+' with ODBSet<br>') ;
ODBSet(path,value);
ival = ODBGet(path)
document.writeln('Value: '+ival+'<br>')

document.write('<br>Now using ODBKey to get a key using path: '+path+' <br>');
key = ODBKey(path);
document.write('<br>Testing response for the pattern: '+pattern+'...');
 if ( pattern.test(key))
      document.write('test is TRUE <br>');
 else
      document.write('test is FALSE<br>');
document.write('key array : '+key+'<br>');
document.write('done<br>');
return;
}


document.write('</head><body>')
document.write('<form method="get" name="form2" action='+my_action+'> ')
document.write('<input name="exp" value="'+my_expt+'" type="hidden">');

irn=ODBGet(path); // remember initial run number
ODBSet(path,70); // initialize the run number to 70

document.write('Example showing use of ODBGet, ODBSet, ODBKey, ODBGetMsg <br>');
document.write('First with a good path...<br>');
document.write('<span style= "color: green;">')
test("/runinfo/run number", 76);
document.write('</span>')
document.write('<br>Then with bad path to show the difference....<br>');
document.write('<span style= "color: red;">')
test("/nopath/nokey", 79);
document.write('</span>')
message= ODBGetMsg(1);
document.write('Last message:'+message+'<br>');

ODBSet(path,irn); // rewrite initial run number
</script> \endhtmlonly
</form>
</html>
\end{DoxyCode}


\par
\par
\par
 \begin{center} Figure 3 Output from above example code showing ODB access with JS built-\/in functions \par
\par
\par
  \par
\par
\par
 \end{center} \hypertarget{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example3}{}\paragraph{Example of ODB access with arrays}\label{RC_mhttpd_custom_ODB_access_examples_RC_mhttpd_js_example3}
Accessing ODB values can slow the page update considerably where there are many values to access. The access time can be cut considerably by having most of the input and output data in arrays.

 Note that writing arrays with ODBSet has been supported since \hyperlink{NDF_ndf_may_2010}{May 2010} . 

In the following example, the raw data is provided in two large arrays. Some of this data is used in logical calculations (done in JavaScript) to determine the state of various devices, and the result is output into an array in the ODB in order to colour various items with the use of \char`\"{}fills\char`\"{} on the image pages. \par
 In this example, the arrays PLCR,PLCA in the odb are read into arrays in JavaScript in the function get\_\-PLC\_\-arrays in the file custom\_\-functions.js. Calculated data stored as an array in the odb are read into an array CAL. 
\begin{DoxyCode}
// custom_fuctions.js
// globals
var equipment_path='/Equipment/TpcGasPlc/';
var gascalc_array = equipment_path + 'GasCalc/Variables/Calculated[*]';
var variables_path = equipment_path + 'Variables/';
var plcr_path = variables_path + 'PLCR'; // indices of these PLC arrays are in na
      mes.js
var plca_path = variables_path + 'PLCA';

var PLCR=[];
var PLCA=[];
var CAL=[];

function get_PLC_arrays()
{  // get the arrays in one go
   // returns 0=success or 1=failure
 
  var pattern1=/DB_NO_KEY/;
  var pattern2=/undefined/;

  var i,idx;
    
  PLCR =     ODBGet(plcr_path+ '[*]');
  if ( pattern1.test(PLCR) ||  pattern2.test(PLCR)  )
  {
      alert ('get_PLCR_array: ERROR '+PLCR+' from ODBGet('+plcr_path+'[*])' );
      return 1;
  } 
  
   PLCA = ODBGet(plca_path+ '[*]', "%9.5f"); // the required values are float
   if ( pattern1.test(PLCA) ||  pattern2.test(PLCA)  )
   {
      alert ('get_PLCA_array: ERROR '+PLCA+' from ODBGet('+plca_path+'[*])' );
      return 1;
   }
              
// get Calculated array
   CAL = ODBGet(gascalc_array, "%d"); // the required values are INT
   if ( pattern1.test(CAL) ||  pattern2.test(CAL)  )
   {
      alert ('get_CAL_array: ERROR '+CAL+' from ODBGet('+gascalc_array+')' );
      return 1;
   }

   return 0; // success
}

..........
\end{DoxyCode}


For each of the gas pages, various items are calculated and the CAL array is updated for each item. At the end of all calculations, the CAL array is written back into the ODB.


\begin{DoxyCode}
<!-- GasPage.html -->
.......

<!-- js_functions!   custom_functions.js defined by  ODB key  /custom/js_function
      s!  -->
\htmlonly <script type="text/javascript"  src="js_functions!">
</script> \endhtmlonly
</head><body>


\htmlonly <script>
//Read all the arrays from the ODB
var plc_error = get_PLC_arrays();
.....
calculate_device(G2VA1_STAT,G2VA1,plc_error); // saves result to CAL array
......
calculate_logical(17,PU_Box,plc_error); // saves result to CAL array
......
ODBSet(gascalc_array, CAL); // write CAL array into ODB after all calculations
</script> \endhtmlonly
</body>
</html>
\end{DoxyCode}




\par
 \label{index_end}
\hypertarget{index_end}{}
 \subparagraph{Features using ODB access from a Custom page}\label{RC_mhttpd_custom_ODB_access_features}
\par




\par
 This page describes several features with ODB access on a custom page.


\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_checkboxes}{Including checkboxes on a custom page}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_update_part}{Periodic update of parts of a custom page}
\item \hyperlink{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{Password protection of ODB variables accessed from a custom page}
\end{DoxyItemize}\hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_checkboxes}{}\paragraph{Including checkboxes on a custom page}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_checkboxes}
The function ODBSet can be used when one clicks on an {\bfseries checkbox} for example: 
\begin{DoxyCode}
  <input type="checkbox" onClick="ODBSet('/Logger/Write data',this.checked?'1':'0
      ')">
\end{DoxyCode}


If used as above, the state of the checkbox must be initialized when the page is loaded. This can be done with some JavaScript code called on initialization, which then uses \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{ODBSet JavaScript function} as described above.

Alternatively, the checkbox can be created using an  $<$odb...$>$  \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odb_html}{tag} as follows: 
\begin{DoxyCode}
  <odb src="/Logger/Write data" type="checkbox" edit="2" onclick="ODBSet('/Logger
      /Write data',this.checked?'1':'0')">
\end{DoxyCode}


The special code {\bfseries edit=\char`\"{}2\char`\"{}} instructs mhttpd not to put any JavaScript code into the checkbox tag, since setting this value in the ODB is now handled by the user-\/supplied ODBSet() code.\hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_example_3}{}\paragraph{Example of Checkboxes using JavaScript and HTML}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_example_3}

\begin{DoxyCode}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 TRANSITIONAL//EN">
<html><head>
<title> ODBEdit test</title>
<!-- include the mhttpd JS library -->
\htmlonly <script src="/js/mhttpd.js" type="text/javascript"></script> \endhtmlon
      ly

\htmlonly <script type="text/javascript">

var my_action = '"/CS/try&"'
var ival;
var my_expt="midas";
</script> \endhtmlonly
</head><body>
<form method="get" name="form2" action='+my_action+'>
<input name="exp" value="'+my_expt+'" type="hidden">
Write data: <odb src="/Logger/Write data"><br>
JS Checkbox ... Write Data:
<input  name="mybox"  type="checkbox"   onClick="ODBSet('/Logger/Write data',this
      .checked?'1':'0')">
\htmlonly <script>
if( ODBGet('/Logger/Write data') =='y')
  ival=1;
else
  ival=0;
document.write('<br>ival='+ival+'<br>');
document.form2.mybox.checked=ival  // initialize to the correct value
</script> \endhtmlonly

<br>HTML checkbox... Write Data:
  <odb src="/Logger/Write data" type="checkbox" edit="2" onclick="ODBSet('/Logger
      /Write data',this.checked?'1':'0')">
<br>
</form>
</html>
\end{DoxyCode}


\par
\par
\par
 \begin{center} Figure 4 Output from above code: checkboxes \par
\par
\par
  \par
\par
\par
 \end{center} 

\par


\par


\label{RC_mhttpd_custom_ODB_access_features_idx_mhttpd_page_custom_refresh_partial}
\hypertarget{RC_mhttpd_custom_ODB_access_features_idx_mhttpd_page_custom_refresh_partial}{}
 \hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_update_part}{}\paragraph{Periodic update of parts of a custom page}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_js_update_part}
The functionality of ODBGet together with the
\begin{DoxyItemize}
\item {\bfseries window.setInterval()} function
\end{DoxyItemize}

can be used to update parts of the web page periodically. \par
 For example the Javascript fragment below contains a function which updates the current run number every 10 seconds in the background : 
\begin{DoxyCode}
  window.setInterval("Refresh()", 10000);

  function Refresh() {
    document.getElementById("run_number").innerHTML = ODBGet('/Runinfo/Run number
      ');
  }
\end{DoxyCode}


The custom page has to contain an element with id=\char`\"{}run\_\-number\char`\"{}, such as 
\begin{DoxyCode}
  <td id="run_number"></td>
\end{DoxyCode}
 \par
\par
\hypertarget{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}{}\paragraph{Password protection of ODB variables accessed from a custom page}\label{RC_mhttpd_custom_ODB_access_features_RC_mhttpd_custom_pw_protection}
Being able to control an experiment through a web interface of course raises the question of safety. This is not so much about external access (for which there are other protection schemes like host lists etc.) but it's about accidental access by the normal shift crew. If a single click on a web page opens a critical valve, this might be a problem. In order to restrict access to some \char`\"{}experts\char`\"{}, an additional password can be chosen for all or some controls on a custom page.

Password protection is optional, and must be set up by the user. The {\itshape password\/} must be defined as an ODB entry of the form  /Custom/Pwd/$<$password$>$ . If the password is {\itshape CustomPwd\/}, the ODB key /Custom/Pwd/CustomPwd  would be defined.

By using an explicit name, one can use a single password for all controls on a page, or one could use several passwords on the same page. For example, a shift crew password for the less severe controls ({\itshape ShiftPwd\/}), and an \char`\"{}expert\char`\"{} password ({\itshape ExpertPwd\/}) for the critical things.

The ODB would have two passwords defined, i.e.\par
  /Custom/Pwd/ExpertPwd\par
 /Custom/Pwd/ShiftPwd\par


The password is of course not secure in the sense that it's placed in plain text into the ODB, but its purpose is to prevent accidental modification, rather than malicious interference.

\par
 Password protection is available for
\begin{DoxyItemize}
\item \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_pw}{Password protection of Edit Boxes}
\item \hyperlink{RC_mhttpd_custom_ODB_access_RC_mhttpd_custom_odbset}{ODBSet JavaScript function}
\item \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_imagemap_pw}{Area map with password check}
\end{DoxyItemize}

If password protection {\bfseries is} set up, mhttpd will check the supplied password against the ODB entry, and show an error if they don't match.

\label{index_end}
\hypertarget{index_end}{}


 \subparagraph{Demo of custom image page}\label{RC_mhttpd_custom_demo}
\par




\par


This demo will show you how to make a custom page containing an image, and superimpose edit boxes, clickable areas, labels, fills etc.

The HTML document \hyperlink{myexpt_8html}{myexpt.html} can be found in the examples/custom directory. This code forms part of a custom demo. For the full operation of this demo, you'll need to have the frontend {\bfseries \char`\"{}sample frontend\char`\"{}} (midas/example/experiment/frontend.c), mlogger, mhttpd running.

The code \hyperlink{myexpt_8html}{myexpt.html} is shown below for convenience: 
\begin{DoxyCode}
<html>
  <head>
   <title>MyExperiment Demo Status</title>
   <meta http-equiv="Refresh" content="30">
  </head>
 <body>
  <form name="form1" method="Get" action="/CS/MyExpt&">
     <table border=3 cellpadding=2>
          <tr><th bgcolor="#A0A0FF">Demo Experiment<th bgcolor="#A0A0FF">Custom M
      onitor/Control</tr> 
          <tr><td> <b><font color="#ff 0">Actions: </font></b><input
                      value="Status" name="cmd" type="submit"> <input type="submi
      t"
                      name="cmd" value="Start"><input type="submit" name="cmd" va
      lue="Stop">
           </td><td>
           <center> <a href="http://midas.triumf.ca/doc/html/index.html"> Help </
      a></center>
           </td></tr>
           <td>Current run #: <b><odb src="/Runinfo/run number"></b></td>
           <td>#events: <b><odb src="/Equipment/Trigger/Statistics/Events sent"><
      /b></td>
           </tr><tr>
           <td>Event Rate [/sec]: <b><odb src="/Equipment/Trigger/Statistics/Even
      ts per sec."></b></td>
           <td>Data Rate [kB/s]: <b><odb src="/Equipment/Trigger/Statistics/kByte
      s per sec."></b></td>
            </tr><tr>
            <td>Cell Pressure: <b><odb src="/Equipment/NewEpics/Variables/CellPre
      ssure"></b></td>
           <td>FaradayCup   : <b><odb src="/Equipment/NewEpics/Variables/ChargeFa
      radayCup"></b></td>
           </tr><tr>
           <td>Q1 Setpoint: <b><odb src="/Equipment/NewEpics/Variables/EpicsVars[
      17]" edit=1></b></td>
          <td>Q2 Setpoint: <b><odb src="/Equipment/NewEpics/Variables/EpicsVars[1
      9]" edit=1></b></td>
          </tr><tr>
          <th> <img src="http://localhost:8080/HS/Default/Trigger%20rate.gif?
                          exp=default&amp;scale=12h&amp;width=250">
          </th>
          <th> <img src="http://localhost:8080/HS/Default/Scaler%20rate.gif?
                          exp=default&amp;scale=10m&amp;width=250"></th>
          </tr>
          <tr><td colspan=2>
          <map name="myexpt.map">
          <area shape=rect coords="140,70, 420,170" 
                  href="http://midas.triumf.ca/doc/html/index.html" title="Midas 
      Doc">
          <area shape=rect coords="200,200,400,400"
                  href="http://localhost:8080" title="Switch pump">
       <area shape=rect coords="230,515,325,600"
              href="http://localhost:8080" title="Logger in color level (using Fi
      ll)">
        <img src="myexpt.gif" border=1 usemap="#myexpt.map">
          </map>
          </td></tr>
     </table></form>
   </body>
  </html>  
\end{DoxyCode}


To \hyperlink{RC_mhttpd_Activate}{activate} this HTML document, it has to be defined in the ODB as follow: 
\begin{DoxyCode}
[local:Default:Stopped]/>cd /Custom
[local:Default:Stopped]/Custom>create string Myexpt&
String length [32]: 256
[local:Default:Stopped]/Custom>set Myexpt& /midas/examples/custom/myexpt.html
\end{DoxyCode}
 After refresh, the alias-\/link {\bfseries Myexpt} should be visible on the Main Status Page. If you have not already inserted the image file name {\bfseries myexpt.gif} into the Custom page, do so now by following the instructions to \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_image}{insert the image}.

Once the image is inserted, after refresh the image should be visible by clicking on the alias-\/link {\bfseries Myexpt}, and the mapping active.

\label{RC_mhttpd_custom_demo_mapping_demo}
\hypertarget{RC_mhttpd_custom_demo_mapping_demo}{}
 The mapping based on myexpt.map is active, hovering the mouse over the boxes will display the associated titles (Midas Doc, Switch pump, etc), By clicking on either box the browser will go to the defined html page specified by the map.

\par
\par
\par
 \begin{center}  Figure 1 : Demo Custom web page with external reference to html document. \par
\par
\par
  \end{center}  \par
\par
\par


In addition to these initial features, multiple ODB values can be superimposed at define location on the image. Each entry will have a ODB tree associated to it defining the ODB variable, X/Y position, color, etc...

Make the {\bfseries Rate} label as explained \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_labels}{above}. After refreshing the web page, you will see the error message below:


\begin{DoxyCode}
>>>>>>>> Refresh web page <<<<<<<<

12:32:38 [mhttpd] [mhttpd.c:5508:show_custom_gif] Empty Src key for label "Rate"
\end{DoxyCode}


The keys created in the Labels/Rate subtree are explained \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_labels_tree}{here}. Customize this label by assigning the {\bfseries Src} key to a valid ODB Key variable, and the X,Y fields to position top-\/left corner of the label, e.g. 
\begin{DoxyCode}
[local:Default:Stopped]Rate>set src "/Equipment/Trigger/statistics/kbytes per sec
      ."
[local:Default:Stopped]Rate>set x 330
[local:Default:Stopped]Rate>set y 250 
[local:Default:Stopped]Rate>set format "Rate:%1.1f kB/s"
\end{DoxyCode}


Once the initial label is created, the simplest way to extent to multiple labels is to copy the existing label sub-\/tree and modify the label \hyperlink{structparameters}{parameters}. 
\begin{DoxyCode}
[local:Default:Stopped]Labels>cd .. 
[local:Default:Stopped]Labels>copy Rate Event
[local:Default:Stopped]Labels>cd Events/
[local:Default:Stopped]Event>set src "/Equipment/Trigger/statistics/events per se
      c."
[local:Default:Stopped]Event>set Format "Rate:%1.1f evt/s"
[local:Default:Stopped]Event>set y 170
[local:Default:Stopped]Event>set x 250
\end{DoxyCode}
 You will now have two {\bfseries Labels}, named \char`\"{}Rate\char`\"{} and \char`\"{}Event\char`\"{}, both subtrees under ../Labels.

In the same manner, you can create \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_bars}{bars} used for level representation. The keys in the Bars subdirectory are explained \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_bars_tree}{above}.

This code will setup two ODB values defined by the fields src. 
\begin{DoxyCode}
[local:Default:Stopped]myexpt.gif>pwd
/Custom/Images/myexpt.gif
[local:Default:Stopped]myexpt.gif>mkdir Bars
[local:Default:Stopped]myexpt.gif>cd bars/
[local:Default:Stopped]Labels>mkdir Rate

>>>>>>>> Refresh web page <<<<<<<<

14:05:58 [mhttpd] [mhttpd.c:5508:show_custom_gif] Empty Src key for bars "Rate"
[local:Default:Stopped]Labels>cd Rate/
[local:Default:Stopped]Rate>set src "/Equipment/Trigger/statistics/kbytes per sec
      ."
[local:Default:Stopped]Rate>set x 4640
[local:Default:Stopped]Rate>set y 210 
[local:Default:Stopped]Rate>set max 1e6 
[local:Default:Stopped]Labels>cd .. 
[local:Default:Stopped]Labels>copy Rate Events
[local:Default:Stopped]Labels>cd Events/
[local:Default:Stopped]Event>set src "/logger/channles/0/statistics/events writte
      n"
[local:Default:Stopped]Event>set direction 1
[local:Default:Stopped]Event>set y 240
[local:Default:Stopped]Event>set x 450
[local:Default:Stopped]Rate>set max 1e6 
\end{DoxyCode}


You will now have two {\bfseries Bars}, also named \char`\"{}Rate\char`\"{} and \char`\"{}Event\char`\"{}, both subtrees under ../Bars.

The last feature to be added is a \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_fills}{Fill} (where an area can be filled with different colors depending on the given ODB value). These have to be entered by hand. See instructions in \hyperlink{RC_mhttpd_Image_access_RC_mhttpd_custom_fills}{fills}, which shows you how to create a {\bfseries Filled} area named \char`\"{}Level\char`\"{} (a subtree under ../Fills).

Once all these features have been added, the custom page will look as Figure 2: \label{RC_mhttpd_custom_demo_example_image_all}
\hypertarget{RC_mhttpd_custom_demo_example_image_all}{}


\par
\par
\par
 \begin{center}  Figure 2 : Demo Custom web page with labels,bars,fills and history plots \par
\par
\par
  \end{center}  \par
\par
\par




\label{index_end}
\hypertarget{index_end}{}
 \subparagraph{Internal custom page}\label{RC_mhttpd_Internal}
\par




An {\bfseries internal} custom page (written in HTML and/or JavaScript) may be imported under a given /Custom/ ODB key. The name of this key will appear in the Main Status page as an \hyperlink{RC_mhttpd_Alias_page}{alias-\/links} (or alias-\/button -\/ \hyperlink{NDF_ndf_dec_2009}{Dec 2009}). By clicking on this link/button, the contents of this key is interpreted as html content.

The insertion of a new Custom page requires the following steps:
\begin{DoxyItemize}
\item Create an initial html file using your favorite HTML editor (see \hyperlink{RC_mhttpd_custom_features_RC_mhttpd_custom_create}{How to create a custom page})
\item \hyperlink{RC_mhttpd_Activate_RC_odb_custom_internal_example}{Import} this file
\end{DoxyItemize}

\begin{DoxyNote}{Note}

\begin{DoxyItemize}
\item Once the file is imported into ODB, you can {\bfseries ONLY} edit it through the web (as long as mhttpd is active) by clicking on the {\bfseries ODB(button)} ... Custom(Key) ... Edit (Hyperlink at the bottom of the key).
\end{DoxyItemize}
\end{DoxyNote}

\begin{DoxyItemize}
\item The Custom page can also be exported back to a ASCII file using the odbedit command \hyperlink{RC_odbedit_examples_RC_odbedit_export}{export}, e.g. 
\begin{DoxyCode}
  [local:midas:Stopped]/>cd Custom/
  [local:midas:Stopped]/Custom>export test&
  File name: mcustom.html
  [local:midas:Stopped]/Custom>
\end{DoxyCode}

\end{DoxyItemize}

Figure 1 shows an {\bfseries internal} custom page which has been imported into the ODB at key /Custom/Overview\& as shown in Figure 2.

\par
\par
\par
 \begin{center}  Figure 1 : Internal custom web page with history graph. \par
\par
\par
  \end{center}  \par
\par
\par


\par
\par
\par
 \begin{center}  Figure 2 : Internal custom web page loaded into the ODB. \par
\par
\par
  \end{center}  \par
\par
\par


\par


\par
 \par




\label{index_end}
\hypertarget{index_end}{}
 