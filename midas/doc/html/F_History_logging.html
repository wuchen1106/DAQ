<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: History Logging</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="Features.html">SECTION 4: Features</a>&nbsp;&raquo&nbsp;<a class="el" href="F_Logging.html">Logging in MIDAS</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="F_History_logging">History Logging </a></h1><p><br/>
 <a class="anchor" id="idx_Logging_History"></a> <a class="anchor" id="idx_History_Logging"></a>  
<script type="text/javascript">
pages( "F_mySQL",  "Features","F_Elog", "F_History_logging","end"); // back index next {top bottom}
// sections params:   last section; top of this section; next section
sections("Quickstart", "Features", "RunControl");
</script>
<p><br/>
 <a class="anchor" id="idx_history_system"></a></p>
<h2><a class="anchor" id="F_History_System">
MIDAS History System</a></h2>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000007">Todo:</a></b></dt><dd>The history section needs to be reviewed</dd></dl>
<p>The history system is an add-on capability built into the <a class="el" href="F_Logging.html#F_mlogger_utility">MIDAS data logger</a> to record useful information in parallel to the data logging. This information is recorded with a time stamp and saved into a history file (in a <a class="el" href="F_History_logging.html#F_History_format">special format</a> of the form of a database) for later retrieval. One set of files is created per day containing all the requested history events. The history data may be displayed in graphical form using the <a class="el" href="RC_mhttpd_utility.html">mhttpd</a> MIDAS webserver utility, giving the user an easy way of seeing how experimental variables have changed with time. <br/>
 The history logging will be in action <b>only</b> if the logger is running, but it is not necessary to have any logging channel enabled.</p>
<p><span class="new"> See also <a class="el" href="F_History_logging.html#F_History_sql_internal">MIDAS SQL History system</a> , where the History is saved into an SQL database instead of a History file. ( <a class="el" href="NDF.html#ndf_jan_2009">Jan 2009</a> ). </span></p>
<h2><a class="anchor" id="F_Logger_History_Files_Location">
Location of History Files</a></h2>
<p><a class="anchor" id="F_Logger_History_Dir"></a></p>
<p><a class="anchor" id="idx_history_files_location"></a> By default, <a class="el" href="F_History_logging.html">history</a> files are written into the directory path given by the ODB key <a class="el" href="F_Logging_Data.html#F_Logger_Data_Dir">Data Dir</a> in the <a class="el" href="F_Logging_Data.html#F_Logger_tree">/Logger ODB tree</a>.</p>
<p>This location can be changed by use of the ODB Key <span class="odb">History dir</span> in the <a class="el" href="F_Logging_Data.html#F_Logger_tree_keys">/Logger</a> directory. This key is optional and doesn't appear by default in the <a class="el" href="F_Logging_Data.html#F_Logger_tree">/Logger ODB tree</a>. If this key IS present the location of the history files is reassigned to the defined path.</p>
<h3><a class="anchor" id="F_Logger_Create_History_Dir">
Creation of ODB Key  "/Logger/History dir"</a></h3>
<p>Using the <a class="el" href="RC_mhttpd_ODB_page.html">mhttpd ODB editor</a> or the <a class="el" href="RC_odbedit_examples.html#RC_odbedit_cr">odbedit command create</a> as shown below, the user may add this key: </p>
<div class="fragment"><pre class="fragment">[local:Default:S]/Logger&gt;create <span class="keywordtype">string</span> <span class="stringliteral">&quot;History dir&quot;</span>
String length [32]:128
[local:Default:S]/Logger&gt;<span class="keyword">set</span> <span class="stringliteral">&quot;History dir&quot;</span> /mypath/history/2009
[local:Default:S]/Logger&gt;move Channels bottom
[local:Default:S]/Logger&gt;ls
  Data dir                        /scr0/spring2009
  Message file                    midas.log 
  Auto restart                     n
  Write data                      y
  ODB Dump                        n
  ODB Dump File                   run%05d.odb
  Tape message                    y 
  Elog dir                        /mypath/elog/2009
  History dir                     /mypath/history/2009
  Channels
</pre></div><p><br/>
 <hr/>
 <br/>
</p>
<h2><a class="anchor" id="F_History_Event_Types">
Types of History Events</a></h2>
<p>There are two basic types of history events, which are defined in different ways:</p>
<ul>
<li>
<p class="startli"><b>"Frontend"</b> History event <br/>
 Composed in the frontend. See <a class="el" href="F_History_logging.html#F_Frontend_History_Event">Frontend History Event</a> for details.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>"Virtual"</b> History event <br/>
Composed within the Online Database (ODB) under the specific tree <span class="odb">/History/Links</span> (see <a class="el" href="F_History_logging.html#F_ODB_History_tree">ODB History tree</a>)</p>
<p class="endli"></p>
</li>
</ul>
<p>Both these history event definitions <b>take effect when the data logger gets a "start run" transition</b>. Any modifications made during the run are not applied until the start of the next run.</p>
<p><br/>
 <hr/>
 <br/>
 <a class="anchor" id="idx_History_events"></a> </p>
<h2><a class="anchor" id="F_Frontend_History_Event">
Frontend History Event</a></h2>
<p>Each <a class="el" href="FrontendOperation.html#FE_sw_equipment">Equipment</a> has the capability to generate <b> "history data" </b>. <br/>
 <span class="note">  To enable the history logging system for an Equipment, the <a class="el" href="FE_table.html#FE_tbl_History">Log History</a> field in the corresponding <a class="el" href="FrontendOperation.html#FE_Equipment_list">Equipment List</a> is set non-zero.</span></p>
<p><span class="note"></span></p>
<p>This value also controls how <b>frequently</b> the history events are generated. A reasonable value to set for the History value is "60", so that the history events are generated once per minute. This value will appear in the ODB <a class="el" href="FE_ODB_equipment_tree.html">/Equipment tree</a> as the key <span class="odb">/Equipment/&lt;equipment-name&gt;/Common/Log history</span> (where &lt;equipment-name&gt; is the name of the Equipment - see also <a class="el" href="FE_ODB_equipment_tree.html#FE_ODB_equipment_common">The ODB /Equipment/&lt;equipment-name&gt;/Common subtree</a> ).</p>
<p><br/>
 Enabling the history system for an Equipment causes the event contents to be copied to the <span class="odb">/Equipment/&lt;equipment-name&gt;/Variables</span> tree of the ODB for the use of the <a class="el" href="F_MainElements.html#F_History_System_overview">History system</a> . The contents of the event will then be completely copied into the history files, using the definition of the event as <b> tag names </b> for every element of the event. <br/>
</p>
<p>The main data path for the frontend History Event is as follows:</p>
<ol type="1">
<li>The user code in the frontend equipment <a class="el" href="FE_eq_event_routines.html#FE_readout_routine">Event Readout routines</a> reads the data, placing it into a <a class="el" href="FE_bank_construction.html#FE_MIDAS_event_construction">MIDAS data bank</a></li>
<li>In <a class="el" href="mfe_8c.html">mfe.c</a>, if <span class="odb">/Equipment/&lt;equipment-name&gt;/Common/Log history</span> &gt; 0 (i.e. the history system is enabled for this equipment), this data bank is written into ODB (by <a class="el" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb()</a>).</li>
</ol>
<p><a class="anchor" id="idx_hotlink_history-event"></a> <a class="anchor" id="F_history_hot_link"></a> The frequency of ODB writes is limited by ODB_UPDATE_TIME (1/sec in <a class="el" href="mfe_8c.html">mfe.c</a> rev 4298).</p>
<ol type="1">
<li>The odb write triggers an odb <a class="el" href="RC_Hot_Link.html">hot-link</a> into <a class="el" href="F_Logging.html#F_mlogger_utility">mlogger</a></li>
<li>The hot-link calls mlogger.c::log_history(), which calls hs_write() to write the data into the history file. The frequency of the history writes is specified by the number of seconds between writes stored in the ODB key <span class="odb">/Equipment/&lt;<em>Equipment-Name</em>&gt;/Common/Log history</span>.</li>
<li>history.c::hs_write() or history_odbc::hs_write_odbc() writes the data into a history file or into an SQL database.</li>
</ol>
<p>The internal structure of MIDAS history files is documented in <a class="el" href="F_History_logging.html#F_History_format">History format</a> . <br/>
</p>
<p><a class="anchor" id="idx_history_enable"></a> </p>
<h3><a class="anchor" id="F_Enable_History_Event">
Enable the History system for a frontend event</a></h3>
<p>After <a class="el" href="F_History_logging.html#F_Frontend_History_Event">enabling</a> the history system for an Equipment, <b> restart the frontend </b>. The ODB key <span class="odb">/equipment/Equipment-Name/Common/Log history</span> will have been updated with the new value. It may be changed manually if necessary, using <a class="el" href="RC_mhttpd_ODB_page.html">mhttpd</a> or the <a class="el" href="RC_odbedit_examples.html#RC_odbedit_set">odbedit set command</a>. Then <b> restart <a class="el" href="F_Logging.html#F_mlogger_utility">mlogger</a> </b> . The data from the equipment should now appear in the <a class="el" href="RC_mhttpd_History_page.html">mhttpd history page</a> and in the history file (<a class="el" href="F_History_logging.html#F_mhdump_utility">mhdump</a> can be used to read the history file).</p>
<p><a class="anchor" id="idx_history_tags_new"></a> </p>
<h4><a class="anchor" id="F_new_history_tags">
New History Tags</a></h4>
<p><span class="new">Note on NEW format of </span> <span class="odb">/History/Tags</span> <span class="new">Version 4435 of <a class="el" href="F_Logging.html#F_mlogger_utility">mlogger</a> and <a class="el" href="RC_mhttpd_utility.html">mhttpd</a> and later: </span> <br/>
</p>
<p>The <span class="utility">mlogger/mhttpd</span> implementation of <span class="odb">/History/Tags</span> has proved troublesome and we are moving away from it. The <a class="el" href="F_History_logging.html#F_History_sql_internal">SQL database history implementation</a> ( <a class="el" href="NDF.html#ndf_jan_2009">Jan 2009</a> ) already does not use it . <br/>
During the present transition period:</p>
<ul>
<li>
<span class="new">Implementations starting with Version 4435 of <a class="el" href="F_Logging.html#F_mlogger_utility">mlogger</a> and <a class="el" href="RC_mhttpd_utility.html">mhttpd</a> (i.e. <b>"new"</b> versions) will now work without <span class="odb">/History/Tags</span>. </span> The history tags are read directly from the history files themselves. Two downsides to this are <ol>
<li>
it is slower and tags become non-persistent </li>
<li>
if some frontends have not been running for a while, their variables may vanish from the history panel editor. </li>
</ol>
To run in this mode, set <span class="odb">/History/DisableTags</span> to "y". Existing <span class="odb">/History/Tags</span> will be automatically deleted. </li>
<li>
for the above 2 reasons, using <span class="odb">/History/Tags</span> is still recommended, but the format of the tags is now changed to simplify management and reduce odb size. <span class="utility">mlogger</span> will automatically convert the tags to this new format (this is why you should make a backup of your ODB). </li>
<li>
using "old" (i.e. pre Version 4435) <span class="utility">mlogger</span> with "new" <span class="utility">mhttpd</span> is OK: new <span class="utility">mhttpd</span> understands both formats of <span class="odb">/History/Tags</span>. </li>
<li>
using "old" <span class="utility">mhttpd</span> with "new" <span class="utility">mlogger</span> is OK <b>provided the ODB key <span class="odb">/History/CreateOldTags</span> is set to "y" before starting</b> <span class="utility">mlogger</span>. </li>
</ul>
<p><a class="anchor" id="idx_history_tags_old"></a></p>
<h4><a class="anchor" id="F_history_old_tags">
Definition of old-style history tags</a></h4>
<p>Prior to versions 4435 of <a class="el" href="F_Logging.html#F_mlogger_utility">mlogger</a> and <a class="el" href="RC_mhttpd_utility.html">mhttpd</a>, <b>old-style</b> history tags were generated. The <b>history variable name</b> for each element of the Frontend History Event was composed as follows, where </p>
<ul>
<li>
<b>"equipment-name"</b> is the name of the equipment, and </li>
<li>
<p class="startli"><b>"bankname"</b> is the name of a bank generated by the <b>"equipment-name"</b> equipment :</p>
<ul>
<li>
<p class="startli">In the case of a <a class="el" href="FE_Data_format.html#FE_Midas_format">MIDAS format</a> event:</p>
<ul>
<li>
<b>If the ODB key</b> <span class="odb">/Equipment/equipment-name/Settings/Names &lt;bankname&gt;[ ]</span> <b>IS present</b>, <ul>
<li>
the <b>history</b> <b>name</b> is composed of the corresponding name found in the <span class="odb"> Names &lt;bankname&gt;[ ]</span> array. </li>
<li>
The <b>size</b> of this array must match the size of the <span class="odb">/equipment/equipment-name/Variables/&lt;bankname&gt;[ ]</span> array, or an error will be generated. </li>
</ul>
</li>
<li>
<b>Otherwise</b> the <b>history</b> <b>name</b> is composed of the bank name followed by the corresponding index of the element. </li>
</ul>
<p>See <a class="el" href="RC_mhttpd_Equipment_page.html#RC_mhttpd_Equipment_example4">example</a> .</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">In the case of a <a class="el" href="FE_bank_construction.html#FE_FIXED_event_readout">Fixed format</a> event :</p>
<ul>
<li>
<b>No</b> array : the names of the individual element under <span class="odb">/Equipment/equipment-name/Variables/</span> are used for the history name composition. </li>
<li>
<b>With</b> array: if the key <span class="odb">/Equipment/equipment-name/Settings/Names[ ]</span> exists, each element of the array is referenced using the corresponding name of the <span class="odb">../Settings/Names[ ]</span> array. </li>
</ul>
</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="F_example_FE_history_event">
Example Frontend History Event (old-style History tags)</a></h3>
<p>The <a class="el" href="RC_mhttpd_Equipment_page.html#RC_mhttpd_Equipment_example4">example</a> shows the ODB keys for a Frontend Equipment named "Target" that sends out data in two <a class="el" href="FE_bank_construction.html#FE_MIDAS_event_construction">Midas banks</a> named "TGT_" and "SCAL". For simplicity, only the "TGT_" bank is discussed here. The relevent keys are reproduced below.</p>
<p><br/>
The key <span class="odb">"/Equipment/Target/Settings/Names TGT_"</span> is defined as a 7-element array containing the variable names. The key <span class="odb">/Equipment/Target/Variables/TGT_</span> is also present, and contains 7 elements, matching the number of elements in the <span class="odb">"Names TGT_"</span> array. <br/>
 Had the latter key <b>not</b> been present, the history variable names would be <b>TGT_0 ... TGT_6.</b> <br/>
 </p>
<div class="fragment"><pre class="fragment">[host:chaos:Running]cd /Equipment/Target

[host:chaos:Running]Target&gt;ls -l -r
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
Target                          DIR
    settings                    DIR
        Names TGT_              STRING  7     32    10h  0   RWD  
                                        [0]             Time
                                        [1]             Cryostat vacuum
                                        [2]             Heat Pipe pressure
                                        [3]             Target pressure
                                        [4]             Target temperature
                                        [5]             Shield temperature
                                        [6]             Diode temperature
    Common                      DIR
          ...
    Variables                   DIR

        TGT_                    FLOAT   7     4     10s  0   RWD  
                                        [0]             114059
                                        [1]             4.661
                                        [2]             23.16
                                        [3]             -0.498
                                        [4]             22.888
                                        [5]             82.099
                                        [6]             40
    Statistics                  DIR
          ...
</pre></div><p><br/>
 <hr/>
 <br/>
 <a class="anchor" id="idx_history_ODB-tree"></a> <a class="anchor" id="idx_ODB_tree_History"></a></p>
<h2><a class="anchor" id="F_ODB_History_tree">
ODB /History tree</a></h2>
<p><a class="anchor" id="idx_logger_utility_mlogger"></a> The first time <a class="el" href="F_Logging.html#F_mlogger_utility">mlogger</a> is run, it creates the <span class="odb">/History </span> tree. This tree is created using the variables found in the <span class="odb">/Equipment</span> tree. For the "Target" equipment defined above, the <span class="odb">/History</span> tree produced is as follows:</p>
<div class="fragment"><pre class="fragment">16:51:24 [Logger,INFO] Program Logger on host dasdevpc2 started
[local:midas:S]/History&gt;ls -lt
[local:midas:S]/History&gt;ls -lr
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
History                         DIR
    Links                       DIR
    PerVariableHistory          <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     46s  0   RWD  0
    DisableTags                 <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     46s  0   RWD  n
    Tags                        DIR
        2                       STRING  8     96    46s  0   RWD
                                        [0]             Target
                                        [1]             9[1] Time
                                        [2]             9[1] Cryostat vacuum
                                        [3]             9[1] Heat Pipe pressure
                                        [4]             9[1] Target pressure
                                        [5]             9[1] Target temperature
                                        [6]             9[1] Shield temperature
                                        [7]             9[1] Diode temperature
</pre></div><p>If a <a class="el" href="FE_eqdec.html">Frontend Trigger Equipment</a> is defined, i.e. an Equipment whose name is "Trigger", extra keys will be created as follows, where the 2 trigger fields are symbolic links to the given path. The sub-tree <span class="odb">System</span> defines a "virtual" equipment and is assigned a particular "History Event ID" by the system.</p>
<div class="fragment"><pre class="fragment">[local:midas:S]/History&gt;ls -lrt
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
History                         DIR
    Links                       DIR
        System                  DIR
            Trigger per sec. -&gt; /Equipment/Trigger/Statistics/Events per sec.
                                DOUBLE  1     8     &gt;99d 1   RWD  0
            Trigger kB per sec. -&gt; /Equipment/Trigger/Statistics/kBytes per sec.
                                DOUBLE  1     8     &gt;99d 1   RWD  0
    PerVariableHistory          <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     2h   0   RWD  0
    DisableTags                 <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     2h   0   RWD  n
    Tags                        DIR
        2                       STRING  5     96    24s  0   RWD
                                        [0]             trigger
                                        [1]             7[1] dummy
                                        [2]             7[1] <a class="code" href="sis3803_8c.html#a8fa8e4c8bef10b038f6a033f736d5bce">test</a>
                                        [3]             6[6] SCLR
                                        [4]             9[6] RATE
        10                      STRING  3     96    3m   0   RWD
                                        [0]             System
                                        [1]             10[1] Trigger per sec.
                                        [2]             10[1] Trigger kB per sec                                   .
</pre></div><p>A second sub-tree is added to the <span class="odb">/History</span> by the <a class="el" href="RC_mhttpd_utility.html">MIDAS web server</a> when the <a class="el" href="RC_mhttpd_History_page.html">History</a> button on the main status page is pressed.</p>
<div class="fragment"><pre class="fragment">[local:midas:S]/History&gt;ls -l -r Display
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
Display                         DIR
  Default                       DIR
    Trigger rate                DIR
        Variables               STRING  2     32    36h  0   RWD
                                        [0]             System:Trigger per sec.
                                        [1]             System:Trigger kB per sec.
        Factor                  FLOAT   2     4     36h  0   RWD
                                        [0]             1
                                        [1]             1
        Timescale               <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     36h  0   RWD  3600
        Zero ylow               <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     36h  0   RWD  y
</pre></div><p>This defines a default history display under the MIDAS web server as long as the reference to "System" is correct. See <a class="el" href="RC_mhttpd_History_page.html">History page</a> and the <a class="el" href="F_History_logging.html#F_History_tree_keys">table below</a> for more information about these these fields.</p>
<h2><a class="anchor" id="F_History_tree_keys">
Explanation of the keys in the ODB /History tree</a></h2>
<table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2">
<caption align="bottom">Above: meaning of keys in the /History ODB tree </caption>
<tr>
<td colspan="7" style="vertical-align: top; background-color: rgb(204, 204, 255); font-weight: bold; text-align: center;"><p>Keys in the ODB <span class="odb">/History</span> tree  </p>
<p></p>
</td></tr>
<tr>
<td colspan="5" style="vertical-align: top; background-color: rgb(204, 204, 255); font-weight: bold; text-align: center;"><p>ODB Key  </p>
</td><td style="vertical-align: top; background-color: rgb(204, 204, 255); font-weight: bold; text-align: center;"><p>Type </p>
<p></p>
</td><td style="vertical-align: top; background-color: rgb(204, 204, 255); font-weight: bold; text-align: center;"><p>Explanation  </p>
<p></p>
</td></tr>
<tr>
<td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>History  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DIR  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>directory containing...  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_links"></a> Links  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DIR  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>directory containing...  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_System_dir"></a> System  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DIR  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>info  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Trigger per sec.  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DOUBLE  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>link to <span class="odb">/Equipment/Trigger/Statistics/Events per sec.</span>  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Trigger kB per sec.  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DOUBLE  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>link to <span class="odb">/Equipment/Trigger/Statistics/kBytes per sec.</span>  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_pervar"></a> PerVariableHistory  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>INT  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Enables/Disables the per-variable History. <span class="new">This key appears starting with version 4203</span> of <span class="utility">mlogger</span>. See <a class="el" href="F_History_logging.html#F_History_sql_pervariable">Note2</a>  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_Disable_tags"></a> DisableTags  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>BOOL  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Set this key to "y" if reading the history tags directly from the history files. Set to "n" to read the history tags from the ODB. <span class="new">This key appears starting with version 4435</span> of <span class="utility">mlogger</span>. See <a class="el" href="F_History_logging.html#F_new_history_tags">Note1</a>  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_CreateOldTags"></a> CreateOldTags  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>BOOL  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Set this key to "y" to force creation of <span class="odb">/History/Tags</span> using the old format. <span class="new">This key appears starting with version 4435 of</span> <span class="utility">mlogger</span>. See <a class="el" href="F_History_logging.html#F_new_history_tags">Note1</a>.</p>
<p></p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_tags"></a> Tags  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DIR  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>subtree containing the old-style History tags. See <a class="el" href="F_History_logging.html#F_new_history_tags">Note1</a>  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_2"></a> 2  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>STRING  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Array containing ... </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000008">Todo:</a></b></dt><dd>Explanation needed  </dd></dl>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>10  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>STRING  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Array of length 3 containing ... </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000009">Todo:</a></b></dt><dd>Explanation needed</dd></dl>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p><a class="anchor" id="F_History_Display"></a> Display  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DIR  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p><br/>
  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Default  </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DIR  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p><br/>
  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Trigger Rate  </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>DIR  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p><br/>
  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Variables  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>STRING  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Array containing ... </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000010">Todo:</a></b></dt><dd>Explanation needed  </dd></dl>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Factor  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>FLOAT  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Array containing ... </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000011">Todo:</a></b></dt><dd>Explanation needed  </dd></dl>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Timescale  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>INT  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Appears as an input box on the <a class="el" href="RC_mhttpd_History_page.html">History page</a> . Timescale is in date format.  </p>
<p></p>
</td></tr>
<tr>
<td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td><p><br/>
 </p>
</td><td style="vertical-align: top; background-color: lightyellow; font-weight: bold; text-align: left;"><p>Zero ylow  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>BOOL  </p>
</td><td style="vertical-align: top; font-weight: normal; text-align: left;"><p>Appears as a button on the <a class="el" href="RC_mhttpd_History_page.html">History page</a> . </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000012">Todo:</a></b></dt><dd>Explanation needed   </dd></dl>
</td></tr>
</table>
<h2><a class="anchor" id="F_customizing_History">
Customizing the History logging</a></h2>
<p>The History logging is customized by changing the values in the ODB <span class="odb">/history</span> tree. This tree is created automatically when the logger is started.</p>
<hr/>
 <a class="anchor" id="idx_ODBC_SQL-history-system"></a> </p>
<h2><a class="anchor" id="F_History_sql_internal">
MIDAS SQL History system</a></h2>
<p><span class="new"> (SQL History System added <a class="el" href="NDF.html#ndf_jan_2009">Jan 2009</a> ). </span> <br/>
This section describes the internal workings of the MIDAS SQL history system.</p>
<p>The SQL history system implements the MIDAS history using a <a class="el" href="F_mySQL.html#F_Logger_mySQL">SQL database</a> for data storage instead of flat binary files.</p>
<p>The SQL history code lives in a separate files <b>history.h</b> and <b>history_sql.cxx</b>. The present implentation uses the <a class="el" href="BuildingOptions.html#BO_HAVE_ODBC">ODBC</a> API for accessing SQL databases. <span class="new"> As of revision 4433, only MySQL database is supported, with support for PgSQL written and partially tested but not enabled.</span> Drivers for SQL DB APIs other than ODBC should be easy to add in <b>history_sql</b> and most SQL operations are done using an interface class.</p>
<p>Preliminary testing with MySQL and PgSQL indicates that disk space requirements are the same for both storage mechanisms using flat binary files or either of the 2 SQL databases. All 3 tested storage mechanisms store the data uncompressed. (Observed gzip-1 compression ratios from CERN-ALPHA history files are 50% or better).</p>
<p><a class="anchor" id="idx_slow-control_MySQL-database"></a> Preliminary testing also indicates that MySQL database is "not too slow" for use by T2K/ND280 slow control system. Using MySQL, performance seems to improve somewhat compared to traditional history because each SQL table is stored into a separate file, compared to everything-in-one-file in traditional MIDAS history.</p>
<h3><a class="anchor" id="F_History_sql_enable">
How to enable writing history to SQL</a></h3>
<p>In order to setup a MySQL database, the following is needed:</p>
<ul>
<li>the server hostname and port number</li>
<li>database name</li>
<li>user name and password.</li>
</ul>
<p>It is recommended to create 3 different users:</p>
<ul>
<li>a "root" user with full priveleges,</li>
<li>a "reader" user with read-only priveleges</li>
<li>and a "writer" user with "insert, create table, and add column" priveleges (no permission to drop table, remove columns, etc)</li>
</ul>
<ol>
<li>
Setup a MySQL database (RHEL/SL 5) <div class="fragment"><pre class="fragment">ssh root@localhost
service mysqld start
/usr/bin/mysql_secure_installation (enter current password <span class="keywordflow">for</span> root: press &lt;enter&gt;, then accept <span class="keywordflow">default</span> answer <span class="stringliteral">&quot;Y&quot;</span> to all questions)
mysqladmin -<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a> create history
<span class="keyword">using</span> mysql-administrator, create 2 users:
history_writer, with database <span class="stringliteral">&quot;history&quot;</span> schema privileges: select, insert, create, alter
history_reader, with database <span class="stringliteral">&quot;history&quot;</span> schema privileges: select
</pre></div> </li>
<li>
setup $HOME/.odbc.ini file: <div class="fragment"><pre class="fragment">cat $HOME/.odbc.ini
[history_writer]
Description  = history_writer
Driver       = /usr/lib64/libmyodbc3.so
SERVER       = ladd05.triumf.ca
PORT         =
Database     = history
OPTION       = 3
SOCKET       =
User         = history_writer
Password     = ******
[history_reader]
Description  = history_reader
Driver       = /usr/lib64/libmyodbc3.so
SERVER       = ladd05.triumf.ca
PORT         =
Database     = history
OPTION       = 3
SOCKET       =
User         = history_reader
Password     = 
</pre></div> <a class="anchor" id="F_History_sql_pervariable"></a> </li>
<li>
set key <span class="odb">/History/PerVariableHistory</span> to 1 <br/>
(<b>BEWARE!</b> This will change the format of normal MIDAS history files. You do not have to enable per-variable history to use the SQL interface, but the layout of SQL tables may be suboptimal in the same way the layout of data in the MIDAS history file is suboptimal). </li>
<li>
set ODB keys <ul>
<li>
<span class="odb">/Logger/ODBC_DSN</span> to "history_writer" </li>
<li>
<span class="odb">/Logger/ODBC_Debug</span> to 0 (or 1 to see all SQL commands) </li>
</ul>
</li>
<li>
run <span class="utility">mlogger -v</span>, and observe how it issues SQL commands to create the tables and columns corresponding to MIDAS history events and tags. </li>
<li>
<span class="utility">mlogger</span> is programmed to raise alarms if connection to SQL database is interrupted or if some events cannot be written into the database (i.e. data type mismatch, SQL syntax errors, etc). The traditional MIDAS history never raised alarms because it "never failed" - other than from "disk full" errors, which are immediately obvious. </li>
</ol>
<h3><a class="anchor" id="F_History_sql_enable">
How to enable writing history to SQL</a></h3>
<ol>
<li>
set key <span class="odb">/History/ODBC_DSN</span> to "history_reader" </li>
<li>
restart <span class="utility">mhttpd</span> (may not be required?) </li>
<li>
from this moment <span class="utility">mhttpd</span> will only use history information from the SQL database to make history plots and to extract history variable names for the history plot editor. The <span class="odb">/History/Tags</span> and <span class="odb">/History/Events</span> keys are not used. The on-disk .hst &amp; co history are not used. <dl class="todo"><dt><b><a class="el" href="todo.html#_todo000013">Todo:</a></b></dt><dd>What is the co history?</dd></dl>
</li>
<li>
variable names presented to the user may change from MIDAS names to SQL names (use the history panel "Label" text fields to create permanent plot labels). </li>
</ol>
<h3><a class="anchor" id="F_SQL_Layout">
Layout of SQL tables:</a></h3>
<ul>
<li>
one table is created for each history event. Table name is the same as the history event name (as reported by <a class="el" href="F_History_logging.html#F_mhdump_utility">mhdump</a>). </li>
<li>
one column is created for each history tag (history variable). Column name is the same as the tag name (as reported by <a class="el" href="F_History_logging.html#F_mhdump_utility">mhdump</a>). For array tags, one column is created for each array element: array a[3] will produce columns a_0, a_1 and a_2. </li>
<li>
2 special columns are always created: <b>_i_time</b> and <b>_t_time</b> are the timestamps in the UNIX-time integer format and in the SQL "time" format. (A priori, it is not clear which timestamp format is more useful for end users. <span class="utility">mhttpd</span> uses the _i_time integer time format). Note that this timestamp is the time when <span class="utility">mlogger</span> receives the hot-link signal (see <a class="el" href="F_History_logging.html#F_history_hot_link">above</a>) and it can be a few seconds behind the time when the user placed the data into the MIDAS bank. For high precision (and sub-second time resolution) time stamps, users should generate their own timestamps and include them as part of the data itself. </li>
<li>
a special table called <b>_history_index</b> is created to remember the mapping between SQL names and MIDAS names for event names, variable name and tag names. </li>
</ul>
<h3><a class="anchor" id="F_SQL_Schema">
Schema Evolution:</a></h3>
<ul>
<li>
when new data fields are added, new SQL columns are created automatically </li>
<li>
existing SQL columns are never deleted </li>
<li>
arrays are expanded automatically, and arrays never shrink. </li>
<li>
if the type of a data field changes, a conflict may occur with existing SQL columns, for example if previous type was "FLOAT" and new type is "DOUBLE", the existing SQL columns would have the SQL data type "float", too narrow to store new values. <span class="utility">mlogger</span> will complain about this. Such conflicts may be resolved by changing the type of the SQL column using SQL tools. In general, SQL names are created from MIDAS names by replacing all non-alphanumerical characters to an underscore "_". If this procedure creates duplicate column names, the column names and made unique by appending them with a random number, i.e. MIDAS names "A+B" and "A-B" will be translated to "A_B" and "A_B_12345" (random integer). True MIDAS names are saved into the _history_index. </li>
</ul>
<p><br/>
<hr/>
<br/>
 </p>
<h2><a class="anchor" id="F_mh2sql_utility">
mh2sql - import history files into SQL database.</a></h2>
<p><br/>
</p>
<p><span class="utility">mh2sql</span> imports history files into an SQL database in the same way as if they were written into the database by <span class="utility">mlogger</span>.</p>
<ul>
<li><b>Arguments:</b> [-h ] : help - prints this help message</li>
</ul>
<ul>
<li><b> Usage </b> mh2sql odbc_dsn file1.hst file2.hst ...</li>
</ul>
<p><br/>
<hr/>
<br/>
 </p>
<h2><a class="anchor" id="F_mhist_utility">
mhist  - history data retriever</a></h2>
<p>History data retriever.</p>
<ul>
<li><b> Arguments </b><ul>
<li>[-h ] : help</li>
<li>[-e Event ID] : specify event ID</li>
<li>[-v Variable Name] : specify variable name for given Event ID</li>
<li>[-i Index] : index of variables which are arrays</li>
<li>[-i Index1:Index2] index range of variables which are arrays (max 50)</li>
<li>[-t Interval] : minimum interval in sec. between two displayed records</li>
<li>[-h Hours] : display between some hours ago and now</li>
<li>[-d Days] : display between some days ago and now</li>
<li>[-f File] : specify history file explicitly</li>
<li>[-s Start date] : specify start date DDMMYY[.HHMM[SS]]</li>
<li>[-p End date] : specify end date DDMMYY[.HHMM[SS]]</li>
<li>[-l] : list available events and variables</li>
<li>[-b] : display time stamp in decimal format</li>
<li>[-z] : History directory (def: cwd).</li>
</ul>
</li>
</ul>
<ul>
<li><b> Usage </b></li>
<li><b> Example </b> <div class="fragment"><pre class="fragment">  --- All variables of <span class="keyword">event</span> ID 9 during last hour with at least 5 minutes interval.
  &gt; mhist
  Available events:
  ID 9: Target
  ID 5: CHV
  ID 6: B12Y
  ID 20: System

  Select <span class="keyword">event</span> ID: 9

  Available variables:
  0: Time
  1: Cryostat vacuum
  2: Heat Pipe pressure
  3: Target pressure
  4: Target temperature
  5: Shield temperature
  6: Diode temperature

  Select variable (0..6,-1 <span class="keywordflow">for</span> all): -1

  How many hours: 1

  Interval [sec]: 300

  Date    Time    Cryostat vacuum Heat Pipe pressure  Target pressure Target temperature      Shield temperature      Diode temperature
  Jun 19 10:26:23 2000    104444  4.614   23.16   -0.498  22.931  82.163  40
  Jun 19 10:31:24 2000    104956  4.602   23.16   -0.498  22.892  82.108  40
  Jun 19 10:36:24 2000    105509  4.597   23.099  -0.498  22.892  82.126  40
  Jun 19 10:41:33 2000    110021  4.592   23.16   -0.498  22.856  82.08   40
  Jun 19 10:46:40 2000    110534  4.597   23.147  -0.498  22.892  82.117  40
  Jun 19 10:51:44 2000    111046  4.622   23.172  -0.498  22.907  82.117  40
  Jun 19 10:56:47 2000    111558  4.617   23.086  -0.498  22.892  82.117  40
  Jun 19 11:01:56 2000    112009  4.624   23.208  -0.498  22.892  82.117  40
  Jun 19 11:07:00 2000    112521  4.629   23.172  -0.498  22.896  82.099  40
  Jun 19 11:12:05 2000    113034  4.639   23.074  -0.498  22.896  82.117  40
  Jun 19 11:17:09 2000    113546  4.644   23.172  -0.498  22.892  82.126  40
  Jun 19 11:22:15 2000    114059  4.661   23.16   -0.498  22.888  82.099  40
</pre></div></li>
</ul>
<ul>
<li>Single variable "I-WC1+_Anode" of event 5 every hour over the full April 24/2000.</li>
</ul>
<div class="fragment"><pre class="fragment">   mhist -e 5 -v <span class="stringliteral">&quot;I-WC1+_Anode&quot;</span> -t 3600 -s 240400 -<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a> 250400
  Apr 24 00:00:09 2000    160
  Apr 24 01:00:12 2000    160
  Apr 24 02:00:13 2000    160
  Apr 24 03:00:14 2000    160
  Apr 24 04:00:21 2000    180
  Apr 24 05:00:26 2000    0
  Apr 24 06:00:31 2000    160
  Apr 24 07:00:37 2000    160
  Apr 24 08:00:40 2000    160
  Apr 24 09:00:49 2000    160
  Apr 24 10:00:52 2000    160
  Apr 24 11:01:01 2000    160
  Apr 24 12:01:03 2000    160
  Apr 24 13:01:03 2000    0
  Apr 24 14:01:04 2000    0
  Apr 24 15:01:05 2000    -20
  Apr 24 16:01:11 2000    0
  Apr 24 17:01:14 2000    0
  Apr 24 18:01:19 2000    -20
  Apr 24 19:01:19 2000    0
  Apr 24 20:01:21 2000    0
  Apr 24 21:01:23 2000    0
  Apr 24 22:01:32 2000    0
  Apr 24 23:01:39 2000    0
</pre></div><ul>
<li><b> Remarks </b>: History data can be retrieved and displayed through the MIDAS web page (see <a class="el" href="RC_mhttpd_utility.html">mhttpd</a>).</li>
</ul>
<ul>
<li><b> Example </b> <center> <span class="image"> MIDAS Web History display.</span> <div align="center">
<img src="mhhist.gif" alt="mhhist.gif"/>
</div>
 </center></li>
</ul>
<hr/>
<p><a class="anchor" id="idx_mhdump-utility"></a> <a class="anchor" id="idx_history_dump-files"></a> </p>
<h2><a class="anchor" id="F_mhdump_utility">
mhdump - dump history files</a></h2>
<p><b>mhdump</b> is intended to be easier to use, compared to <a class="el" href="F_History_logging.html#F_mhist_utility">mhist</a>. By default it reads and decodes all the data in the given .hst files, with options to limit the decoding to specified events and tags, and an option to omit the event and tag names from the output.</p>
<p>mhdump is completely standalone and does not require MIDAS header files and libraries. </p>
<div class="fragment"><pre class="fragment">$ mhdump
Usage: mhdump [-h] [-L] [-n] [-t] [-E <a class="code" href="structHIST__RECORD.html#af0b5331f4cf74267721acd101a7cdfef">event_id</a>] [-T tag_name] file1.hst file2.hst ...

Switches:
  -h --- print <span class="keyword">this</span> help message
  -L --- list tag definitions only
  -t --- omit tag definitions
  -n --- omit variable names

Examples:
  To list all existing tags: mhdump -L file1.hst file2.hst ...
  To show data <span class="keywordflow">for</span> all events, all tags: mhdump file1.hst file2.hst ...
  To show all data <span class="keywordflow">for</span> <span class="keyword">event</span> 0: mhdump -E 0 file1.hst file2.hst ...
  To show data <span class="keywordflow">for</span> <span class="keyword">event</span> 0, tag <span class="stringliteral">&quot;State&quot;</span>: mhdump -n -E 0 -T State file1.hst file2.hst ...
  To show data <span class="keywordflow">for</span> <span class="keyword">event</span> 3, tag <span class="stringliteral">&quot;MCRT&quot;</span>, array index 5: mhdump -n -E 3 -T MCRT[5] file1.hst file2.hst ...
</pre></div><p>The mhdump source code and a description of the .hst file format are here: </p>
<div class="fragment"><pre class="fragment">http:<span class="comment">//daq-plone.triumf.ca/SR/MIDAS/utils/mhdump/</span>
</pre></div><p><br/>
<hr/>
<br/>
</p>
<p><a class="anchor" id="idx_History_file_format"></a> </p>
<h2><a class="anchor" id="F_History_format">
History format</a></h2>
<p>MIDAS history data are written to MIDAS .hst files. For a complete working example of reading these files, look at mhdump.cxx.</p>
<p>This is the internal format of MIDAS .hst files (reverse engineered by K.Olchanski).</p>
<p>History file consists of definition records and data records. Definition records for each history event always preceed data records for this event. Other than that, definition and data records are present in the file in no particular order. If data definition changes at some point, the new definition record is written to the file and new data records follow using the new format.</p>
<p>The data is written in native-endian format and big-endian history files (i.e. written on PowerPC-based computer) would not read on little-endian computers (i.e. Intel/AMD CPUs).</p>
<p>When decoding history data records, be aware that the data is written on the format returned by <a class="el" href="group__odbfunctionc.html#ga8d8bb0ee338e5fbc46fed2c29e697540">db_get_data()</a>, and follow certain alignement rules. Misaligned data may contain empty padding bytes. </p>
<div class="fragment"><pre class="fragment">definition record:
   <span class="keyword">struct </span><a class="code" href="structHIST__RECORD.html">HIST_RECORD</a>:
      uint32_t <a class="code" href="structHIST__RECORD.html#a455da5efe0b4d3844e387e440b86302d">record_type</a> = 0x46445348 (RT_DEF)
      uint32_t <a class="code" href="structHIST__RECORD.html#af0b5331f4cf74267721acd101a7cdfef">event_id</a>    = history event id
      uint32_t <a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>        = unix <a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>
      uint32_t <a class="code" href="structHIST__RECORD.html#a32da4099349d2a5a77a84e67301c9e56">def_offset</a>  = 0
      uint32_t <a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a>   = size in bytes of following data = ntags*sizeof(TAG)
   event name:
      char name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>] = name of this event (fixed size, 32 bytes)
   struct <a class="code" href="structTAG.html">TAG</a> [0]
      char name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>] = tag name (fixed size, 32 bytes)
      uint32_t type          = type of the data (TID_DOUBLE, etc)
      uint32_t n_data        = 1 for single variables, number of array elements for arrays
   struct <a class="code" href="structTAG.html">TAG</a> [1]
      ...
   struct <a class="code" href="structTAG.html">TAG</a> [ntags-1]
      ...
</pre></div><div class="fragment"><pre class="fragment">data record:
   <span class="keyword">struct </span><a class="code" href="structHIST__RECORD.html">HIST_RECORD</a>: (same as above)
      uint32_t <a class="code" href="structHIST__RECORD.html#a455da5efe0b4d3844e387e440b86302d">record_type</a> = 0x41445348 (RT_DATA)
      uint32_t <a class="code" href="structHIST__RECORD.html#af0b5331f4cf74267721acd101a7cdfef">event_id</a>    = history event id
      uint32_t <a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>        = unix <a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>
      uint32_t <a class="code" href="structHIST__RECORD.html#a32da4099349d2a5a77a84e67301c9e56">def_offset</a>  = ???
      uint32_t <a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a>   = size in bytes of following data
   event data
      char[<a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a>]      = history data for this event (see mhdump.cxx and examples below on decoding this data
</pre></div><p> To decode the "event data" blob in a data record, one should parse the data definition for this event and remember the contents of all tag definitions. One way to parse the data is by computing the "offset" for each tag by adding up the tag size for each tag. For each tag, the corresponding data size is the product of n_data and the size of the MIDAS type, given in this table (extracted from <a class="el" href="midas_8c.html">midas.c</a>):</p>
<div class="fragment"><pre class="fragment"><span class="comment">/* data type sizes */</span>
<span class="keywordtype">int</span> tid_size[] = {
   0,                           <span class="comment">/* tid == 0 not defined                               */</span>
   1,                           <span class="comment">/* TID_BYTE      unsigned byte         0       255    */</span>
   1,                           <span class="comment">/* TID_SBYTE     signed byte         -128      127    */</span>
   1,                           <span class="comment">/* TID_CHAR      single character      0       255    */</span>
   2,                           <span class="comment">/* TID_WORD      two bytes             0      65535   */</span>

   2,                           <span class="comment">/* TID_SHORT     signed word        -32768    32767   */</span>
   4,                           <span class="comment">/* TID_DWORD     four bytes            0      2^32-1  */</span>
   4,                           <span class="comment">/* TID_INT       signed dword        -2^31    2^31-1  */</span>
   4,                           <span class="comment">/* TID_BOOL      four bytes bool       0        1     */</span>
   4,                           <span class="comment">/* TID_FLOAT     4 Byte float format                  */</span>
   8,                           <span class="comment">/* TID_DOUBLE    8 Byte float format                  */</span>
   1,                           <span class="comment">/* TID_BITFIELD  8 Bits Bitfield    00000000 11111111 */</span>
   0,                           <span class="comment">/* TID_STRING    zero terminated string               */</span>
   0,                           <span class="comment">/* TID_ARRAY     variable length array of unkown type */</span>
   0,                           <span class="comment">/* TID_STRUCT    C structure                          */</span>
   0,                           <span class="comment">/* TID_KEY       key in online database               */</span>
   0                            <span class="comment">/* TID_LINK      link in online database              */</span>

};
</pre></div><p>Example code for computing tag offsets: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> offset = 0;
<span class="keywordflow">for</span> (<span class="keywordtype">int</span> itag=0; itag&amp;lt;ntags; itag++) {
   <span class="keywordtype">int</span> size = tags[itag].n_data * tid_size[tags[itag].type];
   type_for_tag[itag] = tags[itag].type;
   offset_for_tag[itag] = offset;
   offset += size;
}
</pre></div><p>Example code for decoding the event data blob: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">char</span> *buf = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a>];
fread(buf, 1, <a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a>, f); <span class="comment">// read data blob from file</span>

<span class="keywordtype">int</span> itag = ...; <span class="comment">// the tag we want to look at</span>
<span class="keywordtype">int</span> j    = ...; <span class="comment">// array index inside the tag</span>

<span class="keywordtype">int</span> offset = offset_for_tag[itag];
<span class="keywordtype">void</span>* ptr = (<span class="keywordtype">void</span>*)(buf+offset);

<span class="keywordflow">switch</span> (type_for_tag[itag]) {
   <span class="keywordflow">default</span>:
      printf(<span class="stringliteral">&quot;unknownType%d &quot;</span>,type_for_tag[itag]);
      <span class="keywordflow">break</span>;
   <span class="keywordflow">case</span> 6: <span class="comment">/* DWORD */</span>
      printf(<span class="stringliteral">&quot;%u &quot;</span>,((uint32_t*)ptr)[j]);
      <span class="keywordflow">break</span>;
}
</pre></div><p><br/>
  
<script type="text/javascript">
pages( "F_mySQL",  "Features","F_Elog", "F_History_logging",""); // back index next {top bottom}
// sections params:   last section; top of this section; next section
sections("Quickstart", "Features", "RunControl");
</script>
<p><a class="anchor" id="end"></a> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

