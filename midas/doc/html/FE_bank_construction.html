<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: Bank construction in an Event readout routine</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="FrontendOperation.html">SECTION 6: Frontend Operation</a>&nbsp;&raquo&nbsp;<a class="el" href="Frontend_code.html">Frontend code</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="FE_bank_construction">Bank construction in an Event readout routine </a></h1><p><a class="anchor" id="idx_bank_construction"></a> <br/>
  
 
<script type="text/javascript">
pages(" FE_event_notification",  "FrontendOperation","FE_Super_Event", "FE_bank_construction","end" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("RunControl","FrontendOperation","DataAnalysis");
</script>
<p><br/>
</p>
<p>A readout event will often need to construct banks in which the data is to be sent out. The <a class="el" href="FE_table.html#FE_tbl_Format">bank format</a> is declared in the <a class="el" href="FE_eqdec.html#FE_Example_equipment_structure">Equipment list</a> , e.g. </p>
<div class="fragment"><pre class="fragment">    <a class="code" href="structeqpmnt.html">EQUIPMENT</a> equipment[] = {

      { <span class="stringliteral">&quot;Trigger&quot;</span>,            <span class="comment">// equipment name</span>
        {
          ...
          <span class="stringliteral">&quot;Midas&quot;</span>,            <span class="comment">// format</span>
          ...
      ...  
</pre></div><p>Refer to the following sections for an explanation of event composition depending on the event type selected:</p>
<ul>
<li><a class="el" href="FE_bank_construction.html#FE_FIXED_event_readout">FIXED format Event readout</a>,</li>
<li><a class="el" href="FE_bank_construction.html#FE_MIDAS_event_construction">MIDAS event construction</a>,</li>
</ul>
<p><br/>
 <hr/>
 <br/>
 <a class="anchor" id="idx_format_FIXED"></a> <a class="anchor" id="idx_event_readout_format_fixed"></a></p>
<h2><a class="anchor" id="FE_FIXED_event_readout">
FIXED format Event readout</a></h2>
<p>The <a class="el" href="FE_table.html#FE_tbl_Format">FIXED format</a> is the simplest event format. The event length is fixed and is mapped to a C structure that is filled by the readout routine. Since the standard MIDAS analyzer cannot work with this format, it is only recommended for an experiment which uses its own analyzer and wants to avoid the overhead of a bank structure, or for monitoring purposes in the ODB.</p>
<p><br/>
 There are several ways of defining fixed events. For fixed events, the structure has to be defined twice: once for the compiler in the form of a C structure, and once for the ODB in form of an ASCII representation. There are several ways of doing this. The ASCII string may be supplied to the system as the <a class="el" href="FE_table.html#FE_tbl_InitString">init string</a> in the equipment list as follows:</p>
<table style="text-align: left; width: 100%;" border="0" cellpadding="2" cellspacing="5">
<caption align="bottom">Example of definition of FIXED format using Equipment field "init string" </caption>
<tr>
<td colspan="3" style="vertical-align: top; text-align: center; background-color: rgb(255, 255, 153);"><p><span style="font-weight: bold;">Example of FIXED format event:</span>   </p>
</td></tr>
<tr>
<td><p><b>Fixed Event Definition</b> <br/>
A fixed event with two ADC and TDC values:  </p>
</td><td><p>The <b>trigger_event_str</b> has to be defined before the equipment list and a reference to it has to be placed in the equipment list like:  </p>
</td><td><p>The <b>Readout routine</b> <br/>
The &lt;...&gt; statements are filled with the appropriate code accessing the hardware:  </p>
<p></p>
</td></tr>
<tr>
<td><div class="fragment"><pre class="fragment"><span class="keyword">typedef</span> <span class="keyword">struct </span>{
  <span class="keywordtype">int</span> adc0;
  <span class="keywordtype">int</span> adc1;
  <span class="keywordtype">int</span> tdc0;
  <span class="keywordtype">int</span> tdc1;
  TRIGGER_EVENT;
}
<span class="keywordtype">char</span> *trigger_event_str[] = {
<span class="stringliteral">&quot;adc0 = INT : 0&quot;</span>,
<span class="stringliteral">&quot;adc1 = INT : 0&quot;</span>,
<span class="stringliteral">&quot;tdc0 = INT : 0&quot;</span>,
<span class="stringliteral">&quot;tdc1 = INT : 0&quot;</span>,
  <a class="code" href="structASUM__BANK.html">ASUM_BANK</a>;
}
</pre></div>  </td><td><p></p>
<div class="fragment"><pre class="fragment"> {
  <span class="stringliteral">&quot;FIXED&quot;</span>,            <span class="comment">// FIXED format</span>
...
  <a class="code" href="fevmemodules_8c.html#a9c54bafa1af403e5e4737f9d8d5aba07">read_trigger_event</a>, <span class="comment">// readout routine </span>
  NULL,NULL,
  trigger_event_str,  <span class="comment">// init string </span>
 ,
</pre></div> </td><td><p></p>
<div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="fevmemodules_8c.html#a9c54bafa1af403e5e4737f9d8d5aba07">read_trigger_event</a>(<span class="keywordtype">char</span> *pevent)
{
TRIGGER_EVENT *ptrg;

  ptrg = (TRIGGER_EVENT *) pevent;
  ptrg-&gt;adc0 = &lt;...&gt;;
  ptrg-&gt;adc1 = &lt;...&gt;;
  ptrg-&gt;tdc0 = &lt;...&gt;;
  ptrg-&gt;tdc1 = &lt;...&gt;;

  <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(TRIGGER_EVENT);
</pre></div><p></p>
</td></tr>
</table>
<p><br/>
 Alternatively, the structure may be defined first in the ODB, under /Equipment/&lt;eqp_name&gt;/Variables, and supplied to the readout routine by the frontend program including "experim.h", as follows:</p>
<table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2">
<caption align="bottom">Example of structure from <b><a class="el" href="experim_8h.html">experim.h</a></b> for a fixed event </caption>
<tr>
<td style="vertical-align: top; text-align: center; background-color: rgb(255, 255, 153);"><p><span style="font-weight: bold;">C structure from <em><a class="el" href="experim_8h.html">experim.h</a>:</em> </span>  </p>
</td><td style="vertical-align: top; text-align: center; background-color: rgb(255, 255, 153);"><p><span style="font-weight: bold;">ASCII representation from <em><a class="el" href="experim_8h.html">experim.h</a></em> :</span>   </p>
</td></tr>
<tr>
<td><div class="fragment"><pre class="fragment"><span class="preprocessor">#define INFO_ODB_EVENT_DEFINED</span>
<span class="preprocessor"></span>
<span class="keyword">typedef</span> <span class="keyword">struct </span>{
  <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>     helicity;
  <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>     current_cycle;
  <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>     current_scan;
  <span class="keywordtype">double</span>    current_hel_thr;
  <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>     rf_state;
  <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>     fluor_monitor_counts;
  <span class="keywordtype">float</span>     epicsdev_set_v_;
  <span class="keywordtype">float</span>     epicsdev_read_v_;
  <span class="keywordtype">float</span>     campdev_set;
  <span class="keywordtype">float</span>     campdev_read;
  <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>     last_failed_thr_test;
} INFO_ODB_EVENT;
</pre></div> </td><td><div class="fragment"><pre class="fragment"><span class="preprocessor">#define INFO_ODB_EVENT_STR(_name)</span>
<span class="preprocessor"></span>           <span class="keywordtype">char</span> *_name[] = {\
<span class="stringliteral">&quot;[.]&quot;</span>,\
<span class="stringliteral">&quot;helicity = DWORD : 0&quot;</span>,\
<span class="stringliteral">&quot;current cycle = DWORD : 54&quot;</span>,\
<span class="stringliteral">&quot;current scan = DWORD : 5&quot;</span>,\
<span class="stringliteral">&quot;Current Hel thr = DOUBLE : 0&quot;</span>,\
<span class="stringliteral">&quot;RF state = DWORD : 0&quot;</span>,\
<span class="stringliteral">&quot;Fluor monitor counts = DWORD : 0&quot;</span>,\
<span class="stringliteral">&quot;EpicsDev Set(V) = FLOAT : 0&quot;</span>,\
<span class="stringliteral">&quot;EpicsDev Read(V) = FLOAT : 0&quot;</span>,\
<span class="stringliteral">&quot;Campdev set = FLOAT : 0&quot;</span>,\
<span class="stringliteral">&quot;Campdev read = FLOAT : 0&quot;</span>,\
<span class="stringliteral">&quot;last failed thr test = DWORD : 0&quot;</span>,\
<span class="stringliteral">&quot;&quot;</span>,\
NULL }
</pre></div> </td></tr>
</table>
<p><a class="anchor" id="FE_RO_ODB_example"></a> The <a class="el" href="FE_table.html">Equipment definition</a> for this fixed event might be : </p>
<div class="fragment"><pre class="fragment"> { <span class="stringliteral">&quot;Info ODB&quot;</span>,     <span class="comment">/* equipment name */</span>
    10, 0,         <span class="comment">/* event ID, trigger mask */</span>
    <span class="stringliteral">&quot;&quot;</span>,            <span class="comment">/* no banks sent */</span>
    <a class="code" href="group__mdefineh.html#ga58e919e4e401b299c1834be965c3e78c">EQ_PERIODIC</a>,   <span class="comment">/* equipment type */</span>
    0,             <span class="comment">/* interrupt source */</span>
    <span class="stringliteral">&quot;FIXED&quot;</span>,       <span class="comment">/* format */</span>
    TRUE,          <span class="comment">/* enabled */</span>
    RO_RUNNING | <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a> | 
          <a class="code" href="group__mdefineh.html#ga5b505930aa1fc780118b4fc75f771464">RO_EOR</a>,  <span class="comment">/* read when running; </span>
<span class="comment">                      send to odb */</span>
    500,           <span class="comment">/* polling period */</span>
    0,             <span class="comment">/* event limit */</span>
    0,             <span class="comment">/* number of sub-events */</span>
    0,             <span class="comment">/* log history */</span>
    <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>,
    info_odb,      <span class="comment">/* readout routine */</span>
    NULL,NULL,NULL,
  },
</pre></div><p>The <a class="el" href="frontend_8c.html">frontend.c</a> program would then include <a class="el" href="experim_8h.html">experim.h</a> to gain access to the structure. <br/>
It is a good idea to check the record size and/or create the record in the odb when using C structures from <a class="el" href="experim_8h.html">experim.h</a>, to make sure that the structure is identical in the odb to that in <a class="el" href="experim_8h.html">experim.h</a>. <br/>
 The <b> main program </b> might look like this:</p>
<div class="fragment"><pre class="fragment"><span class="comment">/* frontend.c */</span>
....

<span class="preprocessor">#include experim.h</span>
<span class="preprocessor"></span>
INFO_ODB_EVENT cyinfo;
INFO_ODB_EVENT_STR(info_odb_event_str);
HNDLE hInfo;
<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status, size;
<span class="keywordtype">char</span>   str_set[256];
....

sprintf(str_set,<span class="stringliteral">&quot;/Equipment/INFO ODB/Variables&quot;</span>);

<span class="comment">/* create record /Equipment/INFO ODB/Variables to make sure it exists  */</span>
 <span class="comment">/* find the key for info odb */</span>
  status = <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(hDB, 0, str_set, &amp;hInfo);
  <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
    {
      printf( <span class="stringliteral">&quot;Key %s not found; creating record for info odb\n&quot;</span>,str_set);
      status = <a class="code" href="group__odbfunctionc.html#ga59b971e77416b2b463e2e63f1b05342b">db_create_record</a>(hDB, 0, str_set, strcomb(info_odb_event_str));
    }
  <span class="comment">/* check the record size */</span>
  status = <a class="code" href="group__odbfunctionc.html#ga70b171dc66b0673fc9ed773fca31b7dc">db_get_record_size</a>(hDB, hInfo, 0, &amp;size);
  <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(INFO_ODB_EVENT) != size)
     {
        <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;bnmr_init&quot;</span>, <span class="stringliteral">&quot;error; record sizes do not match&quot;</span>);
        <span class="keywordflow">return</span> <a class="code" href="group__err23.html#gab284e13875988d7c16d30c8fe7597f5a">DB_TYPE_MISMATCH</a>;
     }

  .......    
</pre></div><p>A <b>readout routine</b> for this fixed event is as follows: </p>
<div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> info_odb(<span class="keywordtype">char</span> * pevent, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> off)
<span class="comment">/* - periodic equipment updating the ODB ONLY</span>
<span class="comment">   - no event generation for the data stream.</span>
<span class="comment">*/</span>
{

  <span class="comment">/* fill various values */</span>
  cyinfo.helicity = gbl_ppg_hel;
  cyinfo.current_cycle = gbl_CYCLE_N;
  cyinfo.current_scan = gbl_SCAN_N;
  cyinfo.epicsdev_set_v_ = epics_params.Epics_val;
  cyinfo.epicsdev_read_v_ = epics_params.Epics_read;
  cyinfo.campdev_set = 0;   
  cyinfo.campdev_read = 0; 
    

  memcpy(pevent, (<span class="keywordtype">char</span> *)&amp;(cyinfo.helicity), <span class="keyword">sizeof</span>(cyinfo));
  pevent += <span class="keyword">sizeof</span>(cyinfo);
  logMsg (<span class="stringliteral">&quot;info_odb %d size:%d\n&quot;</span>,gbl_CYCLE_N,<span class="keyword">sizeof</span>(cyinfo),0,0,0,0);
  <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(cyinfo);
}
</pre></div><p> <br/>
 The output from a FIXED event of this type sent to the ODB using <a class="el" href="RC_mhttpd_utility.html">mhttpd</a> is shown <a class="el" href="RC_mhttpd_status_page_features.html#RC_mhttpd_eq_variables">here</a>.</p>
<p>More <b>examples of FIXED events</b> can be found in the <b>slow controls device drivers</b>, for example ../examples/slowcont/frontend.c and ../drivers/class/hv.c</p>
<p><br/>
 <hr/>
 <br/>
 <a class="anchor" id="idx_event_readout_format_midas"></a> <a class="anchor" id="idx_Midas_event-construction"></a> </p>
<h2><a class="anchor" id="FE_MIDAS_event_construction">
MIDAS event construction</a></h2>
<p>The <a class="el" href="FE_Data_format.html#FE_Midas_format">MIDAS event format</a> is a variable length event format. It uses "banks" as subsets of an event. A bank is composed of a bank header followed by the data. The bank header itself is made of 3 fields i.e:</p>
<ul>
<li>bank name (4 characters)</li>
<li>bank type</li>
<li>bank length</li>
</ul>
<p>Usually a bank contains an array of values that logically belong together. For example, an experiment can generate an ADC bank, a TDC bank and a bank with trigger information. The length of a bank can vary from one event to another due to zero suppression from the hardware. Besides the variable data length support of the bank structure, another main advantage is the possibility for the analyzer to add more (calculated) banks during the analysis process to the event in process. After the first analysis stage, the event can contain in addition to the the raw ADC bank, a bank with calibrated ADC values called CADC for example. In this CADC bank the raw ADC values could be offset or gain-corrected.</p>
<hr/>
<h3><a class="anchor" id="FE_Midas_Data_Types">
Midas Data Types</a></h3>
<p>Midas defines its own <b> data types </b> for OS compatibility. It is suggested that you use them in order to ensure correct compilation when moving code from one OS to another.</p>
<p><em>float</em> and <em>double</em> retain OS definition.</p>
<ul>
<li>BYTE unsigned char</li>
<li>WORD unsigned short int (16bits word)</li>
<li>DWORD unsigned 32bits word</li>
<li>INT signed 32bits word</li>
<li>BOOL OS dependent.</li>
</ul>
<p>When defining a data type either in the frontend code for bank definition or in user code to define ODB variables, Midas requires the use of its own data type declaration. The list below shows the main Type IDentification to be used (refer to <a class="el" href="group__mdefineh.html">Midas Define</a> for complete listing):</p>
<ul>
<li>TID_BYTE unsigned byte 0 255</li>
<li>TID_SBYTE signed BYTE -128 127</li>
<li>TID_CHAR single character 0 255</li>
<li>TID_WORD two BYTE 0 65535</li>
<li>TID_SHORT signed WORD -32768 32767</li>
<li>TID_DWORD four bytes 0 2**32-1</li>
<li>TID_INT signed DWORD -2**31 2**31-1</li>
<li>TID_BOOL four bytes bool 0 1</li>
<li>TID_FLOAT four bytes float format</li>
<li>TID_DOUBLE eight bytes float format</li>
</ul>
<hr/>
 <a class="anchor" id="idx_Midas_bank"></a> </p>
<h3><a class="anchor" id="FE_creation_Midas_banks">
Creation of MIDAS banks</a></h3>
<p>MIDAS banks are created in the frontend readout code with calls to the MIDAS library. The following routines are available:</p>
<ul>
<li><a class="el" href="group__bkfunctionc.html#gac6fadde40824dbf7bd70abedd29be2bd">bk_init()</a> , <a class="el" href="group__bkfunctionc.html#gae7cbf587db63fcdf66dd18b29f08b6d2">bk_init32()</a> Initializes a bank structure in an event. <br/>
Note that bk_init32 can be used to reduce the size of very large banks, where the data will fit into a 32-bit word</li>
<li><a class="el" href="group__bkfunctionc.html#ga4bb781187e18834136ed8ac368d53413">bk_create()</a> Creates a bank with a given name (exactly four characters)</li>
<li><a class="el" href="group__bkfunctionc.html#ga132dc71c8f74b478cdcc59bc1d9f6a26">bk_close()</a> Closes a bank previously opened with <a class="el" href="group__bkfunctionc.html#ga4bb781187e18834136ed8ac368d53413">bk_create()</a>.</li>
<li><a class="el" href="group__bkfunctionc.html#gafe085ddb11bdcff4ca461224254289ef">bk_locate()</a> Locates a bank within an event by its name.</li>
<li><a class="el" href="group__bkfunctionc.html#gab6012589013da85b128d8443501a4a44">bk_iterate()</a> Returns bank and data pointers to each bank in the event.</li>
<li><a class="el" href="group__bkfunctionc.html#ga4d8a0ef23239ae478544fa96a0e98a33">bk_list()</a> Constructs a string with all the banks' names in the event.</li>
<li><a class="el" href="group__bkfunctionc.html#ga8fc93de36e62c4328cb6581be7f42a0f">bk_size()</a> Returns the size in bytes of all banks including the bank headers in an event.</li>
</ul>
<p><br/>
 Examples for VME and CAMAC hardware are shown here.</p>
<p>The VME example reads out a VME ADC module into one MIDAS bank. In the CAMAC example the event will contain two banks: one for the ADC data and one for the TDC data.</p>
<table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2">
<caption align="bottom">Readout routines showing Midas Bank construction </caption>
<tr>
<td style="vertical-align: top; text-align: center; background-color: rgb(255, 255, 153);"><p><span style="font-weight: bold;">VME :</span>  </p>
</td><td style="vertical-align: top; text-align: center; background-color: rgb(255, 255, 204);"><p><span style="font-weight: bold;">CAMAC :</span>  </p>
</td></tr>
<tr>
<td><div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="fevmemodules_8c.html#a9c54bafa1af403e5e4737f9d8d5aba07">read_trigger_event</a>(<span class="keywordtype">char</span> *pevent, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> off)
{
<span class="preprocessor">#if defined VADC0_CODE</span>
<span class="preprocessor"></span>  <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>  *pdata;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span> <a class="code" href="fevmemodules_8c.html#adb65a4e8d1413f7d40cc16e7118899ce">evlimit</a> = <a class="code" href="group__mbufferh.html#gadbb75a9d81e264e357bc5fc73dd4ebb8">SERIAL_NUMBER</a>(pevent);

<span class="preprocessor">#if defined VADC0_CODE</span>
<span class="preprocessor"></span>  <span class="comment">/* create structured ADC0 bank */</span>
  <a class="code" href="group__bkfunctionc.html#ga4bb781187e18834136ed8ac368d53413">bk_create</a>(pevent, <span class="stringliteral">&quot;ADC0&quot;</span>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, &amp;pdata);
  <a class="code" href="v792_8c.html#a93c9ec6788ab26b8dc1ca782761f91ac">v792_EvtCntRead</a>(myvme, VADC0_BASE, &amp;evtcnt);
  <span class="comment">/* Read Event */</span>
  <a class="code" href="v792_8c.html#a723985757a28f135d0b1224a85accb62">v792_EventRead</a>(myvme, VADC0_BASE, pdata, &amp;nentry);
  pdata += nentry;
  <a class="code" href="group__bkfunctionc.html#ga132dc71c8f74b478cdcc59bc1d9f6a26">bk_close</a>(pevent, pdata);
  <a class="code" href="v792_8c.html#a526dbfe955e68a6e982bb5a3345b74e3">v792_DataClear</a>(myvme, VADC0_BASE);
  <span class="keywordflow">return</span> <a class="code" href="group__bkfunctionc.html#ga8fc93de36e62c4328cb6581be7f42a0f">bk_size</a>(pevent);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keywordflow">return</span> 0; <span class="comment">/* no event */</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

}
</pre></div>  </td><td><p></p>
<div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="fevmemodules_8c.html#a9c54bafa1af403e5e4737f9d8d5aba07">read_trigger_event</a>(<span class="keywordtype">char</span> *pevent)
{
<a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> *pdata, a;

  <span class="comment">// init bank structure </span>
  <a class="code" href="group__bkfunctionc.html#gac6fadde40824dbf7bd70abedd29be2bd">bk_init</a>(pevent);

  <span class="comment">// create ADC bank </span>
  <a class="code" href="group__bkfunctionc.html#ga4bb781187e18834136ed8ac368d53413">bk_create</a>(pevent, <span class="stringliteral">&quot;ADC0&quot;</span>, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, &amp;pdata);

  <span class="comment">// read ADC bank </span>
  <span class="keywordflow">for</span> (a=0 ; a&lt;8 ; a++)
    <a class="code" href="group__mcstdfunctionh.html#ga859bdf77e425ce09a21c873a86c8af70">cami</a>(1, 1, a, 0, pdata++);

  <a class="code" href="group__bkfunctionc.html#ga132dc71c8f74b478cdcc59bc1d9f6a26">bk_close</a>(pevent, pdata);

  <span class="comment">// create TDC bank </span>
  <a class="code" href="group__bkfunctionc.html#ga4bb781187e18834136ed8ac368d53413">bk_create</a>(pevent, <span class="stringliteral">&quot;TDC0&quot;</span>, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, &amp;pdata);

  <span class="comment">// read TDC bank </span>
  <span class="keywordflow">for</span> (a=0 ; a&lt;8 ; a++)
    <a class="code" href="group__mcstdfunctionh.html#ga859bdf77e425ce09a21c873a86c8af70">cami</a>(1, 2, a, 0, pdata++);

  <a class="code" href="group__bkfunctionc.html#ga132dc71c8f74b478cdcc59bc1d9f6a26">bk_close</a>(pevent, pdata);

  <span class="keywordflow">return</span> <a class="code" href="group__bkfunctionc.html#ga8fc93de36e62c4328cb6581be7f42a0f">bk_size</a>(pevent);
</pre></div> </td></tr>
</table>
<p><br/>
</p>
<p>Upon normal completion, the readout routine returns the event size in bytes. If the event is not valid, the routine can return zero. In this case no event is sent to the back-end. This can be used to implement a software event filter (sometimes called "third level trigger").</p>
<p>Examples of unpacking the data from Midas banks are shown in the <a class="el" href="DataAnalysis.html">SECTION 7: Data Analysis</a> section.</p>
<p><br/>
 <hr/>
 <br/>
</p>
<h3><a class="anchor" id="FE_Midas_Event_Header_Manipulation">
Midas Event header manipulation</a></h3>
<p><a class="anchor" id="FE_Midas_Event_Header_Macros"></a> Every event travelling through the Midas system has a "Event Header" containing the minimum information required to identify its contents. The size of the header has been kept as small as possible in order to minimize its impact on the data rate as well as on the data storage requirment. The following Macros in the <a class="el" href="F_Midas_Code_and_Libraries.html#F_Midas_Library">MIDAS Code and Libraries</a> are available for manipulating Midas event headers. They permit reading or overrideing the content of the event header, as long as the argument of the macro refers to the top of the Midas event (pevent). This argument (pevent) is available in the frontend code in any of the user readout functions.</p>
<p>The Macros are also available to the user analyzer code, which retrieves the event and provide direct access to the event header (pheader) and to the user part of the event (pevent). Sub-functions using pevent would then be able to get back the header through the use of the macros.</p>
<ul>
<li><a class="el" href="group__mbufferh.html#ga6a0d6be5b8aad5a907d5b880bae93eb9">TRIGGER_MASK</a></li>
<li><a class="el" href="group__mbufferh.html#gaf42c9a1ac33cf459bfd366673f6a4d70">EVENT_ID</a></li>
<li><a class="el" href="group__mbufferh.html#gadbb75a9d81e264e357bc5fc73dd4ebb8">SERIAL_NUMBER</a></li>
<li><a class="el" href="group__mbufferh.html#gae8d2f03c283637c81cdcfd3fda065d53">TIME_STAMP</a></li>
</ul>
<p><a class="anchor" id="timestamp"></a> The following frontend C-code fragments from a running experiment demonstrate the use of these Macros :</p>
<ul>
<li>example 1 <div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> read_ge_event(<span class="keywordtype">char</span> *pevent, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> offset)
{
  <span class="keyword">static</span> <a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> *pdata;
  <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, x, q;
  <a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> temp;
 
  <span class="comment">// Change the time stamp in millisecond for the Super event</span>
  <a class="code" href="group__mbufferh.html#gae8d2f03c283637c81cdcfd3fda065d53">TIME_STAMP</a>(pevent) = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
  
  <a class="code" href="group__bkfunctionc.html#gac6fadde40824dbf7bd70abedd29be2bd">bk_init</a>(pevent);
  <a class="code" href="group__bkfunctionc.html#ga4bb781187e18834136ed8ac368d53413">bk_create</a>(pevent, <span class="stringliteral">&quot;GERM&quot;</span>, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, &amp;pdata);
  ...
}
</pre></div></li>
</ul>
<ul>
<li>example 2</li>
</ul>
<div class="fragment"><pre class="fragment">  ...
  lam = *((<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *)pevent);

  <span class="keywordflow">if</span> (lam &amp; <a class="code" href="group__midasincludecode.html#ga479219e07f43223f74ff8638705a804e">LAM_STATION</a>(JW_N))

  {
    ...
    <span class="comment">// compose event header</span>
    <a class="code" href="group__mbufferh.html#ga6a0d6be5b8aad5a907d5b880bae93eb9">TRIGGER_MASK</a>(pevent) = JW_MASK;
    <a class="code" href="group__mbufferh.html#gaf42c9a1ac33cf459bfd366673f6a4d70">EVENT_ID</a>(pevent)     = JW_ID;
    <a class="code" href="group__mbufferh.html#gadbb75a9d81e264e357bc5fc73dd4ebb8">SERIAL_NUMBER</a>(pevent)= eq-&gt;serial_number++;
    <span class="comment">// read MCS event</span>
    size = read_mcs_event(pevent);
    <span class="comment">// Correct serial in case event is empty </span>
    <span class="keywordflow">if</span> (size == 0)
      <a class="code" href="group__mbufferh.html#gadbb75a9d81e264e357bc5fc73dd4ebb8">SERIAL_NUMBER</a>(pevent) = eq-&gt;serial_number--;
    ...
  }
  ...
</pre></div><hr/>
 <br/>
</p>
 
<script type="text/javascript">
pages("FE_event_notification",  "FrontendOperation","FE_Super_Event", "FE_bank_construction","" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("RunControl","FrontendOperation","DataAnalysis");
</script>
<p><br/>
 <a class="anchor" id="end"></a> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

