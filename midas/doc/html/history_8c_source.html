<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: history.c Source File</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_967645259cf3504d40df5943f0783e6b.html">src</a>
  </div>
</div>
<div class="contents">
<h1>history.c</h1><a href="history_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         HISTORY.C</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     MIDAS history functions</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  $Id: history.c 5041 2011-06-04 03:23:04Z ritt $</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">\********************************************************************/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="msystem_8h.html">msystem.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;strlcpy.h&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">/** @defgroup hsfunctioncode Midas History Functions (hs_xxx)</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">/**dox***************************************************************/</span><span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">/** @addtogroup hsfunctioncode</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> *  @{  */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#if !defined(OS_VXWORKS)</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="comment">/********************************************************************\</span>
<a name="l00027"></a>00027 <span class="comment">*                                                                    *</span>
<a name="l00028"></a>00028 <span class="comment">*                 History functions                                  *</span>
<a name="l00029"></a>00029 <span class="comment">*                                                                    *</span>
<a name="l00030"></a>00030 <span class="comment">\********************************************************************/</span>
<a name="l00031"></a>00031 <span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">/**dox***************************************************************/</span>
<a name="l00033"></a>00033 <span class="preprocessor">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00035"></a>00035 <span class="keyword">static</span> <a class="code" href="structHISTORY.html">HISTORY</a> *_history;
<a name="l00036"></a>00036 <span class="keyword">static</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> _history_entries = 0;
<a name="l00037"></a>00037 <span class="keyword">static</span> <span class="keywordtype">char</span> _hs_path_name[MAX_STRING_LENGTH];
<a name="l00038"></a>00038 <span class="comment"></span>
<a name="l00039"></a>00039 <span class="comment">/**dox***************************************************************/</span>
<a name="l00040"></a>00040 <span class="preprocessor">#endif                          </span><span class="comment">/* DOXYGEN_SHOULD_SKIP_THIS */</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">/********************************************************************/</span><span class="comment"></span>
<a name="l00043"></a>00043 <span class="comment">/**</span>
<a name="l00044"></a>00044 <span class="comment">Sets the path for future history file accesses. Should</span>
<a name="l00045"></a>00045 <span class="comment">be called before any other history function is called.</span>
<a name="l00046"></a>00046 <span class="comment">@param path             Directory where history files reside</span>
<a name="l00047"></a>00047 <span class="comment">@return HS_SUCCESS</span>
<a name="l00048"></a>00048 <span class="comment">*/</span>
<a name="l00049"></a><a class="code" href="group__hsfunctioncode.html#gadd381765666fd1aa3395b63b86d44887">00049</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="group__hsfunctioncode.html#gadd381765666fd1aa3395b63b86d44887">hs_set_path</a>(<span class="keywordtype">char</span> *path)
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051    <span class="comment">/* set path locally and remotely */</span>
<a name="l00052"></a>00052    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l00053"></a>00053       rpc_call(<a class="code" href="group__mrpcdefineh.html#gae96ac179fd36bfa722adab529b8d547e">RPC_HS_SET_PATH</a>, path);
<a name="l00054"></a>00054 
<a name="l00055"></a>00055    strcpy(_hs_path_name, path);
<a name="l00056"></a>00056 
<a name="l00057"></a>00057    <span class="comment">/* check for trailing directory seperator */</span>
<a name="l00058"></a>00058    <span class="keywordflow">if</span> (strlen(_hs_path_name) &gt; 0 &amp;&amp; _hs_path_name[strlen(_hs_path_name) - 1] != DIR_SEPARATOR)
<a name="l00059"></a>00059       strcat(_hs_path_name, DIR_SEPARATOR_STR);
<a name="l00060"></a>00060 
<a name="l00061"></a>00061    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 <span class="comment"></span>
<a name="l00064"></a>00064 <span class="comment">/**dox***************************************************************/</span>
<a name="l00065"></a>00065 <span class="preprocessor">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a>00067 <span class="comment">/********************************************************************/</span>
<a name="l00068"></a>00068 <span class="comment"></span>
<a name="l00069"></a>00069 <span class="comment">/**</span>
<a name="l00070"></a>00070 <span class="comment">Open history file belonging to certain date. Internal use</span>
<a name="l00071"></a>00071 <span class="comment">           only.</span>
<a name="l00072"></a>00072 <span class="comment">@param ltime          Date for which a history file should be opened.</span>
<a name="l00073"></a>00073 <span class="comment">@param suffix         File name suffix like &quot;hst&quot;, &quot;idx&quot;, &quot;idf&quot;</span>
<a name="l00074"></a>00074 <span class="comment">@param mode           R/W access mode</span>
<a name="l00075"></a>00075 <span class="comment">@param fh             File handle</span>
<a name="l00076"></a>00076 <span class="comment">@return HS_SUCCESS</span>
<a name="l00077"></a>00077 <span class="comment">*/</span>
<a name="l00078"></a>00078 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_open_file(time_t ltime, <span class="keywordtype">char</span> *suffix, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> mode, <span class="keywordtype">int</span> *fh)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080    <span class="keyword">struct </span>tm *tms;
<a name="l00081"></a>00081    <span class="keywordtype">char</span> file_name[256];
<a name="l00082"></a>00082    time_t ttime;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084    <span class="comment">/* generate new file name YYMMDD.xxx */</span>
<a name="l00085"></a>00085 <span class="preprocessor">#if !defined(OS_VXWORKS)</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">#if !defined(OS_VMS)</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>   tzset();
<a name="l00088"></a>00088 <span class="preprocessor">#endif</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>   ttime = (time_t) ltime;
<a name="l00091"></a>00091    tms = localtime(&amp;ttime);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093    sprintf(file_name, <span class="stringliteral">&quot;%s%02d%02d%02d.%s&quot;</span>, _hs_path_name, tms-&gt;tm_year % 100, tms-&gt;tm_mon + 1, tms-&gt;tm_mday, suffix);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095    <span class="comment">/* open file, add O_BINARY flag for Windows NT */</span>
<a name="l00096"></a>00096    *fh = open(file_name, mode | O_BINARY, 0644);
<a name="l00097"></a>00097 
<a name="l00098"></a>00098    <span class="comment">//printf(&quot;hs_open_file: time %d, file \&apos;%s\&apos;, fh %d\n&quot;, (int)ltime, file_name, *fh);</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="comment">/********************************************************************/</span>
<a name="l00104"></a>00104 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_gen_index(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime)
<a name="l00105"></a>00105 <span class="comment">/********************************************************************\</span>
<a name="l00106"></a>00106 <span class="comment"></span>
<a name="l00107"></a>00107 <span class="comment">  Routine: hs_gen_index</span>
<a name="l00108"></a>00108 <span class="comment"></span>
<a name="l00109"></a>00109 <span class="comment">  Purpose: Regenerate index files (&quot;idx&quot; and &quot;idf&quot; files) for a given</span>
<a name="l00110"></a>00110 <span class="comment">           history file (&quot;hst&quot;). Interal use only.</span>
<a name="l00111"></a>00111 <span class="comment"></span>
<a name="l00112"></a>00112 <span class="comment">  Input:</span>
<a name="l00113"></a>00113 <span class="comment">    time_t ltime            Date for which a history file should</span>
<a name="l00114"></a>00114 <span class="comment">                            be analyzed.</span>
<a name="l00115"></a>00115 <span class="comment"></span>
<a name="l00116"></a>00116 <span class="comment">  Output:</span>
<a name="l00117"></a>00117 <span class="comment">    none</span>
<a name="l00118"></a>00118 <span class="comment"></span>
<a name="l00119"></a>00119 <span class="comment">  Function value:</span>
<a name="l00120"></a>00120 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00121"></a>00121 <span class="comment">    HS_FILE_ERROR           Index files cannot be created</span>
<a name="l00122"></a>00122 <span class="comment"></span>
<a name="l00123"></a>00123 <span class="comment">\********************************************************************/</span>
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125    <span class="keywordtype">char</span> event_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l00126"></a>00126    <span class="keywordtype">int</span> fh, fhd, fhi;
<a name="l00127"></a>00127    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> n;
<a name="l00128"></a>00128    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec;
<a name="l00129"></a>00129    <a class="code" href="structINDEX__RECORD.html">INDEX_RECORD</a> irec;
<a name="l00130"></a>00130    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l00131"></a>00131    <span class="keywordtype">int</span> recovering = 0;
<a name="l00132"></a>00132    <span class="comment">//time_t now = time(NULL);</span>
<a name="l00133"></a>00133 
<a name="l00134"></a>00134    <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;hs_gen_index&quot;</span>, <span class="stringliteral">&quot;generating index files for time %d&quot;</span>, (<span class="keywordtype">int</span>) ltime);
<a name="l00135"></a>00135    printf(<span class="stringliteral">&quot;Recovering index files...\n&quot;</span>);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137    <span class="keywordflow">if</span> (ltime == 0)
<a name="l00138"></a>00138       ltime = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140    <span class="comment">/* open new index file */</span>
<a name="l00141"></a>00141    hs_open_file(ltime, <span class="stringliteral">&quot;idx&quot;</span>, O_RDWR | O_CREAT | O_TRUNC, &amp;fhi);
<a name="l00142"></a>00142    hs_open_file(ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDWR | O_CREAT | O_TRUNC, &amp;fhd);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144    <span class="keywordflow">if</span> (fhd &lt; 0 || fhi &lt; 0) {
<a name="l00145"></a>00145       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_gen_index&quot;</span>, <span class="stringliteral">&quot;cannot create index file&quot;</span>);
<a name="l00146"></a>00146       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00147"></a>00147    }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="comment">/* open history file */</span>
<a name="l00150"></a>00150    hs_open_file(ltime, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l00151"></a>00151    <span class="keywordflow">if</span> (fh &lt; 0)
<a name="l00152"></a>00152       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00153"></a>00153    lseek(fh, 0, SEEK_SET);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155    <span class="comment">/* loop over file records in .hst file */</span>
<a name="l00156"></a>00156    <span class="keywordflow">do</span> {
<a name="l00157"></a>00157       n = read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l00158"></a>00158       <span class="comment">//printf(&quot;read %d\n&quot;, n);</span>
<a name="l00159"></a>00159       <span class="keywordflow">if</span> (n &lt; <span class="keyword">sizeof</span>(rec))
<a name="l00160"></a>00160          <span class="keywordflow">break</span>;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162       <span class="comment">/* check if record type is definition */</span>
<a name="l00163"></a>00163       <span class="keywordflow">if</span> (rec.record_type == <a class="code" href="group__mhistoryh.html#ga53bf0d0c21b64cf42e4355c3919f6fa2">RT_DEF</a>) {
<a name="l00164"></a>00164          <span class="comment">/* read name */</span>
<a name="l00165"></a>00165          read(fh, event_name, <span class="keyword">sizeof</span>(event_name));
<a name="l00166"></a>00166 
<a name="l00167"></a>00167          printf(<span class="stringliteral">&quot;Event definition %s, ID %d\n&quot;</span>, event_name, rec.event_id);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169          <span class="comment">/* write definition index record */</span>
<a name="l00170"></a>00170          def_rec.<a class="code" href="structDEF__RECORD.html#a9d9787264de717f2512af5e7d48e5a32">event_id</a> = rec.event_id;
<a name="l00171"></a>00171          memcpy(def_rec.<a class="code" href="structDEF__RECORD.html#ad4fdebc35644bab90bbe3164176690cf">event_name</a>, event_name, <span class="keyword">sizeof</span>(event_name));
<a name="l00172"></a>00172          def_rec.<a class="code" href="structDEF__RECORD.html#a3368ac2be8ed74559ed9ef115756f5e7">def_offset</a> = TELL(fh) - <span class="keyword">sizeof</span>(event_name) - <span class="keyword">sizeof</span>(rec);
<a name="l00173"></a>00173          write(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00174"></a>00174 
<a name="l00175"></a>00175          <span class="comment">//printf(&quot;data def at %d (age %d)\n&quot;, rec.time, now-rec.time);</span>
<a name="l00176"></a>00176 
<a name="l00177"></a>00177          <span class="comment">/* skip tags */</span>
<a name="l00178"></a>00178          lseek(fh, rec.data_size, SEEK_CUR);
<a name="l00179"></a>00179       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rec.record_type == <a class="code" href="group__mhistoryh.html#gaa8c3f42edf394b6d0fd9f1c3e00fe948">RT_DATA</a> &amp;&amp; rec.data_size &gt; 1 &amp;&amp; rec.data_size &lt; 1 * 1024 * 1024) {
<a name="l00180"></a>00180          <span class="comment">/* write index record */</span>
<a name="l00181"></a>00181          irec.<a class="code" href="structINDEX__RECORD.html#ab893c0617053652c09947d7d24740f27">event_id</a> = rec.event_id;
<a name="l00182"></a>00182          irec.<a class="code" href="structINDEX__RECORD.html#a729b9b6590da0af9a8c9984d0d58a8d7">time</a> = rec.time;
<a name="l00183"></a>00183          irec.<a class="code" href="structINDEX__RECORD.html#aa5cd05f92f95ebccc6f2c7fdf3b3f1a9">offset</a> = TELL(fh) - <span class="keyword">sizeof</span>(rec);
<a name="l00184"></a>00184          write(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l00185"></a>00185 
<a name="l00186"></a>00186          <span class="comment">//printf(&quot;data rec at %d (age %d)\n&quot;, rec.time, now-rec.time);</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188          <span class="comment">/* skip data */</span>
<a name="l00189"></a>00189          lseek(fh, rec.data_size, SEEK_CUR);
<a name="l00190"></a>00190       } <span class="keywordflow">else</span> {
<a name="l00191"></a>00191          <span class="keywordflow">if</span> (!recovering)
<a name="l00192"></a>00192             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_gen_index&quot;</span>, <span class="stringliteral">&quot;broken history file for time %d, trying to recover&quot;</span>, (<span class="keywordtype">int</span>) ltime);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194          recovering = 1;
<a name="l00195"></a>00195          lseek(fh, 1 - <span class="keyword">sizeof</span>(rec), SEEK_CUR);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197          <span class="keywordflow">continue</span>;
<a name="l00198"></a>00198       }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200    } <span class="keywordflow">while</span> (TRUE);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202    close(fh);
<a name="l00203"></a>00203    close(fhi);
<a name="l00204"></a>00204    close(fhd);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206    printf(<span class="stringliteral">&quot;...done.\n&quot;</span>);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="comment">/********************************************************************/</span>
<a name="l00213"></a>00213 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_search_file(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * ltime, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> direction)
<a name="l00214"></a>00214 <span class="comment">/********************************************************************\</span>
<a name="l00215"></a>00215 <span class="comment"></span>
<a name="l00216"></a>00216 <span class="comment">  Routine: hs_search_file</span>
<a name="l00217"></a>00217 <span class="comment"></span>
<a name="l00218"></a>00218 <span class="comment">  Purpose: Search an history file for a given date. If not found,</span>
<a name="l00219"></a>00219 <span class="comment">           look for files after date (direction==1) or before date</span>
<a name="l00220"></a>00220 <span class="comment">           (direction==-1) up to one year.</span>
<a name="l00221"></a>00221 <span class="comment"></span>
<a name="l00222"></a>00222 <span class="comment">  Input:</span>
<a name="l00223"></a>00223 <span class="comment">    DWORD  *ltime           Date of history file</span>
<a name="l00224"></a>00224 <span class="comment">    INT    direction        Search direction</span>
<a name="l00225"></a>00225 <span class="comment"></span>
<a name="l00226"></a>00226 <span class="comment">  Output:</span>
<a name="l00227"></a>00227 <span class="comment">    DWORD  *ltime           Date of history file found</span>
<a name="l00228"></a>00228 <span class="comment"></span>
<a name="l00229"></a>00229 <span class="comment">  Function value:</span>
<a name="l00230"></a>00230 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00231"></a>00231 <span class="comment">    HS_FILE_ERROR           No file found</span>
<a name="l00232"></a>00232 <span class="comment"></span>
<a name="l00233"></a>00233 <span class="comment">\********************************************************************/</span>
<a name="l00234"></a>00234 {
<a name="l00235"></a>00235    time_t lt;
<a name="l00236"></a>00236    <span class="keywordtype">int</span> fh, fhd, fhi;
<a name="l00237"></a>00237    <span class="keyword">struct </span>tm *tms;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239    <span class="keywordflow">if</span> (*ltime == 0)
<a name="l00240"></a>00240       *ltime = <a class="code" href="group__msfunctionc.html#gab7852119bd4dc1e08aa03127d8ca008b">ss_time</a>();
<a name="l00241"></a>00241 
<a name="l00242"></a>00242    lt = (time_t) * ltime;
<a name="l00243"></a>00243    <span class="keywordflow">do</span> {
<a name="l00244"></a>00244       <span class="comment">/* try to open history file for date &quot;lt&quot; */</span>
<a name="l00245"></a>00245       hs_open_file(lt, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247       <span class="comment">/* if not found, look for next day */</span>
<a name="l00248"></a>00248       <span class="keywordflow">if</span> (fh &lt; 0)
<a name="l00249"></a>00249          lt += direction * 3600 * 24;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251       <span class="comment">/* stop if more than a year before starting point or in the future */</span>
<a name="l00252"></a>00252    } <span class="keywordflow">while</span> (fh &lt; 0 &amp;&amp; (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) * ltime - (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) lt &lt; 3600 * 24 * 365 &amp;&amp; lt &lt;= (time_t) <a class="code" href="group__msfunctionc.html#gab7852119bd4dc1e08aa03127d8ca008b">ss_time</a>());
<a name="l00253"></a>00253 
<a name="l00254"></a>00254    <span class="keywordflow">if</span> (fh &lt; 0)
<a name="l00255"></a>00255       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    <span class="keywordflow">if</span> (lt != *ltime) {
<a name="l00258"></a>00258       <span class="comment">/* if switched to new day, set start_time to 0:00 */</span>
<a name="l00259"></a>00259       tms = localtime(&amp;lt);
<a name="l00260"></a>00260       tms-&gt;tm_hour = tms-&gt;tm_min = tms-&gt;tm_sec = 0;
<a name="l00261"></a>00261       *ltime = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) mktime(tms);
<a name="l00262"></a>00262    }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264    <span class="comment">/* check if index files are there */</span>
<a name="l00265"></a>00265    hs_open_file(*ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l00266"></a>00266    hs_open_file(*ltime, <span class="stringliteral">&quot;idx&quot;</span>, O_RDONLY, &amp;fhi);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268    close(fh);
<a name="l00269"></a>00269    <span class="keywordflow">if</span> (fhd &gt; 0)
<a name="l00270"></a>00270       close(fhd);
<a name="l00271"></a>00271    <span class="keywordflow">if</span> (fhi &gt; 0)
<a name="l00272"></a>00272       close(fhi);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274    <span class="comment">/* generate them if not */</span>
<a name="l00275"></a>00275    <span class="keywordflow">if</span> (fhd &lt; 0 || fhi &lt; 0)
<a name="l00276"></a>00276       hs_gen_index(*ltime);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="comment">/********************************************************************/</span>
<a name="l00283"></a>00283 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_define_event(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <span class="keywordtype">char</span> *name, <a class="code" href="structTAG.html">TAG</a> * tag, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> size)
<a name="l00284"></a>00284 <span class="comment">/********************************************************************\</span>
<a name="l00285"></a>00285 <span class="comment"></span>
<a name="l00286"></a>00286 <span class="comment">  Routine: hs_define_event</span>
<a name="l00287"></a>00287 <span class="comment"></span>
<a name="l00288"></a>00288 <span class="comment">  Purpose: Define a new event for which a history should be recorded.</span>
<a name="l00289"></a>00289 <span class="comment">           This routine must be called before any call to</span>
<a name="l00290"></a>00290 <span class="comment">           hs_write_event. It also should be called if the definition</span>
<a name="l00291"></a>00291 <span class="comment">           of the event has changed.</span>
<a name="l00292"></a>00292 <span class="comment"></span>
<a name="l00293"></a>00293 <span class="comment">           The event definition is written directly to the history</span>
<a name="l00294"></a>00294 <span class="comment">           file. If the definition is identical to a previous</span>
<a name="l00295"></a>00295 <span class="comment">           definition, it is not written to the file.</span>
<a name="l00296"></a>00296 <span class="comment"></span>
<a name="l00297"></a>00297 <span class="comment"></span>
<a name="l00298"></a>00298 <span class="comment">  Input:</span>
<a name="l00299"></a>00299 <span class="comment">    DWORD  event_id         ID for this event. Must be unique.</span>
<a name="l00300"></a>00300 <span class="comment">    char   name             Name of this event</span>
<a name="l00301"></a>00301 <span class="comment">    TAG    tag              Tag list containing names and types of</span>
<a name="l00302"></a>00302 <span class="comment">                            variables in this event.</span>
<a name="l00303"></a>00303 <span class="comment">    DWORD  size             Size of tag array</span>
<a name="l00304"></a>00304 <span class="comment"></span>
<a name="l00305"></a>00305 <span class="comment">  Output:</span>
<a name="l00306"></a>00306 <span class="comment">    &lt;none&gt;</span>
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">  Function value:</span>
<a name="l00309"></a>00309 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00310"></a>00310 <span class="comment">    HS_NO_MEMEORY           Out of memory</span>
<a name="l00311"></a>00311 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l00312"></a>00312 <span class="comment"></span>
<a name="l00313"></a>00313 <span class="comment">\********************************************************************/</span>
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315 <span class="comment">/* History events are only written locally (?)</span>
<a name="l00316"></a>00316 <span class="comment"></span>
<a name="l00317"></a>00317 <span class="comment">  if (rpc_is_remote())</span>
<a name="l00318"></a>00318 <span class="comment">    return rpc_call(RPC_HS_DEFINE_EVENT, event_id, name, tag, size);</span>
<a name="l00319"></a>00319 <span class="comment">*/</span>
<a name="l00320"></a>00320    {
<a name="l00321"></a>00321       <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec, prev_rec;
<a name="l00322"></a>00322       <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l00323"></a>00323       time_t ltime;
<a name="l00324"></a>00324       <span class="keywordtype">char</span> str[256], event_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>], *buffer;
<a name="l00325"></a>00325       <span class="keywordtype">int</span> fh, fhi, fhd;
<a name="l00326"></a>00326       <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, n, len, index, status, semaphore;
<a name="l00327"></a>00327       <span class="keyword">struct </span>tm *tmb;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329       <span class="comment">/* request semaphore */</span>
<a name="l00330"></a>00330       cm_get_experiment_semaphore(NULL, NULL, &amp;semaphore, NULL);
<a name="l00331"></a>00331       status = ss_semaphore_wait_for(semaphore, 5 * 1000);
<a name="l00332"></a>00332       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>)
<a name="l00333"></a>00333          <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;        <span class="comment">/* someone else blocked the history system */</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335       <span class="comment">/* allocate new space for the new history descriptor */</span>
<a name="l00336"></a>00336       <span class="keywordflow">if</span> (_history_entries == 0) {
<a name="l00337"></a>00337          _history = (<a class="code" href="structHISTORY.html">HISTORY</a> *) M_MALLOC(<span class="keyword">sizeof</span>(<a class="code" href="structHISTORY.html">HISTORY</a>));
<a name="l00338"></a>00338          memset(_history, 0, <span class="keyword">sizeof</span>(<a class="code" href="structHISTORY.html">HISTORY</a>));
<a name="l00339"></a>00339          <span class="keywordflow">if</span> (_history == NULL) {
<a name="l00340"></a>00340             ss_semaphore_release(semaphore);
<a name="l00341"></a>00341             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga8d2556d6b5d8902646a36e3aa7e71dc5">HS_NO_MEMORY</a>;
<a name="l00342"></a>00342          }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344          _history_entries = 1;
<a name="l00345"></a>00345          index = 0;
<a name="l00346"></a>00346       } <span class="keywordflow">else</span> {
<a name="l00347"></a>00347          <span class="comment">/* check if history already open */</span>
<a name="l00348"></a>00348          <span class="keywordflow">for</span> (i = 0; i &lt; _history_entries; i++)
<a name="l00349"></a>00349             <span class="keywordflow">if</span> (_history[i].event_id == event_id)
<a name="l00350"></a>00350                <span class="keywordflow">break</span>;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352          <span class="comment">/* if not found, create new one */</span>
<a name="l00353"></a>00353          <span class="keywordflow">if</span> (i == _history_entries) {
<a name="l00354"></a>00354             _history = (<a class="code" href="structHISTORY.html">HISTORY</a> *) realloc(_history, <span class="keyword">sizeof</span>(<a class="code" href="structHISTORY.html">HISTORY</a>) * (_history_entries + 1));
<a name="l00355"></a>00355             memset(&amp;_history[_history_entries], 0, <span class="keyword">sizeof</span>(<a class="code" href="structHISTORY.html">HISTORY</a>));
<a name="l00356"></a>00356 
<a name="l00357"></a>00357             _history_entries++;
<a name="l00358"></a>00358             <span class="keywordflow">if</span> (_history == NULL) {
<a name="l00359"></a>00359                _history_entries--;
<a name="l00360"></a>00360                ss_semaphore_release(semaphore);
<a name="l00361"></a>00361                <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga8d2556d6b5d8902646a36e3aa7e71dc5">HS_NO_MEMORY</a>;
<a name="l00362"></a>00362             }
<a name="l00363"></a>00363          }
<a name="l00364"></a>00364          index = i;
<a name="l00365"></a>00365       }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367       <span class="comment">/* assemble definition record header */</span>
<a name="l00368"></a>00368       rec.<a class="code" href="structHIST__RECORD.html#a455da5efe0b4d3844e387e440b86302d">record_type</a> = <a class="code" href="group__mhistoryh.html#ga53bf0d0c21b64cf42e4355c3919f6fa2">RT_DEF</a>;
<a name="l00369"></a>00369       rec.<a class="code" href="structHIST__RECORD.html#af0b5331f4cf74267721acd101a7cdfef">event_id</a> = event_id;
<a name="l00370"></a>00370       rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a> = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL);
<a name="l00371"></a>00371       rec.<a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a> = size;
<a name="l00372"></a>00372       strncpy(event_name, name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374       <span class="comment">/* pad tag names with zeos */</span>
<a name="l00375"></a>00375       <span class="keywordflow">for</span> (i = 0; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) i &lt; size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>); i++) {
<a name="l00376"></a>00376          len = strlen(tag[i].name);
<a name="l00377"></a>00377          memset(tag[i].name + len, 0, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a> - len);
<a name="l00378"></a>00378       }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380       <span class="comment">/* if history structure not set up, do so now */</span>
<a name="l00381"></a>00381       <span class="keywordflow">if</span> (!_history[index].hist_fh) {
<a name="l00382"></a>00382          <span class="comment">/* open history file */</span>
<a name="l00383"></a>00383          hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;hst&quot;</span>, O_CREAT | O_RDWR, &amp;fh);
<a name="l00384"></a>00384          <span class="keywordflow">if</span> (fh &lt; 0) {
<a name="l00385"></a>00385             ss_semaphore_release(semaphore);
<a name="l00386"></a>00386             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00387"></a>00387          }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389          <span class="comment">/* open index files */</span>
<a name="l00390"></a>00390          hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;idf&quot;</span>, O_CREAT | O_RDWR, &amp;fhd);
<a name="l00391"></a>00391          hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;idx&quot;</span>, O_CREAT | O_RDWR, &amp;fhi);
<a name="l00392"></a>00392          lseek(fh, 0, SEEK_END);
<a name="l00393"></a>00393          lseek(fhi, 0, SEEK_END);
<a name="l00394"></a>00394          lseek(fhd, 0, SEEK_END);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396          <span class="comment">/* regenerate index if missing */</span>
<a name="l00397"></a>00397          <span class="keywordflow">if</span> (TELL(fh) &gt; 0 &amp;&amp; TELL(fhd) == 0) {
<a name="l00398"></a>00398             close(fh);
<a name="l00399"></a>00399             close(fhi);
<a name="l00400"></a>00400             close(fhd);
<a name="l00401"></a>00401             hs_gen_index(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>);
<a name="l00402"></a>00402             hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;hst&quot;</span>, O_RDWR, &amp;fh);
<a name="l00403"></a>00403             hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;idx&quot;</span>, O_RDWR, &amp;fhi);
<a name="l00404"></a>00404             hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;idf&quot;</span>, O_RDWR, &amp;fhd);
<a name="l00405"></a>00405             lseek(fh, 0, SEEK_END);
<a name="l00406"></a>00406             lseek(fhi, 0, SEEK_END);
<a name="l00407"></a>00407             lseek(fhd, 0, SEEK_END);
<a name="l00408"></a>00408          }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410          ltime = (time_t) rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>;
<a name="l00411"></a>00411          tmb = localtime(&amp;ltime);
<a name="l00412"></a>00412          tmb-&gt;tm_hour = tmb-&gt;tm_min = tmb-&gt;tm_sec = 0;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414          <span class="comment">/* setup history structure */</span>
<a name="l00415"></a>00415          _history[index].<a class="code" href="structHISTORY.html#a79a69e6f7ee9000ef228992c63fa1b17">hist_fh</a> = fh;
<a name="l00416"></a>00416          _history[index].<a class="code" href="structHISTORY.html#a09233da06a1c7e441bd32f6230e80657">index_fh</a> = fhi;
<a name="l00417"></a>00417          _history[index].<a class="code" href="structHISTORY.html#acbcd08fbd4a1a660d097850b410d80ac">def_fh</a> = fhd;
<a name="l00418"></a>00418          _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a> = TELL(fh);
<a name="l00419"></a>00419          _history[index].<a class="code" href="structHISTORY.html#a322ce5ffb593fad70e8c2057d3835b5a">event_id</a> = event_id;
<a name="l00420"></a>00420          strcpy(_history[index].event_name, event_name);
<a name="l00421"></a>00421          _history[index].<a class="code" href="structHISTORY.html#a7bc815860465a4962450eb181ab6a6e3">base_time</a> = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) mktime(tmb);
<a name="l00422"></a>00422          _history[index].<a class="code" href="structHISTORY.html#aa4e80312dae8b75b2c05c697e6ee5951">n_tag</a> = size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>);
<a name="l00423"></a>00423          _history[index].<a class="code" href="structHISTORY.html#abef679759fcdaa44b47213a6ad972a77">tag</a> = (<a class="code" href="structTAG.html">TAG</a> *) M_MALLOC(size);
<a name="l00424"></a>00424          memcpy(_history[index].tag, tag, size);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426          <span class="comment">/* search previous definition */</span>
<a name="l00427"></a>00427          n = TELL(fhd) / <span class="keyword">sizeof</span>(def_rec);
<a name="l00428"></a>00428          def_rec.<a class="code" href="structDEF__RECORD.html#a9d9787264de717f2512af5e7d48e5a32">event_id</a> = 0;
<a name="l00429"></a>00429          <span class="keywordflow">for</span> (i = n - 1; i &gt;= 0; i--) {
<a name="l00430"></a>00430             lseek(fhd, i * <span class="keyword">sizeof</span>(def_rec), SEEK_SET);
<a name="l00431"></a>00431             read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00432"></a>00432             <span class="keywordflow">if</span> (def_rec.event_id == event_id)
<a name="l00433"></a>00433                <span class="keywordflow">break</span>;
<a name="l00434"></a>00434          }
<a name="l00435"></a>00435          lseek(fhd, 0, SEEK_END);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437          <span class="comment">/* if definition found, compare it with new one */</span>
<a name="l00438"></a>00438          <span class="keywordflow">if</span> (def_rec.event_id == event_id) {
<a name="l00439"></a>00439             buffer = (<span class="keywordtype">char</span> *) M_MALLOC(size);
<a name="l00440"></a>00440             memset(buffer, 0, size);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442             lseek(fh, def_rec.def_offset, SEEK_SET);
<a name="l00443"></a>00443             read(fh, (<span class="keywordtype">char</span> *) &amp;prev_rec, <span class="keyword">sizeof</span>(prev_rec));
<a name="l00444"></a>00444             read(fh, str, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l00445"></a>00445             read(fh, buffer, size);
<a name="l00446"></a>00446             lseek(fh, 0, SEEK_END);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448             <span class="keywordflow">if</span> (prev_rec.data_size != size || strcmp(str, event_name) != 0 || memcmp(buffer, tag, size) != 0) {
<a name="l00449"></a>00449                <span class="comment">/* write definition to history file */</span>
<a name="l00450"></a>00450                write(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l00451"></a>00451                write(fh, event_name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l00452"></a>00452                write(fh, (<span class="keywordtype">char</span> *) tag, size);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454                <span class="comment">/* write index record */</span>
<a name="l00455"></a>00455                def_rec.event_id = event_id;
<a name="l00456"></a>00456                memcpy(def_rec.event_name, event_name, <span class="keyword">sizeof</span>(event_name));
<a name="l00457"></a>00457                def_rec.def_offset = _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a>;
<a name="l00458"></a>00458                write(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00459"></a>00459             } <span class="keywordflow">else</span>
<a name="l00460"></a>00460                <span class="comment">/* definition identical, just remember old offset */</span>
<a name="l00461"></a>00461                _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a> = def_rec.def_offset;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463             M_FREE(buffer);
<a name="l00464"></a>00464          } <span class="keywordflow">else</span> {
<a name="l00465"></a>00465             <span class="comment">/* write definition to history file */</span>
<a name="l00466"></a>00466             write(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l00467"></a>00467             write(fh, event_name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l00468"></a>00468             write(fh, (<span class="keywordtype">char</span> *) tag, size);
<a name="l00469"></a>00469 
<a name="l00470"></a>00470             <span class="comment">/* write definition index record */</span>
<a name="l00471"></a>00471             def_rec.event_id = event_id;
<a name="l00472"></a>00472             memcpy(def_rec.event_name, event_name, <span class="keyword">sizeof</span>(event_name));
<a name="l00473"></a>00473             def_rec.def_offset = _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a>;
<a name="l00474"></a>00474             write(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00475"></a>00475          }
<a name="l00476"></a>00476       } <span class="keywordflow">else</span> {
<a name="l00477"></a>00477          fh = _history[index].<a class="code" href="structHISTORY.html#a79a69e6f7ee9000ef228992c63fa1b17">hist_fh</a>;
<a name="l00478"></a>00478          fhd = _history[index].<a class="code" href="structHISTORY.html#acbcd08fbd4a1a660d097850b410d80ac">def_fh</a>;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480          <span class="comment">/* compare definition with previous definition */</span>
<a name="l00481"></a>00481          buffer = (<span class="keywordtype">char</span> *) M_MALLOC(size);
<a name="l00482"></a>00482          memset(buffer, 0, size);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484          lseek(fh, _history[index].def_offset, SEEK_SET);
<a name="l00485"></a>00485          read(fh, (<span class="keywordtype">char</span> *) &amp;prev_rec, <span class="keyword">sizeof</span>(prev_rec));
<a name="l00486"></a>00486          read(fh, str, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l00487"></a>00487          read(fh, buffer, size);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489          lseek(fh, 0, SEEK_END);
<a name="l00490"></a>00490          lseek(fhd, 0, SEEK_END);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492          <span class="keywordflow">if</span> (prev_rec.data_size != size || strcmp(str, event_name) != 0 || memcmp(buffer, tag, size) != 0) {
<a name="l00493"></a>00493             <span class="comment">/* save new definition offset */</span>
<a name="l00494"></a>00494             _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a> = TELL(fh);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496             <span class="comment">/* write definition to history file */</span>
<a name="l00497"></a>00497             write(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l00498"></a>00498             write(fh, event_name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l00499"></a>00499             write(fh, (<span class="keywordtype">char</span> *) tag, size);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501             <span class="comment">/* write index record */</span>
<a name="l00502"></a>00502             def_rec.event_id = event_id;
<a name="l00503"></a>00503             memcpy(def_rec.event_name, event_name, <span class="keyword">sizeof</span>(event_name));
<a name="l00504"></a>00504             def_rec.def_offset = _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a>;
<a name="l00505"></a>00505             write(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00506"></a>00506          }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508          M_FREE(buffer);
<a name="l00509"></a>00509       }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511       ss_semaphore_release(semaphore);
<a name="l00512"></a>00512    }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 
<a name="l00518"></a>00518 <span class="comment">/********************************************************************/</span>
<a name="l00519"></a>00519 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_write_event(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <span class="keywordtype">void</span> *data, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> size)
<a name="l00520"></a>00520 <span class="comment">/********************************************************************\</span>
<a name="l00521"></a>00521 <span class="comment"></span>
<a name="l00522"></a>00522 <span class="comment">  Routine: hs_write_event</span>
<a name="l00523"></a>00523 <span class="comment"></span>
<a name="l00524"></a>00524 <span class="comment">  Purpose: Write an event to a history file.</span>
<a name="l00525"></a>00525 <span class="comment"></span>
<a name="l00526"></a>00526 <span class="comment">  Input:</span>
<a name="l00527"></a>00527 <span class="comment">    DWORD  event_id         Event ID</span>
<a name="l00528"></a>00528 <span class="comment">    void   *data            Data buffer containing event</span>
<a name="l00529"></a>00529 <span class="comment">    DWORD  size             Data buffer size in bytes</span>
<a name="l00530"></a>00530 <span class="comment"></span>
<a name="l00531"></a>00531 <span class="comment">  Output:</span>
<a name="l00532"></a>00532 <span class="comment">    none</span>
<a name="l00533"></a>00533 <span class="comment">                            future hs_write_event</span>
<a name="l00534"></a>00534 <span class="comment"></span>
<a name="l00535"></a>00535 <span class="comment">  Function value:</span>
<a name="l00536"></a>00536 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00537"></a>00537 <span class="comment">    HS_NO_MEMEORY           Out of memory</span>
<a name="l00538"></a>00538 <span class="comment">    HS_FILE_ERROR           Cannot write to history file</span>
<a name="l00539"></a>00539 <span class="comment">    HS_UNDEFINED_EVENT      Event was not defined via hs_define_event</span>
<a name="l00540"></a>00540 <span class="comment"></span>
<a name="l00541"></a>00541 <span class="comment">\********************************************************************/</span>
<a name="l00542"></a>00542 {
<a name="l00543"></a>00543 <span class="comment">/* history events are only written locally (?)</span>
<a name="l00544"></a>00544 <span class="comment"></span>
<a name="l00545"></a>00545 <span class="comment">  if (rpc_is_remote())</span>
<a name="l00546"></a>00546 <span class="comment">    return rpc_call(RPC_HS_WRITE_EVENT, event_id, data, size);</span>
<a name="l00547"></a>00547 <span class="comment">*/</span>
<a name="l00548"></a>00548    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec, drec;
<a name="l00549"></a>00549    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l00550"></a>00550    <a class="code" href="structINDEX__RECORD.html">INDEX_RECORD</a> irec;
<a name="l00551"></a>00551    <span class="keywordtype">int</span> fh, fhi, fhd, last_pos_data, last_pos_index;
<a name="l00552"></a>00552    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> index, semaphore, status;
<a name="l00553"></a>00553    <span class="keyword">struct </span>tm tmb, tmr;
<a name="l00554"></a>00554    time_t ltime;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556    <span class="comment">/* request semaphore */</span>
<a name="l00557"></a>00557    cm_get_experiment_semaphore(NULL, NULL, &amp;semaphore, NULL);
<a name="l00558"></a>00558    status = ss_semaphore_wait_for(semaphore, 5 * 1000);
<a name="l00559"></a>00559    <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>) {
<a name="l00560"></a>00560       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_write_event&quot;</span>, <span class="stringliteral">&quot;semaphore timeout&quot;</span>);
<a name="l00561"></a>00561       <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;           <span class="comment">/* someone else blocked the history system */</span>
<a name="l00562"></a>00562    }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564    <span class="comment">/* find index to history structure */</span>
<a name="l00565"></a>00565    <span class="keywordflow">for</span> (index = 0; index &lt; _history_entries; index++)
<a name="l00566"></a>00566       <span class="keywordflow">if</span> (_history[index].event_id == event_id)
<a name="l00567"></a>00567          <span class="keywordflow">break</span>;
<a name="l00568"></a>00568    <span class="keywordflow">if</span> (index == _history_entries) {
<a name="l00569"></a>00569       ss_semaphore_release(semaphore);
<a name="l00570"></a>00570       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gad7b85d13f7ee77c6d195ed38380bbc27">HS_UNDEFINED_EVENT</a>;
<a name="l00571"></a>00571    }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573    <span class="comment">/* assemble record header */</span>
<a name="l00574"></a>00574    rec.<a class="code" href="structHIST__RECORD.html#a455da5efe0b4d3844e387e440b86302d">record_type</a> = <a class="code" href="group__mhistoryh.html#gaa8c3f42edf394b6d0fd9f1c3e00fe948">RT_DATA</a>;
<a name="l00575"></a>00575    rec.<a class="code" href="structHIST__RECORD.html#af0b5331f4cf74267721acd101a7cdfef">event_id</a> = _history[index].<a class="code" href="structHISTORY.html#a322ce5ffb593fad70e8c2057d3835b5a">event_id</a>;
<a name="l00576"></a>00576    rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a> = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL);
<a name="l00577"></a>00577    rec.<a class="code" href="structHIST__RECORD.html#a32da4099349d2a5a77a84e67301c9e56">def_offset</a> = _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a>;
<a name="l00578"></a>00578    rec.<a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a> = size;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    irec.<a class="code" href="structINDEX__RECORD.html#ab893c0617053652c09947d7d24740f27">event_id</a> = _history[index].<a class="code" href="structHISTORY.html#a322ce5ffb593fad70e8c2057d3835b5a">event_id</a>;
<a name="l00581"></a>00581    irec.<a class="code" href="structINDEX__RECORD.html#a729b9b6590da0af9a8c9984d0d58a8d7">time</a> = rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583    <span class="comment">/* check if new day */</span>
<a name="l00584"></a>00584    ltime = (time_t) rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>;
<a name="l00585"></a>00585    memcpy(&amp;tmr, localtime(&amp;ltime), <span class="keyword">sizeof</span>(tmr));
<a name="l00586"></a>00586    ltime = (time_t) _history[index].base_time;
<a name="l00587"></a>00587    memcpy(&amp;tmb, localtime(&amp;ltime), <span class="keyword">sizeof</span>(tmb));
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    <span class="keywordflow">if</span> (tmr.tm_yday != tmb.tm_yday) {
<a name="l00590"></a>00590       <span class="comment">/* close current history file */</span>
<a name="l00591"></a>00591       close(_history[index].hist_fh);
<a name="l00592"></a>00592       close(_history[index].def_fh);
<a name="l00593"></a>00593       close(_history[index].index_fh);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595       <span class="comment">/* open new history file */</span>
<a name="l00596"></a>00596       hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;hst&quot;</span>, O_CREAT | O_RDWR, &amp;fh);
<a name="l00597"></a>00597       <span class="keywordflow">if</span> (fh &lt; 0) {
<a name="l00598"></a>00598          ss_semaphore_release(semaphore);
<a name="l00599"></a>00599          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00600"></a>00600       }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602       <span class="comment">/* open new index file */</span>
<a name="l00603"></a>00603       hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;idx&quot;</span>, O_CREAT | O_RDWR, &amp;fhi);
<a name="l00604"></a>00604       <span class="keywordflow">if</span> (fhi &lt; 0) {
<a name="l00605"></a>00605          ss_semaphore_release(semaphore);
<a name="l00606"></a>00606          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00607"></a>00607       }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609       <span class="comment">/* open new definition index file */</span>
<a name="l00610"></a>00610       hs_open_file(rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>, <span class="stringliteral">&quot;idf&quot;</span>, O_CREAT | O_RDWR, &amp;fhd);
<a name="l00611"></a>00611       <span class="keywordflow">if</span> (fhd &lt; 0) {
<a name="l00612"></a>00612          ss_semaphore_release(semaphore);
<a name="l00613"></a>00613          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00614"></a>00614       }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616       lseek(fh, 0, SEEK_END);
<a name="l00617"></a>00617       lseek(fhi, 0, SEEK_END);
<a name="l00618"></a>00618       lseek(fhd, 0, SEEK_END);
<a name="l00619"></a>00619 
<a name="l00620"></a>00620       <span class="comment">/* remember new file handles */</span>
<a name="l00621"></a>00621       _history[index].<a class="code" href="structHISTORY.html#a79a69e6f7ee9000ef228992c63fa1b17">hist_fh</a> = fh;
<a name="l00622"></a>00622       _history[index].<a class="code" href="structHISTORY.html#a09233da06a1c7e441bd32f6230e80657">index_fh</a> = fhi;
<a name="l00623"></a>00623       _history[index].<a class="code" href="structHISTORY.html#acbcd08fbd4a1a660d097850b410d80ac">def_fh</a> = fhd;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625       _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a> = TELL(fh);
<a name="l00626"></a>00626       rec.<a class="code" href="structHIST__RECORD.html#a32da4099349d2a5a77a84e67301c9e56">def_offset</a> = _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a>;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628       tmr.tm_hour = tmr.tm_min = tmr.tm_sec = 0;
<a name="l00629"></a>00629       _history[index].<a class="code" href="structHISTORY.html#a7bc815860465a4962450eb181ab6a6e3">base_time</a> = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) mktime(&amp;tmr);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631       <span class="comment">/* write definition from _history structure */</span>
<a name="l00632"></a>00632       drec.<a class="code" href="structHIST__RECORD.html#a455da5efe0b4d3844e387e440b86302d">record_type</a> = <a class="code" href="group__mhistoryh.html#ga53bf0d0c21b64cf42e4355c3919f6fa2">RT_DEF</a>;
<a name="l00633"></a>00633       drec.<a class="code" href="structHIST__RECORD.html#af0b5331f4cf74267721acd101a7cdfef">event_id</a> = _history[index].<a class="code" href="structHISTORY.html#a322ce5ffb593fad70e8c2057d3835b5a">event_id</a>;
<a name="l00634"></a>00634       drec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a> = rec.<a class="code" href="structHIST__RECORD.html#a82235a34fe6b068c106c608b3893aff7">time</a>;
<a name="l00635"></a>00635       drec.<a class="code" href="structHIST__RECORD.html#a93cecf8007191fbee0ec012e0eced9c1">data_size</a> = _history[index].<a class="code" href="structHISTORY.html#aa4e80312dae8b75b2c05c697e6ee5951">n_tag</a> * <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>);
<a name="l00636"></a>00636 
<a name="l00637"></a>00637       write(fh, (<span class="keywordtype">char</span> *) &amp;drec, <span class="keyword">sizeof</span>(drec));
<a name="l00638"></a>00638       write(fh, _history[index].event_name, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l00639"></a>00639       write(fh, (<span class="keywordtype">char</span> *) _history[index].tag, drec.data_size);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641       <span class="comment">/* write definition index record */</span>
<a name="l00642"></a>00642       def_rec.<a class="code" href="structDEF__RECORD.html#a9d9787264de717f2512af5e7d48e5a32">event_id</a> = _history[index].<a class="code" href="structHISTORY.html#a322ce5ffb593fad70e8c2057d3835b5a">event_id</a>;
<a name="l00643"></a>00643       memcpy(def_rec.<a class="code" href="structDEF__RECORD.html#ad4fdebc35644bab90bbe3164176690cf">event_name</a>, _history[index].<a class="code" href="structHISTORY.html#aa1eb8e97074d13d85926b4c12eff22f4">event_name</a>, <span class="keyword">sizeof</span>(def_rec.<a class="code" href="structDEF__RECORD.html#ad4fdebc35644bab90bbe3164176690cf">event_name</a>));
<a name="l00644"></a>00644       def_rec.<a class="code" href="structDEF__RECORD.html#a3368ac2be8ed74559ed9ef115756f5e7">def_offset</a> = _history[index].<a class="code" href="structHISTORY.html#a321719dd05a884e2bca6cba8ca5b47ea">def_offset</a>;
<a name="l00645"></a>00645       write(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00646"></a>00646    }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648    <span class="comment">/* got to end of file */</span>
<a name="l00649"></a>00649    lseek(_history[index].hist_fh, 0, SEEK_END);
<a name="l00650"></a>00650    last_pos_data = irec.<a class="code" href="structINDEX__RECORD.html#aa5cd05f92f95ebccc6f2c7fdf3b3f1a9">offset</a> = TELL(_history[index].hist_fh);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    <span class="comment">/* write record header */</span>
<a name="l00653"></a>00653    write(_history[index].hist_fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l00654"></a>00654 
<a name="l00655"></a>00655    <span class="comment">/* write data */</span>
<a name="l00656"></a>00656    <span class="keywordflow">if</span> (write(_history[index].hist_fh, (<span class="keywordtype">char</span> *) data, size) &lt; (<span class="keywordtype">int</span>) size) {
<a name="l00657"></a>00657       <span class="comment">/* disk maybe full? Do a roll-back! */</span>
<a name="l00658"></a>00658       lseek(_history[index].hist_fh, last_pos_data, SEEK_SET);
<a name="l00659"></a>00659       TRUNCATE(_history[index].hist_fh);
<a name="l00660"></a>00660       ss_semaphore_release(semaphore);
<a name="l00661"></a>00661       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00662"></a>00662    }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664    <span class="comment">/* write index record */</span>
<a name="l00665"></a>00665    lseek(_history[index].index_fh, 0, SEEK_END);
<a name="l00666"></a>00666    last_pos_index = TELL(_history[index].index_fh);
<a name="l00667"></a>00667    <span class="keywordflow">if</span> (write(_history[index].index_fh, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec)) &lt; <span class="keyword">sizeof</span>(irec)) {
<a name="l00668"></a>00668       <span class="comment">/* disk maybe full? Do a roll-back! */</span>
<a name="l00669"></a>00669       lseek(_history[index].hist_fh, last_pos_data, SEEK_SET);
<a name="l00670"></a>00670       TRUNCATE(_history[index].hist_fh);
<a name="l00671"></a>00671       lseek(_history[index].index_fh, last_pos_index, SEEK_SET);
<a name="l00672"></a>00672       TRUNCATE(_history[index].index_fh);
<a name="l00673"></a>00673       ss_semaphore_release(semaphore);
<a name="l00674"></a>00674       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00675"></a>00675    }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677    ss_semaphore_release(semaphore);
<a name="l00678"></a>00678    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 <span class="comment">/********************************************************************/</span>
<a name="l00683"></a>00683 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_enum_events(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime, <span class="keywordtype">char</span> *event_name, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * name_size, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> event_id[], <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * id_size)
<a name="l00684"></a>00684 <span class="comment">/********************************************************************\</span>
<a name="l00685"></a>00685 <span class="comment"></span>
<a name="l00686"></a>00686 <span class="comment">  Routine: hs_enum_events</span>
<a name="l00687"></a>00687 <span class="comment"></span>
<a name="l00688"></a>00688 <span class="comment">  Purpose: Enumerate events for a given date</span>
<a name="l00689"></a>00689 <span class="comment"></span>
<a name="l00690"></a>00690 <span class="comment">  Input:</span>
<a name="l00691"></a>00691 <span class="comment">    DWORD  ltime            Date at which events should be enumerated</span>
<a name="l00692"></a>00692 <span class="comment"></span>
<a name="l00693"></a>00693 <span class="comment">  Output:</span>
<a name="l00694"></a>00694 <span class="comment">    char   *event_name      Array containing event names</span>
<a name="l00695"></a>00695 <span class="comment">    DWORD  *name_size       Size of name array</span>
<a name="l00696"></a>00696 <span class="comment">    char   *event_id        Array containing event IDs</span>
<a name="l00697"></a>00697 <span class="comment">    DWORD  *id_size         Size of ID array</span>
<a name="l00698"></a>00698 <span class="comment"></span>
<a name="l00699"></a>00699 <span class="comment">  Function value:</span>
<a name="l00700"></a>00700 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00701"></a>00701 <span class="comment">    HS_NO_MEMEORY           Out of memory</span>
<a name="l00702"></a>00702 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l00703"></a>00703 <span class="comment"></span>
<a name="l00704"></a>00704 <span class="comment">\********************************************************************/</span>
<a name="l00705"></a>00705 {
<a name="l00706"></a>00706    <span class="keywordtype">int</span> fh, fhd;
<a name="l00707"></a>00707    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status, i, j, n;
<a name="l00708"></a>00708    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l00711"></a>00711       <span class="keywordflow">return</span> rpc_call(<a class="code" href="group__mrpcdefineh.html#gac43c0f6b242f855a6e30335913ef2de9">RPC_HS_ENUM_EVENTS</a>, ltime, event_name, name_size, event_id, id_size);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713    <span class="comment">/* search latest history file */</span>
<a name="l00714"></a>00714    status = hs_search_file(&amp;ltime, -1);
<a name="l00715"></a>00715    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l00716"></a>00716       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_enum_events&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l00717"></a>00717       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00718"></a>00718    }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    <span class="comment">/* open history and definition files */</span>
<a name="l00721"></a>00721    hs_open_file(ltime, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l00722"></a>00722    hs_open_file(ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l00723"></a>00723    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0) {
<a name="l00724"></a>00724       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_enum_events&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l00725"></a>00725       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00726"></a>00726    }
<a name="l00727"></a>00727    lseek(fhd, 0, SEEK_SET);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729    <span class="comment">/* loop over definition index file */</span>
<a name="l00730"></a>00730    n = 0;
<a name="l00731"></a>00731    <span class="keywordflow">do</span> {
<a name="l00732"></a>00732       <span class="comment">/* read event definition */</span>
<a name="l00733"></a>00733       j = read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00734"></a>00734       <span class="keywordflow">if</span> (j &lt; (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(def_rec))
<a name="l00735"></a>00735          <span class="keywordflow">break</span>;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737       <span class="comment">/* look for existing entry for this event id */</span>
<a name="l00738"></a>00738       <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l00739"></a>00739          <span class="keywordflow">if</span> (event_id[i] == (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) def_rec.event_id) {
<a name="l00740"></a>00740             strcpy(event_name + i * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>, def_rec.event_name);
<a name="l00741"></a>00741             <span class="keywordflow">break</span>;
<a name="l00742"></a>00742          }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744       <span class="comment">/* new entry found */</span>
<a name="l00745"></a>00745       <span class="keywordflow">if</span> (i == n) {
<a name="l00746"></a>00746          <span class="keywordflow">if</span> (i * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a> &gt; (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) * name_size || i * <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) &gt; (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) * id_size) {
<a name="l00747"></a>00747             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_enum_events&quot;</span>, <span class="stringliteral">&quot;index buffer too small&quot;</span>);
<a name="l00748"></a>00748             close(fh);
<a name="l00749"></a>00749             close(fhd);
<a name="l00750"></a>00750             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga8d2556d6b5d8902646a36e3aa7e71dc5">HS_NO_MEMORY</a>;
<a name="l00751"></a>00751          }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753          <span class="comment">/* copy definition record */</span>
<a name="l00754"></a>00754          strcpy(event_name + i * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>, def_rec.event_name);
<a name="l00755"></a>00755          event_id[i] = def_rec.event_id;
<a name="l00756"></a>00756          n++;
<a name="l00757"></a>00757       }
<a name="l00758"></a>00758    } <span class="keywordflow">while</span> (TRUE);
<a name="l00759"></a>00759 
<a name="l00760"></a>00760    close(fh);
<a name="l00761"></a>00761    close(fhd);
<a name="l00762"></a>00762    *name_size = n * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>;
<a name="l00763"></a>00763    *id_size = n * <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>);
<a name="l00764"></a>00764 
<a name="l00765"></a>00765    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="comment">/********************************************************************/</span>
<a name="l00770"></a>00770 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_count_events(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * count)
<a name="l00771"></a>00771 <span class="comment">/********************************************************************\</span>
<a name="l00772"></a>00772 <span class="comment"></span>
<a name="l00773"></a>00773 <span class="comment">  Routine: hs_count_events</span>
<a name="l00774"></a>00774 <span class="comment"></span>
<a name="l00775"></a>00775 <span class="comment">  Purpose: Count number of different events for a given date</span>
<a name="l00776"></a>00776 <span class="comment"></span>
<a name="l00777"></a>00777 <span class="comment">  Input:</span>
<a name="l00778"></a>00778 <span class="comment">    DWORD  ltime            Date at which events should be counted</span>
<a name="l00779"></a>00779 <span class="comment"></span>
<a name="l00780"></a>00780 <span class="comment">  Output:</span>
<a name="l00781"></a>00781 <span class="comment">    DWORD  *count           Number of different events found</span>
<a name="l00782"></a>00782 <span class="comment"></span>
<a name="l00783"></a>00783 <span class="comment">  Function value:</span>
<a name="l00784"></a>00784 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00785"></a>00785 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l00786"></a>00786 <span class="comment"></span>
<a name="l00787"></a>00787 <span class="comment">\********************************************************************/</span>
<a name="l00788"></a>00788 {
<a name="l00789"></a>00789    <span class="keywordtype">int</span> fh, fhd;
<a name="l00790"></a>00790    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status, i, j, n;
<a name="l00791"></a>00791    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *id;
<a name="l00792"></a>00792    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l00795"></a>00795       <span class="keywordflow">return</span> rpc_call(<a class="code" href="group__mrpcdefineh.html#gaa8cdf659ab08fa5857d82b73e20bf47b">RPC_HS_COUNT_EVENTS</a>, ltime, count);
<a name="l00796"></a>00796 
<a name="l00797"></a>00797    <span class="comment">/* search latest history file */</span>
<a name="l00798"></a>00798    status = hs_search_file(&amp;ltime, -1);
<a name="l00799"></a>00799    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l00800"></a>00800       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_count_events&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l00801"></a>00801       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00802"></a>00802    }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804    <span class="comment">/* open history and definition files */</span>
<a name="l00805"></a>00805    hs_open_file(ltime, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l00806"></a>00806    hs_open_file(ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l00807"></a>00807    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0) {
<a name="l00808"></a>00808       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_count_events&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l00809"></a>00809       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00810"></a>00810    }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812    <span class="comment">/* allocate event id array */</span>
<a name="l00813"></a>00813    lseek(fhd, 0, SEEK_END);
<a name="l00814"></a>00814    <span class="keywordtype">id</span> = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *) M_MALLOC(TELL(fhd) / <span class="keyword">sizeof</span>(def_rec) * <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>));
<a name="l00815"></a>00815    lseek(fhd, 0, SEEK_SET);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817    <span class="comment">/* loop over index file */</span>
<a name="l00818"></a>00818    n = 0;
<a name="l00819"></a>00819    <span class="keywordflow">do</span> {
<a name="l00820"></a>00820       <span class="comment">/* read definition index record */</span>
<a name="l00821"></a>00821       j = read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00822"></a>00822       <span class="keywordflow">if</span> (j &lt; (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(def_rec))
<a name="l00823"></a>00823          <span class="keywordflow">break</span>;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825       <span class="comment">/* look for existing entries */</span>
<a name="l00826"></a>00826       <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l00827"></a>00827          <span class="keywordflow">if</span> (<span class="keywordtype">id</span>[i] == def_rec.event_id)
<a name="l00828"></a>00828             <span class="keywordflow">break</span>;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830       <span class="comment">/* new entry found */</span>
<a name="l00831"></a>00831       <span class="keywordflow">if</span> (i == n) {
<a name="l00832"></a>00832          <span class="keywordtype">id</span>[i] = def_rec.event_id;
<a name="l00833"></a>00833          n++;
<a name="l00834"></a>00834       }
<a name="l00835"></a>00835    } <span class="keywordflow">while</span> (TRUE);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 
<a name="l00838"></a>00838    M_FREE(<span class="keywordtype">id</span>);
<a name="l00839"></a>00839    close(fh);
<a name="l00840"></a>00840    close(fhd);
<a name="l00841"></a>00841    *count = n;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <span class="comment">/********************************************************************/</span>
<a name="l00848"></a>00848 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_get_event_id(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime, <span class="keywordtype">char</span> *name, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * <span class="keywordtype">id</span>)
<a name="l00849"></a>00849 <span class="comment">/********************************************************************\</span>
<a name="l00850"></a>00850 <span class="comment"></span>
<a name="l00851"></a>00851 <span class="comment">  Routine: hs_get_event_id</span>
<a name="l00852"></a>00852 <span class="comment"></span>
<a name="l00853"></a>00853 <span class="comment">  Purpose: Return event ID for a given name. If event cannot be found</span>
<a name="l00854"></a>00854 <span class="comment">           in current definition file, go back in time until found</span>
<a name="l00855"></a>00855 <span class="comment"></span>
<a name="l00856"></a>00856 <span class="comment">  Input:</span>
<a name="l00857"></a>00857 <span class="comment">    DWORD  ltime            Date at which event ID should be looked for</span>
<a name="l00858"></a>00858 <span class="comment"></span>
<a name="l00859"></a>00859 <span class="comment">  Output:</span>
<a name="l00860"></a>00860 <span class="comment">    DWORD  *id              Event ID</span>
<a name="l00861"></a>00861 <span class="comment"></span>
<a name="l00862"></a>00862 <span class="comment">  Function value:</span>
<a name="l00863"></a>00863 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00864"></a>00864 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l00865"></a>00865 <span class="comment">    HS_UNDEFINED_EVENT      Event &quot;name&quot; not found</span>
<a name="l00866"></a>00866 <span class="comment"></span>
<a name="l00867"></a>00867 <span class="comment">\********************************************************************/</span>
<a name="l00868"></a>00868 {
<a name="l00869"></a>00869    <span class="keywordtype">int</span> fh, fhd;
<a name="l00870"></a>00870    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status, i;
<a name="l00871"></a>00871    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> lt;
<a name="l00872"></a>00872    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l00873"></a>00873 
<a name="l00874"></a>00874    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l00875"></a>00875       <span class="keywordflow">return</span> rpc_call(<a class="code" href="group__mrpcdefineh.html#ga4f8ad9ec49e28393516bd2c909463c6c">RPC_HS_GET_EVENT_ID</a>, ltime, name, <span class="keywordtype">id</span>);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877    <span class="comment">/* search latest history file */</span>
<a name="l00878"></a>00878    <span class="keywordflow">if</span> (ltime == 0)
<a name="l00879"></a>00879       ltime = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL);
<a name="l00880"></a>00880 
<a name="l00881"></a>00881    lt = ltime;
<a name="l00882"></a>00882 
<a name="l00883"></a>00883    <span class="keywordflow">do</span> {
<a name="l00884"></a>00884       status = hs_search_file(&amp;lt, -1);
<a name="l00885"></a>00885       <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l00886"></a>00886          <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_count_events&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l00887"></a>00887          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00888"></a>00888       }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890       <span class="comment">/* open history and definition files */</span>
<a name="l00891"></a>00891       hs_open_file(lt, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l00892"></a>00892       hs_open_file(lt, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l00893"></a>00893       <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0) {
<a name="l00894"></a>00894          <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_count_events&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l00895"></a>00895          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00896"></a>00896       }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898       <span class="comment">/* loop over index file */</span>
<a name="l00899"></a>00899       *<span class="keywordtype">id</span> = 0;
<a name="l00900"></a>00900       <span class="keywordflow">do</span> {
<a name="l00901"></a>00901          <span class="comment">/* read definition index record */</span>
<a name="l00902"></a>00902          i = read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00903"></a>00903          <span class="keywordflow">if</span> (i &lt; (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(def_rec))
<a name="l00904"></a>00904             <span class="keywordflow">break</span>;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906          <span class="keywordflow">if</span> (strcmp(name, def_rec.event_name) == 0) {
<a name="l00907"></a>00907             *<span class="keywordtype">id</span> = def_rec.event_id;
<a name="l00908"></a>00908             close(fh);
<a name="l00909"></a>00909             close(fhd);
<a name="l00910"></a>00910             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00911"></a>00911          }
<a name="l00912"></a>00912       } <span class="keywordflow">while</span> (TRUE);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914       close(fh);
<a name="l00915"></a>00915       close(fhd);
<a name="l00916"></a>00916 
<a name="l00917"></a>00917       <span class="comment">/* not found -&gt; go back one day */</span>
<a name="l00918"></a>00918       lt -= 3600 * 24;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920    } <span class="keywordflow">while</span> (lt &gt; ltime - 3600 * 24 * 365 * 10); <span class="comment">/* maximum 10 years */</span>
<a name="l00921"></a>00921 
<a name="l00922"></a>00922    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gad7b85d13f7ee77c6d195ed38380bbc27">HS_UNDEFINED_EVENT</a>;
<a name="l00923"></a>00923 }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 
<a name="l00926"></a>00926 <span class="comment">/********************************************************************/</span>
<a name="l00927"></a>00927 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_count_vars(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * count)
<a name="l00928"></a>00928 <span class="comment">/********************************************************************\</span>
<a name="l00929"></a>00929 <span class="comment"></span>
<a name="l00930"></a>00930 <span class="comment">  Routine: hs_count_vars</span>
<a name="l00931"></a>00931 <span class="comment"></span>
<a name="l00932"></a>00932 <span class="comment">  Purpose: Count number of variables for a given date and event id</span>
<a name="l00933"></a>00933 <span class="comment"></span>
<a name="l00934"></a>00934 <span class="comment">  Input:</span>
<a name="l00935"></a>00935 <span class="comment">    DWORD  ltime            Date at which tags should be counted</span>
<a name="l00936"></a>00936 <span class="comment"></span>
<a name="l00937"></a>00937 <span class="comment">  Output:</span>
<a name="l00938"></a>00938 <span class="comment">    DWORD  *count           Number of tags</span>
<a name="l00939"></a>00939 <span class="comment"></span>
<a name="l00940"></a>00940 <span class="comment">  Function value:</span>
<a name="l00941"></a>00941 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l00942"></a>00942 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l00943"></a>00943 <span class="comment"></span>
<a name="l00944"></a>00944 <span class="comment">\********************************************************************/</span>
<a name="l00945"></a>00945 {
<a name="l00946"></a>00946    <span class="keywordtype">int</span> fh, fhd;
<a name="l00947"></a>00947    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, n, status;
<a name="l00948"></a>00948    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l00949"></a>00949    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l00952"></a>00952       <span class="keywordflow">return</span> rpc_call(<a class="code" href="group__mrpcdefineh.html#ga17a4f1c2652c0b2c77d1aee2cbad0ce3">RPC_HS_COUNT_VARS</a>, ltime, event_id, count);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954    <span class="comment">/* search latest history file */</span>
<a name="l00955"></a>00955    status = hs_search_file(&amp;ltime, -1);
<a name="l00956"></a>00956    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l00957"></a>00957       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_count_tags&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l00958"></a>00958       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00959"></a>00959    }
<a name="l00960"></a>00960 
<a name="l00961"></a>00961    <span class="comment">/* open history and definition files */</span>
<a name="l00962"></a>00962    hs_open_file(ltime, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l00963"></a>00963    hs_open_file(ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l00964"></a>00964    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0) {
<a name="l00965"></a>00965       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_count_tags&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l00966"></a>00966       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00967"></a>00967    }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969    <span class="comment">/* search last definition */</span>
<a name="l00970"></a>00970    lseek(fhd, 0, SEEK_END);
<a name="l00971"></a>00971    n = TELL(fhd) / <span class="keyword">sizeof</span>(def_rec);
<a name="l00972"></a>00972    def_rec.<a class="code" href="structDEF__RECORD.html#a9d9787264de717f2512af5e7d48e5a32">event_id</a> = 0;
<a name="l00973"></a>00973    <span class="keywordflow">for</span> (i = n - 1; i &gt;= 0; i--) {
<a name="l00974"></a>00974       lseek(fhd, i * <span class="keyword">sizeof</span>(def_rec), SEEK_SET);
<a name="l00975"></a>00975       read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l00976"></a>00976       <span class="keywordflow">if</span> (def_rec.event_id == event_id)
<a name="l00977"></a>00977          <span class="keywordflow">break</span>;
<a name="l00978"></a>00978    }
<a name="l00979"></a>00979    <span class="keywordflow">if</span> (def_rec.event_id != event_id) {
<a name="l00980"></a>00980       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_count_tags&quot;</span>, <span class="stringliteral">&quot;event %d not found in index file&quot;</span>, event_id);
<a name="l00981"></a>00981       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l00982"></a>00982    }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984    <span class="comment">/* read definition */</span>
<a name="l00985"></a>00985    lseek(fh, def_rec.def_offset, SEEK_SET);
<a name="l00986"></a>00986    read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l00987"></a>00987    *count = rec.data_size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>);
<a name="l00988"></a>00988 
<a name="l00989"></a>00989    close(fh);
<a name="l00990"></a>00990    close(fhd);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l00993"></a>00993 }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995 
<a name="l00996"></a>00996 <span class="comment">/********************************************************************/</span>
<a name="l00997"></a>00997 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_enum_vars(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <span class="keywordtype">char</span> *var_name, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * size, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * var_n, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * n_size)
<a name="l00998"></a>00998 <span class="comment">/********************************************************************\</span>
<a name="l00999"></a>00999 <span class="comment"></span>
<a name="l01000"></a>01000 <span class="comment">  Routine: hs_enum_vars</span>
<a name="l01001"></a>01001 <span class="comment"></span>
<a name="l01002"></a>01002 <span class="comment">  Purpose: Enumerate variable tags for a given date and event id</span>
<a name="l01003"></a>01003 <span class="comment"></span>
<a name="l01004"></a>01004 <span class="comment">  Input:</span>
<a name="l01005"></a>01005 <span class="comment">    DWORD  ltime            Date at which tags should be enumerated</span>
<a name="l01006"></a>01006 <span class="comment">    DWORD  event_id         Event ID</span>
<a name="l01007"></a>01007 <span class="comment"></span>
<a name="l01008"></a>01008 <span class="comment">  Output:</span>
<a name="l01009"></a>01009 <span class="comment">    char   *var_name        Array containing variable names</span>
<a name="l01010"></a>01010 <span class="comment">    DWORD  *size            Size of name array</span>
<a name="l01011"></a>01011 <span class="comment">    DWORD  *var_n           Array size of variable</span>
<a name="l01012"></a>01012 <span class="comment">    DWORD  *n_size          Size of n array</span>
<a name="l01013"></a>01013 <span class="comment"></span>
<a name="l01014"></a>01014 <span class="comment">  Function value:</span>
<a name="l01015"></a>01015 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l01016"></a>01016 <span class="comment">    HS_NO_MEMEORY           Out of memory</span>
<a name="l01017"></a>01017 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l01018"></a>01018 <span class="comment"></span>
<a name="l01019"></a>01019 <span class="comment">\********************************************************************/</span>
<a name="l01020"></a>01020 {
<a name="l01021"></a>01021    <span class="keywordtype">char</span> str[256];
<a name="l01022"></a>01022    <span class="keywordtype">int</span> fh, fhd;
<a name="l01023"></a>01023    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, n, status;
<a name="l01024"></a>01024    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l01025"></a>01025    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec;
<a name="l01026"></a>01026    <a class="code" href="structTAG.html">TAG</a> *tag;
<a name="l01027"></a>01027 
<a name="l01028"></a>01028    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l01029"></a>01029       <span class="keywordflow">return</span> rpc_call(<a class="code" href="group__mrpcdefineh.html#ga03b69c70087647cbea450ba968bcec9b">RPC_HS_ENUM_VARS</a>, ltime, event_id, var_name, size);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    <span class="comment">/* search latest history file */</span>
<a name="l01032"></a>01032    status = hs_search_file(&amp;ltime, -1);
<a name="l01033"></a>01033    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l01034"></a>01034       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_enum_vars&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l01035"></a>01035       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01036"></a>01036    }
<a name="l01037"></a>01037 
<a name="l01038"></a>01038    <span class="comment">/* open history and definition files */</span>
<a name="l01039"></a>01039    hs_open_file(ltime, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l01040"></a>01040    hs_open_file(ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l01041"></a>01041    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0) {
<a name="l01042"></a>01042       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_enum_vars&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l01043"></a>01043       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01044"></a>01044    }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046    <span class="comment">/* search last definition */</span>
<a name="l01047"></a>01047    lseek(fhd, 0, SEEK_END);
<a name="l01048"></a>01048    n = TELL(fhd) / <span class="keyword">sizeof</span>(def_rec);
<a name="l01049"></a>01049    def_rec.<a class="code" href="structDEF__RECORD.html#a9d9787264de717f2512af5e7d48e5a32">event_id</a> = 0;
<a name="l01050"></a>01050    <span class="keywordflow">for</span> (i = n - 1; i &gt;= 0; i--) {
<a name="l01051"></a>01051       lseek(fhd, i * <span class="keyword">sizeof</span>(def_rec), SEEK_SET);
<a name="l01052"></a>01052       read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l01053"></a>01053       <span class="keywordflow">if</span> (def_rec.event_id == event_id)
<a name="l01054"></a>01054          <span class="keywordflow">break</span>;
<a name="l01055"></a>01055    }
<a name="l01056"></a>01056    <span class="keywordflow">if</span> (def_rec.event_id != event_id) {
<a name="l01057"></a>01057       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_enum_vars&quot;</span>, <span class="stringliteral">&quot;event %d not found in index file&quot;</span>, event_id);
<a name="l01058"></a>01058       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01059"></a>01059    }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    <span class="comment">/* read definition header */</span>
<a name="l01062"></a>01062    lseek(fh, def_rec.def_offset, SEEK_SET);
<a name="l01063"></a>01063    read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l01064"></a>01064    read(fh, str, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066    <span class="comment">/* read event definition */</span>
<a name="l01067"></a>01067    n = rec.data_size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>);
<a name="l01068"></a>01068    tag = (<a class="code" href="structTAG.html">TAG</a> *) M_MALLOC(rec.data_size);
<a name="l01069"></a>01069    read(fh, (<span class="keywordtype">char</span> *) tag, rec.data_size);
<a name="l01070"></a>01070 
<a name="l01071"></a>01071    <span class="keywordflow">if</span> (n * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a> &gt; (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) * size || n * <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) &gt; *n_size) {
<a name="l01072"></a>01072 
<a name="l01073"></a>01073       <span class="comment">/* store partial definition */</span>
<a name="l01074"></a>01074       <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) * size / <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>; i++) {
<a name="l01075"></a>01075          strcpy(var_name + i * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>, tag[i].name);
<a name="l01076"></a>01076          var_n[i] = tag[i].<a class="code" href="structTAG.html#aec010a11e0792b46f71ba64fae6f44e8">n_data</a>;
<a name="l01077"></a>01077       }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_enum_vars&quot;</span>, <span class="stringliteral">&quot;tag buffer too small&quot;</span>);
<a name="l01080"></a>01080       M_FREE(tag);
<a name="l01081"></a>01081       close(fh);
<a name="l01082"></a>01082       close(fhd);
<a name="l01083"></a>01083       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga8d2556d6b5d8902646a36e3aa7e71dc5">HS_NO_MEMORY</a>;
<a name="l01084"></a>01084    }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086    <span class="comment">/* store full definition */</span>
<a name="l01087"></a>01087    <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l01088"></a>01088       strcpy(var_name + i * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>, tag[i].name);
<a name="l01089"></a>01089       var_n[i] = tag[i].<a class="code" href="structTAG.html#aec010a11e0792b46f71ba64fae6f44e8">n_data</a>;
<a name="l01090"></a>01090    }
<a name="l01091"></a>01091    *size = n * <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>;
<a name="l01092"></a>01092    *n_size = n * <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>);
<a name="l01093"></a>01093 
<a name="l01094"></a>01094    M_FREE(tag);
<a name="l01095"></a>01095    close(fh);
<a name="l01096"></a>01096    close(fhd);
<a name="l01097"></a>01097 
<a name="l01098"></a>01098    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101 
<a name="l01102"></a>01102 <span class="comment">/********************************************************************/</span>
<a name="l01103"></a>01103 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_get_var(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <span class="keywordtype">char</span> *var_name, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * type, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> * n_data)
<a name="l01104"></a>01104 <span class="comment">/********************************************************************\</span>
<a name="l01105"></a>01105 <span class="comment"></span>
<a name="l01106"></a>01106 <span class="comment">  Routine: hs_get_var</span>
<a name="l01107"></a>01107 <span class="comment"></span>
<a name="l01108"></a>01108 <span class="comment">  Purpose: Get definition for certain variable</span>
<a name="l01109"></a>01109 <span class="comment"></span>
<a name="l01110"></a>01110 <span class="comment">  Input:</span>
<a name="l01111"></a>01111 <span class="comment">    DWORD  ltime            Date at which variable definition should</span>
<a name="l01112"></a>01112 <span class="comment">                            be returned</span>
<a name="l01113"></a>01113 <span class="comment">    DWORD  event_id         Event ID</span>
<a name="l01114"></a>01114 <span class="comment">    char   *var_name        Name of variable</span>
<a name="l01115"></a>01115 <span class="comment"></span>
<a name="l01116"></a>01116 <span class="comment">  Output:</span>
<a name="l01117"></a>01117 <span class="comment">    INT    *type            Type of variable</span>
<a name="l01118"></a>01118 <span class="comment">    INT    *n_data          Number of items in variable</span>
<a name="l01119"></a>01119 <span class="comment"></span>
<a name="l01120"></a>01120 <span class="comment">  Function value:</span>
<a name="l01121"></a>01121 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l01122"></a>01122 <span class="comment">    HS_NO_MEMEORY           Out of memory</span>
<a name="l01123"></a>01123 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l01124"></a>01124 <span class="comment"></span>
<a name="l01125"></a>01125 <span class="comment">\********************************************************************/</span>
<a name="l01126"></a>01126 {
<a name="l01127"></a>01127    <span class="keywordtype">char</span> str[256];
<a name="l01128"></a>01128    <span class="keywordtype">int</span> fh, fhd;
<a name="l01129"></a>01129    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, n, status;
<a name="l01130"></a>01130    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l01131"></a>01131    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec;
<a name="l01132"></a>01132    <a class="code" href="structTAG.html">TAG</a> *tag;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l01135"></a>01135       <span class="keywordflow">return</span> rpc_call(<a class="code" href="group__mrpcdefineh.html#ga80424615873f6deec4b651d65133a241">RPC_HS_GET_VAR</a>, ltime, event_id, var_name, type, n_data);
<a name="l01136"></a>01136 
<a name="l01137"></a>01137    <span class="comment">/* search latest history file */</span>
<a name="l01138"></a>01138    status = hs_search_file(&amp;ltime, -1);
<a name="l01139"></a>01139    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l01140"></a>01140       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_get_var&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l01141"></a>01141       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01142"></a>01142    }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    <span class="comment">/* open history and definition files */</span>
<a name="l01145"></a>01145    hs_open_file(ltime, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l01146"></a>01146    hs_open_file(ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l01147"></a>01147    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0) {
<a name="l01148"></a>01148       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_get_var&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l01149"></a>01149       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01150"></a>01150    }
<a name="l01151"></a>01151 
<a name="l01152"></a>01152    <span class="comment">/* search last definition */</span>
<a name="l01153"></a>01153    lseek(fhd, 0, SEEK_END);
<a name="l01154"></a>01154    n = TELL(fhd) / <span class="keyword">sizeof</span>(def_rec);
<a name="l01155"></a>01155    def_rec.<a class="code" href="structDEF__RECORD.html#a9d9787264de717f2512af5e7d48e5a32">event_id</a> = 0;
<a name="l01156"></a>01156    <span class="keywordflow">for</span> (i = n - 1; i &gt;= 0; i--) {
<a name="l01157"></a>01157       lseek(fhd, i * <span class="keyword">sizeof</span>(def_rec), SEEK_SET);
<a name="l01158"></a>01158       read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (def_rec.event_id == event_id)
<a name="l01160"></a>01160          <span class="keywordflow">break</span>;
<a name="l01161"></a>01161    }
<a name="l01162"></a>01162    <span class="keywordflow">if</span> (def_rec.event_id != event_id) {
<a name="l01163"></a>01163       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_get_var&quot;</span>, <span class="stringliteral">&quot;event %d not found in index file&quot;</span>, event_id);
<a name="l01164"></a>01164       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01165"></a>01165    }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167    <span class="comment">/* read definition header */</span>
<a name="l01168"></a>01168    lseek(fh, def_rec.def_offset, SEEK_SET);
<a name="l01169"></a>01169    read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l01170"></a>01170    read(fh, str, <a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>);
<a name="l01171"></a>01171 
<a name="l01172"></a>01172    <span class="comment">/* read event definition */</span>
<a name="l01173"></a>01173    n = rec.data_size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>);
<a name="l01174"></a>01174    tag = (<a class="code" href="structTAG.html">TAG</a> *) M_MALLOC(rec.data_size);
<a name="l01175"></a>01175    read(fh, (<span class="keywordtype">char</span> *) tag, rec.data_size);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177    <span class="comment">/* search variable */</span>
<a name="l01178"></a>01178    <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l01179"></a>01179       <span class="keywordflow">if</span> (strcmp(tag[i].name, var_name) == 0)
<a name="l01180"></a>01180          <span class="keywordflow">break</span>;
<a name="l01181"></a>01181 
<a name="l01182"></a>01182    close(fh);
<a name="l01183"></a>01183    close(fhd);
<a name="l01184"></a>01184 
<a name="l01185"></a>01185    <span class="keywordflow">if</span> (i &lt; n) {
<a name="l01186"></a>01186       *type = tag[i].<a class="code" href="structTAG.html#a3fdedadca645679ef114cc651a978d17">type</a>;
<a name="l01187"></a>01187       *n_data = tag[i].<a class="code" href="structTAG.html#aec010a11e0792b46f71ba64fae6f44e8">n_data</a>;
<a name="l01188"></a>01188    } <span class="keywordflow">else</span> {
<a name="l01189"></a>01189       *type = *n_data = 0;
<a name="l01190"></a>01190       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_get_var&quot;</span>, <span class="stringliteral">&quot;variable %s not found&quot;</span>, var_name);
<a name="l01191"></a>01191       M_FREE(tag);
<a name="l01192"></a>01192       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga1b25c77e3145468cf83f8e88bf1e0804">HS_UNDEFINED_VAR</a>;
<a name="l01193"></a>01193    }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    M_FREE(tag);
<a name="l01196"></a>01196    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l01197"></a>01197 }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 <span class="comment">/********************************************************************/</span>
<a name="l01201"></a>01201 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_get_tags(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> ltime, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <span class="keywordtype">char</span> event_name[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>], <span class="keywordtype">int</span>* n_tags, <a class="code" href="structTAG.html">TAG</a>** tags)
<a name="l01202"></a>01202 <span class="comment">/********************************************************************\</span>
<a name="l01203"></a>01203 <span class="comment"></span>
<a name="l01204"></a>01204 <span class="comment">  Routine: hs_get_tags</span>
<a name="l01205"></a>01205 <span class="comment"></span>
<a name="l01206"></a>01206 <span class="comment">  Purpose: Get tags for event id</span>
<a name="l01207"></a>01207 <span class="comment"></span>
<a name="l01208"></a>01208 <span class="comment">  Input:</span>
<a name="l01209"></a>01209 <span class="comment">    DWORD  ltime            Date at which variable definition should</span>
<a name="l01210"></a>01210 <span class="comment">                            be returned</span>
<a name="l01211"></a>01211 <span class="comment">    DWORD  event_id         Event ID</span>
<a name="l01212"></a>01212 <span class="comment"></span>
<a name="l01213"></a>01213 <span class="comment">  Output:</span>
<a name="l01214"></a>01214 <span class="comment">    char    event_name[NAME_LENGTH] Event name from history file</span>
<a name="l01215"></a>01215 <span class="comment">    INT    *n_tags          Number of tags</span>
<a name="l01216"></a>01216 <span class="comment">    TAG   **tags            Pointer to array of tags (should be free()ed by the caller)</span>
<a name="l01217"></a>01217 <span class="comment"></span>
<a name="l01218"></a>01218 <span class="comment">  Function value:</span>
<a name="l01219"></a>01219 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l01220"></a>01220 <span class="comment">    HS_NO_MEMEORY           Out of memory</span>
<a name="l01221"></a>01221 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l01222"></a>01222 <span class="comment"></span>
<a name="l01223"></a>01223 <span class="comment">\********************************************************************/</span>
<a name="l01224"></a>01224 {
<a name="l01225"></a>01225    <span class="keywordtype">int</span> fh, fhd;
<a name="l01226"></a>01226    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, n, status;
<a name="l01227"></a>01227    <a class="code" href="structDEF__RECORD.html">DEF_RECORD</a> def_rec;
<a name="l01228"></a>01228    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec;
<a name="l01229"></a>01229 
<a name="l01230"></a>01230    *n_tags = 0;
<a name="l01231"></a>01231    *tags = NULL;
<a name="l01232"></a>01232 
<a name="l01233"></a>01233    <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l01234"></a>01234       assert(!<span class="stringliteral">&quot;RPC not implemented&quot;</span>);
<a name="l01235"></a>01235 
<a name="l01236"></a>01236    <span class="comment">/* search latest history file */</span>
<a name="l01237"></a>01237    status = hs_search_file(&amp;ltime, -1);
<a name="l01238"></a>01238    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l01239"></a>01239       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_get_tags&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l01240"></a>01240       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01241"></a>01241    }
<a name="l01242"></a>01242 
<a name="l01243"></a>01243    <span class="comment">/* open history and definition files */</span>
<a name="l01244"></a>01244    hs_open_file(ltime, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l01245"></a>01245    hs_open_file(ltime, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l01246"></a>01246    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0) {
<a name="l01247"></a>01247       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_get_tags&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l01248"></a>01248       <span class="keywordflow">if</span> (fh&gt;0)
<a name="l01249"></a>01249          close(fh);
<a name="l01250"></a>01250       <span class="keywordflow">if</span> (fhd&gt;0)
<a name="l01251"></a>01251          close(fhd);
<a name="l01252"></a>01252       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01253"></a>01253    }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255    <span class="comment">/* search last definition */</span>
<a name="l01256"></a>01256    lseek(fhd, 0, SEEK_END);
<a name="l01257"></a>01257    n = TELL(fhd) / <span class="keyword">sizeof</span>(def_rec);
<a name="l01258"></a>01258    def_rec.<a class="code" href="structDEF__RECORD.html#a9d9787264de717f2512af5e7d48e5a32">event_id</a> = 0;
<a name="l01259"></a>01259    <span class="keywordflow">for</span> (i = n - 1; i &gt;= 0; i--) {
<a name="l01260"></a>01260       lseek(fhd, i * <span class="keyword">sizeof</span>(def_rec), SEEK_SET);
<a name="l01261"></a>01261       read(fhd, (<span class="keywordtype">char</span> *) &amp;def_rec, <span class="keyword">sizeof</span>(def_rec));
<a name="l01262"></a>01262       <span class="keywordflow">if</span> (def_rec.event_id == event_id)
<a name="l01263"></a>01263          <span class="keywordflow">break</span>;
<a name="l01264"></a>01264    }
<a name="l01265"></a>01265 
<a name="l01266"></a>01266    <span class="keywordflow">if</span> (def_rec.event_id != event_id) {
<a name="l01267"></a>01267       <span class="comment">//cm_msg(MERROR, &quot;hs_get_tags&quot;, &quot;event %d not found in index file&quot;, event_id);</span>
<a name="l01268"></a>01268       close(fh);
<a name="l01269"></a>01269       close(fhd);
<a name="l01270"></a>01270       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gad7b85d13f7ee77c6d195ed38380bbc27">HS_UNDEFINED_EVENT</a>;
<a name="l01271"></a>01271    }
<a name="l01272"></a>01272 
<a name="l01273"></a>01273    <span class="comment">/* read definition header */</span>
<a name="l01274"></a>01274    lseek(fh, def_rec.def_offset, SEEK_SET);
<a name="l01275"></a>01275    status = read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l01276"></a>01276    assert(status == <span class="keyword">sizeof</span>(rec));
<a name="l01277"></a>01277 
<a name="l01278"></a>01278    status = read(fh, event_name, NAME_LENGTH);
<a name="l01279"></a>01279    assert(status == NAME_LENGTH);
<a name="l01280"></a>01280 
<a name="l01281"></a>01281    <span class="comment">/* read event definition */</span>
<a name="l01282"></a>01282    *n_tags = rec.data_size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>);
<a name="l01283"></a>01283 
<a name="l01284"></a>01284    *tags = (<a class="code" href="structTAG.html">TAG</a>*) malloc(rec.data_size);
<a name="l01285"></a>01285 
<a name="l01286"></a>01286    status = read(fh, (<span class="keywordtype">char</span> *) (*tags), rec.data_size);
<a name="l01287"></a>01287    assert(status == rec.data_size);
<a name="l01288"></a>01288 
<a name="l01289"></a>01289    close(fh);
<a name="l01290"></a>01290    close(fhd);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l01293"></a>01293 }
<a name="l01294"></a>01294 
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_read(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> start_time, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> end_time, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> interval, <span class="keywordtype">char</span> *tag_name, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> var_index, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * time_buffer, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * tbsize, <span class="keywordtype">void</span> *data_buffer, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * dbsize, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * type, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> * n)
<a name="l01297"></a>01297 <span class="comment">/********************************************************************\</span>
<a name="l01298"></a>01298 <span class="comment"></span>
<a name="l01299"></a>01299 <span class="comment">  Routine: hs_read</span>
<a name="l01300"></a>01300 <span class="comment"></span>
<a name="l01301"></a>01301 <span class="comment">  Purpose: Read history for a variable at a certain time interval</span>
<a name="l01302"></a>01302 <span class="comment"></span>
<a name="l01303"></a>01303 <span class="comment">  Input:</span>
<a name="l01304"></a>01304 <span class="comment">    DWORD  event_id         Event ID</span>
<a name="l01305"></a>01305 <span class="comment">    DWORD  start_time       Starting Date/Time</span>
<a name="l01306"></a>01306 <span class="comment">    DWORD  end_time         End Date/Time</span>
<a name="l01307"></a>01307 <span class="comment">    DWORD  interval         Minimum time in seconds between reported</span>
<a name="l01308"></a>01308 <span class="comment">                            events. Can be used to skip events</span>
<a name="l01309"></a>01309 <span class="comment">    char   *tag_name        Variable name inside event</span>
<a name="l01310"></a>01310 <span class="comment">    DWORD  var_index        Index if variable is array</span>
<a name="l01311"></a>01311 <span class="comment"></span>
<a name="l01312"></a>01312 <span class="comment">  Output:</span>
<a name="l01313"></a>01313 <span class="comment">    DWORD  *time_buffer     Buffer containing times for each value</span>
<a name="l01314"></a>01314 <span class="comment">    DWORD  *tbsize          Size of time buffer</span>
<a name="l01315"></a>01315 <span class="comment">    void   *data_buffer     Buffer containing variable values</span>
<a name="l01316"></a>01316 <span class="comment">    DWORD  *dbsize          Data buffer size</span>
<a name="l01317"></a>01317 <span class="comment">    DWORD  *type            Type of variable (one of TID_xxx)</span>
<a name="l01318"></a>01318 <span class="comment">    DWORD  *n               Number of time/value pairs found</span>
<a name="l01319"></a>01319 <span class="comment">                            in specified interval and placed into</span>
<a name="l01320"></a>01320 <span class="comment">                            time_buffer and data_buffer</span>
<a name="l01321"></a>01321 <span class="comment"></span>
<a name="l01322"></a>01322 <span class="comment"></span>
<a name="l01323"></a>01323 <span class="comment">  Function value:</span>
<a name="l01324"></a>01324 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l01325"></a>01325 <span class="comment">    HS_NO_MEMEORY           Out of memory</span>
<a name="l01326"></a>01326 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l01327"></a>01327 <span class="comment">    HS_WRONG_INDEX          var_index exceeds array size of variable</span>
<a name="l01328"></a>01328 <span class="comment">    HS_UNDEFINED_VAR        Variable &quot;tag_name&quot; not found in event</span>
<a name="l01329"></a>01329 <span class="comment">    HS_TRUNCATED            Buffer too small, data has been truncated</span>
<a name="l01330"></a>01330 <span class="comment"></span>
<a name="l01331"></a>01331 <span class="comment">\********************************************************************/</span>
<a name="l01332"></a>01332 {
<a name="l01333"></a>01333    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> prev_time, last_irec_time;
<a name="l01334"></a>01334    <span class="keywordtype">int</span> fh, fhd, fhi, cp = 0;
<a name="l01335"></a>01335    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, delta, index = 0, status, cache_size;
<a name="l01336"></a>01336    <a class="code" href="structINDEX__RECORD.html">INDEX_RECORD</a> irec, *pirec;
<a name="l01337"></a>01337    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec, drec;
<a name="l01338"></a>01338    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> old_def_offset, var_size = 0, var_offset = 0;
<a name="l01339"></a>01339    <a class="code" href="structTAG.html">TAG</a> *tag;
<a name="l01340"></a>01340    <span class="keywordtype">char</span> str[NAME_LENGTH];
<a name="l01341"></a>01341    <span class="keyword">struct </span>tm *tms;
<a name="l01342"></a>01342    <span class="keywordtype">char</span> *cache = NULL;
<a name="l01343"></a>01343    time_t ltime;
<a name="l01344"></a>01344    <span class="keywordtype">int</span> rd;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346    <span class="comment">//printf(&quot;hs_read event %d, time %d:%d, tagname: \&apos;%s\&apos;, varindex: %d\n&quot;, event_id, start_time, end_time, tag_name, var_index);</span>
<a name="l01347"></a>01347 
<a name="l01348"></a>01348 <span class="preprocessor">#if 0</span>
<a name="l01349"></a>01349 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (rpc_is_remote())
<a name="l01350"></a>01350       <span class="keywordflow">return</span> rpc_call(<a class="code" href="group__mrpcdefineh.html#gae54df220cd65f15f7669bba8f031e6a6">RPC_HS_READ</a>, event_id, start_time, end_time, interval, tag_name, var_index, time_buffer, tbsize, data_buffer, dbsize, type, n);
<a name="l01351"></a>01351 <span class="preprocessor">#endif</span>
<a name="l01352"></a>01352 <span class="preprocessor"></span>
<a name="l01353"></a>01353    <span class="comment">/* if not time given, use present to one hour in past */</span>
<a name="l01354"></a>01354    <span class="keywordflow">if</span> (start_time == 0)
<a name="l01355"></a>01355       start_time = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL) - 3600;
<a name="l01356"></a>01356    <span class="keywordflow">if</span> (end_time == 0)
<a name="l01357"></a>01357       end_time = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359    *n = 0;
<a name="l01360"></a>01360    prev_time = 0;
<a name="l01361"></a>01361    last_irec_time = start_time;
<a name="l01362"></a>01362 
<a name="l01363"></a>01363    <span class="comment">/* search history file for start_time */</span>
<a name="l01364"></a>01364    status = hs_search_file(&amp;start_time, 1);
<a name="l01365"></a>01365    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l01366"></a>01366       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_read&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l01367"></a>01367       *tbsize = *dbsize = *n = 0;
<a name="l01368"></a>01368       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01369"></a>01369    }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371    <span class="comment">/* open history and definition files */</span>
<a name="l01372"></a>01372    hs_open_file(start_time, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l01373"></a>01373    hs_open_file(start_time, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l01374"></a>01374    hs_open_file(start_time, <span class="stringliteral">&quot;idx&quot;</span>, O_RDONLY, &amp;fhi);
<a name="l01375"></a>01375    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0 || fhi &lt; 0) {
<a name="l01376"></a>01376       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_read&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l01377"></a>01377       *tbsize = *dbsize = *n = 0;
<a name="l01378"></a>01378       <span class="keywordflow">if</span> (fh &gt; 0)
<a name="l01379"></a>01379          close(fh);
<a name="l01380"></a>01380       <span class="keywordflow">if</span> (fhd &gt; 0)
<a name="l01381"></a>01381          close(fhd);
<a name="l01382"></a>01382       <span class="keywordflow">if</span> (fhi &gt; 0)
<a name="l01383"></a>01383          close(fhi);
<a name="l01384"></a>01384       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01385"></a>01385    }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387    <span class="comment">/* try to read index file into cache */</span>
<a name="l01388"></a>01388    lseek(fhi, 0, SEEK_END);
<a name="l01389"></a>01389    cache_size = TELL(fhi);
<a name="l01390"></a>01390 
<a name="l01391"></a>01391    <span class="keywordflow">if</span> (cache_size == 0) {
<a name="l01392"></a>01392       <span class="keywordflow">goto</span> nextday;
<a name="l01393"></a>01393    }
<a name="l01394"></a>01394 
<a name="l01395"></a>01395    <span class="keywordflow">if</span> (cache_size &gt; 0) {
<a name="l01396"></a>01396       cache = (<span class="keywordtype">char</span> *) M_MALLOC(cache_size);
<a name="l01397"></a>01397       <span class="keywordflow">if</span> (cache) {
<a name="l01398"></a>01398          lseek(fhi, 0, SEEK_SET);
<a name="l01399"></a>01399          i = read(fhi, cache, cache_size);
<a name="l01400"></a>01400          <span class="keywordflow">if</span> (i &lt; cache_size) {
<a name="l01401"></a>01401             M_FREE(cache);
<a name="l01402"></a>01402             <span class="keywordflow">if</span> (fh &gt; 0)
<a name="l01403"></a>01403                close(fh);
<a name="l01404"></a>01404             <span class="keywordflow">if</span> (fhd &gt; 0)
<a name="l01405"></a>01405                close(fhd);
<a name="l01406"></a>01406             <span class="keywordflow">if</span> (fhi &gt; 0)
<a name="l01407"></a>01407                close(fhi);
<a name="l01408"></a>01408             <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01409"></a>01409          }
<a name="l01410"></a>01410       }
<a name="l01411"></a>01411 
<a name="l01412"></a>01412       <span class="comment">/* search record closest to start time */</span>
<a name="l01413"></a>01413       <span class="keywordflow">if</span> (cache == NULL) {
<a name="l01414"></a>01414          lseek(fhi, 0, SEEK_END);
<a name="l01415"></a>01415          delta = (TELL(fhi) / <span class="keyword">sizeof</span>(irec)) / 2;
<a name="l01416"></a>01416          lseek(fhi, delta * <span class="keyword">sizeof</span>(irec), SEEK_SET);
<a name="l01417"></a>01417          <span class="keywordflow">do</span> {
<a name="l01418"></a>01418             delta = (int) (<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta) / 2.0 + 0.5);
<a name="l01419"></a>01419             rd = read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01420"></a>01420             assert(rd == <span class="keyword">sizeof</span>(irec));
<a name="l01421"></a>01421             <span class="keywordflow">if</span> (irec.time &gt; start_time)
<a name="l01422"></a>01422                delta = -delta;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424             lseek(fhi, (delta - 1) * <span class="keyword">sizeof</span>(irec), SEEK_CUR);
<a name="l01425"></a>01425          } <span class="keywordflow">while</span> (<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta) &gt; 1 &amp;&amp; irec.time != start_time);
<a name="l01426"></a>01426          rd = read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01427"></a>01427          assert(rd == <span class="keyword">sizeof</span>(irec));
<a name="l01428"></a>01428          <span class="keywordflow">if</span> (irec.time &gt; start_time)
<a name="l01429"></a>01429             delta = -<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta);
<a name="l01430"></a>01430 
<a name="l01431"></a>01431          i = TELL(fhi) + (delta - 1) * <span class="keyword">sizeof</span>(irec);
<a name="l01432"></a>01432          <span class="keywordflow">if</span> (i &lt;= 0)
<a name="l01433"></a>01433             lseek(fhi, 0, SEEK_SET);
<a name="l01434"></a>01434          <span class="keywordflow">else</span>
<a name="l01435"></a>01435             lseek(fhi, (delta - 1) * <span class="keyword">sizeof</span>(irec), SEEK_CUR);
<a name="l01436"></a>01436          rd = read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01437"></a>01437          assert(rd == <span class="keyword">sizeof</span>(irec));
<a name="l01438"></a>01438       } <span class="keywordflow">else</span> {
<a name="l01439"></a>01439          delta = (cache_size / <span class="keyword">sizeof</span>(irec)) / 2;
<a name="l01440"></a>01440          cp = delta * <span class="keyword">sizeof</span>(irec);
<a name="l01441"></a>01441          <span class="keywordflow">do</span> {
<a name="l01442"></a>01442             delta = (int) (<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta) / 2.0 + 0.5);
<a name="l01443"></a>01443             pirec = (<a class="code" href="structINDEX__RECORD.html">INDEX_RECORD</a> *) (cache + cp);
<a name="l01444"></a>01444 
<a name="l01445"></a>01445             <span class="comment">//printf(&quot;pirec %p, cache %p, cp %d\n&quot;, pirec, cache, cp);</span>
<a name="l01446"></a>01446 
<a name="l01447"></a>01447             <span class="keywordflow">if</span> (pirec-&gt;<a class="code" href="structINDEX__RECORD.html#a729b9b6590da0af9a8c9984d0d58a8d7">time</a> &gt; start_time)
<a name="l01448"></a>01448                delta = -delta;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450             cp = cp + delta * <span class="keyword">sizeof</span>(irec);
<a name="l01451"></a>01451 
<a name="l01452"></a>01452             <span class="keywordflow">if</span> (cp &lt; 0)
<a name="l01453"></a>01453                cp = 0;
<a name="l01454"></a>01454          } <span class="keywordflow">while</span> (<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta) &gt; 1 &amp;&amp; pirec-&gt;<a class="code" href="structINDEX__RECORD.html#a729b9b6590da0af9a8c9984d0d58a8d7">time</a> != start_time);
<a name="l01455"></a>01455          pirec = (<a class="code" href="structINDEX__RECORD.html">INDEX_RECORD</a> *) (cache + cp);
<a name="l01456"></a>01456          <span class="keywordflow">if</span> (pirec-&gt;<a class="code" href="structINDEX__RECORD.html#a729b9b6590da0af9a8c9984d0d58a8d7">time</a> &gt; start_time)
<a name="l01457"></a>01457             delta = -<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta);
<a name="l01458"></a>01458 
<a name="l01459"></a>01459          <span class="keywordflow">if</span> (cp &lt;= delta * (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(irec))
<a name="l01460"></a>01460             cp = 0;
<a name="l01461"></a>01461          <span class="keywordflow">else</span>
<a name="l01462"></a>01462             cp = cp + delta * <span class="keyword">sizeof</span>(irec);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464          <span class="keywordflow">if</span> (cp &gt;= cache_size)
<a name="l01465"></a>01465             cp = cache_size - <span class="keyword">sizeof</span>(irec);
<a name="l01466"></a>01466          <span class="keywordflow">if</span> (cp &lt; 0)
<a name="l01467"></a>01467             cp = 0;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469          memcpy(&amp;irec, (<a class="code" href="structINDEX__RECORD.html">INDEX_RECORD</a> *) (cache + cp), <span class="keyword">sizeof</span>(irec));
<a name="l01470"></a>01470          cp += <span class="keyword">sizeof</span>(irec);
<a name="l01471"></a>01471       }
<a name="l01472"></a>01472    } <span class="keywordflow">else</span> {                     <span class="comment">/* file size &gt; 0 */</span>
<a name="l01473"></a>01473 
<a name="l01474"></a>01474       cache = NULL;
<a name="l01475"></a>01475       irec.time = start_time;
<a name="l01476"></a>01476    }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478    <span class="comment">/* read records, skip wrong IDs */</span>
<a name="l01479"></a>01479    old_def_offset = -1;
<a name="l01480"></a>01480    last_irec_time = start_time - 24 * 60 * 60;
<a name="l01481"></a>01481    <span class="keywordflow">do</span> {
<a name="l01482"></a>01482       <span class="comment">//printf(&quot;time %d -&gt; %d\n&quot;, last_irec_time, irec.time);</span>
<a name="l01483"></a>01483 
<a name="l01484"></a>01484       <span class="keywordflow">if</span> (irec.time &lt; last_irec_time) {
<a name="l01485"></a>01485          <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_read&quot;</span>, <span class="stringliteral">&quot;corrupted history data: time does not increase: %d -&gt; %d&quot;</span>, last_irec_time, irec.time);
<a name="l01486"></a>01486          <span class="comment">//*tbsize = *dbsize = *n = 0;</span>
<a name="l01487"></a>01487          <span class="keywordflow">if</span> (fh &gt; 0)
<a name="l01488"></a>01488             close(fh);
<a name="l01489"></a>01489          <span class="keywordflow">if</span> (fhd &gt; 0)
<a name="l01490"></a>01490             close(fhd);
<a name="l01491"></a>01491          <span class="keywordflow">if</span> (fhi &gt; 0)
<a name="l01492"></a>01492             close(fhi);
<a name="l01493"></a>01493          hs_gen_index(last_irec_time);
<a name="l01494"></a>01494          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l01495"></a>01495       }
<a name="l01496"></a>01496       last_irec_time = irec.time;
<a name="l01497"></a>01497       <span class="keywordflow">if</span> (irec.event_id == event_id &amp;&amp; irec.time &lt;= end_time &amp;&amp; irec.time &gt;= start_time) {
<a name="l01498"></a>01498          <span class="comment">/* check if record time more than &quot;interval&quot; seconds after previous time */</span>
<a name="l01499"></a>01499          <span class="keywordflow">if</span> (irec.time &gt;= prev_time + interval) {
<a name="l01500"></a>01500             prev_time = irec.time;
<a name="l01501"></a>01501             lseek(fh, irec.offset, SEEK_SET);
<a name="l01502"></a>01502             rd = read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l01503"></a>01503             <span class="keywordflow">if</span> (rd != <span class="keyword">sizeof</span>(rec)) {
<a name="l01504"></a>01504                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_read&quot;</span>, <span class="stringliteral">&quot;corrupted history data at time %d: read() of %d bytes returned %d, errno %d (%s)&quot;</span>, (<span class="keywordtype">int</span>) irec.time, <span class="keyword">sizeof</span>(rec), rd, errno, strerror(errno));
<a name="l01505"></a>01505                <span class="comment">//*tbsize = *dbsize = *n = 0;</span>
<a name="l01506"></a>01506                <span class="keywordflow">if</span> (fh &gt; 0)
<a name="l01507"></a>01507                   close(fh);
<a name="l01508"></a>01508                <span class="keywordflow">if</span> (fhd &gt; 0)
<a name="l01509"></a>01509                   close(fhd);
<a name="l01510"></a>01510                <span class="keywordflow">if</span> (fhi &gt; 0)
<a name="l01511"></a>01511                   close(fhi);
<a name="l01512"></a>01512                hs_gen_index(last_irec_time);
<a name="l01513"></a>01513                <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l01514"></a>01514             }
<a name="l01515"></a>01515 
<a name="l01516"></a>01516             <span class="comment">/* if definition changed, read new definition */</span>
<a name="l01517"></a>01517             <span class="keywordflow">if</span> ((<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) rec.def_offset != old_def_offset) {
<a name="l01518"></a>01518                lseek(fh, rec.def_offset, SEEK_SET);
<a name="l01519"></a>01519                read(fh, (<span class="keywordtype">char</span> *) &amp;drec, <span class="keyword">sizeof</span>(drec));
<a name="l01520"></a>01520                read(fh, str, NAME_LENGTH);
<a name="l01521"></a>01521 
<a name="l01522"></a>01522                tag = (<a class="code" href="structTAG.html">TAG</a> *) M_MALLOC(drec.data_size);
<a name="l01523"></a>01523                <span class="keywordflow">if</span> (tag == NULL) {
<a name="l01524"></a>01524                   *n = *tbsize = *dbsize = 0;
<a name="l01525"></a>01525                   <span class="keywordflow">if</span> (cache)
<a name="l01526"></a>01526                      M_FREE(cache);
<a name="l01527"></a>01527                   close(fh);
<a name="l01528"></a>01528                   close(fhd);
<a name="l01529"></a>01529                   close(fhi);
<a name="l01530"></a>01530                   <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga8d2556d6b5d8902646a36e3aa7e71dc5">HS_NO_MEMORY</a>;
<a name="l01531"></a>01531                }
<a name="l01532"></a>01532                read(fh, (<span class="keywordtype">char</span> *) tag, drec.data_size);
<a name="l01533"></a>01533 
<a name="l01534"></a>01534                <span class="comment">/* find index of tag_name in new definition */</span>
<a name="l01535"></a>01535                index = -1;
<a name="l01536"></a>01536                <span class="keywordflow">for</span> (i = 0; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) i &lt; drec.data_size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>); i++)
<a name="l01537"></a>01537                   <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(tag[i].name, tag_name)) {
<a name="l01538"></a>01538                      index = i;
<a name="l01539"></a>01539                      <span class="keywordflow">break</span>;
<a name="l01540"></a>01540                   }
<a name="l01541"></a>01541 
<a name="l01542"></a>01542                <span class="comment">/*</span>
<a name="l01543"></a>01543 <span class="comment">                  if ((DWORD) i == drec.data_size/sizeof(TAG))</span>
<a name="l01544"></a>01544 <span class="comment">                  {</span>
<a name="l01545"></a>01545 <span class="comment">                  *n = *tbsize = *dbsize = 0;</span>
<a name="l01546"></a>01546 <span class="comment">                  if (cache)</span>
<a name="l01547"></a>01547 <span class="comment">                  M_FREE(cache);</span>
<a name="l01548"></a>01548 <span class="comment"></span>
<a name="l01549"></a>01549 <span class="comment">                  return HS_UNDEFINED_VAR;</span>
<a name="l01550"></a>01550 <span class="comment">                  }</span>
<a name="l01551"></a>01551 <span class="comment">                */</span>
<a name="l01552"></a>01552 
<a name="l01553"></a>01553                <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp; var_index &gt;= tag[i].n_data) {
<a name="l01554"></a>01554                   *n = *tbsize = *dbsize = 0;
<a name="l01555"></a>01555                   <span class="keywordflow">if</span> (cache)
<a name="l01556"></a>01556                      M_FREE(cache);
<a name="l01557"></a>01557                   M_FREE(tag);
<a name="l01558"></a>01558                   close(fh);
<a name="l01559"></a>01559                   close(fhd);
<a name="l01560"></a>01560                   close(fhi);
<a name="l01561"></a>01561                   <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gab8c5289d12d853f0d8266cdf37c39b08">HS_WRONG_INDEX</a>;
<a name="l01562"></a>01562                }
<a name="l01563"></a>01563 
<a name="l01564"></a>01564                <span class="comment">/* calculate offset for variable */</span>
<a name="l01565"></a>01565                <span class="keywordflow">if</span> (index &gt;= 0) {
<a name="l01566"></a>01566                   *type = tag[i].<a class="code" href="structTAG.html#a3fdedadca645679ef114cc651a978d17">type</a>;
<a name="l01567"></a>01567 
<a name="l01568"></a>01568                   <span class="comment">/* loop over all previous variables */</span>
<a name="l01569"></a>01569                   <span class="keywordflow">for</span> (i = 0, var_offset = 0; i &lt; index; i++)
<a name="l01570"></a>01570                      var_offset += rpc_tid_size(tag[i].type) * tag[i].<a class="code" href="structTAG.html#aec010a11e0792b46f71ba64fae6f44e8">n_data</a>;
<a name="l01571"></a>01571 
<a name="l01572"></a>01572                   <span class="comment">/* strings have size n_data */</span>
<a name="l01573"></a>01573                   <span class="keywordflow">if</span> (tag[index].type == <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>)
<a name="l01574"></a>01574                      var_size = tag[i].<a class="code" href="structTAG.html#aec010a11e0792b46f71ba64fae6f44e8">n_data</a>;
<a name="l01575"></a>01575                   <span class="keywordflow">else</span>
<a name="l01576"></a>01576                      var_size = rpc_tid_size(tag[index].type);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578                   var_offset += var_size * var_index;
<a name="l01579"></a>01579                }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581                M_FREE(tag);
<a name="l01582"></a>01582                old_def_offset = rec.def_offset;
<a name="l01583"></a>01583                lseek(fh, irec.offset + <span class="keyword">sizeof</span>(rec), SEEK_SET);
<a name="l01584"></a>01584             }
<a name="l01585"></a>01585 
<a name="l01586"></a>01586             <span class="keywordflow">if</span> (index &gt;= 0) {
<a name="l01587"></a>01587                <span class="comment">/* check if data fits in buffers */</span>
<a name="l01588"></a>01588                <span class="keywordflow">if</span> ((*n) * <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) &gt;= *tbsize || (*n) * var_size &gt;= *dbsize) {
<a name="l01589"></a>01589                   *dbsize = (*n) * var_size;
<a name="l01590"></a>01590                   *tbsize = (*n) * <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>);
<a name="l01591"></a>01591                   <span class="keywordflow">if</span> (cache)
<a name="l01592"></a>01592                      M_FREE(cache);
<a name="l01593"></a>01593                   close(fh);
<a name="l01594"></a>01594                   close(fhd);
<a name="l01595"></a>01595                   close(fhi);
<a name="l01596"></a>01596                   <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga8b8cfc047a951f9afe9f833484d7e814">HS_TRUNCATED</a>;
<a name="l01597"></a>01597                }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599                <span class="comment">/* copy time from header */</span>
<a name="l01600"></a>01600                time_buffer[*n] = irec.time;
<a name="l01601"></a>01601 
<a name="l01602"></a>01602                <span class="comment">/* copy data from record */</span>
<a name="l01603"></a>01603                lseek(fh, var_offset, SEEK_CUR);
<a name="l01604"></a>01604                read(fh, (<span class="keywordtype">char</span> *) data_buffer + (*n) * var_size, var_size);
<a name="l01605"></a>01605 
<a name="l01606"></a>01606                <span class="comment">/* increment counter */</span>
<a name="l01607"></a>01607                (*n)++;
<a name="l01608"></a>01608             }
<a name="l01609"></a>01609          }
<a name="l01610"></a>01610       }
<a name="l01611"></a>01611 
<a name="l01612"></a>01612       <span class="comment">/* read next index record */</span>
<a name="l01613"></a>01613       <span class="keywordflow">if</span> (cache) {
<a name="l01614"></a>01614          <span class="keywordflow">if</span> (cp &gt;= cache_size) {
<a name="l01615"></a>01615             i = -1;
<a name="l01616"></a>01616             M_FREE(cache);
<a name="l01617"></a>01617             cache = NULL;
<a name="l01618"></a>01618          } <span class="keywordflow">else</span> {
<a name="l01619"></a>01619 
<a name="l01620"></a>01620           try_again:
<a name="l01621"></a>01621 
<a name="l01622"></a>01622             i = <span class="keyword">sizeof</span>(irec);
<a name="l01623"></a>01623 
<a name="l01624"></a>01624             memcpy(&amp;irec, cache + cp, <span class="keyword">sizeof</span>(irec));
<a name="l01625"></a>01625             cp += <span class="keyword">sizeof</span>(irec);
<a name="l01626"></a>01626 
<a name="l01627"></a>01627             <span class="comment">/* if history file is broken ... */</span>
<a name="l01628"></a>01628             <span class="keywordflow">if</span> (irec.time &lt; last_irec_time || irec.time &gt; last_irec_time + 24 * 60 * 60) {
<a name="l01629"></a>01629                <span class="comment">//if (irec.time &lt; last_irec_time) {</span>
<a name="l01630"></a>01630                <span class="comment">//printf(&quot;time %d -&gt; %d, cache_size %d, cp %d\n&quot;, last_irec_time, irec.time, cache_size, cp);</span>
<a name="l01631"></a>01631 
<a name="l01632"></a>01632                <span class="comment">//printf(&quot;Seeking next record...\n&quot;);</span>
<a name="l01633"></a>01633 
<a name="l01634"></a>01634                <span class="keywordflow">while</span> (cp &lt; cache_size) {
<a name="l01635"></a>01635                   <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *evidp = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *) (cache + cp);
<a name="l01636"></a>01636                   <span class="keywordflow">if</span> (*evidp == event_id) {
<a name="l01637"></a>01637                      <span class="comment">//printf(&quot;Found at cp %d\n&quot;, cp);</span>
<a name="l01638"></a>01638                      <span class="keywordflow">goto</span> try_again;
<a name="l01639"></a>01639                   }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641                   cp++;
<a name="l01642"></a>01642                }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644                i = -1;
<a name="l01645"></a>01645             }
<a name="l01646"></a>01646          }
<a name="l01647"></a>01647       } <span class="keywordflow">else</span>
<a name="l01648"></a>01648          i = read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01649"></a>01649 
<a name="l01650"></a>01650       <span class="comment">/* end of file: search next history file */</span>
<a name="l01651"></a>01651       <span class="keywordflow">if</span> (i &lt;= 0) {
<a name="l01652"></a>01652          close(fh);
<a name="l01653"></a>01653          close(fhd);
<a name="l01654"></a>01654          close(fhi);
<a name="l01655"></a>01655          fh = fhd = fhi = 0;
<a name="l01656"></a>01656 
<a name="l01657"></a>01657        nextday:
<a name="l01658"></a>01658 
<a name="l01659"></a>01659          <span class="comment">/* advance one day */</span>
<a name="l01660"></a>01660          ltime = (time_t) last_irec_time;
<a name="l01661"></a>01661          tms = localtime(&amp;ltime);
<a name="l01662"></a>01662          tms-&gt;tm_hour = tms-&gt;tm_min = tms-&gt;tm_sec = 0;
<a name="l01663"></a>01663          last_irec_time = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) mktime(tms);
<a name="l01664"></a>01664 
<a name="l01665"></a>01665          last_irec_time += 3600 * 24;
<a name="l01666"></a>01666 
<a name="l01667"></a>01667          <span class="keywordflow">if</span> (last_irec_time &gt; end_time)
<a name="l01668"></a>01668             <span class="keywordflow">break</span>;
<a name="l01669"></a>01669 
<a name="l01670"></a>01670          <span class="comment">/* search next file */</span>
<a name="l01671"></a>01671          status = hs_search_file(&amp;last_irec_time, 1);
<a name="l01672"></a>01672          <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>)
<a name="l01673"></a>01673             <span class="keywordflow">break</span>;
<a name="l01674"></a>01674 
<a name="l01675"></a>01675          <span class="comment">/* open history and definition files */</span>
<a name="l01676"></a>01676          hs_open_file(last_irec_time, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l01677"></a>01677          hs_open_file(last_irec_time, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l01678"></a>01678          hs_open_file(last_irec_time, <span class="stringliteral">&quot;idx&quot;</span>, O_RDONLY, &amp;fhi);
<a name="l01679"></a>01679          <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0 || fhi &lt; 0) {
<a name="l01680"></a>01680             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_read&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l01681"></a>01681             <span class="keywordflow">break</span>;
<a name="l01682"></a>01682          }
<a name="l01683"></a>01683 
<a name="l01684"></a>01684          <span class="comment">/* try to read index file into cache */</span>
<a name="l01685"></a>01685          lseek(fhi, 0, SEEK_END);
<a name="l01686"></a>01686          cache_size = TELL(fhi);
<a name="l01687"></a>01687 
<a name="l01688"></a>01688          <span class="keywordflow">if</span> (cache_size == 0) {
<a name="l01689"></a>01689             <span class="keywordflow">goto</span> nextday;
<a name="l01690"></a>01690          }
<a name="l01691"></a>01691 
<a name="l01692"></a>01692          lseek(fhi, 0, SEEK_SET);
<a name="l01693"></a>01693          cache = (<span class="keywordtype">char</span> *) M_MALLOC(cache_size);
<a name="l01694"></a>01694          <span class="keywordflow">if</span> (cache) {
<a name="l01695"></a>01695             i = read(fhi, cache, cache_size);
<a name="l01696"></a>01696             <span class="keywordflow">if</span> (i &lt; cache_size)
<a name="l01697"></a>01697                <span class="keywordflow">break</span>;
<a name="l01698"></a>01698             <span class="comment">/* read first record */</span>
<a name="l01699"></a>01699             cp = 0;
<a name="l01700"></a>01700             memcpy(&amp;irec, cache, <span class="keyword">sizeof</span>(irec));
<a name="l01701"></a>01701          } <span class="keywordflow">else</span> {
<a name="l01702"></a>01702             <span class="comment">/* read first record */</span>
<a name="l01703"></a>01703             i = read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01704"></a>01704             <span class="keywordflow">if</span> (i &lt;= 0)
<a name="l01705"></a>01705                <span class="keywordflow">break</span>;
<a name="l01706"></a>01706             assert(i == <span class="keyword">sizeof</span>(irec));
<a name="l01707"></a>01707          }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709          <span class="comment">/* old definition becomes invalid */</span>
<a name="l01710"></a>01710          old_def_offset = -1;
<a name="l01711"></a>01711       }
<a name="l01712"></a>01712       <span class="comment">//if (event_id==4 &amp;&amp; irec.event_id == event_id)</span>
<a name="l01713"></a>01713       <span class="comment">//  printf(&quot;time %d end %d\n&quot;, irec.time, end_time);</span>
<a name="l01714"></a>01714    } <span class="keywordflow">while</span> (irec.time &lt; end_time);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716    <span class="keywordflow">if</span> (cache)
<a name="l01717"></a>01717       M_FREE(cache);
<a name="l01718"></a>01718    <span class="keywordflow">if</span> (fh)
<a name="l01719"></a>01719       close(fh);
<a name="l01720"></a>01720    <span class="keywordflow">if</span> (fhd)
<a name="l01721"></a>01721       close(fhd);
<a name="l01722"></a>01722    <span class="keywordflow">if</span> (fhi)
<a name="l01723"></a>01723       close(fhi);
<a name="l01724"></a>01724 
<a name="l01725"></a>01725    *dbsize = *n * var_size;
<a name="l01726"></a>01726    *tbsize = *n * <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>);
<a name="l01727"></a>01727 
<a name="l01728"></a>01728    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l01729"></a>01729 }
<a name="l01730"></a>01730 <span class="comment"></span>
<a name="l01731"></a>01731 <span class="comment">/**dox***************************************************************/</span>
<a name="l01732"></a>01732 <span class="preprocessor">#endif                          </span><span class="comment">/* DOXYGEN_SHOULD_SKIP_THIS */</span>
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 <span class="comment">/********************************************************************/</span><span class="comment"></span>
<a name="l01735"></a>01735 <span class="comment">/**</span>
<a name="l01736"></a>01736 <span class="comment">Display history for a given event at stdout. The output</span>
<a name="l01737"></a>01737 <span class="comment">can be redirected to be read by Excel for example. </span>
<a name="l01738"></a>01738 <span class="comment">@param event_id         Event ID</span>
<a name="l01739"></a>01739 <span class="comment">@param start_time       Starting Date/Time</span>
<a name="l01740"></a>01740 <span class="comment">@param end_time         End Date/Time</span>
<a name="l01741"></a>01741 <span class="comment">@param interval         Minimum time in seconds between reported                                                                                </span>
<a name="l01742"></a>01742 <span class="comment">                            events. Can be used to skip events</span>
<a name="l01743"></a>01743 <span class="comment">@param binary_time      Display DWORD time stamp</span>
<a name="l01744"></a>01744 <span class="comment">@return HS_SUCCESS, HS_FILE_ERROR</span>
<a name="l01745"></a>01745 <span class="comment">*/</span>
<a name="l01746"></a>01746 <span class="comment">/********************************************************************/</span>
<a name="l01747"></a><a class="code" href="group__hsfunctioncode.html#gaa0adfd626d570a1e37a01f2f8b8afdfd">01747</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="group__hsfunctioncode.html#gaa0adfd626d570a1e37a01f2f8b8afdfd">hs_dump</a>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> event_id, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> start_time, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> end_time, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> interval, <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> binary_time)
<a name="l01748"></a>01748 {
<a name="l01749"></a>01749    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> prev_time, last_irec_time;
<a name="l01750"></a>01750    time_t ltime;
<a name="l01751"></a>01751    <span class="keywordtype">int</span> fh, fhd, fhi;
<a name="l01752"></a>01752    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, j, delta, status, n_tag = 0, old_n_tag = 0;
<a name="l01753"></a>01753    <a class="code" href="structINDEX__RECORD.html">INDEX_RECORD</a> irec;
<a name="l01754"></a>01754    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec, drec;
<a name="l01755"></a>01755    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> old_def_offset, offset;
<a name="l01756"></a>01756    <a class="code" href="structTAG.html">TAG</a> *tag = NULL, *old_tag = NULL;
<a name="l01757"></a>01757    <span class="keywordtype">char</span> str[NAME_LENGTH], data_buffer[10000];
<a name="l01758"></a>01758    <span class="keyword">struct </span>tm *tms;
<a name="l01759"></a>01759 
<a name="l01760"></a>01760    <span class="comment">/* if not time given, use present to one hour in past */</span>
<a name="l01761"></a>01761    <span class="keywordflow">if</span> (start_time == 0)
<a name="l01762"></a>01762       start_time = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL) - 3600;
<a name="l01763"></a>01763    <span class="keywordflow">if</span> (end_time == 0)
<a name="l01764"></a>01764       end_time = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) time(NULL);
<a name="l01765"></a>01765 
<a name="l01766"></a>01766    <span class="comment">/* search history file for start_time */</span>
<a name="l01767"></a>01767    status = hs_search_file(&amp;start_time, 1);
<a name="l01768"></a>01768    <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>) {
<a name="l01769"></a>01769       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_dump&quot;</span>, <span class="stringliteral">&quot;cannot find recent history file&quot;</span>);
<a name="l01770"></a>01770       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01771"></a>01771    }
<a name="l01772"></a>01772 
<a name="l01773"></a>01773    <span class="comment">/* open history and definition files */</span>
<a name="l01774"></a>01774    hs_open_file(start_time, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l01775"></a>01775    hs_open_file(start_time, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l01776"></a>01776    hs_open_file(start_time, <span class="stringliteral">&quot;idx&quot;</span>, O_RDONLY, &amp;fhi);
<a name="l01777"></a>01777    <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0 || fhi &lt; 0) {
<a name="l01778"></a>01778       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_dump&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l01779"></a>01779       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01780"></a>01780    }
<a name="l01781"></a>01781 
<a name="l01782"></a>01782    <span class="comment">/* search record closest to start time */</span>
<a name="l01783"></a>01783    lseek(fhi, 0, SEEK_END);
<a name="l01784"></a>01784    delta = (TELL(fhi) / <span class="keyword">sizeof</span>(irec)) / 2;
<a name="l01785"></a>01785    lseek(fhi, delta * <span class="keyword">sizeof</span>(irec), SEEK_SET);
<a name="l01786"></a>01786    <span class="keywordflow">do</span> {
<a name="l01787"></a>01787       delta = (int) (<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta) / 2.0 + 0.5);
<a name="l01788"></a>01788       read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01789"></a>01789       <span class="keywordflow">if</span> (irec.time &gt; start_time)
<a name="l01790"></a>01790          delta = -delta;
<a name="l01791"></a>01791 
<a name="l01792"></a>01792       i = lseek(fhi, (delta - 1) * <span class="keyword">sizeof</span>(irec), SEEK_CUR);
<a name="l01793"></a>01793    } <span class="keywordflow">while</span> (<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta) &gt; 1 &amp;&amp; irec.<a class="code" href="structINDEX__RECORD.html#a729b9b6590da0af9a8c9984d0d58a8d7">time</a> != start_time);
<a name="l01794"></a>01794    read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01795"></a>01795    <span class="keywordflow">if</span> (irec.time &gt; start_time)
<a name="l01796"></a>01796       delta = -<a class="code" href="hv_8c.html#a6a010865b10e541735fa2da8f3cd062d">abs</a>(delta);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798    i = TELL(fhi) + (delta - 1) * <span class="keyword">sizeof</span>(irec);
<a name="l01799"></a>01799    <span class="keywordflow">if</span> (i &lt;= 0)
<a name="l01800"></a>01800       lseek(fhi, 0, SEEK_SET);
<a name="l01801"></a>01801    <span class="keywordflow">else</span>
<a name="l01802"></a>01802       lseek(fhi, (delta - 1) * <span class="keyword">sizeof</span>(irec), SEEK_CUR);
<a name="l01803"></a>01803    read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01804"></a>01804 
<a name="l01805"></a>01805    <span class="comment">/* read records, skip wrong IDs */</span>
<a name="l01806"></a>01806    old_def_offset = -1;
<a name="l01807"></a>01807    prev_time = 0;
<a name="l01808"></a>01808    last_irec_time = 0;
<a name="l01809"></a>01809    <span class="keywordflow">do</span> {
<a name="l01810"></a>01810       <span class="keywordflow">if</span> (irec.time &lt; last_irec_time) {
<a name="l01811"></a>01811          <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_dump&quot;</span>, <span class="stringliteral">&quot;corrupted history data: time does not increase: %d -&gt; %d&quot;</span>, last_irec_time, irec.time);
<a name="l01812"></a>01812          hs_gen_index(last_irec_time);
<a name="l01813"></a>01813          <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01814"></a>01814       }
<a name="l01815"></a>01815       last_irec_time = irec.time;
<a name="l01816"></a>01816       <span class="keywordflow">if</span> (irec.event_id == event_id &amp;&amp; irec.time &lt;= end_time &amp;&amp; irec.time &gt;= start_time) {
<a name="l01817"></a>01817          <span class="keywordflow">if</span> (irec.time &gt;= prev_time + interval) {
<a name="l01818"></a>01818             prev_time = irec.time;
<a name="l01819"></a>01819             lseek(fh, irec.offset, SEEK_SET);
<a name="l01820"></a>01820             read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l01821"></a>01821 
<a name="l01822"></a>01822             <span class="comment">/* if definition changed, read new definition */</span>
<a name="l01823"></a>01823             <span class="keywordflow">if</span> ((<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) rec.def_offset != old_def_offset) {
<a name="l01824"></a>01824                lseek(fh, rec.def_offset, SEEK_SET);
<a name="l01825"></a>01825                read(fh, (<span class="keywordtype">char</span> *) &amp;drec, <span class="keyword">sizeof</span>(drec));
<a name="l01826"></a>01826                read(fh, str, NAME_LENGTH);
<a name="l01827"></a>01827 
<a name="l01828"></a>01828                <span class="keywordflow">if</span> (tag == NULL)
<a name="l01829"></a>01829                   tag = (<a class="code" href="structTAG.html">TAG</a> *) M_MALLOC(drec.data_size);
<a name="l01830"></a>01830                <span class="keywordflow">else</span>
<a name="l01831"></a>01831                   tag = (<a class="code" href="structTAG.html">TAG</a> *) realloc(tag, drec.data_size);
<a name="l01832"></a>01832                <span class="keywordflow">if</span> (tag == NULL)
<a name="l01833"></a>01833                   <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga8d2556d6b5d8902646a36e3aa7e71dc5">HS_NO_MEMORY</a>;
<a name="l01834"></a>01834                read(fh, (<span class="keywordtype">char</span> *) tag, drec.data_size);
<a name="l01835"></a>01835                n_tag = drec.data_size / <span class="keyword">sizeof</span>(<a class="code" href="structTAG.html">TAG</a>);
<a name="l01836"></a>01836 
<a name="l01837"></a>01837                <span class="comment">/* print tag names if definition has changed */</span>
<a name="l01838"></a>01838                <span class="keywordflow">if</span> (old_tag == NULL || old_n_tag != n_tag || memcmp(old_tag, tag, drec.data_size) != 0) {
<a name="l01839"></a>01839                   printf(<span class="stringliteral">&quot;Date\t&quot;</span>);
<a name="l01840"></a>01840                   <span class="keywordflow">for</span> (i = 0; i &lt; n_tag; i++) {
<a name="l01841"></a>01841                      <span class="keywordflow">if</span> (tag[i].n_data == 1 || tag[i].type == <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>)
<a name="l01842"></a>01842                         printf(<span class="stringliteral">&quot;%s\t&quot;</span>, tag[i].name);
<a name="l01843"></a>01843                      <span class="keywordflow">else</span>
<a name="l01844"></a>01844                         <span class="keywordflow">for</span> (j = 0; j &lt; (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) tag[i].n_data; j++)
<a name="l01845"></a>01845                            printf(<span class="stringliteral">&quot;%s%d\t&quot;</span>, tag[i].name, j);
<a name="l01846"></a>01846                   }
<a name="l01847"></a>01847                   printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01848"></a>01848 
<a name="l01849"></a>01849                   <span class="keywordflow">if</span> (old_tag == NULL)
<a name="l01850"></a>01850                      old_tag = (<a class="code" href="structTAG.html">TAG</a> *) M_MALLOC(drec.data_size);
<a name="l01851"></a>01851                   <span class="keywordflow">else</span>
<a name="l01852"></a>01852                      old_tag = (<a class="code" href="structTAG.html">TAG</a> *) realloc(old_tag, drec.data_size);
<a name="l01853"></a>01853                   memcpy(old_tag, tag, drec.data_size);
<a name="l01854"></a>01854                   old_n_tag = n_tag;
<a name="l01855"></a>01855                }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857                old_def_offset = rec.def_offset;
<a name="l01858"></a>01858                lseek(fh, irec.offset + <span class="keyword">sizeof</span>(rec), SEEK_SET);
<a name="l01859"></a>01859             }
<a name="l01860"></a>01860 
<a name="l01861"></a>01861             <span class="comment">/* print time from header */</span>
<a name="l01862"></a>01862             <span class="keywordflow">if</span> (binary_time)
<a name="l01863"></a>01863                printf(<span class="stringliteral">&quot;%d &quot;</span>, irec.time);
<a name="l01864"></a>01864             <span class="keywordflow">else</span> {
<a name="l01865"></a>01865                ltime = (time_t) irec.time;
<a name="l01866"></a>01866                sprintf(str, <span class="stringliteral">&quot;%s&quot;</span>, ctime(&amp;ltime) + 4);
<a name="l01867"></a>01867                str[20] = <span class="charliteral">&apos;\t&apos;</span>;
<a name="l01868"></a>01868                printf(<span class="stringliteral">&quot;%s&quot;</span>, str);
<a name="l01869"></a>01869             }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871             <span class="comment">/* read data */</span>
<a name="l01872"></a>01872             read(fh, data_buffer, rec.data_size);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874             <span class="comment">/* interprete data from tag definition */</span>
<a name="l01875"></a>01875             offset = 0;
<a name="l01876"></a>01876             <span class="keywordflow">for</span> (i = 0; i &lt; n_tag; i++) {
<a name="l01877"></a>01877                <span class="comment">/* strings have a length of n_data */</span>
<a name="l01878"></a>01878                <span class="keywordflow">if</span> (tag[i].type == <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>) {
<a name="l01879"></a>01879                   printf(<span class="stringliteral">&quot;%s\t&quot;</span>, data_buffer + offset);
<a name="l01880"></a>01880                   offset += tag[i].<a class="code" href="structTAG.html#aec010a11e0792b46f71ba64fae6f44e8">n_data</a>;
<a name="l01881"></a>01881                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag[i].n_data == 1) {
<a name="l01882"></a>01882                   <span class="comment">/* non-array data */</span>
<a name="l01883"></a>01883                   <a class="code" href="group__odbfunctionc.html#ga594e4b0d774999bdcc1161e8b6b84052">db_sprintf</a>(str, data_buffer + offset, rpc_tid_size(tag[i].type), 0, tag[i].type);
<a name="l01884"></a>01884                   printf(<span class="stringliteral">&quot;%s\t&quot;</span>, str);
<a name="l01885"></a>01885                   offset += rpc_tid_size(tag[i].type);
<a name="l01886"></a>01886                } <span class="keywordflow">else</span>
<a name="l01887"></a>01887                   <span class="comment">/* loop over array data */</span>
<a name="l01888"></a>01888                   <span class="keywordflow">for</span> (j = 0; j &lt; (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) tag[i].n_data; j++) {
<a name="l01889"></a>01889                      <a class="code" href="group__odbfunctionc.html#ga594e4b0d774999bdcc1161e8b6b84052">db_sprintf</a>(str, data_buffer + offset, rpc_tid_size(tag[i].type), 0, tag[i].type);
<a name="l01890"></a>01890                      printf(<span class="stringliteral">&quot;%s\t&quot;</span>, str);
<a name="l01891"></a>01891                      offset += rpc_tid_size(tag[i].type);
<a name="l01892"></a>01892                   }
<a name="l01893"></a>01893             }
<a name="l01894"></a>01894             printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01895"></a>01895          }
<a name="l01896"></a>01896       }
<a name="l01897"></a>01897 
<a name="l01898"></a>01898       <span class="comment">/* read next index record */</span>
<a name="l01899"></a>01899       i = read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01900"></a>01900 
<a name="l01901"></a>01901       <span class="comment">/* end of file: search next history file */</span>
<a name="l01902"></a>01902       <span class="keywordflow">if</span> (i &lt;= 0) {
<a name="l01903"></a>01903          close(fh);
<a name="l01904"></a>01904          close(fhd);
<a name="l01905"></a>01905          close(fhi);
<a name="l01906"></a>01906 
<a name="l01907"></a>01907          <span class="comment">/* advance one day */</span>
<a name="l01908"></a>01908          ltime = (time_t) last_irec_time;
<a name="l01909"></a>01909          tms = localtime(&amp;ltime);
<a name="l01910"></a>01910          tms-&gt;tm_hour = tms-&gt;tm_min = tms-&gt;tm_sec = 0;
<a name="l01911"></a>01911          last_irec_time = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) mktime(tms);
<a name="l01912"></a>01912 
<a name="l01913"></a>01913          last_irec_time += 3600 * 24;
<a name="l01914"></a>01914          <span class="keywordflow">if</span> (last_irec_time &gt; end_time)
<a name="l01915"></a>01915             <span class="keywordflow">break</span>;
<a name="l01916"></a>01916 
<a name="l01917"></a>01917          <span class="comment">/* search next file */</span>
<a name="l01918"></a>01918          status = hs_search_file((<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *) &amp; last_irec_time, 1);
<a name="l01919"></a>01919          <span class="keywordflow">if</span> (status != <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>)
<a name="l01920"></a>01920             <span class="keywordflow">break</span>;
<a name="l01921"></a>01921 
<a name="l01922"></a>01922          <span class="comment">/* open history and definition files */</span>
<a name="l01923"></a>01923          hs_open_file(last_irec_time, <span class="stringliteral">&quot;hst&quot;</span>, O_RDONLY, &amp;fh);
<a name="l01924"></a>01924          hs_open_file(last_irec_time, <span class="stringliteral">&quot;idf&quot;</span>, O_RDONLY, &amp;fhd);
<a name="l01925"></a>01925          hs_open_file(last_irec_time, <span class="stringliteral">&quot;idx&quot;</span>, O_RDONLY, &amp;fhi);
<a name="l01926"></a>01926          <span class="keywordflow">if</span> (fh &lt; 0 || fhd &lt; 0 || fhi &lt; 0) {
<a name="l01927"></a>01927             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_dump&quot;</span>, <span class="stringliteral">&quot;cannot open index files&quot;</span>);
<a name="l01928"></a>01928             <span class="keywordflow">break</span>;
<a name="l01929"></a>01929          }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931          <span class="comment">/* read first record */</span>
<a name="l01932"></a>01932          i = read(fhi, (<span class="keywordtype">char</span> *) &amp;irec, <span class="keyword">sizeof</span>(irec));
<a name="l01933"></a>01933          <span class="keywordflow">if</span> (i &lt;= 0)
<a name="l01934"></a>01934             <span class="keywordflow">break</span>;
<a name="l01935"></a>01935 
<a name="l01936"></a>01936          <span class="comment">/* old definition becomes invalid */</span>
<a name="l01937"></a>01937          old_def_offset = -1;
<a name="l01938"></a>01938       }
<a name="l01939"></a>01939    } <span class="keywordflow">while</span> (irec.time &lt; end_time);
<a name="l01940"></a>01940 
<a name="l01941"></a>01941    M_FREE(tag);
<a name="l01942"></a>01942    M_FREE(old_tag);
<a name="l01943"></a>01943    close(fh);
<a name="l01944"></a>01944    close(fhd);
<a name="l01945"></a>01945    close(fhi);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l01948"></a>01948 }
<a name="l01949"></a>01949 <span class="comment"></span>
<a name="l01950"></a>01950 <span class="comment">/**dox***************************************************************/</span>
<a name="l01951"></a>01951 <span class="preprocessor">#ifndef DOXYGEN_SHOULD_SKIP_THIS</span>
<a name="l01952"></a>01952 <span class="preprocessor"></span>
<a name="l01953"></a>01953 <span class="comment">/********************************************************************/</span>
<a name="l01954"></a>01954 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hs_fdump(<span class="keywordtype">char</span> *file_name, <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> <span class="keywordtype">id</span>, <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> binary_time)
<a name="l01955"></a>01955 <span class="comment">/********************************************************************\</span>
<a name="l01956"></a>01956 <span class="comment"></span>
<a name="l01957"></a>01957 <span class="comment">  Routine: hs_fdump</span>
<a name="l01958"></a>01958 <span class="comment"></span>
<a name="l01959"></a>01959 <span class="comment">  Purpose: Display history for a given history file</span>
<a name="l01960"></a>01960 <span class="comment"></span>
<a name="l01961"></a>01961 <span class="comment">  Input:</span>
<a name="l01962"></a>01962 <span class="comment">    char   *file_name       Name of file to dump</span>
<a name="l01963"></a>01963 <span class="comment">    DWORD  event_id         Event ID</span>
<a name="l01964"></a>01964 <span class="comment">    BOOL   binary_time      Display DWORD time stamp</span>
<a name="l01965"></a>01965 <span class="comment"></span>
<a name="l01966"></a>01966 <span class="comment">  Output:</span>
<a name="l01967"></a>01967 <span class="comment">    &lt;screen output&gt;</span>
<a name="l01968"></a>01968 <span class="comment"></span>
<a name="l01969"></a>01969 <span class="comment">  Function value:</span>
<a name="l01970"></a>01970 <span class="comment">    HS_SUCCESS              Successful completion</span>
<a name="l01971"></a>01971 <span class="comment">    HS_FILE_ERROR           Cannot open history file</span>
<a name="l01972"></a>01972 <span class="comment"></span>
<a name="l01973"></a>01973 <span class="comment">\********************************************************************/</span>
<a name="l01974"></a>01974 {
<a name="l01975"></a>01975    <span class="keywordtype">int</span> fh;
<a name="l01976"></a>01976    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> n;
<a name="l01977"></a>01977    time_t ltime;
<a name="l01978"></a>01978    <a class="code" href="structHIST__RECORD.html">HIST_RECORD</a> rec;
<a name="l01979"></a>01979    <span class="keywordtype">char</span> event_name[NAME_LENGTH];
<a name="l01980"></a>01980    <span class="keywordtype">char</span> str[256];
<a name="l01981"></a>01981 
<a name="l01982"></a>01982    <span class="comment">/* open file, add O_BINARY flag for Windows NT */</span>
<a name="l01983"></a>01983    sprintf(str, <span class="stringliteral">&quot;%s%s&quot;</span>, _hs_path_name, file_name);
<a name="l01984"></a>01984    fh = open(str, O_RDONLY | O_BINARY, 0644);
<a name="l01985"></a>01985    <span class="keywordflow">if</span> (fh &lt; 0) {
<a name="l01986"></a>01986       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;hs_fdump&quot;</span>, <span class="stringliteral">&quot;cannot open file %s&quot;</span>, str);
<a name="l01987"></a>01987       <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga564032fce62ccc4689bd3b5864ad0f9c">HS_FILE_ERROR</a>;
<a name="l01988"></a>01988    }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990    <span class="comment">/* loop over file records in .hst file */</span>
<a name="l01991"></a>01991    <span class="keywordflow">do</span> {
<a name="l01992"></a>01992       n = read(fh, (<span class="keywordtype">char</span> *) &amp;rec, <span class="keyword">sizeof</span>(rec));
<a name="l01993"></a>01993       <span class="keywordflow">if</span> (n &lt; <span class="keyword">sizeof</span>(rec))
<a name="l01994"></a>01994          <span class="keywordflow">break</span>;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996       <span class="comment">/* check if record type is definition */</span>
<a name="l01997"></a>01997       <span class="keywordflow">if</span> (rec.record_type == <a class="code" href="group__mhistoryh.html#ga53bf0d0c21b64cf42e4355c3919f6fa2">RT_DEF</a>) {
<a name="l01998"></a>01998          <span class="comment">/* read name */</span>
<a name="l01999"></a>01999          read(fh, event_name, <span class="keyword">sizeof</span>(event_name));
<a name="l02000"></a>02000 
<a name="l02001"></a>02001          <span class="keywordflow">if</span> (rec.event_id == <span class="keywordtype">id</span> || <span class="keywordtype">id</span> == 0)
<a name="l02002"></a>02002             printf(<span class="stringliteral">&quot;Event definition %s, ID %d\n&quot;</span>, event_name, rec.event_id);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004          <span class="comment">/* skip tags */</span>
<a name="l02005"></a>02005          lseek(fh, rec.data_size, SEEK_CUR);
<a name="l02006"></a>02006       } <span class="keywordflow">else</span> {
<a name="l02007"></a>02007          <span class="comment">/* print data record */</span>
<a name="l02008"></a>02008          <span class="keywordflow">if</span> (binary_time)
<a name="l02009"></a>02009             sprintf(str, <span class="stringliteral">&quot;%d &quot;</span>, rec.time);
<a name="l02010"></a>02010          <span class="keywordflow">else</span> {
<a name="l02011"></a>02011             ltime = (time_t) rec.time;
<a name="l02012"></a>02012             strcpy(str, ctime(&amp;ltime) + 4);
<a name="l02013"></a>02013             str[15] = 0;
<a name="l02014"></a>02014          }
<a name="l02015"></a>02015          <span class="keywordflow">if</span> (rec.event_id == <span class="keywordtype">id</span> || <span class="keywordtype">id</span> == 0)
<a name="l02016"></a>02016             printf(<span class="stringliteral">&quot;ID %d, %s, size %d\n&quot;</span>, rec.event_id, str, rec.data_size);
<a name="l02017"></a>02017 
<a name="l02018"></a>02018          <span class="comment">/* skip data */</span>
<a name="l02019"></a>02019          lseek(fh, rec.data_size, SEEK_CUR);
<a name="l02020"></a>02020       }
<a name="l02021"></a>02021 
<a name="l02022"></a>02022    } <span class="keywordflow">while</span> (TRUE);
<a name="l02023"></a>02023 
<a name="l02024"></a>02024    close(fh);
<a name="l02025"></a>02025 
<a name="l02026"></a>02026    <span class="keywordflow">return</span> <a class="code" href="group__err26.html#ga2d533509db8628a7e0eb794e2b3e77b0">HS_SUCCESS</a>;
<a name="l02027"></a>02027 }
<a name="l02028"></a>02028 <span class="preprocessor">#endif                          </span><span class="comment">/* OS_VXWORKS hs section */</span>
<a name="l02029"></a>02029 <span class="comment"></span>
<a name="l02030"></a>02030 <span class="comment">/**dox***************************************************************/</span>
<a name="l02031"></a>02031 <span class="preprocessor">#endif                          </span><span class="comment">/* DOXYGEN_SHOULD_SKIP_THIS */</span>
<a name="l02032"></a>02032 <span class="comment"></span>
<a name="l02033"></a>02033 <span class="comment">/**dox***************************************************************/</span><span class="comment"></span>
<a name="l02034"></a>02034 <span class="comment">         /** @} */</span><span class="comment">/* end of hsfunctioncode */</span>
<a name="l02035"></a>02035 <span class="comment"></span>
<a name="l02036"></a>02036 <span class="comment">/**dox***************************************************************/</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

