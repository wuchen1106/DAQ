<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: mfe.c Source File</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_967645259cf3504d40df5943f0783e6b.html">src</a>
  </div>
</div>
<div class="contents">
<h1>mfe.c</h1><a href="mfe_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/********************************************************************\</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  Name:         mfe.c</span>
<a name="l00004"></a>00004 <span class="comment">  Created by:   Stefan Ritt</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  Contents:     The system part of the MIDAS frontend. Has to be</span>
<a name="l00007"></a>00007 <span class="comment">                linked with user code to form a complete frontend</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">  $Id: mfe.c 5227 2012-01-06 14:04:44Z ritt $</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">\********************************************************************/</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="midas_8h.html">midas.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="msystem_8h.html">msystem.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="mcstd_8h.html">mcstd.h</a>&quot;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">/* items defined in frontend.c */</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="mfe_8c.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>;
<a name="l00024"></a>00024 <span class="keyword">extern</span> <span class="keywordtype">char</span> *<a class="code" href="mfe_8c.html#ac7fc683b5a25d9607abc270a54db6d97">frontend_file_name</a>;
<a name="l00025"></a>00025 <span class="keyword">extern</span> <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mfe_8c.html#a0215c0a842a0e97fe65c7ef5fb7633a5">frontend_call_loop</a>;
<a name="l00026"></a>00026 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>;
<a name="l00027"></a>00027 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>;
<a name="l00028"></a>00028 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>;
<a name="l00029"></a>00029 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>;
<a name="l00030"></a>00030 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a802849119d469feb2d1deee1be9593ac">frontend_init</a>(<span class="keywordtype">void</span>);
<a name="l00031"></a>00031 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a3b682405038cc4f6af505d7ca6367a4f">frontend_exit</a>(<span class="keywordtype">void</span>);
<a name="l00032"></a>00032 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#ad902740ed5577f2f940454359ec1df1c">frontend_loop</a>(<span class="keywordtype">void</span>);
<a name="l00033"></a>00033 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#ad8bfe703c49342b9f0275aba77dc7758">begin_of_run</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00034"></a>00034 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#ae6d798649008b7523c77222bae2d4187">end_of_run</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00035"></a>00035 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a164db20cf6c8c81e8c8ca50a590de436">pause_run</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00036"></a>00036 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a6cada7e3f07b9fc2b9886263223661d4">resume_run</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, <span class="keywordtype">char</span> *error);
<a name="l00037"></a>00037 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> source, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> count, <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="sis3803_8c.html#a8fa8e4c8bef10b038f6a033f736d5bce">test</a>);
<a name="l00038"></a>00038 <span class="keyword">extern</span> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a681a5d1fe2e8a4735bcf03824ffb3e81">interrupt_configure</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> cmd, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> source, POINTER_T adr);
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">/* globals */</span>
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">00044</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a> = 1; <span class="comment">// 0 for RPC socket, 1 for event socket</span>
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="mfe_8c.html#a022c39e327f494dda3664f8888f860f1">00046</a> <span class="preprocessor">#define SERVER_CACHE_SIZE  100000       </span><span class="comment">/* event cache before buffer */</span>
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="mfe_8c.html#a380a50d445745c2da54a29a1f2e5099e">00048</a> <span class="preprocessor">#define ODB_UPDATE_TIME      1000       </span><span class="comment">/* 1 seconds for ODB update */</span>
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="mfe_8c.html#a093e717ef9582e83efcc2550ef0c28cb">00050</a> <span class="preprocessor">#define DEFAULT_FE_TIMEOUT  60000       </span><span class="comment">/* 60 seconds for watchdog timeout */</span>
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="fevme_8cxx.html#a81f01ccafac403262a2e430c118516a3">00052</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a>;                  <span class="comment">/* STATE_RUNNING, STATE_STOPPED, STATE_PAUSED */</span>
<a name="l00053"></a><a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">00053</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>;
<a name="l00054"></a><a class="code" href="mfe_8c.html#a6431147bd66aebfe3ca728d244da1253">00054</a> <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> <a class="code" href="mfe_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;              <span class="comment">/* current time in seconds since 1970 */</span>
<a name="l00055"></a><a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">00055</a> <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;         <span class="comment">/* current time in milliseconds */</span>
<a name="l00056"></a><a class="code" href="mfe_8c.html#a5a5eefb72c568f3c9c81d8c9c4b0dddc">00056</a> <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> <a class="code" href="mfe_8c.html#a5a5eefb72c568f3c9c81d8c9c4b0dddc">rate_period</a>;              <span class="comment">/* period in ms for rate calculations */</span>
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">00058</a> <span class="keywordtype">char</span> <a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[<a class="code" href="group__midasincludecode.html#ga2010c9ed4ef21c3171de778157b9c494">HOST_NAME_LENGTH</a>];
<a name="l00059"></a><a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">00059</a> <span class="keywordtype">char</span> <a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[<a class="code" href="group__midasincludecode.html#gaf71324c57f05ff9e24bd384925dd6b17">NAME_LENGTH</a>];
<a name="l00060"></a><a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">00060</a> <span class="keywordtype">char</span> <a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>[256];
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">00062</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a>;
<a name="l00063"></a><a class="code" href="mfe_8c.html#a17033889b9f2e378c3bc26401a399550">00063</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a17033889b9f2e378c3bc26401a399550">optimize</a> = 0;               <span class="comment">/* set this to one to opimize TCP buffer size */</span>
<a name="l00064"></a><a class="code" href="mfe_8c.html#a8432f49f703ed2d20248effc3125b0e1">00064</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a8432f49f703ed2d20248effc3125b0e1">fe_stop</a> = 0;                <span class="comment">/* stop switch for VxWorks */</span>
<a name="l00065"></a><a class="code" href="ebuser_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">00065</a> <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mfe_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>;                     <span class="comment">/* disable watchdog messages from server */</span>
<a name="l00066"></a><a class="code" href="mfe_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">00066</a> <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> <a class="code" href="mfe_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = 0;         <span class="comment">/* restart run after event limit reached stop */</span>
<a name="l00067"></a><a class="code" href="mfe_8c.html#a8af66bd2f0727f85b7ba0b1670d90427">00067</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a8af66bd2f0727f85b7ba0b1670d90427">manual_trigger_event_id</a> = 0;        <span class="comment">/* set from the manual_trigger callback */</span>
<a name="l00068"></a><a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">00068</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a> = -1;        <span class="comment">/* frontend index for event building */</span>
<a name="l00069"></a><a class="code" href="mfe_8c.html#ace3256e0c09b9b2d5c109f8dbab3692f">00069</a> <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mfe_8c.html#ace3256e0c09b9b2d5c109f8dbab3692f">lockout_readout_thread</a> = TRUE; <span class="comment">/* manual triggers, periodic events and 1Hz flush cache lockout the readout thread */</span>
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="fevme_8cxx.html#ab1f60c53f74e806a3b9f687af38d7421">00071</a> HNDLE <a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="keyword">extern</span> <a class="code" href="structeqpmnt.html">EQUIPMENT</a> <a class="code" href="mfe_8c.html#aa86ef8764826784b74603ffb23852283">equipment</a>[];
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="mfe_8c.html#ae08e1d173902a2cb83c58d268c6e4d3e">00075</a> <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *<a class="code" href="mfe_8c.html#ae08e1d173902a2cb83c58d268c6e4d3e">interrupt_eq</a> = NULL;
<a name="l00076"></a><a class="code" href="mfe_8c.html#a70168de725104e9390e949e6caa942ec">00076</a> <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *<a class="code" href="mfe_8c.html#a70168de725104e9390e949e6caa942ec">multithread_eq</a> = NULL;
<a name="l00077"></a><a class="code" href="mfe_8c.html#a4ab4f1288fd294c7c649291f87355985">00077</a> <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mfe_8c.html#a4ab4f1288fd294c7c649291f87355985">slowcont_eq</a> = FALSE;
<a name="l00078"></a><a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">00078</a> <span class="keywordtype">void</span> *<a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l00079"></a><a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">00079</a> <span class="keywordtype">void</span> *<a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">frag_buffer</a> = NULL;
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">00081</a> <span class="keywordtype">int</span> *<a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a>;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">/* inter-thread communication */</span>
<a name="l00084"></a><a class="code" href="mfe_8c.html#a57f548429c75f48f83776762f94fd489">00084</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>=0, <a class="code" href="mfe_8c.html#a0cc81c4acd29047148a2b696a95b330c">rbh2</a>=0, <a class="code" href="mfe_8c.html#aec9294c38a73a78aa646600cef3e77f5">rbh1_next</a>=0, <a class="code" href="mfe_8c.html#a57f548429c75f48f83776762f94fd489">rbh2_next</a>=0;
<a name="l00085"></a><a class="code" href="mfe_8c.html#ab8d6a79a86973098e87386a79dfc4bc7">00085</a> <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ab8d6a79a86973098e87386a79dfc4bc7">stop_all_threads</a> = 0;
<a name="l00086"></a>00086 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a1dcae9fe323025ad03d3ec1b5a95263d">readout_thread</a>(<span class="keywordtype">void</span> *param);
<a name="l00087"></a><a class="code" href="mfe_8c.html#a0e0b5bde115b046964736980402f114e">00087</a> <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a0e0b5bde115b046964736980402f114e">readout_thread_active</a> = 0;
<a name="l00088"></a>00088 <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#acbf3a0cf2e2a061816bd2d95dd097a20">mfe_error_check</a>(<span class="keywordtype">void</span>);
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a467e7d6c77bcbb9259a7167ae1cdf29a">send_event</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> idx, <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> manual_trig);
<a name="l00091"></a>00091 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a9cd62f651300e81799cae815b51ca654">receive_trigger_event</a>(<a class="code" href="structeqpmnt.html">EQUIPMENT</a> *eq);
<a name="l00092"></a>00092 <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> transition);
<a name="l00093"></a>00093 <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>(<span class="keywordtype">void</span>);
<a name="l00094"></a>00094 <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(<a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> flag);
<a name="l00095"></a>00095 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ab6ce300200eebdc71c6a3d5b3760a1ba">readout_enabled</a>(<span class="keywordtype">void</span>);
<a name="l00096"></a>00096 <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a4d77ab19483f67e8240c29a9ff9ca777">display</a>(<a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> bInit);
<a name="l00097"></a>00097 <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#abb411e407679b5b38f424cc2f9f86b07">rotate_wheel</a>(<span class="keywordtype">void</span>);
<a name="l00098"></a>00098 <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mfe_8c.html#ace89325172f363d2efd92735e52ec69e">logger_root</a>();
<a name="l00099"></a>00099 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a6ed70b349943dd2724230ead1d85e4ec">check_polled_events</a>(<span class="keywordtype">void</span>);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/*---- ODB records -------------------------------------------------*/</span>
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="mfe_8c.html#ac92b30327caaa939b1b6630775c78ecd">00103</a> <span class="preprocessor">#define EQUIPMENT_COMMON_STR &quot;\</span>
<a name="l00104"></a>00104 <span class="preprocessor">Event ID = WORD : 0\n\</span>
<a name="l00105"></a>00105 <span class="preprocessor">Trigger mask = WORD : 0\n\</span>
<a name="l00106"></a>00106 <span class="preprocessor">Buffer = STRING : [32] SYSTEM\n\</span>
<a name="l00107"></a>00107 <span class="preprocessor">Type = INT : 0\n\</span>
<a name="l00108"></a>00108 <span class="preprocessor">Source = INT : 0\n\</span>
<a name="l00109"></a>00109 <span class="preprocessor">Format = STRING : [8] FIXED\n\</span>
<a name="l00110"></a>00110 <span class="preprocessor">Enabled = BOOL : 0\n\</span>
<a name="l00111"></a>00111 <span class="preprocessor">Read on = INT : 0\n\</span>
<a name="l00112"></a>00112 <span class="preprocessor">Period = INT : 0\n\</span>
<a name="l00113"></a>00113 <span class="preprocessor">Event limit = DOUBLE : 0\n\</span>
<a name="l00114"></a>00114 <span class="preprocessor">Num subevents = DWORD : 0\n\</span>
<a name="l00115"></a>00115 <span class="preprocessor">Log history = INT : 0\n\</span>
<a name="l00116"></a>00116 <span class="preprocessor">Frontend host = STRING : [32] \n\</span>
<a name="l00117"></a>00117 <span class="preprocessor">Frontend name = STRING : [32] \n\</span>
<a name="l00118"></a>00118 <span class="preprocessor">Frontend file name = STRING : [256] \n\</span>
<a name="l00119"></a>00119 <span class="preprocessor">Status = STRING : [256] \n\</span>
<a name="l00120"></a>00120 <span class="preprocessor">Status color = STRING : [32] \n\</span>
<a name="l00121"></a>00121 <span class="preprocessor">&quot;</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>
<a name="l00123"></a><a class="code" href="mfe_8c.html#a6064db0cc46885d207cedb497e3c355e">00123</a> <span class="preprocessor">#define EQUIPMENT_STATISTICS_STR &quot;\</span>
<a name="l00124"></a>00124 <span class="preprocessor">Events sent = DOUBLE : 0\n\</span>
<a name="l00125"></a>00125 <span class="preprocessor">Events per sec. = DOUBLE : 0\n\</span>
<a name="l00126"></a>00126 <span class="preprocessor">kBytes per sec. = DOUBLE : 0\n\</span>
<a name="l00127"></a>00127 <span class="preprocessor">&quot;</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>
<a name="l00129"></a>00129 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="mfe_8c.html#a0a854b7675d4589bce8f016a94b2706c">00131</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a0a854b7675d4589bce8f016a94b2706c">set_rate_period</a>(<span class="keywordtype">int</span> ms)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133    <a class="code" href="mfe_8c.html#a5a5eefb72c568f3c9c81d8c9c4b0dddc">rate_period</a> = ms;
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00136"></a><a class="code" href="mfe_8c.html#a440b07315fbe46315b56aa8c954952e6">00136</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a440b07315fbe46315b56aa8c954952e6">get_rate_period</a>()
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138    <span class="keywordflow">return</span> <a class="code" href="mfe_8c.html#a5a5eefb72c568f3c9c81d8c9c4b0dddc">rate_period</a>;
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="comment">/*-- transition callbacks ------------------------------------------*/</span>
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="comment">/*-- start ---------------------------------------------------------*/</span>
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="mfe_8c.html#a5ed14877e514f13eeb65a16898b2ba32">00145</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a5ed14877e514f13eeb65a16898b2ba32">tr_start</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> rn, <span class="keywordtype">char</span> *error)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, status;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="comment">/* disable interrupts or readout thread</span>
<a name="l00150"></a>00150 <span class="comment">    * if somehow it was not stopped from previous run */</span>
<a name="l00151"></a>00151    <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(FALSE);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153    <span class="comment">/* reset serial numbers and statistics */</span>
<a name="l00154"></a>00154    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l00155"></a>00155       equipment[i].<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a> = 0;
<a name="l00156"></a>00156       equipment[i].<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a> = 0;
<a name="l00157"></a>00157       equipment[i].<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> = 0;
<a name="l00158"></a>00158       equipment[i].<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a218c744ea441413af262fbd5ddf3780f">events_per_sec</a> = 0;
<a name="l00159"></a>00159       equipment[i].<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> = 0;
<a name="l00160"></a>00160       equipment[i].<a class="code" href="structeqpmnt.html#ab487ff66b0ceb7677a3e664717158c51">odb_in</a> = equipment[i].<a class="code" href="structeqpmnt.html#a2ba622da82fc7a02605e5f630464b13f">odb_out</a> = 0;
<a name="l00161"></a>00161       <a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a>[i] = 0;
<a name="l00162"></a>00162    }
<a name="l00163"></a>00163    <a class="code" href="group__odbfunctionc.html#gae5ccb46009b64dbeff8dbc05be27664b">db_send_changed_records</a>();
<a name="l00164"></a>00164 
<a name="l00165"></a>00165    status = <a class="code" href="mfe_8c.html#ad8bfe703c49342b9f0275aba77dc7758">begin_of_run</a>(rn, error);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167    <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l00168"></a>00168       <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l00169"></a>00169       <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171       <a class="code" href="mfe_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) {
<a name="l00174"></a>00174          ss_printf(14, 2, <span class="stringliteral">&quot;Running &quot;</span>);
<a name="l00175"></a>00175          ss_printf(36, 2, <span class="stringliteral">&quot;%d&quot;</span>, rn);
<a name="l00176"></a>00176       }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178       <span class="comment">/* enable interrupts or readout thread */</span>
<a name="l00179"></a>00179       <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l00180"></a>00180    }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182    <span class="keywordflow">return</span> status;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 <span class="comment">/*-- prestop -------------------------------------------------------*/</span>
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="mfe_8c.html#a5c030a1926f2439e78b7bd0d00221937">00187</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a5c030a1926f2439e78b7bd0d00221937">tr_stop</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> rn, <span class="keywordtype">char</span> *error)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status, i;
<a name="l00190"></a>00190    <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *eq;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192    <span class="comment">/* disable interrupts or readout thread */</span>
<a name="l00193"></a>00193    <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(FALSE);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195    status = <a class="code" href="mfe_8c.html#ae6d798649008b7523c77222bae2d4187">end_of_run</a>(rn, error);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197    <span class="comment">/* check if event(s) happened just before disabling the trigger */</span>
<a name="l00198"></a>00198    <span class="keywordflow">if</span> ((i = <a class="code" href="mfe_8c.html#a6ed70b349943dd2724230ead1d85e4ec">check_polled_events</a>()) &gt; 0) {
<a name="l00199"></a>00199       <span class="comment">// cm_msg(MINFO, &quot;tr_stop&quot;, &quot;sent remaining %d polled events&quot;, i);</span>
<a name="l00200"></a>00200    }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202    <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l00203"></a>00203       <span class="comment">/* don&apos;t send events if already stopped */</span>
<a name="l00204"></a>00204       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> != <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>)
<a name="l00205"></a>00205          <a class="code" href="mfe_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207       <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> = <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>;
<a name="l00208"></a>00208       <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00211"></a>00211          ss_printf(14, 2, <span class="stringliteral">&quot;Stopped &quot;</span>);
<a name="l00212"></a>00212    } <span class="keywordflow">else</span>
<a name="l00213"></a>00213       <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l00216"></a>00216       <span class="comment">/* read remaining events from ring buffers */</span>
<a name="l00217"></a>00217       <span class="keywordflow">if</span> (equipment[i].info.eq_type &amp; (<a class="code" href="group__mdefineh.html#ga7cc85959e8d0c4e476cf659c2cee7a33">EQ_MULTITHREAD</a> | <a class="code" href="group__mdefineh.html#gad5ba2ec0f5d55139048dbe2d416da6ba">EQ_INTERRUPT</a>)) {
<a name="l00218"></a>00218          <span class="keywordflow">while</span> (<a class="code" href="mfe_8c.html#a9cd62f651300e81799cae815b51ca654">receive_trigger_event</a>(equipment+i) &gt; 0);
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221       <span class="comment">/* flush remaining buffered events */</span>
<a name="l00222"></a>00222       <a class="code" href="group__rpcfunctionc.html#ga83d80e4f1e8d2a2d7f38e58dcfd3c711">rpc_flush_event</a>();
<a name="l00223"></a>00223       <span class="keywordflow">if</span> (equipment[i].buffer_handle) {
<a name="l00224"></a>00224          <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> err = <a class="code" href="group__bmfunctionc.html#ga9b74b8aa633c942682e642acba93c51d">bm_flush_cache</a>(equipment[i].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l00225"></a>00225          <span class="keywordflow">if</span> (err != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) {
<a name="l00226"></a>00226             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;tr_stop&quot;</span>, <span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>, err);
<a name="l00227"></a>00227             <span class="keywordflow">return</span> err;
<a name="l00228"></a>00228          }
<a name="l00229"></a>00229       }
<a name="l00230"></a>00230    }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232    <span class="comment">/* update final statistics record in ODB */</span>
<a name="l00233"></a>00233    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l00234"></a>00234       eq = &amp;equipment[i];
<a name="l00235"></a>00235       eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> += eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>;
<a name="l00236"></a>00236       eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a218c744ea441413af262fbd5ddf3780f">events_per_sec</a> = 0;
<a name="l00237"></a>00237       eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> = 0;
<a name="l00238"></a>00238       eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> = 0;
<a name="l00239"></a>00239       eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> = 0;
<a name="l00240"></a>00240       <a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a>[i] = 0;
<a name="l00241"></a>00241    }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243    <a class="code" href="group__odbfunctionc.html#gae5ccb46009b64dbeff8dbc05be27664b">db_send_changed_records</a>();
<a name="l00244"></a>00244 
<a name="l00245"></a>00245    <span class="keywordflow">return</span> status;
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">/*-- pause ---------------------------------------------------------*/</span>
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="mfe_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">00250</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">tr_pause</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> rn, <span class="keywordtype">char</span> *error)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254    <span class="comment">/* disable interrupts or readout thread */</span>
<a name="l00255"></a>00255    <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(FALSE);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    status = <a class="code" href="mfe_8c.html#a164db20cf6c8c81e8c8ca50a590de436">pause_run</a>(rn, error);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259    <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l00260"></a>00260       <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> = <a class="code" href="group__mdefineh.html#gab08c47284371c683ba80d6b3244400f1">STATE_PAUSED</a>;
<a name="l00261"></a>00261       <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263       <a class="code" href="mfe_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a>);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00266"></a>00266          ss_printf(14, 2, <span class="stringliteral">&quot;Paused  &quot;</span>);
<a name="l00267"></a>00267    } <span class="keywordflow">else</span>
<a name="l00268"></a>00268       <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270    <span class="keywordflow">return</span> status;
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">/*-- resume --------------------------------------------------------*/</span>
<a name="l00274"></a>00274 
<a name="l00275"></a><a class="code" href="mfe_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">00275</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> rn, <span class="keywordtype">char</span> *error)
<a name="l00276"></a>00276 {
<a name="l00277"></a>00277    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279    status = <a class="code" href="mfe_8c.html#a6cada7e3f07b9fc2b9886263223661d4">resume_run</a>(rn, error);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281    <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l00282"></a>00282       <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> = <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>;
<a name="l00283"></a>00283       <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = rn;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285       <a class="code" href="mfe_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a>);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00288"></a>00288          ss_printf(14, 2, <span class="stringliteral">&quot;Running &quot;</span>);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290       <span class="comment">/* enable interrupts or readout thread */</span>
<a name="l00291"></a>00291       <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l00292"></a>00292    }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294    <span class="keywordflow">return</span> status;
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00298"></a>00298 
<a name="l00299"></a><a class="code" href="mfe_8c.html#aa5db6f0a873100f5d99f5f3518be2425">00299</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#aa5db6f0a873100f5d99f5f3518be2425">manual_trigger</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> idx, <span class="keywordtype">void</span> *prpc_param[])
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301    <span class="keywordtype">int</span> i;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303    i = idx; <span class="comment">/* avoid compiler warning */</span>
<a name="l00304"></a>00304    <a class="code" href="mfe_8c.html#a8af66bd2f0727f85b7ba0b1670d90427">manual_trigger_event_id</a> = CWORD(0);
<a name="l00305"></a>00305    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00309"></a>00309 
<a name="l00310"></a><a class="code" href="mfe_8c.html#ac5da75a0713cdecd2f46a7301b31c0c4">00310</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ac5da75a0713cdecd2f46a7301b31c0c4">sc_thread</a>(<span class="keywordtype">void</span> *info)
<a name="l00311"></a>00311 {
<a name="l00312"></a>00312    <a class="code" href="structDEVICE__DRIVER.html">DEVICE_DRIVER</a> *device_drv = info;
<a name="l00313"></a>00313    <span class="keywordtype">int</span> i, status, cmd;
<a name="l00314"></a>00314    <span class="keywordtype">int</span> current_channel = 0;
<a name="l00315"></a>00315    <span class="keywordtype">int</span> current_priority_channel = 0;
<a name="l00316"></a>00316    <span class="keywordtype">float</span> value;
<a name="l00317"></a>00317    <span class="keywordtype">int</span> *last_update;
<a name="l00318"></a>00318    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> current_time;
<a name="l00319"></a>00319    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> <a class="code" href="mevb_8c.html#a5fecce64b1b883ada4ac0bc410fb3304">last_time</a>;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321    last_update = calloc(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00322"></a>00322    last_time = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    <span class="keywordflow">do</span> {
<a name="l00325"></a>00325       <span class="comment">/* read one channel from device */</span>
<a name="l00326"></a>00326       <span class="keywordflow">for</span> (cmd = <a class="code" href="group__err26.html#gae7830d58842019be517f323325aaef2c">CMD_GET_FIRST</a>; cmd &lt;= <a class="code" href="group__err26.html#ga59a67892841cce1949a4de5f3ed495fc">CMD_GET_LAST</a>; cmd++) {
<a name="l00327"></a>00327          value = (float)ss_nan();
<a name="l00328"></a>00328          status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(cmd, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, current_channel, &amp;value);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330          ss_semaphore_wait_for(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>, 1000);
<a name="l00331"></a>00331          device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[current_channel].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[cmd] = value;
<a name="l00332"></a>00332          device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a039db8f66e6b3f5ed6c3358d6e934bb1">status</a> = status;
<a name="l00333"></a>00333          ss_semaphore_release(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335          <span class="comment">// printf(&quot;TID %d: channel %d, value %f\n&quot;, ss_gettid(), current_channel, value);</span>
<a name="l00336"></a>00336       }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338       <span class="comment">/* switch to next channel in next loop */</span>
<a name="l00339"></a>00339       current_channel = (current_channel + 1) % device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341       <span class="comment">/* check for priority channel */</span>
<a name="l00342"></a>00342       current_time = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l00343"></a>00343       i = (current_priority_channel + 1) % device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>;
<a name="l00344"></a>00344       while (!(current_time - last_update[i] &lt; 10000)) {
<a name="l00345"></a>00345          i = (i + 1) % device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>;
<a name="l00346"></a>00346          if (i == current_priority_channel) {
<a name="l00347"></a>00347             <span class="comment">/* non found, so finish */</span>
<a name="l00348"></a>00348             <span class="keywordflow">break</span>;
<a name="l00349"></a>00349          }
<a name="l00350"></a>00350       }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352       <span class="comment">/* updated channel found, so read it additionally */</span>
<a name="l00353"></a>00353       <span class="keywordflow">if</span> (current_time - last_update[i] &lt; 10000) {
<a name="l00354"></a>00354          current_priority_channel = i;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356          <span class="keywordflow">for</span> (cmd = <a class="code" href="group__err26.html#gae7830d58842019be517f323325aaef2c">CMD_GET_FIRST</a>; cmd &lt;= <a class="code" href="group__err26.html#ga59a67892841cce1949a4de5f3ed495fc">CMD_GET_LAST</a>; cmd++) {
<a name="l00357"></a>00357             status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(cmd, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, i, &amp;value);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359             ss_semaphore_wait_for(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>, 1000);
<a name="l00360"></a>00360             device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[i].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[cmd] = value;
<a name="l00361"></a>00361             device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a039db8f66e6b3f5ed6c3358d6e934bb1">status</a> = status;
<a name="l00362"></a>00362             ss_semaphore_release(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>);
<a name="l00363"></a>00363          }
<a name="l00364"></a>00364       }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366       <span class="comment">/* check if anything to write to device */</span>
<a name="l00367"></a>00367       <span class="keywordflow">for</span> (i = 0; i &lt; device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>; i++) {
<a name="l00368"></a>00368 
<a name="l00369"></a>00369          <span class="keywordflow">for</span> (cmd = <a class="code" href="group__err26.html#ga3ee43155ccdffd4f1ce480a5a078d33e">CMD_SET_FIRST</a>; cmd &lt;= <a class="code" href="group__err26.html#ga3c5f7e38133a18c2bdc72fc11358bf9a">CMD_SET_LAST</a>; cmd++) {
<a name="l00370"></a>00370             <span class="keywordflow">if</span> (!ss_isnan(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[i].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[cmd])) {
<a name="l00371"></a>00371                ss_semaphore_wait_for(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>, 1000);
<a name="l00372"></a>00372                value = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[i].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[cmd];
<a name="l00373"></a>00373                device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[i].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[cmd] = (float) ss_nan();
<a name="l00374"></a>00374                device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a039db8f66e6b3f5ed6c3358d6e934bb1">status</a> = status;
<a name="l00375"></a>00375                ss_semaphore_release(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377                status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(cmd, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, i, value);
<a name="l00378"></a>00378                last_update[i] = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l00379"></a>00379             }
<a name="l00380"></a>00380          }
<a name="l00381"></a>00381       }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383       <span class="comment">/* limit data rate if defined in equipment list */</span>
<a name="l00384"></a>00384       <span class="keywordflow">if</span> (current_channel == 0)
<a name="l00385"></a>00385          <span class="keywordflow">if</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a0c44eefaa711ea871881308c507c8b00">pequipment</a> &amp;&amp; device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a0c44eefaa711ea871881308c507c8b00">pequipment</a>-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>) {
<a name="l00386"></a>00386             <span class="keywordflow">while</span> (<a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>() - last_time &lt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>)device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a0c44eefaa711ea871881308c507c8b00">pequipment</a>-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &amp;&amp;
<a name="l00387"></a>00387                    !device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4dc7498cbf9c5c57a6d1b90aa7a7db6a">stop_thread</a>)
<a name="l00388"></a>00388                <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(10);
<a name="l00389"></a>00389             last_time = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l00390"></a>00390          }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392    } <span class="keywordflow">while</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4dc7498cbf9c5c57a6d1b90aa7a7db6a">stop_thread</a> == 0);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394    free(last_update);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396    <span class="comment">/* signal stopped thread */</span>
<a name="l00397"></a>00397    device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4dc7498cbf9c5c57a6d1b90aa7a7db6a">stop_thread</a> = 2;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00400"></a>00400 }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00403"></a>00403 
<a name="l00404"></a><a class="code" href="group__mequipment.html#gab0636870de45a7b8a7bcb625c0ac7582">00404</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="group__mequipment.html#gab0636870de45a7b8a7bcb625c0ac7582">device_driver</a>(<a class="code" href="structDEVICE__DRIVER.html">DEVICE_DRIVER</a> * device_drv, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> cmd, ...)
<a name="l00405"></a>00405 {
<a name="l00406"></a>00406    va_list argptr;
<a name="l00407"></a>00407    HNDLE <a class="code" href="mevb_8c.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l00408"></a>00408    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> channel, status, i, j;
<a name="l00409"></a>00409    <span class="keywordtype">float</span> value, *pvalue;
<a name="l00410"></a>00410    <span class="keywordtype">char</span> *name, *label, str[256];
<a name="l00411"></a>00411 
<a name="l00412"></a>00412    va_start(argptr, cmd);
<a name="l00413"></a>00413    status = <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415    <span class="keywordflow">switch</span> (cmd) {
<a name="l00416"></a>00416    <span class="keywordflow">case</span> <a class="code" href="group__err26.html#ga2677fc43f8393bcf3bafc8bbface003f">CMD_INIT</a>:
<a name="l00417"></a>00417       hKey = va_arg(argptr, HNDLE);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419       <span class="keywordflow">if</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a> &amp; <a class="code" href="group__mequipment.html#ga2499f0abd1f0577de72d1d5645fc7713">DF_MULTITHREAD</a>) {
<a name="l00420"></a>00420          status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(<a class="code" href="group__err26.html#ga2677fc43f8393bcf3bafc8bbface003f">CMD_INIT</a>, hKey, &amp;device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>,
<a name="l00421"></a>00421                                     device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a>,
<a name="l00422"></a>00422                                     device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a885e46846e92facb6222f6a430127772">bd</a>);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424          <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a> &amp;&amp; (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a> &amp; <a class="code" href="group__mequipment.html#ga2499f0abd1f0577de72d1d5645fc7713">DF_MULTITHREAD</a>)) {
<a name="l00425"></a>00425             <span class="comment">/* create inter-thread data exchange buffers */</span>
<a name="l00426"></a>00426             device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a> = (<a class="code" href="structDD__MT__BUFFER.html">DD_MT_BUFFER</a> *) calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structDD__MT__BUFFER.html">DD_MT_BUFFER</a>));
<a name="l00427"></a>00427             device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a39e0e855a040ada9fdf72bebe936541e">n_channels</a> = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>;
<a name="l00428"></a>00428             device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a> = (<a class="code" href="structDD__MT__CHANNEL.html">DD_MT_CHANNEL</a> *) calloc(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>, <span class="keyword">sizeof</span>(<a class="code" href="structDD__MT__CHANNEL.html">DD_MT_CHANNEL</a>));
<a name="l00429"></a>00429             assert(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431             <span class="comment">/* set all set values to NaN */</span>
<a name="l00432"></a>00432             <span class="keywordflow">for</span> (i=0 ; i&lt;device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a> ; i++)
<a name="l00433"></a>00433                <span class="keywordflow">for</span> (j=<a class="code" href="group__err26.html#ga3ee43155ccdffd4f1ce480a5a078d33e">CMD_SET_FIRST</a> ; j&lt;=<a class="code" href="group__err26.html#ga3c5f7e38133a18c2bdc72fc11358bf9a">CMD_SET_LAST</a> ; j++)
<a name="l00434"></a>00434                   device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[i].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[j] = (<span class="keywordtype">float</span>)ss_nan();
<a name="l00435"></a>00435 
<a name="l00436"></a>00436             <span class="comment">/* get default names for this driver already now */</span>
<a name="l00437"></a>00437             <span class="keywordflow">for</span> (i = 0; i &lt; device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>; i++)
<a name="l00438"></a>00438                device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(<a class="code" href="group__err26.html#gacd4918f4633cc4bb4bc967382c756b9a">CMD_GET_LABEL</a>, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, i,
<a name="l00439"></a>00439                                  device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[i].<a class="code" href="structDD__MT__CHANNEL.html#a9f3418338f716f8780e5bf9f2b650229">label</a>);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441             <span class="comment">/* create semaphore */</span>
<a name="l00442"></a>00442             sprintf(str, <span class="stringliteral">&quot;DD_%s&quot;</span>, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>);
<a name="l00443"></a>00443             status = ss_semaphore_create(str, &amp;device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>);
<a name="l00444"></a>00444             <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga7440cf35b00082fb16e8584ada5b50e0">SS_CREATED</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a>)
<a name="l00445"></a>00445                <span class="keywordflow">return</span> <a class="code" href="group__err26.html#gac4221d7e494c798f57552f502e2459ef">FE_ERR_DRIVER</a>;
<a name="l00446"></a>00446             status = <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>;
<a name="l00447"></a>00447          }
<a name="l00448"></a>00448       } <span class="keywordflow">else</span> {
<a name="l00449"></a>00449          status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(<a class="code" href="group__err26.html#ga2677fc43f8393bcf3bafc8bbface003f">CMD_INIT</a>, hKey, &amp;device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>,
<a name="l00450"></a>00450                                     device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a1451258cb714852eef78ec04e7970f65">channels</a>, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a>,
<a name="l00451"></a>00451                                     device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a885e46846e92facb6222f6a430127772">bd</a>);
<a name="l00452"></a>00452       }
<a name="l00453"></a>00453       <span class="keywordflow">break</span>;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455    <span class="keywordflow">case</span> <a class="code" href="group__err26.html#gab905e6aff2332984df0552c6b50203f2">CMD_START</a>:
<a name="l00456"></a>00456       <span class="keywordflow">if</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a> &amp; <a class="code" href="group__mequipment.html#ga2499f0abd1f0577de72d1d5645fc7713">DF_MULTITHREAD</a> &amp;&amp; device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a> != NULL) {
<a name="l00457"></a>00457          <span class="comment">/* create dedicated thread for this device */</span>
<a name="l00458"></a>00458          device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a423b3c5c3e9c6f3c930341ea61d44fb8">thread_id</a> = <a class="code" href="group__msfunctionc.html#ga29342b1b9eaa66a0076dd0876090087d">ss_thread_create</a>(<a class="code" href="mfe_8c.html#ac5da75a0713cdecd2f46a7301b31c0c4">sc_thread</a>, device_drv);
<a name="l00459"></a>00459       }
<a name="l00460"></a>00460       <span class="keywordflow">break</span>;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462    <span class="keywordflow">case</span> <a class="code" href="group__err26.html#ga46dc7ae84992bfe62cc00731959a67f4">CMD_STOP</a>:
<a name="l00463"></a>00463       <span class="keywordflow">if</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a> &amp; <a class="code" href="group__mequipment.html#ga2499f0abd1f0577de72d1d5645fc7713">DF_MULTITHREAD</a> &amp;&amp; device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a> != NULL) {
<a name="l00464"></a>00464          device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4dc7498cbf9c5c57a6d1b90aa7a7db6a">stop_thread</a> = 1;
<a name="l00465"></a>00465          <span class="comment">/* wait for max. 10 seconds until thread has gracefully stopped */</span>
<a name="l00466"></a>00466          <span class="keywordflow">for</span> (i = 0; i &lt; 1000; i++) {
<a name="l00467"></a>00467             <span class="keywordflow">if</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4dc7498cbf9c5c57a6d1b90aa7a7db6a">stop_thread</a> == 2)
<a name="l00468"></a>00468                <span class="keywordflow">break</span>;
<a name="l00469"></a>00469             <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(10);
<a name="l00470"></a>00470          }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472          <span class="comment">/* if timeout expired, kill thread */</span>
<a name="l00473"></a>00473          <span class="keywordflow">if</span> (i == 1000)
<a name="l00474"></a>00474             <a class="code" href="group__msfunctionc.html#gacf452572de3c2f6c5c899bc4a19aeaac">ss_thread_kill</a>(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a423b3c5c3e9c6f3c930341ea61d44fb8">thread_id</a>);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476          ss_semaphore_delete(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>, TRUE);
<a name="l00477"></a>00477          free(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>);
<a name="l00478"></a>00478          free(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>);
<a name="l00479"></a>00479       }
<a name="l00480"></a>00480       <span class="keywordflow">break</span>;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <span class="keywordflow">case</span> <a class="code" href="group__err26.html#gacfa1d482ab47b3ceebb9717007111649">CMD_EXIT</a>:
<a name="l00483"></a>00483       status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(<a class="code" href="group__err26.html#gacfa1d482ab47b3ceebb9717007111649">CMD_EXIT</a>, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>);
<a name="l00484"></a>00484       <span class="keywordflow">break</span>;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486    <span class="keywordflow">case</span> <a class="code" href="group__err26.html#gaa0706cd66be2ae6e198adc217c2ad9bf">CMD_SET_LABEL</a>:
<a name="l00487"></a>00487       channel = va_arg(argptr, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>);
<a name="l00488"></a>00488       label = va_arg(argptr, <span class="keywordtype">char</span> *);
<a name="l00489"></a>00489       status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(<a class="code" href="group__err26.html#gaa0706cd66be2ae6e198adc217c2ad9bf">CMD_SET_LABEL</a>, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, channel, label);
<a name="l00490"></a>00490       <span class="keywordflow">break</span>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    <span class="keywordflow">case</span> <a class="code" href="group__err26.html#gacd4918f4633cc4bb4bc967382c756b9a">CMD_GET_LABEL</a>:
<a name="l00493"></a>00493       channel = va_arg(argptr, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>);
<a name="l00494"></a>00494       name = va_arg(argptr, <span class="keywordtype">char</span> *);
<a name="l00495"></a>00495       status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(<a class="code" href="group__err26.html#gacd4918f4633cc4bb4bc967382c756b9a">CMD_GET_LABEL</a>, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, channel, name);
<a name="l00496"></a>00496       <span class="keywordflow">break</span>;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498    <span class="keywordflow">default</span>:
<a name="l00499"></a>00499 
<a name="l00500"></a>00500       <span class="keywordflow">if</span> (cmd &gt;= <a class="code" href="group__err26.html#ga3ee43155ccdffd4f1ce480a5a078d33e">CMD_SET_FIRST</a> &amp;&amp; cmd &lt;= <a class="code" href="group__err26.html#ga3c5f7e38133a18c2bdc72fc11358bf9a">CMD_SET_LAST</a>) {
<a name="l00501"></a>00501 
<a name="l00502"></a>00502          <span class="comment">/* transfer data to sc_thread for SET commands */</span>
<a name="l00503"></a>00503          channel = va_arg(argptr, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>);
<a name="l00504"></a>00504          value = (float) va_arg(argptr, <span class="keywordtype">double</span>);        <span class="comment">// floats are passed as double</span>
<a name="l00505"></a>00505          <span class="keywordflow">if</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a> &amp; <a class="code" href="group__mequipment.html#ga2499f0abd1f0577de72d1d5645fc7713">DF_MULTITHREAD</a>) {
<a name="l00506"></a>00506             ss_semaphore_wait_for(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>, 1000);
<a name="l00507"></a>00507             device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[channel].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[cmd] = value;
<a name="l00508"></a>00508             status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a039db8f66e6b3f5ed6c3358d6e934bb1">status</a>;
<a name="l00509"></a>00509             ss_semaphore_release(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>);
<a name="l00510"></a>00510          } <span class="keywordflow">else</span> {
<a name="l00511"></a>00511             status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(cmd, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, channel, value);
<a name="l00512"></a>00512          }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd &gt;= <a class="code" href="group__err26.html#gae7830d58842019be517f323325aaef2c">CMD_GET_FIRST</a> &amp;&amp; cmd &lt;= <a class="code" href="group__err26.html#ga59a67892841cce1949a4de5f3ed495fc">CMD_GET_LAST</a>) {
<a name="l00515"></a>00515 
<a name="l00516"></a>00516          <span class="comment">/* transfer data from sc_thread for GET commands */</span>
<a name="l00517"></a>00517          channel = va_arg(argptr, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>);
<a name="l00518"></a>00518          pvalue = va_arg(argptr, <span class="keywordtype">float</span> *);
<a name="l00519"></a>00519          <span class="keywordflow">if</span> (device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#ac40f8fcceded9b51b8a772a66f874087">flags</a> &amp; <a class="code" href="group__mequipment.html#ga2499f0abd1f0577de72d1d5645fc7713">DF_MULTITHREAD</a>) {
<a name="l00520"></a>00520             ss_semaphore_wait_for(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>, 1000);
<a name="l00521"></a>00521             *pvalue = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a9a75471f954f8787aa6be021758bcba9">channel</a>[channel].<a class="code" href="structDD__MT__CHANNEL.html#ac75b2491b9c60c295e5c67e7b42150a7">variable</a>[cmd];
<a name="l00522"></a>00522             status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a4b3a73f364d8f40376824d1ac2a95eb7">mt_buffer</a>-&gt;<a class="code" href="structDD__MT__BUFFER.html#a039db8f66e6b3f5ed6c3358d6e934bb1">status</a>;
<a name="l00523"></a>00523             ss_semaphore_release(device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a8233d106afdba2ec9eafefad8cc9a7a0">semaphore</a>);
<a name="l00524"></a>00524          } <span class="keywordflow">else</span>
<a name="l00525"></a>00525             status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(cmd, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, channel, pvalue);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527       } <span class="keywordflow">else</span> {
<a name="l00528"></a>00528 
<a name="l00529"></a>00529          <span class="comment">/* all remaining commands which are passed directly to the device driver */</span>
<a name="l00530"></a>00530          channel = va_arg(argptr, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>);
<a name="l00531"></a>00531          pvalue = va_arg(argptr, <span class="keywordtype">float</span> *);
<a name="l00532"></a>00532          status = device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#adfdb7ee99dd506e35f65d3f8d4b41a4b">dd</a>(cmd, device_drv-&gt;<a class="code" href="structDEVICE__DRIVER.html#a334e4f80981fd4d70bb6ebea2fe3e911">dd_info</a>, channel, pvalue);
<a name="l00533"></a>00533       }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535       <span class="keywordflow">break</span>;
<a name="l00536"></a>00536    }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    va_end(argptr);
<a name="l00539"></a>00539    <span class="keywordflow">return</span> status;
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00543"></a>00543 
<a name="l00544"></a><a class="code" href="mfe_8c.html#ab834073e5b665fccaa4eff2a61bc9372">00544</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#ab834073e5b665fccaa4eff2a61bc9372">register_equipment</a>(<span class="keywordtype">void</span>)
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> idx, size, status;
<a name="l00547"></a>00547    <span class="keywordtype">char</span> str[256];
<a name="l00548"></a>00548    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l00549"></a>00549    <a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a> *eq_stats;
<a name="l00550"></a>00550    HNDLE <a class="code" href="mevb_8c.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l00551"></a>00551    <a class="code" href="structBANK__LIST.html">BANK_LIST</a> *bank_list;
<a name="l00552"></a>00552    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> dummy;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554    <span class="comment">/* get current ODB run state */</span>
<a name="l00555"></a>00555    size = <span class="keyword">sizeof</span>(<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a>);
<a name="l00556"></a>00556    <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> = <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>;
<a name="l00557"></a>00557    <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/State&quot;</span>, &amp;<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, TRUE);
<a name="l00558"></a>00558    size = <span class="keyword">sizeof</span>(<a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l00559"></a>00559    <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> = 1;
<a name="l00560"></a>00560    status =
<a name="l00561"></a>00561        <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;<a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, &amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, TRUE);
<a name="l00562"></a>00562    assert(status == <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>);
<a name="l00563"></a>00563 
<a name="l00564"></a>00564    <span class="comment">/* scan EQUIPMENT table from FRONTEND.C */</span>
<a name="l00565"></a>00565    <span class="keywordflow">for</span> (idx = 0; equipment[idx].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; idx++) {
<a name="l00566"></a>00566       eq_info = &amp;equipment[idx].<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l00567"></a>00567       eq_stats = &amp;equipment[idx].<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a> == 0) {
<a name="l00570"></a>00570          printf(<span class="stringliteral">&quot;\nEvent ID 0 for %s not allowed\n&quot;</span>, equipment[idx].name);
<a name="l00571"></a>00571          <a class="code" href="group__cmfunctionc.html#ga7d5a287821786e8dde3d2340826215b2">cm_disconnect_experiment</a>();
<a name="l00572"></a>00572          <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(5000);
<a name="l00573"></a>00573          exit(0);
<a name="l00574"></a>00574       }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576       <span class="comment">/* init status */</span>
<a name="l00577"></a>00577       equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579       <span class="comment">/* check for % in equipment (needed for event building) */</span>
<a name="l00580"></a>00580       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a> != -1) {
<a name="l00581"></a>00581          <span class="comment">/* modify equipment name to &lt;name&gt;xx where xx is the frontend index */</span>
<a name="l00582"></a>00582          <span class="keywordflow">if</span> (strchr(equipment[idx].name, <span class="charliteral">&apos;%&apos;</span>)) {
<a name="l00583"></a>00583             strcpy(str, equipment[idx].name);
<a name="l00584"></a>00584             sprintf(equipment[idx].name, str, <a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a>);
<a name="l00585"></a>00585          }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587          <span class="comment">/* modify event buffer name to &lt;name&gt;xx where xx is the frontend index */</span>
<a name="l00588"></a>00588          <span class="keywordflow">if</span> (strchr(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, <span class="charliteral">&apos;%&apos;</span>)) {
<a name="l00589"></a>00589             strcpy(str, eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>);
<a name="l00590"></a>00590             sprintf(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, str, <a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a>);
<a name="l00591"></a>00591          }
<a name="l00592"></a>00592       } <span class="keywordflow">else</span> {
<a name="l00593"></a>00593          <span class="comment">/* stip %.. */</span>
<a name="l00594"></a>00594          <span class="keywordflow">if</span> (strchr(equipment[idx].name, <span class="charliteral">&apos;%&apos;</span>))
<a name="l00595"></a>00595             *strchr(equipment[idx].name, <span class="charliteral">&apos;%&apos;</span>) = 0;
<a name="l00596"></a>00596          <span class="keywordflow">if</span> (strchr(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, <span class="charliteral">&apos;%&apos;</span>))
<a name="l00597"></a>00597             *strchr(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, <span class="charliteral">&apos;%&apos;</span>) = 0;
<a name="l00598"></a>00598       }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Common&quot;</span>, equipment[idx].name);
<a name="l00601"></a>00601 
<a name="l00602"></a>00602       <span class="comment">/* get last event limit from ODB */</span>
<a name="l00603"></a>00603       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> != <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) {
<a name="l00604"></a>00604          <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00605"></a>00605          size = <span class="keyword">sizeof</span>(double);
<a name="l00606"></a>00606          <span class="keywordflow">if</span> (hKey)
<a name="l00607"></a>00607             <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Event limit&quot;</span>, &amp;eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>, &amp;size,
<a name="l00608"></a>00608                          <a class="code" href="group__mdefineh.html#ga13378fa303cf601b4b491866a6688362">TID_DOUBLE</a>, TRUE);
<a name="l00609"></a>00609       }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611       <span class="comment">/* Create common subtree */</span>
<a name="l00612"></a>00612       status = <a class="code" href="group__odbfunctionc.html#gad504df013bd9f61366ed48d6666985a1">db_check_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="mfe_8c.html#ac92b30327caaa939b1b6630775c78ecd">EQUIPMENT_COMMON_STR</a>, FALSE);
<a name="l00613"></a>00613       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga8c6c8ed2099cf2468f0c7c6cd475fe7e">DB_NO_KEY</a> || status == <a class="code" href="group__err23.html#ga0ee271607cfbec2e6050b0ea6e5ef533">DB_STRUCT_MISMATCH</a>) {
<a name="l00614"></a>00614          <a class="code" href="group__odbfunctionc.html#ga59b971e77416b2b463e2e63f1b05342b">db_create_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="mfe_8c.html#ac92b30327caaa939b1b6630775c78ecd">EQUIPMENT_COMMON_STR</a>);
<a name="l00615"></a>00615          <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00616"></a>00616          <a class="code" href="group__odbfunctionc.html#ga1e4bca66d45d069477c614bc2481d89f">db_set_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_info, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a>), 0);
<a name="l00617"></a>00617       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00618"></a>00618          printf(<span class="stringliteral">&quot;Cannot check equipment record, status = %d\n&quot;</span>, status);
<a name="l00619"></a>00619          <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l00620"></a>00620       }
<a name="l00621"></a>00621       <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00622"></a>00622       assert(hKey);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624       <span class="comment">/* set fixed parameters from user structure */</span>
<a name="l00625"></a>00625       <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Event ID&quot;</span>, &amp;eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>, <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>), 1, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>);
<a name="l00626"></a>00626       <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Type&quot;</span>, &amp;eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a>, <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>), 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00627"></a>00627       <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Source&quot;</span>, &amp;eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a345e65d8874f6b968bedc00e76d4f431">source</a>, <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>), 1, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629       <span class="comment">/* open hot link to equipment info */</span>
<a name="l00630"></a>00630       <a class="code" href="group__odbfunctionc.html#ga852bc9fa8ee4d0884b328aeb0b0cfd63">db_open_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_info, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632       <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a60d08f3eadb2b1f809d06d7a64b0bc5e">format</a>, <span class="stringliteral">&quot;YBOS&quot;</span>))
<a name="l00633"></a>00633               assert(!<span class="stringliteral">&quot;YBOS not supported anymore&quot;</span>);
<a name="l00634"></a>00634       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a60d08f3eadb2b1f809d06d7a64b0bc5e">format</a>, <span class="stringliteral">&quot;FIXED&quot;</span>))
<a name="l00635"></a>00635          equipment[idx].<a class="code" href="structeqpmnt.html#acad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>;
<a name="l00636"></a>00636       <span class="keywordflow">else</span>                      <span class="comment">/* default format is MIDAS */</span>
<a name="l00637"></a>00637          equipment[idx].<a class="code" href="structeqpmnt.html#acad980d7699722234c72bfca6243203b">format</a> = <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639       gethostname(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0f7f20fef7826740571d2ffa82da4dfd">frontend_host</a>, <span class="keyword">sizeof</span>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0f7f20fef7826740571d2ffa82da4dfd">frontend_host</a>));
<a name="l00640"></a>00640       strcpy(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a2cfd04e323109fe1cbb75ca8047aaa77">frontend_name</a>, <a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>);
<a name="l00641"></a>00641       strcpy(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0788ebd106c11c952e09f99e142d8bbf">frontend_file_name</a>, <a class="code" href="mfe_8c.html#ac7fc683b5a25d9607abc270a54db6d97">frontend_file_name</a>);
<a name="l00642"></a>00642       sprintf(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0c629c9353558e8f2f1759357608ebb6">status</a>, <span class="stringliteral">&quot;%s@%s&quot;</span>, <a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>, eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0f7f20fef7826740571d2ffa82da4dfd">frontend_host</a>);
<a name="l00643"></a>00643       strcpy(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#acfbe0f2e23fe95a1a06d55d6e0d3ac9c">status_color</a>, <span class="stringliteral">&quot;#00FF00&quot;</span>);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645       <span class="comment">/* update variables in ODB */</span>
<a name="l00646"></a>00646       <a class="code" href="group__odbfunctionc.html#ga1e4bca66d45d069477c614bc2481d89f">db_set_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_info, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a>), 0);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648       <span class="comment">/*---- Create variables record ---------------------------------*/</span>
<a name="l00649"></a>00649 
<a name="l00650"></a>00650       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, equipment[idx].name);
<a name="l00651"></a>00651       <span class="keywordflow">if</span> (equipment[idx].event_descrip) {
<a name="l00652"></a>00652          <span class="keywordflow">if</span> (equipment[idx].format == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>)
<a name="l00653"></a>00653             <a class="code" href="group__odbfunctionc.html#gad504df013bd9f61366ed48d6666985a1">db_check_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, (<span class="keywordtype">char</span> *) equipment[idx].event_descrip, TRUE);
<a name="l00654"></a>00654          <span class="keywordflow">else</span> {
<a name="l00655"></a>00655             <span class="comment">/* create bank descriptions */</span>
<a name="l00656"></a>00656             bank_list = (<a class="code" href="structBANK__LIST.html">BANK_LIST</a> *) equipment[idx].event_descrip;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658             <span class="keywordflow">for</span> (; bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>[0]; bank_list++) {
<a name="l00659"></a>00659                <span class="comment">/* mabye needed later...</span>
<a name="l00660"></a>00660 <span class="comment">                  if (bank_list-&gt;output_flag == 0)</span>
<a name="l00661"></a>00661 <span class="comment">                  continue;</span>
<a name="l00662"></a>00662 <span class="comment">                */</span>
<a name="l00663"></a>00663 
<a name="l00664"></a>00664                <span class="keywordflow">if</span> (bank_list-&gt;<a class="code" href="structBANK__LIST.html#a949d7a28bdf3923796ffb2dff8f28690">type</a> == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l00665"></a>00665                   sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, equipment[idx].name,
<a name="l00666"></a>00666                           bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l00667"></a>00667                   status =
<a name="l00668"></a>00668                       <a class="code" href="group__odbfunctionc.html#gad504df013bd9f61366ed48d6666985a1">db_check_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, strcomb((<span class="keyword">const</span> <span class="keywordtype">char</span>**)bank_list-&gt;<a class="code" href="structBANK__LIST.html#a7ebd92f00cb428fcbb555f3ad30b86c8">init_str</a>), TRUE);
<a name="l00669"></a>00669                   <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00670"></a>00670                      printf(<span class="stringliteral">&quot;Cannot check/create record \&quot;%s\&quot;, status = %d\n&quot;</span>, str,
<a name="l00671"></a>00671                             status);
<a name="l00672"></a>00672                      <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l00673"></a>00673                   }
<a name="l00674"></a>00674                } <span class="keywordflow">else</span> {
<a name="l00675"></a>00675                   sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables/%s&quot;</span>, equipment[idx].name,
<a name="l00676"></a>00676                           bank_list-&gt;<a class="code" href="structBANK__LIST.html#a108f74b9ebdca9718cfd91de54899325">name</a>);
<a name="l00677"></a>00677                   dummy = 0;
<a name="l00678"></a>00678                   <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;dummy, rpc_tid_size(bank_list-&gt;<a class="code" href="structBANK__LIST.html#a949d7a28bdf3923796ffb2dff8f28690">type</a>), 1,
<a name="l00679"></a>00679                                bank_list-&gt;<a class="code" href="structBANK__LIST.html#a949d7a28bdf3923796ffb2dff8f28690">type</a>);
<a name="l00680"></a>00680                }
<a name="l00681"></a>00681             }
<a name="l00682"></a>00682          }
<a name="l00683"></a>00683       } <span class="keywordflow">else</span>
<a name="l00684"></a>00684          <a class="code" href="group__odbfunctionc.html#ga4dcab15e47980882e35bddf3ceb9aee5">db_create_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="group__mdefineh.html#ga15ae151ae0b7588b3327bd8451d9bcb8">TID_KEY</a>);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Variables&quot;</span>, equipment[idx].name);
<a name="l00687"></a>00687       <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00688"></a>00688       equipment[idx].<a class="code" href="structeqpmnt.html#ab6664c255e4c3fdc58806733ac04503b">hkey_variables</a> = hKey;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690       <span class="comment">/*---- Create and initialize statistics tree -------------------*/</span>
<a name="l00691"></a>00691 
<a name="l00692"></a>00692       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Statistics&quot;</span>, equipment[idx].name);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694       status = <a class="code" href="group__odbfunctionc.html#gad504df013bd9f61366ed48d6666985a1">db_check_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, <a class="code" href="mfe_8c.html#a6064db0cc46885d207cedb497e3c355e">EQUIPMENT_STATISTICS_STR</a>, TRUE);
<a name="l00695"></a>00695       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00696"></a>00696          printf(<span class="stringliteral">&quot;Cannot create/check statistics record \&apos;%s\&apos;, error %d\n&quot;</span>, str, status);
<a name="l00697"></a>00697          <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l00698"></a>00698       }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700       status = <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00701"></a>00701       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00702"></a>00702          printf(<span class="stringliteral">&quot;Cannot find statistics record \&apos;%s\&apos;, error %d\n&quot;</span>, str, status);
<a name="l00703"></a>00703          <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l00704"></a>00704       }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706       eq_stats-&gt;<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> = 0;
<a name="l00707"></a>00707       eq_stats-&gt;<a class="code" href="structEQUIPMENT__STATS.html#a218c744ea441413af262fbd5ddf3780f">events_per_sec</a> = 0;
<a name="l00708"></a>00708       eq_stats-&gt;<a class="code" href="structEQUIPMENT__STATS.html#a7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> = 0;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710       <span class="comment">/* open hot link to statistics tree */</span>
<a name="l00711"></a>00711       status = <a class="code" href="group__odbfunctionc.html#ga852bc9fa8ee4d0884b328aeb0b0cfd63">db_open_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_stats, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a>), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL, NULL);
<a name="l00712"></a>00712       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga467b0af34b1011481919088b6af86b95">DB_NO_ACCESS</a>) {
<a name="l00713"></a>00713          <span class="comment">/* record is probably still in exclusive access by dead FE, so reset it */</span>
<a name="l00714"></a>00714          status = db_set_mode(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a> | <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a> | <a class="code" href="group__mdefineh.html#ga75f614b7ebb2b887b9e8f13c1b53ca6f">MODE_DELETE</a>, TRUE);
<a name="l00715"></a>00715          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l00716"></a>00716             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, 
<a name="l00717"></a>00717                    <span class="stringliteral">&quot;Cannot change access mode for record \&apos;%s\&apos;, error %d&quot;</span>, str, status);
<a name="l00718"></a>00718          <span class="keywordflow">else</span>
<a name="l00719"></a>00719             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, <span class="stringliteral">&quot;Recovered access mode for record \&apos;%s\&apos;&quot;</span>, str);
<a name="l00720"></a>00720          status = <a class="code" href="group__odbfunctionc.html#ga852bc9fa8ee4d0884b328aeb0b0cfd63">db_open_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, eq_stats, <span class="keyword">sizeof</span>(<a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a>), <a class="code" href="group__mdefineh.html#gab8fac4c725bb7d4b05ae138c07ef54af">MODE_WRITE</a>, NULL, NULL);
<a name="l00721"></a>00721       }
<a name="l00722"></a>00722       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l00723"></a>00723          <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, 
<a name="l00724"></a>00724                 <span class="stringliteral">&quot;Cannot open statistics record \&apos;%s\&apos;, error %d&quot;</span>, str, status);
<a name="l00725"></a>00725          <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l00726"></a>00726       }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728       <span class="comment">/*---- open event buffer ---------------------------------------*/</span>
<a name="l00729"></a>00729 
<a name="l00730"></a>00730       <span class="comment">/* check for fragmented event */</span>
<a name="l00731"></a>00731       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>) {
<a name="l00732"></a>00732          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">frag_buffer</a> == NULL)
<a name="l00733"></a>00733             <a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">frag_buffer</a> = malloc(<a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>);
<a name="l00734"></a>00734 
<a name="l00735"></a>00735          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">frag_buffer</a> == NULL) {
<a name="l00736"></a>00736             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l00737"></a>00737                   <span class="stringliteral">&quot;Not enough memory to allocate buffer for fragmented events&quot;</span>);
<a name="l00738"></a>00738             <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l00739"></a>00739          }
<a name="l00740"></a>00740       }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>[0]) {
<a name="l00743"></a>00743          status =
<a name="l00744"></a>00744              <a class="code" href="group__bmfunctionc.html#gae9636ff3e34ee94e31cb292bd07a679d">bm_open_buffer</a>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, 2*<a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>,
<a name="l00745"></a>00745                             &amp;equipment[idx].<a class="code" href="structeqpmnt.html#a7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>);
<a name="l00746"></a>00746          <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a> &amp;&amp; status != <a class="code" href="group__err22.html#gaf4d0ec9887b0864c100b8062d21f4c0b">BM_CREATED</a>) {
<a name="l00747"></a>00747             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l00748"></a>00748                    <span class="stringliteral">&quot;Cannot open event buffer \&quot;%s\&quot; size %d, bm_open_buffer() status %d&quot;</span>, eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a0666cb14ec61ae2c4f535b76c9401ae1">buffer</a>, 2*<a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>, status);
<a name="l00749"></a>00749             <span class="keywordflow">return</span> 0;
<a name="l00750"></a>00750          }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752          <span class="comment">/* set the default buffer cache size */</span>
<a name="l00753"></a>00753          <a class="code" href="group__bmfunctionc.html#ga2689ca85c6d0023f1a02e6827a5eff6e">bm_set_cache_size</a>(equipment[idx].buffer_handle, 0, <a class="code" href="mfe_8c.html#a022c39e327f494dda3664f8888f860f1">SERVER_CACHE_SIZE</a>);
<a name="l00754"></a>00754       } <span class="keywordflow">else</span>
<a name="l00755"></a>00755          equipment[idx].<a class="code" href="structeqpmnt.html#a7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a> = 0;
<a name="l00756"></a>00756    }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758    <a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a> = calloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), idx);
<a name="l00759"></a>00759 
<a name="l00760"></a>00760    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00764"></a>00764 
<a name="l00765"></a><a class="code" href="mfe_8c.html#a7755389a61fd0afb9b11bc68a2218058">00765</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a7755389a61fd0afb9b11bc68a2218058">initialize_equipment</a>(<span class="keywordtype">void</span>)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> idx, i, j, k, n, count;
<a name="l00768"></a>00768    <span class="keywordtype">char</span> str[256];
<a name="l00769"></a>00769    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> start_time, delta_time;
<a name="l00770"></a>00770    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l00771"></a>00771    <a class="code" href="structEQUIPMENT__STATS.html">EQUIPMENT_STATS</a> *eq_stats;
<a name="l00772"></a>00772    <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> manual_trig_flag = FALSE;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774    <span class="comment">/* scan EQUIPMENT table from FRONTEND.C */</span>
<a name="l00775"></a>00775    <span class="keywordflow">for</span> (idx = 0; equipment[idx].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; idx++) {
<a name="l00776"></a>00776       eq_info = &amp;equipment[idx].<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l00777"></a>00777       eq_stats = &amp;equipment[idx].<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779       <span class="comment">/*---- initialize interrupt events -----------------------------*/</span>
<a name="l00780"></a>00780 
<a name="l00781"></a>00781       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gad5ba2ec0f5d55139048dbe2d416da6ba">EQ_INTERRUPT</a>) {
<a name="l00782"></a>00782          <span class="comment">/* install interrupt for interrupt events */</span>
<a name="l00783"></a>00783 
<a name="l00784"></a>00784          <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l00785"></a>00785             <span class="keywordflow">if</span> (equipment[i].info.eq_type &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>) {
<a name="l00786"></a>00786                equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00787"></a>00787                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;initialize_equipment&quot;</span>,
<a name="l00788"></a>00788                       <span class="stringliteral">&quot;Interrupt readout cannot be combined with polled readout&quot;</span>);
<a name="l00789"></a>00789             }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791          <span class="keywordflow">if</span> (equipment[idx].status != <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>) {
<a name="l00792"></a>00792             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>) {
<a name="l00793"></a>00793                interrupt_eq = &amp;equipment[idx];
<a name="l00794"></a>00794                
<a name="l00795"></a>00795                <span class="comment">/* create ring buffer for inter-thread data transfer */</span>
<a name="l00796"></a>00796                <span class="keywordflow">if</span> (!<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>) {
<a name="l00797"></a>00797                   <a class="code" href="group__rbfunctionc.html#gae447c0770b51e5e0e173905f8700ce0f">rb_create</a>(<a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>, <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>, &amp;<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>);
<a name="l00798"></a>00798                   <a class="code" href="mfe_8c.html#a0cc81c4acd29047148a2b696a95b330c">rbh2</a> = <a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>;
<a name="l00799"></a>00799                }
<a name="l00800"></a>00800                
<a name="l00801"></a>00801                <span class="comment">/* establish interrupt handler */</span>
<a name="l00802"></a>00802                <a class="code" href="mfe_8c.html#a681a5d1fe2e8a4735bcf03824ffb3e81">interrupt_configure</a>(<a class="code" href="group__err26.html#ga8a891110d186a3a4b02f6dfde253efb2">CMD_INTERRUPT_ATTACH</a>, idx,
<a name="l00803"></a>00803                                    (POINTER_T) <a class="code" href="mfe_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>);
<a name="l00804"></a>00804             } <span class="keywordflow">else</span> {
<a name="l00805"></a>00805                equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00806"></a>00806                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;initialize_equipment&quot;</span>,
<a name="l00807"></a>00807                       <span class="stringliteral">&quot;Equipment %s disabled in file \&quot;frontend.c\&quot;&quot;</span>,
<a name="l00808"></a>00808                       equipment[idx].name);
<a name="l00809"></a>00809             }
<a name="l00810"></a>00810          }
<a name="l00811"></a>00811       }
<a name="l00812"></a>00812 
<a name="l00813"></a>00813       <span class="comment">/*---- evaluate polling count ----------------------------------*/</span>
<a name="l00814"></a>00814 
<a name="l00815"></a>00815       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; (<a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a> | <a class="code" href="group__mdefineh.html#ga7cc85959e8d0c4e476cf659c2cee7a33">EQ_MULTITHREAD</a>)) {
<a name="l00816"></a>00816          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gad5ba2ec0f5d55139048dbe2d416da6ba">EQ_INTERRUPT</a>) {
<a name="l00817"></a>00817             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>)
<a name="l00818"></a>00818                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l00819"></a>00819                       <span class="stringliteral">&quot;Equipment \&quot;%s\&quot; cannot be of type EQ_INTERRUPT and EQ_POLLED at the same time&quot;</span>, 
<a name="l00820"></a>00820                       equipment[idx].name);
<a name="l00821"></a>00821             <span class="keywordflow">else</span>
<a name="l00822"></a>00822                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>,
<a name="l00823"></a>00823                       <span class="stringliteral">&quot;Equipment \&quot;%s\&quot; cannot be of type EQ_INTERRUPT and EQ_MULTITHREAD at the same time&quot;</span>, 
<a name="l00824"></a>00824                       equipment[idx].name);
<a name="l00825"></a>00825             <span class="keywordflow">return</span> 0;
<a name="l00826"></a>00826          }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00829"></a>00829             printf(<span class="stringliteral">&quot;\nCalibrating&quot;</span>);
<a name="l00830"></a>00830 
<a name="l00831"></a>00831          count = 1;
<a name="l00832"></a>00832          <span class="keywordflow">do</span> {
<a name="l00833"></a>00833             <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l00834"></a>00834                printf(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836             start_time = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l00837"></a>00837 
<a name="l00838"></a>00838             <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(equipment[idx].info.source, count, TRUE);
<a name="l00839"></a>00839 
<a name="l00840"></a>00840             delta_time = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>() - start_time;
<a name="l00841"></a>00841 
<a name="l00842"></a>00842             <span class="keywordflow">if</span> (count == 1 &amp;&amp; delta_time &gt; eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a> * 1.2) {
<a name="l00843"></a>00843                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;register_equipment&quot;</span>, <span class="stringliteral">&quot;Polling routine with count=1 takes %d ms&quot;</span>, delta_time);
<a name="l00844"></a>00844                <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l00845"></a>00845                <span class="keywordflow">break</span>;
<a name="l00846"></a>00846             }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848             <span class="keywordflow">if</span> (delta_time &gt; 0)
<a name="l00849"></a>00849                count = (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) ((<span class="keywordtype">double</span>) count * eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a> / delta_time);
<a name="l00850"></a>00850             <span class="keywordflow">else</span>
<a name="l00851"></a>00851                count *= 100;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853          } <span class="keywordflow">while</span> (delta_time &gt; eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a> * 1.2 || delta_time &lt; eq_info-&gt;period * 0.8);
<a name="l00854"></a>00854 
<a name="l00855"></a>00855          equipment[idx].<a class="code" href="structeqpmnt.html#ae9bf94db8ff48533601c3833b1b20097">poll_count</a> = count;
<a name="l00856"></a>00856       }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858       <span class="comment">/*---- initialize multithread events -------------------------*/</span>
<a name="l00859"></a>00859 
<a name="l00860"></a>00860       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga7cc85959e8d0c4e476cf659c2cee7a33">EQ_MULTITHREAD</a>) {
<a name="l00861"></a>00861          <span class="comment">/* install interrupt for interrupt events */</span>
<a name="l00862"></a>00862 
<a name="l00863"></a>00863          <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l00864"></a>00864             <span class="keywordflow">if</span> (equipment[i].info.eq_type &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>) {
<a name="l00865"></a>00865                equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00866"></a>00866                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;initialize_equipment&quot;</span>,
<a name="l00867"></a>00867                       <span class="stringliteral">&quot;Multi-threaded readout cannot be combined with polled readout for equipment \&apos;%s\&apos;&quot;</span>, equipment[i].name);
<a name="l00868"></a>00868             }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870          <span class="keywordflow">if</span> (equipment[idx].status != <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>) {
<a name="l00871"></a>00871             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>) {
<a name="l00872"></a>00872                <span class="keywordflow">if</span> (multithread_eq) {
<a name="l00873"></a>00873                   equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00874"></a>00874                   <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;initialize_equipment&quot;</span>,
<a name="l00875"></a>00875                          <span class="stringliteral">&quot;Defined more than one equipment with multi-threaded readout for equipment \&apos;%s\&apos;&quot;</span>, equipment[i].name);
<a name="l00876"></a>00876                } <span class="keywordflow">else</span> {
<a name="l00877"></a>00877                   multithread_eq = &amp;equipment[idx];
<a name="l00878"></a>00878 
<a name="l00879"></a>00879                   <span class="comment">/* create ring buffer for inter-thread data transfer */</span>
<a name="l00880"></a>00880                   <span class="keywordflow">if</span> (!<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>) {
<a name="l00881"></a>00881                      <a class="code" href="group__rbfunctionc.html#gae447c0770b51e5e0e173905f8700ce0f">rb_create</a>(<a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>, <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>, &amp;<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>);
<a name="l00882"></a>00882                      <a class="code" href="mfe_8c.html#a0cc81c4acd29047148a2b696a95b330c">rbh2</a> = <a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>;
<a name="l00883"></a>00883                   }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885                   <span class="comment">/* create hardware reading thread */</span>
<a name="l00886"></a>00886                   <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(FALSE);
<a name="l00887"></a>00887                   <a class="code" href="group__msfunctionc.html#ga29342b1b9eaa66a0076dd0876090087d">ss_thread_create</a>(<a class="code" href="mfe_8c.html#a1dcae9fe323025ad03d3ec1b5a95263d">readout_thread</a>, multithread_eq);
<a name="l00888"></a>00888                }
<a name="l00889"></a>00889             } <span class="keywordflow">else</span> {
<a name="l00890"></a>00890                equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00891"></a>00891                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;initialize_equipment&quot;</span>,
<a name="l00892"></a>00892                       <span class="stringliteral">&quot;Equipment %s disabled in file \&quot;frontend.c\&quot;&quot;</span>,
<a name="l00893"></a>00893                       equipment[idx].name);
<a name="l00894"></a>00894             }
<a name="l00895"></a>00895          }
<a name="l00896"></a>00896       }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898       <span class="comment">/*---- initialize slow control equipment ---------------------*/</span>
<a name="l00899"></a>00899 
<a name="l00900"></a>00900       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) {
<a name="l00901"></a>00901 
<a name="l00902"></a>00902          <a class="code" href="mfe_8c.html#a3ab359e237ee86bc2f53285b7bf2f673">set_equipment_status</a>(equipment[idx].name, <span class="stringliteral">&quot;Initializing...&quot;</span>, <span class="stringliteral">&quot;yellow&quot;</span>);
<a name="l00903"></a>00903 
<a name="l00904"></a>00904          <span class="comment">/* resolve duplicate device names */</span>
<a name="l00905"></a>00905          <span class="keywordflow">for</span> (i = 0; equipment[idx].<a class="code" href="structeqpmnt.html#af19c464fc7092048c9418328ca4e4afc">driver</a>[i].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0]; i++)
<a name="l00906"></a>00906             <span class="keywordflow">for</span> (j = i + 1; equipment[idx].<a class="code" href="structeqpmnt.html#af19c464fc7092048c9418328ca4e4afc">driver</a>[j].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0]; j++)
<a name="l00907"></a>00907                <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(equipment[idx].driver[i].name,
<a name="l00908"></a>00908                                  equipment[idx].driver[j].name)) {
<a name="l00909"></a>00909                   strcpy(str, equipment[idx].driver[i].name);
<a name="l00910"></a>00910                   <span class="keywordflow">for</span> (k = 0, n = 0; equipment[idx].<a class="code" href="structeqpmnt.html#af19c464fc7092048c9418328ca4e4afc">driver</a>[k].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0]; k++)
<a name="l00911"></a>00911                      <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(str, equipment[idx].driver[k].name))
<a name="l00912"></a>00912                         sprintf(equipment[idx].driver[k].name, <span class="stringliteral">&quot;%s_%d&quot;</span>, str, n++);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914                   <span class="keywordflow">break</span>;
<a name="l00915"></a>00915                }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917          <span class="comment">/* loop over equipment list and call class driver&apos;s init method */</span>
<a name="l00918"></a>00918          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>) {
<a name="l00919"></a>00919             printf(<span class="stringliteral">&quot;%s:\n&quot;</span>, equipment[idx].name);
<a name="l00920"></a>00920             equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = equipment[idx].<a class="code" href="structeqpmnt.html#ae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga2677fc43f8393bcf3bafc8bbface003f">CMD_INIT</a>, &amp;equipment[idx]);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922             <span class="keywordflow">if</span> (equipment[idx].status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l00923"></a>00923                strcpy(str, <span class="stringliteral">&quot;Ok&quot;</span>);
<a name="l00924"></a>00924             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (equipment[idx].status == <a class="code" href="group__err26.html#ga9fea053c26a278026fa0d7501c300c4f">FE_ERR_HW</a>)
<a name="l00925"></a>00925                strcpy(str, <span class="stringliteral">&quot;Hardware error&quot;</span>);
<a name="l00926"></a>00926             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (equipment[idx].status == <a class="code" href="group__err26.html#ga8a0cc5de6ea758c61231a11b6a076e1f">FE_ERR_ODB</a>)
<a name="l00927"></a>00927                strcpy(str, <span class="stringliteral">&quot;ODB error&quot;</span>);
<a name="l00928"></a>00928             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (equipment[idx].status == <a class="code" href="group__err26.html#gac4221d7e494c798f57552f502e2459ef">FE_ERR_DRIVER</a>)
<a name="l00929"></a>00929                strcpy(str, <span class="stringliteral">&quot;Driver error&quot;</span>);
<a name="l00930"></a>00930             <span class="keywordflow">else</span>
<a name="l00931"></a>00931                strcpy(str, <span class="stringliteral">&quot;Error&quot;</span>);
<a name="l00932"></a>00932 
<a name="l00933"></a>00933             <span class="keywordflow">if</span> (equipment[idx].status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l00934"></a>00934                <a class="code" href="mfe_8c.html#a3ab359e237ee86bc2f53285b7bf2f673">set_equipment_status</a>(equipment[idx].name, str, <span class="stringliteral">&quot;#00FF00&quot;</span>);
<a name="l00935"></a>00935             <span class="keywordflow">else</span> {
<a name="l00936"></a>00936                <a class="code" href="mfe_8c.html#a3ab359e237ee86bc2f53285b7bf2f673">set_equipment_status</a>(equipment[idx].name, str, <span class="stringliteral">&quot;#FF0000&quot;</span>);
<a name="l00937"></a>00937                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;initialize_equipment&quot;</span>, <span class="stringliteral">&quot;Equipment %s disabled because of %s&quot;</span>, equipment[idx].name, str);
<a name="l00938"></a>00938             }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940          } <span class="keywordflow">else</span> {
<a name="l00941"></a>00941             equipment[idx].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> = <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>;
<a name="l00942"></a>00942             <a class="code" href="mfe_8c.html#a3ab359e237ee86bc2f53285b7bf2f673">set_equipment_status</a>(equipment[idx].name, <span class="stringliteral">&quot;Disabled&quot;</span>, <span class="stringliteral">&quot;yellow&quot;</span>);
<a name="l00943"></a>00943          }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945          <span class="comment">/* now start threads if requested */</span>
<a name="l00946"></a>00946          <span class="keywordflow">if</span> (equipment[idx].status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l00947"></a>00947             equipment[idx].<a class="code" href="structeqpmnt.html#ae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#gab905e6aff2332984df0552c6b50203f2">CMD_START</a>, &amp;equipment[idx]);   <span class="comment">/* start threads for this equipment */</span>
<a name="l00948"></a>00948 
<a name="l00949"></a>00949          <span class="comment">/* remember that we have slowcontrol equipment (needed later for scheduler) */</span>
<a name="l00950"></a>00950          <a class="code" href="mfe_8c.html#a4ab4f1288fd294c7c649291f87355985">slowcont_eq</a> = TRUE;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952          <span class="comment">/* let user read error messages */</span>
<a name="l00953"></a>00953          <span class="keywordflow">if</span> (equipment[idx].status != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a> &amp;&amp; 
<a name="l00954"></a>00954              equipment[idx].status != <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>)
<a name="l00955"></a>00955             <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l00956"></a>00956       }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958       <span class="comment">/*---- register callback for manual triggered events -----------*/</span>
<a name="l00959"></a>00959       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gac73e1045dff2b724325100af2e946717">EQ_MANUAL_TRIG</a>) {
<a name="l00960"></a>00960          <span class="keywordflow">if</span> (!manual_trig_flag)
<a name="l00961"></a>00961             cm_register_function(<a class="code" href="group__mrpcdefineh.html#gaf820c7d84c71a1469983d23ebec18a8f">RPC_MANUAL_TRIG</a>, <a class="code" href="mfe_8c.html#aa5db6f0a873100f5d99f5f3518be2425">manual_trigger</a>);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963          manual_trig_flag = TRUE;
<a name="l00964"></a>00964       }
<a name="l00965"></a>00965    }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a4ab4f1288fd294c7c649291f87355985">slowcont_eq</a>)
<a name="l00968"></a>00968       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#ga6e27d8876a43afce3ee4dd16527cbb9e">MINFO</a>, <span class="stringliteral">&quot;initialize_equipment&quot;</span>, <span class="stringliteral">&quot;Slow control equipment initialized&quot;</span>);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00971"></a>00971 }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l00974"></a>00974 
<a name="l00975"></a><a class="code" href="mfe_8c.html#a3ab359e237ee86bc2f53285b7bf2f673">00975</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a3ab359e237ee86bc2f53285b7bf2f673">set_equipment_status</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *eqipment_status, <span class="keyword">const</span> <span class="keywordtype">char</span> *status_color)
<a name="l00976"></a>00976 {
<a name="l00977"></a>00977    <span class="keywordtype">int</span> status, idx;
<a name="l00978"></a>00978    <span class="keywordtype">char</span> str[256];
<a name="l00979"></a>00979    HNDLE <a class="code" href="mevb_8c.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l00980"></a>00980 
<a name="l00981"></a>00981    <span class="keywordflow">for</span> (idx = 0; equipment[idx].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; idx++)
<a name="l00982"></a>00982       <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(equipment[idx].name, name))
<a name="l00983"></a>00983          <span class="keywordflow">break</span>;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985    <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(equipment[idx].name, name)) {
<a name="l00986"></a>00986       sprintf(str, <span class="stringliteral">&quot;/Equipment/%s/Common&quot;</span>, name);
<a name="l00987"></a>00987       <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, str, &amp;hKey);
<a name="l00988"></a>00988       assert(hKey);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990       status = <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Status&quot;</span>, eqipment_status, 256, 1, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l00991"></a>00991       assert(status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>);
<a name="l00992"></a>00992       status = <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Status color&quot;</span>, status_color, 32, 1, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>);
<a name="l00993"></a>00993       assert(status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>);
<a name="l00994"></a>00994    }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01000"></a>01000 
<a name="l01001"></a><a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">01001</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pevent, HNDLE <a class="code" href="mevb_8c.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> format)
<a name="l01002"></a>01002 {
<a name="l01003"></a>01003    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> size, i, status, n_data;
<a name="l01004"></a>01004    <span class="keywordtype">char</span> *pdata;
<a name="l01005"></a>01005    <span class="keywordtype">char</span> name[5];
<a name="l01006"></a>01006    <a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *pbh;
<a name="l01007"></a>01007    <a class="code" href="structBANK.html">BANK</a> *pbk;
<a name="l01008"></a>01008    <a class="code" href="structBANK32.html">BANK32</a> *pbk32;
<a name="l01009"></a>01009    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> bkname;
<a name="l01010"></a>01010    <a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> bktype;
<a name="l01011"></a>01011    HNDLE hKeyRoot, hKeyl;
<a name="l01012"></a>01012    <a class="code" href="structKEY.html">KEY</a> key;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014 
<a name="l01015"></a>01015    <span class="comment">/* outcommented since db_find_key does not work in FTCP mode, SR 25.4.03</span>
<a name="l01016"></a>01016 <span class="comment">      rpc_set_option(-1, RPC_OTRANSPORT, RPC_FTCP); */</span>
<a name="l01017"></a>01017 
<a name="l01018"></a>01018    <span class="keywordflow">if</span> (format == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
<a name="l01019"></a>01019       <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga1e4bca66d45d069477c614bc2481d89f">db_set_record</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, (<span class="keywordtype">char</span> *) (pevent + 1),
<a name="l01020"></a>01020                         pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>, 0) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01021"></a>01021          <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;update_odb&quot;</span>, <span class="stringliteral">&quot;event #%d size mismatch&quot;</span>, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a>);
<a name="l01022"></a>01022    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="group__mdefineh.html#gac7ef5b0cbb1fc1d26c3bfd4cc4a191a9">FORMAT_MIDAS</a>) {
<a name="l01023"></a>01023       pbh = (<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a> *) (pevent + 1);
<a name="l01024"></a>01024       pbk = NULL;
<a name="l01025"></a>01025       pbk32 = NULL;
<a name="l01026"></a>01026       <span class="keywordflow">do</span> {
<a name="l01027"></a>01027          <span class="comment">/* scan all banks */</span>
<a name="l01028"></a>01028          <span class="keywordflow">if</span> (bk_is32(pbh)) {
<a name="l01029"></a>01029             size = bk_iterate32(pbh, &amp;pbk32, &amp;pdata);
<a name="l01030"></a>01030             <span class="keywordflow">if</span> (pbk32 == NULL)
<a name="l01031"></a>01031                <span class="keywordflow">break</span>;
<a name="l01032"></a>01032             bkname = *((<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *) pbk32-&gt;<a class="code" href="structBANK32.html#a048e3afc084c62bffb7af80f110c30c3">name</a>);
<a name="l01033"></a>01033             bktype = (<a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>) pbk32-&gt;<a class="code" href="structBANK32.html#a24b3068dc97237c8525e2188586a2c1b">type</a>;
<a name="l01034"></a>01034          } <span class="keywordflow">else</span> {
<a name="l01035"></a>01035             size = <a class="code" href="group__bkfunctionc.html#gab6012589013da85b128d8443501a4a44">bk_iterate</a>(pbh, &amp;pbk, &amp;pdata);
<a name="l01036"></a>01036             <span class="keywordflow">if</span> (pbk == NULL)
<a name="l01037"></a>01037                <span class="keywordflow">break</span>;
<a name="l01038"></a>01038             bkname = *((<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *) pbk-&gt;<a class="code" href="structBANK.html#a39a277bc7edde0d3e783ef0d93f44c1e">name</a>);
<a name="l01039"></a>01039             bktype = (<a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>) pbk-&gt;<a class="code" href="structBANK.html#a91558478db8ed86d585715b8217ca72f">type</a>;
<a name="l01040"></a>01040          }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042          n_data = size;
<a name="l01043"></a>01043          <span class="keywordflow">if</span> (rpc_tid_size(bktype &amp; 0xFF))
<a name="l01044"></a>01044             n_data /= rpc_tid_size(bktype &amp; 0xFF);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046          <span class="comment">/* get bank key */</span>
<a name="l01047"></a>01047          *((<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *) name) = bkname;
<a name="l01048"></a>01048          name[4] = 0;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050          <span class="keywordflow">if</span> (bktype == <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>) {
<a name="l01051"></a>01051             status = <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, name, &amp;hKeyRoot);
<a name="l01052"></a>01052             <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01053"></a>01053                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;update_odb&quot;</span>,
<a name="l01054"></a>01054                       <span class="stringliteral">&quot;please define bank %s in BANK_LIST in frontend.c&quot;</span>, name);
<a name="l01055"></a>01055                <span class="keywordflow">continue</span>;
<a name="l01056"></a>01056             }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058             <span class="comment">/* write structured bank */</span>
<a name="l01059"></a>01059             <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01060"></a>01060                status = <a class="code" href="group__odbfunctionc.html#gac7c23e0ebd6b203c81ca491db5b4753e">db_enum_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKeyl);
<a name="l01061"></a>01061                <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01062"></a>01062                   <span class="keywordflow">break</span>;
<a name="l01063"></a>01063 
<a name="l01064"></a>01064                <a class="code" href="group__odbfunctionc.html#ga424ad3b166e3fba9bae29f7dfc74a369">db_get_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyl, &amp;key);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066                <span class="comment">/* adjust for alignment */</span>
<a name="l01067"></a>01067                <span class="keywordflow">if</span> (key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a> &amp;&amp; key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a> != <a class="code" href="group__mdefineh.html#gaa63f41f547c7f46f828aaf35073807ea">TID_LINK</a>)
<a name="l01068"></a>01068                   pdata =
<a name="l01069"></a>01069                       (<span class="keywordtype">void</span> *) <a class="code" href="group__mmacroh.html#ga03bfa072452094d4d31ce3d304438f14">VALIGN</a>(pdata, <a class="code" href="group__mmacroh.html#ga3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(ss_get_struct_align(), key.<a class="code" href="structKEY.html#acd1951fdb8bf0dec79ef833f6dec9276">item_size</a>));
<a name="l01070"></a>01070 
<a name="l01071"></a>01071                status = <a class="code" href="group__odbfunctionc.html#gaa3f93c5321c56ad5a5200d17958e9bb3">db_set_data</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyl, pdata, key.<a class="code" href="structKEY.html#acd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="structKEY.html#a2604fa0fc38ce19b011785f806185a02">num_values</a>,
<a name="l01072"></a>01072                                     key.<a class="code" href="structKEY.html#a2604fa0fc38ce19b011785f806185a02">num_values</a>, key.<a class="code" href="structKEY.html#a3360f9082d5083ea144f093d0cd774e3">type</a>);
<a name="l01073"></a>01073                <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01074"></a>01074                   <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;update_odb&quot;</span>, <span class="stringliteral">&quot;cannot write %s to ODB&quot;</span>, name);
<a name="l01075"></a>01075                   <span class="keywordflow">continue</span>;
<a name="l01076"></a>01076                }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078                <span class="comment">/* shift data pointer to next item */</span>
<a name="l01079"></a>01079                pdata += key.<a class="code" href="structKEY.html#acd1951fdb8bf0dec79ef833f6dec9276">item_size</a> * key.<a class="code" href="structKEY.html#a2604fa0fc38ce19b011785f806185a02">num_values</a>;
<a name="l01080"></a>01080             }
<a name="l01081"></a>01081          } <span class="keywordflow">else</span> {
<a name="l01082"></a>01082             <span class="comment">/* write variable length bank  */</span>
<a name="l01083"></a>01083             <span class="keywordflow">if</span> (n_data &gt; 0)
<a name="l01084"></a>01084                <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, name, pdata, size, n_data, bktype &amp; 0xFF);
<a name="l01085"></a>01085          }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087       } <span class="keywordflow">while</span> (1);
<a name="l01088"></a>01088    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (format == <a class="code" href="group__mdefineh.html#gaab9657af955d54be6cd05e0a726ad964">FORMAT_YBOS</a>) {
<a name="l01089"></a>01089      assert(!<span class="stringliteral">&quot;YBOS not supported anymore&quot;</span>);
<a name="l01090"></a>01090    }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092    <a class="code" href="group__rpcfunctionc.html#gaab360e4fd185439b0913c723581115ea">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#ga9d0de5957c2c776323a0c74e668f544d">RPC_TCP</a>);
<a name="l01093"></a>01093 }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01096"></a>01096 
<a name="l01097"></a><a class="code" href="mfe_8c.html#a467e7d6c77bcbb9259a7167ae1cdf29a">01097</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a467e7d6c77bcbb9259a7167ae1cdf29a">send_event</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> idx, <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> manual_trig)
<a name="l01098"></a>01098 {
<a name="l01099"></a>01099    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l01100"></a>01100    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent, *pfragment;
<a name="l01101"></a>01101    <span class="keywordtype">char</span> *pdata;
<a name="l01102"></a>01102    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pd;
<a name="l01103"></a>01103    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, status;
<a name="l01104"></a>01104    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> sent, size;
<a name="l01105"></a>01105 
<a name="l01106"></a>01106    eq_info = &amp;equipment[idx].<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108    <span class="comment">/* check for fragmented event */</span>
<a name="l01109"></a>01109    <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>)
<a name="l01110"></a>01110       pevent = <a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">frag_buffer</a>;
<a name="l01111"></a>01111    <span class="keywordflow">else</span>
<a name="l01112"></a>01112       pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)<a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114    <span class="comment">/* compose MIDAS event header */</span>
<a name="l01115"></a>01115    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01116"></a>01116    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01117"></a>01117    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) manual_trig;
<a name="l01118"></a>01118    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="group__msfunctionc.html#gab7852119bd4dc1e08aa03127d8ca008b">ss_time</a>();
<a name="l01119"></a>01119    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> = equipment[idx].<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121    equipment[idx].<a class="code" href="structeqpmnt.html#a6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01122"></a>01122 
<a name="l01123"></a>01123    <span class="comment">/* call user readout routine */</span>
<a name="l01124"></a>01124    *((<a class="code" href="structeqpmnt.html">EQUIPMENT</a> **) (pevent + 1)) = &amp;equipment[idx];
<a name="l01125"></a>01125    pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = equipment[idx].<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127    <span class="comment">/* send event */</span>
<a name="l01128"></a>01128    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l01129"></a>01129       <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>) {
<a name="l01130"></a>01130          <span class="comment">/* fragment event */</span>
<a name="l01131"></a>01131          <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>) {
<a name="l01132"></a>01132             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>,
<a name="l01133"></a>01133                    <span class="stringliteral">&quot;Event size %ld larger than maximum size %d for frag. ev.&quot;</span>,
<a name="l01134"></a>01134                    (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l01135"></a>01135                    max_event_size_frag);
<a name="l01136"></a>01136             <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01137"></a>01137          }
<a name="l01138"></a>01138 
<a name="l01139"></a>01139          <span class="comment">/* compose fragments */</span>
<a name="l01140"></a>01140          pfragment = <a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142          <span class="comment">/* compose MIDAS event header */</span>
<a name="l01143"></a>01143          memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01144"></a>01144          pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a>;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146          <span class="comment">/* store total event size */</span>
<a name="l01147"></a>01147          pd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) (pfragment + 1);
<a name="l01148"></a>01148          size = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l01149"></a>01149          <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
<a name="l01150"></a>01150             pd[i] = (<span class="keywordtype">unsigned</span> char) (size &amp; 0xFF);      <span class="comment">/* little endian, please! */</span>
<a name="l01151"></a>01151             size &gt;&gt;= 8;
<a name="l01152"></a>01152          }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154          pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156          pdata = (<span class="keywordtype">char</span> *) (pevent + 1);
<a name="l01157"></a>01157 
<a name="l01158"></a>01158          <span class="keywordflow">for</span> (i = 0, sent = 0; sent &lt; pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>; i++) {
<a name="l01159"></a>01159             <span class="keywordflow">if</span> (i &gt; 0) {
<a name="l01160"></a>01160                pfragment = <a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162                <span class="comment">/* compose MIDAS event header */</span>
<a name="l01163"></a>01163                memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01164"></a>01164                pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>;
<a name="l01165"></a>01165 
<a name="l01166"></a>01166                <span class="comment">/* copy portion of event */</span>
<a name="l01167"></a>01167                size = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> - sent;
<a name="l01168"></a>01168                <span class="keywordflow">if</span> (size &gt; <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l01169"></a>01169                   size = <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01170"></a>01170 
<a name="l01171"></a>01171                memcpy(pfragment + 1, pdata, size);
<a name="l01172"></a>01172                pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = size;
<a name="l01173"></a>01173                sent += size;
<a name="l01174"></a>01174                pdata += size;
<a name="l01175"></a>01175             }
<a name="l01176"></a>01176 
<a name="l01177"></a>01177             <span class="comment">/* send event to buffer */</span>
<a name="l01178"></a>01178             <span class="keywordflow">if</span> (equipment[idx].buffer_handle) {
<a name="l01179"></a>01179                status = <a class="code" href="group__rpcfunctionc.html#ga3191feb350dfa7289e8c7cf2f5993222">rpc_send_event</a>(equipment[idx].buffer_handle, pfragment,
<a name="l01180"></a>01180                                        pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a>);
<a name="l01181"></a>01181                <span class="keywordflow">if</span> (status != <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>) {
<a name="l01182"></a>01182                   <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;rpc_send_event(SYNC) error %d&quot;</span>, status);
<a name="l01183"></a>01183                   <span class="keywordflow">return</span> status;
<a name="l01184"></a>01184                }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186                <span class="comment">/* flush events from buffer */</span>
<a name="l01187"></a>01187                <a class="code" href="group__rpcfunctionc.html#ga83d80e4f1e8d2a2d7f38e58dcfd3c711">rpc_flush_event</a>();
<a name="l01188"></a>01188             }
<a name="l01189"></a>01189          }
<a name="l01190"></a>01190 
<a name="l01191"></a>01191          <span class="keywordflow">if</span> (equipment[idx].buffer_handle) {
<a name="l01192"></a>01192             <span class="comment">/* flush buffer cache on server side */</span>
<a name="l01193"></a>01193             status = <a class="code" href="group__bmfunctionc.html#ga9b74b8aa633c942682e642acba93c51d">bm_flush_cache</a>(equipment[idx].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01194"></a>01194             <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) {
<a name="l01195"></a>01195                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>, status);
<a name="l01196"></a>01196                <span class="keywordflow">return</span> status;
<a name="l01197"></a>01197             }
<a name="l01198"></a>01198          }
<a name="l01199"></a>01199       } <span class="keywordflow">else</span> {
<a name="l01200"></a>01200          <span class="comment">/* send unfragmented event */</span>
<a name="l01201"></a>01201 
<a name="l01202"></a>01202          <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>) {
<a name="l01203"></a>01203             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01204"></a>01204                    (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)), max_event_size);
<a name="l01205"></a>01205             <span class="keywordflow">return</span> <a class="code" href="group__err24.html#ga39da075b89b283b1ba6ee8163cd75e6d">SS_NO_MEMORY</a>;
<a name="l01206"></a>01206          }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208          <span class="comment">/* send event to buffer */</span>
<a name="l01209"></a>01209          <span class="keywordflow">if</span> (equipment[idx].buffer_handle) {
<a name="l01210"></a>01210             status = <a class="code" href="group__rpcfunctionc.html#ga3191feb350dfa7289e8c7cf2f5993222">rpc_send_event</a>(equipment[idx].buffer_handle, pevent,
<a name="l01211"></a>01211                                     pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a>);
<a name="l01212"></a>01212             <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) {
<a name="l01213"></a>01213                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;bm_send_event(SYNC) error %d&quot;</span>, status);
<a name="l01214"></a>01214                <span class="keywordflow">return</span> status;
<a name="l01215"></a>01215             }
<a name="l01216"></a>01216             <a class="code" href="group__rpcfunctionc.html#ga83d80e4f1e8d2a2d7f38e58dcfd3c711">rpc_flush_event</a>();
<a name="l01217"></a>01217             status = <a class="code" href="group__bmfunctionc.html#ga9b74b8aa633c942682e642acba93c51d">bm_flush_cache</a>(equipment[idx].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01218"></a>01218             <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) {
<a name="l01219"></a>01219                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>, status);
<a name="l01220"></a>01220                <span class="keywordflow">return</span> status;
<a name="l01221"></a>01221             }
<a name="l01222"></a>01222          }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224          <span class="comment">/* send event to ODB if RO_ODB flag is set or history is on. Do not</span>
<a name="l01225"></a>01225 <span class="comment">            send SLOW events since the class driver does that */</span>
<a name="l01226"></a>01226          <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a>) ||
<a name="l01227"></a>01227              (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a2740dd481bbbb7c8e417b5818ff8e064">history</a> &gt; 0 &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; ~<a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>))) {
<a name="l01228"></a>01228             <a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, equipment[idx].hkey_variables, equipment[idx].format);
<a name="l01229"></a>01229             equipment[idx].<a class="code" href="structeqpmnt.html#a2ba622da82fc7a02605e5f630464b13f">odb_out</a>++;
<a name="l01230"></a>01230          }
<a name="l01231"></a>01231       }
<a name="l01232"></a>01232 
<a name="l01233"></a>01233       equipment[idx].<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01234"></a>01234       equipment[idx].<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l01235"></a>01235    } <span class="keywordflow">else</span>
<a name="l01236"></a>01236       equipment[idx].<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l01239"></a>01239       <span class="keywordflow">if</span> (equipment[i].buffer_handle) {
<a name="l01240"></a>01240          status = <a class="code" href="group__bmfunctionc.html#ga9b74b8aa633c942682e642acba93c51d">bm_flush_cache</a>(equipment[i].buffer_handle, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>);
<a name="l01241"></a>01241          <span class="keywordflow">if</span> (status != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) {
<a name="l01242"></a>01242             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>, <span class="stringliteral">&quot;bm_flush_cache(SYNC) error %d&quot;</span>, status);
<a name="l01243"></a>01243             <span class="keywordflow">return</span> status;
<a name="l01244"></a>01244          }
<a name="l01245"></a>01245       }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247    <span class="keywordflow">return</span> <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>;
<a name="l01248"></a>01248 }
<a name="l01249"></a>01249 
<a name="l01250"></a>01250 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01251"></a>01251 
<a name="l01252"></a><a class="code" href="mfe_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">01252</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a3b6c3bbe0dd40506673ff86ca13ebf5b">send_all_periodic_events</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> transition)
<a name="l01253"></a>01253 {
<a name="l01254"></a>01254    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l01255"></a>01255    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i;
<a name="l01256"></a>01256 
<a name="l01257"></a>01257    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l01258"></a>01258       eq_info = &amp;equipment[i].<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l01259"></a>01259 
<a name="l01260"></a>01260       <span class="keywordflow">if</span> (!eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a512d7966d5f96f8c75fec4ba1b1946c4">enabled</a> || equipment[i].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l01261"></a>01261          <span class="keywordflow">continue</span>;
<a name="l01262"></a>01262 
<a name="l01263"></a>01263       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga88e94e1aadd86417c8eaa304d8c3b467">RO_BOR</a>) == 0)
<a name="l01264"></a>01264          <span class="keywordflow">continue</span>;
<a name="l01265"></a>01265       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga5b505930aa1fc780118b4fc75f771464">RO_EOR</a>) == 0)
<a name="l01266"></a>01266          <span class="keywordflow">continue</span>;
<a name="l01267"></a>01267       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga55beb931c834300fea83d24014f235d8">RO_PAUSE</a>) == 0)
<a name="l01268"></a>01268          <span class="keywordflow">continue</span>;
<a name="l01269"></a>01269       <span class="keywordflow">if</span> (transition == <a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga549159f6ef3ef7c17261bcccecbe57ec">RO_RESUME</a>) == 0)
<a name="l01270"></a>01270          <span class="keywordflow">continue</span>;
<a name="l01271"></a>01271 
<a name="l01272"></a>01272       <a class="code" href="mfe_8c.html#a467e7d6c77bcbb9259a7167ae1cdf29a">send_event</a>(i, FALSE);
<a name="l01273"></a>01273    }
<a name="l01274"></a>01274 }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01277"></a>01277 
<a name="l01278"></a><a class="code" href="mfe_8c.html#a5b555b249c0a043a3fc3b948eef7658b">01278</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a5b555b249c0a043a3fc3b948eef7658b">_readout_enabled_flag</a> = 0;
<a name="l01279"></a>01279 
<a name="l01280"></a><a class="code" href="mfe_8c.html#ab6ce300200eebdc71c6a3d5b3760a1ba">01280</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ab6ce300200eebdc71c6a3d5b3760a1ba">readout_enabled</a>()
<a name="l01281"></a>01281 {
<a name="l01282"></a>01282    <span class="keywordflow">return</span> <a class="code" href="mfe_8c.html#a5b555b249c0a043a3fc3b948eef7658b">_readout_enabled_flag</a>;
<a name="l01283"></a>01283 }
<a name="l01284"></a>01284 
<a name="l01285"></a><a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">01285</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(<a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> flag)
<a name="l01286"></a>01286 {
<a name="l01287"></a>01287    <a class="code" href="mfe_8c.html#a5b555b249c0a043a3fc3b948eef7658b">_readout_enabled_flag</a> = flag;
<a name="l01288"></a>01288 
<a name="l01289"></a>01289    <span class="keywordflow">if</span> (interrupt_eq) {
<a name="l01290"></a>01290       <span class="keywordflow">if</span> (flag)
<a name="l01291"></a>01291          <a class="code" href="mfe_8c.html#a681a5d1fe2e8a4735bcf03824ffb3e81">interrupt_configure</a>(<a class="code" href="group__err26.html#gaab5043b2fd69a86d3bcecfb3fd8f7af3">CMD_INTERRUPT_ENABLE</a>, 0, 0);
<a name="l01292"></a>01292       <span class="keywordflow">else</span>
<a name="l01293"></a>01293          <a class="code" href="mfe_8c.html#a681a5d1fe2e8a4735bcf03824ffb3e81">interrupt_configure</a>(<a class="code" href="group__err26.html#gaa12884ae2e3cbffa489d7c5074a029f7">CMD_INTERRUPT_DISABLE</a>, 0, 0);
<a name="l01294"></a>01294    }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296    <span class="keywordflow">if</span> (multithread_eq) {
<a name="l01297"></a>01297       <span class="comment">/* readout thread might still be in readout, so wait until finished */</span>
<a name="l01298"></a>01298       <span class="keywordflow">if</span> (flag == 0)
<a name="l01299"></a>01299          <span class="keywordflow">while</span> (<a class="code" href="mfe_8c.html#a0e0b5bde115b046964736980402f114e">readout_thread_active</a>)
<a name="l01300"></a>01300             <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(10);
<a name="l01301"></a>01301    }
<a name="l01302"></a>01302 }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01305"></a>01305 
<a name="l01306"></a><a class="code" href="fevmemodules_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">01306</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a8b84b3b4051dae0ba00258a3c885c0c7">interrupt_routine</a>(<span class="keywordtype">void</span>)
<a name="l01307"></a>01307 {
<a name="l01308"></a>01308    <span class="keywordtype">int</span> status;
<a name="l01309"></a>01309    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l01310"></a>01310    <span class="keywordtype">void</span> *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l01311"></a>01311 
<a name="l01312"></a>01312    <span class="comment">/* get pointer for upcoming event.</span>
<a name="l01313"></a>01313 <span class="comment">      This is a blocking call if no space available */</span>
<a name="l01314"></a>01314    status = <a class="code" href="group__rbfunctionc.html#ga26333526532b367bfacce172d6adcfa6">rb_get_wp</a>(<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>, &amp;p, 100000);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316    <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01317"></a>01317       pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)p;
<a name="l01318"></a>01318 
<a name="l01319"></a>01319       <span class="comment">/* compose MIDAS event header */</span>
<a name="l01320"></a>01320       pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = interrupt_eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01321"></a>01321       pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = interrupt_eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01322"></a>01322       pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l01323"></a>01323       pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="mfe_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l01324"></a>01324       pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> = interrupt_eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326       <span class="comment">/* call user readout routine */</span>
<a name="l01327"></a>01327       pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = interrupt_eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l01328"></a>01328 
<a name="l01329"></a>01329       <span class="comment">/* send event */</span>
<a name="l01330"></a>01330       <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l01331"></a>01331 
<a name="l01332"></a>01332          <span class="comment">/* put event into ring buffer */</span>
<a name="l01333"></a>01333          <a class="code" href="group__rbfunctionc.html#gad79588efc047402f5264e3ae9dc3bacc">rb_increment_wp</a>(<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335       } <span class="keywordflow">else</span>
<a name="l01336"></a>01336          interrupt_eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l01337"></a>01337    }
<a name="l01338"></a>01338 }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01341"></a>01341 
<a name="l01342"></a><a class="code" href="mfe_8c.html#a1dcae9fe323025ad03d3ec1b5a95263d">01342</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a1dcae9fe323025ad03d3ec1b5a95263d">readout_thread</a>(<span class="keywordtype">void</span> *param)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344    <span class="keywordtype">int</span> status, source;
<a name="l01345"></a>01345    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent;
<a name="l01346"></a>01346    <span class="keywordtype">void</span> *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348    p = param; <span class="comment">/* avoid compiler warning */</span>
<a name="l01349"></a>01349    <span class="keywordflow">while</span> (!<a class="code" href="mfe_8c.html#ab8d6a79a86973098e87386a79dfc4bc7">stop_all_threads</a>) {
<a name="l01350"></a>01350       <span class="comment">/* obtain buffer space */</span>
<a name="l01351"></a>01351       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#aec9294c38a73a78aa646600cef3e77f5">rbh1_next</a>) <span class="comment">// if set by user code, use it</span>
<a name="l01352"></a>01352          <a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a> = <a class="code" href="mfe_8c.html#aec9294c38a73a78aa646600cef3e77f5">rbh1_next</a>;
<a name="l01353"></a>01353 
<a name="l01354"></a>01354       status = <a class="code" href="group__rbfunctionc.html#ga26333526532b367bfacce172d6adcfa6">rb_get_wp</a>(<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>, &amp;p, 0);
<a name="l01355"></a>01355       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab8d6a79a86973098e87386a79dfc4bc7">stop_all_threads</a>)
<a name="l01356"></a>01356          <span class="keywordflow">break</span>;
<a name="l01357"></a>01357       <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gac3c60a757927f22fc91643550d780a85">DB_TIMEOUT</a>) {
<a name="l01358"></a>01358          <span class="comment">// printf(&quot;readout_thread: Ring buffer is full, waiting for space!\n&quot;);</span>
<a name="l01359"></a>01359          <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(10);
<a name="l01360"></a>01360          <span class="keywordflow">continue</span>;
<a name="l01361"></a>01361       }
<a name="l01362"></a>01362       <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l01363"></a>01363          <span class="keywordflow">break</span>;
<a name="l01364"></a>01364 
<a name="l01365"></a>01365       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab6ce300200eebdc71c6a3d5b3760a1ba">readout_enabled</a>()) {
<a name="l01366"></a>01366         
<a name="l01367"></a>01367          <span class="comment">/* indicate activity for readout_enable() */</span>
<a name="l01368"></a>01368          <a class="code" href="mfe_8c.html#a0e0b5bde115b046964736980402f114e">readout_thread_active</a> = 1;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370          <span class="comment">/* check for new event */</span>
<a name="l01371"></a>01371          source = <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(multithread_eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a345e65d8874f6b968bedc00e76d4f431">source</a>, multithread_eq-&gt;<a class="code" href="structeqpmnt.html#ae9bf94db8ff48533601c3833b1b20097">poll_count</a>, FALSE);
<a name="l01372"></a>01372 
<a name="l01373"></a>01373          <span class="keywordflow">if</span> (source &gt; 0) {
<a name="l01374"></a>01374 
<a name="l01375"></a>01375             <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab8d6a79a86973098e87386a79dfc4bc7">stop_all_threads</a>)
<a name="l01376"></a>01376                <span class="keywordflow">break</span>;
<a name="l01377"></a>01377 
<a name="l01378"></a>01378             pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)p;
<a name="l01379"></a>01379             <span class="comment">/* put source at beginning of event, will be overwritten by </span>
<a name="l01380"></a>01380 <span class="comment">               user readout code, just a special feature used by some </span>
<a name="l01381"></a>01381 <span class="comment">               multi-source applications */</span>
<a name="l01382"></a>01382             *(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> *) (pevent + 1) = source;
<a name="l01383"></a>01383             
<a name="l01384"></a>01384             <span class="comment">/* compose MIDAS event header */</span>
<a name="l01385"></a>01385             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = multithread_eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01386"></a>01386             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = multithread_eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01387"></a>01387             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l01388"></a>01388             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="mfe_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l01389"></a>01389             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> = multithread_eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01390"></a>01390 
<a name="l01391"></a>01391             <span class="comment">/* call user readout routine */</span>
<a name="l01392"></a>01392             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = multithread_eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l01393"></a>01393 
<a name="l01394"></a>01394             <span class="comment">/* check event size */</span>
<a name="l01395"></a>01395             <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>) {
<a name="l01396"></a>01396                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;readout_thread&quot;</span>,
<a name="l01397"></a>01397                         <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01398"></a>01398                         (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l01399"></a>01399                         max_event_size);
<a name="l01400"></a>01400                assert(FALSE);
<a name="l01401"></a>01401             }
<a name="l01402"></a>01402 
<a name="l01403"></a>01403             <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> &gt; 0) {
<a name="l01404"></a>01404                <span class="comment">/* put event into ring buffer */</span>
<a name="l01405"></a>01405                <a class="code" href="group__rbfunctionc.html#gad79588efc047402f5264e3ae9dc3bacc">rb_increment_wp</a>(<a class="code" href="mfe_8c.html#a1b7abb16c33dc41bd5c97aa08439568e">rbh1</a>, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l01406"></a>01406             } <span class="keywordflow">else</span>
<a name="l01407"></a>01407                multithread_eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>--;
<a name="l01408"></a>01408          }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410          <a class="code" href="mfe_8c.html#a0e0b5bde115b046964736980402f114e">readout_thread_active</a> = 0;
<a name="l01411"></a>01411 
<a name="l01412"></a>01412       } <span class="keywordflow">else</span> <span class="comment">// readout_enabled</span>
<a name="l01413"></a>01413         <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(10);
<a name="l01414"></a>01414 
<a name="l01415"></a>01415    }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417    <a class="code" href="mfe_8c.html#a0e0b5bde115b046964736980402f114e">readout_thread_active</a> = 0;
<a name="l01418"></a>01418 
<a name="l01419"></a>01419    <span class="keywordflow">return</span> 0;
<a name="l01420"></a>01420 }
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 <span class="comment">/*-- Receive event from readout thread or interrupt routine --------*/</span>
<a name="l01423"></a>01423 
<a name="l01424"></a><a class="code" href="mfe_8c.html#aab90250febb716e08aff848e5382b496">01424</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#aab90250febb716e08aff848e5382b496">set_event_rb</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> rb)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426    <a class="code" href="mfe_8c.html#a0cc81c4acd29047148a2b696a95b330c">rbh2</a> = rb;
<a name="l01427"></a>01427 }
<a name="l01428"></a>01428 
<a name="l01429"></a><a class="code" href="mfe_8c.html#a9cd62f651300e81799cae815b51ca654">01429</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a9cd62f651300e81799cae815b51ca654">receive_trigger_event</a>(<a class="code" href="structeqpmnt.html">EQUIPMENT</a> *eq)
<a name="l01430"></a>01430 {
<a name="l01431"></a>01431    <span class="keywordtype">int</span> status;
<a name="l01432"></a>01432    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *prb, *pevent;
<a name="l01433"></a>01433    <span class="keywordtype">void</span> *<a class="code" href="sis3803_8c.html#afcb0609a0beab248bb3994a3368bd9ff">p</a>;
<a name="l01434"></a>01434    <span class="keywordtype">int</span> nbytes;
<a name="l01435"></a>01435 
<a name="l01436"></a>01436    <span class="keywordflow">if</span> (0) {
<a name="l01437"></a>01437       <span class="keyword">static</span> <span class="keywordtype">int</span> count = 0;
<a name="l01438"></a>01438       <span class="keywordflow">if</span> (((count++) % 100) == 0) {
<a name="l01439"></a>01439          <a class="code" href="group__rbfunctionc.html#gae92c348180d666240c295b7c334b4ebe">rb_get_buffer_level</a>(<a class="code" href="mfe_8c.html#a0cc81c4acd29047148a2b696a95b330c">rbh2</a>, &amp;nbytes);
<a name="l01440"></a>01440          <span class="keywordflow">if</span> (nbytes != 0)
<a name="l01441"></a>01441             printf(<span class="stringliteral">&quot;mfe: ring buffer contains %d bytes\n&quot;</span>, nbytes);
<a name="l01442"></a>01442       }
<a name="l01443"></a>01443    }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445    status = <a class="code" href="group__rbfunctionc.html#ga0335381f2ef26fd5251bc7b30d6d1e90">rb_get_rp</a>(<a class="code" href="mfe_8c.html#a0cc81c4acd29047148a2b696a95b330c">rbh2</a>, &amp;p, 10);
<a name="l01446"></a>01446    prb = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)p;
<a name="l01447"></a>01447    <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gac3c60a757927f22fc91643550d780a85">DB_TIMEOUT</a>)
<a name="l01448"></a>01448       <span class="keywordflow">return</span> 0;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450    pevent = prb;
<a name="l01451"></a>01451 
<a name="l01452"></a>01452    <span class="comment">/* send event */</span>
<a name="l01453"></a>01453    <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l01454"></a>01454       <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>) {
<a name="l01455"></a>01455          
<a name="l01456"></a>01456          <span class="comment">/* save event in temporary buffer to push it to the ODB later */</span>
<a name="l01457"></a>01457          <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a>)
<a name="l01458"></a>01458             memcpy(<a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>, pevent, pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01459"></a>01459 
<a name="l01460"></a>01460          <span class="comment">/* send first event to ODB if logger writes in root format */</span>
<a name="l01461"></a>01461          <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> == 0)
<a name="l01462"></a>01462             <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ace89325172f363d2efd92735e52ec69e">logger_root</a>())
<a name="l01463"></a>01463                <a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, eq-&gt;<a class="code" href="structeqpmnt.html#ab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>, eq-&gt;<a class="code" href="structeqpmnt.html#acad980d7699722234c72bfca6243203b">format</a>);
<a name="l01464"></a>01464 
<a name="l01465"></a>01465          status = <a class="code" href="group__rpcfunctionc.html#ga3191feb350dfa7289e8c7cf2f5993222">rpc_send_event</a>(eq-&gt;<a class="code" href="structeqpmnt.html#a7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l01466"></a>01466                                  pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>),
<a name="l01467"></a>01467                                  <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a>);
<a name="l01468"></a>01468 
<a name="l01469"></a>01469          <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l01470"></a>01470             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;receive_trigger_event&quot;</span>, <span class="stringliteral">&quot;rpc_send_event error %d&quot;</span>, status);
<a name="l01471"></a>01471             <span class="keywordflow">return</span> -1;
<a name="l01472"></a>01472          }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474          eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01475"></a>01475 
<a name="l01476"></a>01476          <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#ade7b61b85a73ed33545caf31b706acd3">num_subevents</a>)
<a name="l01477"></a>01477             eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> += eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a>;
<a name="l01478"></a>01478          <span class="keywordflow">else</span>
<a name="l01479"></a>01479             eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481          <a class="code" href="mfe_8c.html#abb411e407679b5b38f424cc2f9f86b07">rotate_wheel</a>();
<a name="l01482"></a>01482       }
<a name="l01483"></a>01483    }
<a name="l01484"></a>01484 
<a name="l01485"></a>01485    <a class="code" href="group__rbfunctionc.html#ga4d2d9f33813530718f4b1f3d423a3b7b">rb_increment_rp</a>(<a class="code" href="mfe_8c.html#a0cc81c4acd29047148a2b696a95b330c">rbh2</a>, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + prb-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l01486"></a>01486 
<a name="l01487"></a>01487    <span class="keywordflow">return</span> prb-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l01488"></a>01488 }
<a name="l01489"></a>01489 
<a name="l01490"></a>01490 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01491"></a>01491 
<a name="l01492"></a><a class="code" href="mfe_8c.html#a4186dc25477a1b947c5d6ef64bcc4da0">01492</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a4186dc25477a1b947c5d6ef64bcc4da0">message_print</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg)
<a name="l01493"></a>01493 {
<a name="l01494"></a>01494    <span class="keywordtype">char</span> str[160];
<a name="l01495"></a>01495 
<a name="l01496"></a>01496    memset(str, <span class="charliteral">&apos; &apos;</span>, 159);
<a name="l01497"></a>01497    str[159] = 0;
<a name="l01498"></a>01498 
<a name="l01499"></a>01499    <span class="keywordflow">if</span> (msg[0] == <span class="charliteral">&apos;[&apos;</span>)
<a name="l01500"></a>01500       msg = strchr(msg, <span class="charliteral">&apos;]&apos;</span>) + 2;
<a name="l01501"></a>01501 
<a name="l01502"></a>01502    memcpy(str, msg, strlen(msg));
<a name="l01503"></a>01503    ss_printf(0, 20, str);
<a name="l01504"></a>01504 
<a name="l01505"></a>01505    <span class="keywordflow">return</span> 0;
<a name="l01506"></a>01506 }
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01509"></a>01509 
<a name="l01510"></a><a class="code" href="mfe_8c.html#a4d77ab19483f67e8240c29a9ff9ca777">01510</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a4d77ab19483f67e8240c29a9ff9ca777">display</a>(<a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> bInit)
<a name="l01511"></a>01511 {
<a name="l01512"></a>01512    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, status;
<a name="l01513"></a>01513    time_t full_time;
<a name="l01514"></a>01514    <span class="keywordtype">char</span> str[30];
<a name="l01515"></a>01515 
<a name="l01516"></a>01516    <span class="keywordflow">if</span> (bInit) {
<a name="l01517"></a>01517       ss_clear_screen();
<a name="l01518"></a>01518 
<a name="l01519"></a>01519       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0])
<a name="l01520"></a>01520          strcpy(str, <a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>);
<a name="l01521"></a>01521       <span class="keywordflow">else</span>
<a name="l01522"></a>01522          strcpy(str, <span class="stringliteral">&quot;&lt;local&gt;&quot;</span>);
<a name="l01523"></a>01523 
<a name="l01524"></a>01524       ss_printf(0, 0, <span class="stringliteral">&quot;%s connected to %s. Press \&quot;!\&quot; to exit&quot;</span>, <a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>, str);
<a name="l01525"></a>01525       ss_printf(0, 1,
<a name="l01526"></a>01526                 <span class="stringliteral">&quot;================================================================================&quot;</span>);
<a name="l01527"></a>01527       ss_printf(0, 2, <span class="stringliteral">&quot;Run status:   %s&quot;</span>,
<a name="l01528"></a>01528                 <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a> ? <span class="stringliteral">&quot;Stopped&quot;</span> : <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> ==
<a name="l01529"></a>01529                 <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> ? <span class="stringliteral">&quot;Running&quot;</span> : <span class="stringliteral">&quot;Paused&quot;</span>);
<a name="l01530"></a>01530       ss_printf(25, 2, <span class="stringliteral">&quot;Run number %d   &quot;</span>, <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l01531"></a>01531       ss_printf(0, 3,
<a name="l01532"></a>01532                 <span class="stringliteral">&quot;================================================================================&quot;</span>);
<a name="l01533"></a>01533       ss_printf(0, 4,
<a name="l01534"></a>01534                 <span class="stringliteral">&quot;Equipment     Status     Events     Events/sec Rate[kB/s] ODB-&gt;FE    FE-&gt;ODB&quot;</span>);
<a name="l01535"></a>01535       ss_printf(0, 5,
<a name="l01536"></a>01536                 <span class="stringliteral">&quot;--------------------------------------------------------------------------------&quot;</span>);
<a name="l01537"></a>01537       <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l01538"></a>01538          ss_printf(0, i + 6, <span class="stringliteral">&quot;%s&quot;</span>, equipment[i].name);
<a name="l01539"></a>01539    }
<a name="l01540"></a>01540 
<a name="l01541"></a>01541    <span class="comment">/* display time */</span>
<a name="l01542"></a>01542    time(&amp;full_time);
<a name="l01543"></a>01543    strcpy(str, ctime(&amp;full_time) + 11);
<a name="l01544"></a>01544    str[8] = 0;
<a name="l01545"></a>01545    ss_printf(72, 0, <span class="stringliteral">&quot;%s&quot;</span>, str);
<a name="l01546"></a>01546 
<a name="l01547"></a>01547    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l01548"></a>01548       status = equipment[i].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a>;
<a name="l01549"></a>01549 
<a name="l01550"></a>01550       <span class="keywordflow">if</span> ((status == 0 || status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>) &amp;&amp; equipment[i].info.enabled)
<a name="l01551"></a>01551          ss_printf(14, i + 6, <span class="stringliteral">&quot;OK       &quot;</span>);
<a name="l01552"></a>01552       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!equipment[i].info.enabled)
<a name="l01553"></a>01553          ss_printf(14, i + 6, <span class="stringliteral">&quot;Disabled &quot;</span>);
<a name="l01554"></a>01554       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga8a0cc5de6ea758c61231a11b6a076e1f">FE_ERR_ODB</a>)
<a name="l01555"></a>01555          ss_printf(14, i + 6, <span class="stringliteral">&quot;ODB Error&quot;</span>);
<a name="l01556"></a>01556       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#ga9fea053c26a278026fa0d7501c300c4f">FE_ERR_HW</a>)
<a name="l01557"></a>01557          ss_printf(14, i + 6, <span class="stringliteral">&quot;HW Error &quot;</span>);
<a name="l01558"></a>01558       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#gae7f0996583000c6c16916cdc846b753a">FE_ERR_DISABLED</a>)
<a name="l01559"></a>01559          ss_printf(14, i + 6, <span class="stringliteral">&quot;Disabled &quot;</span>);
<a name="l01560"></a>01560       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == <a class="code" href="group__err26.html#gac4221d7e494c798f57552f502e2459ef">FE_ERR_DRIVER</a>)
<a name="l01561"></a>01561          ss_printf(14, i + 6, <span class="stringliteral">&quot;Driver err&quot;</span>);
<a name="l01562"></a>01562       <span class="keywordflow">else</span>
<a name="l01563"></a>01563          ss_printf(14, i + 6, <span class="stringliteral">&quot;Unknown  &quot;</span>);
<a name="l01564"></a>01564 
<a name="l01565"></a>01565       <span class="keywordflow">if</span> (equipment[i].stats.<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt; 1E9)
<a name="l01566"></a>01566          ss_printf(25, i + 6, <span class="stringliteral">&quot;%1.3lfG     &quot;</span>, equipment[i].stats.<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> / 1E9);
<a name="l01567"></a>01567       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (equipment[i].stats.<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt; 1E6)
<a name="l01568"></a>01568          ss_printf(25, i + 6, <span class="stringliteral">&quot;%1.3lfM     &quot;</span>, equipment[i].stats.<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> / 1E6);
<a name="l01569"></a>01569       <span class="keywordflow">else</span>
<a name="l01570"></a>01570          ss_printf(25, i + 6, <span class="stringliteral">&quot;%1.0lf      &quot;</span>, equipment[i].stats.<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>);
<a name="l01571"></a>01571       ss_printf(36, i + 6, <span class="stringliteral">&quot;%1.1lf      &quot;</span>, equipment[i].stats.events_per_sec);
<a name="l01572"></a>01572       ss_printf(47, i + 6, <span class="stringliteral">&quot;%1.1lf      &quot;</span>, equipment[i].stats.kbytes_per_sec);
<a name="l01573"></a>01573       ss_printf(58, i + 6, <span class="stringliteral">&quot;%ld       &quot;</span>, equipment[i].odb_in);
<a name="l01574"></a>01574       ss_printf(69, i + 6, <span class="stringliteral">&quot;%ld       &quot;</span>, equipment[i].odb_out);
<a name="l01575"></a>01575    }
<a name="l01576"></a>01576 
<a name="l01577"></a>01577    <span class="comment">/* go to next line */</span>
<a name="l01578"></a>01578    ss_printf(0, i + 6, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01579"></a>01579 }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01582"></a>01582 
<a name="l01583"></a><a class="code" href="mfe_8c.html#abb411e407679b5b38f424cc2f9f86b07">01583</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#abb411e407679b5b38f424cc2f9f86b07">rotate_wheel</a>(<span class="keywordtype">void</span>)
<a name="l01584"></a>01584 {
<a name="l01585"></a>01585    <span class="keyword">static</span> <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> last_wheel = 0, wheel_index = 0;
<a name="l01586"></a>01586    <span class="keyword">static</span> <span class="keywordtype">char</span> wheel_char[] = { <span class="charliteral">&apos;-&apos;</span>, <span class="charliteral">&apos;\\&apos;</span>, <span class="charliteral">&apos;|&apos;</span>, <span class="charliteral">&apos;/&apos;</span> };
<a name="l01587"></a>01587 
<a name="l01588"></a>01588    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) {
<a name="l01589"></a>01589       <span class="keywordflow">if</span> (<a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>() - last_wheel &gt; 300) {
<a name="l01590"></a>01590          last_wheel = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01591"></a>01591          ss_printf(79, 2, <span class="stringliteral">&quot;%c&quot;</span>, wheel_char[wheel_index]);
<a name="l01592"></a>01592          wheel_index = (wheel_index + 1) % 4;
<a name="l01593"></a>01593       }
<a name="l01594"></a>01594    }
<a name="l01595"></a>01595 }
<a name="l01596"></a>01596 
<a name="l01597"></a>01597 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01598"></a>01598 
<a name="l01599"></a><a class="code" href="mfe_8c.html#ace89325172f363d2efd92735e52ec69e">01599</a> <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="mfe_8c.html#ace89325172f363d2efd92735e52ec69e">logger_root</a>()
<a name="l01600"></a>01600 <span class="comment">/* check if logger uses ROOT format */</span>
<a name="l01601"></a>01601 {
<a name="l01602"></a>01602    <span class="keywordtype">int</span> size, i, status;
<a name="l01603"></a>01603    <span class="keywordtype">char</span> str[80];
<a name="l01604"></a>01604    HNDLE hKeyRoot, <a class="code" href="mevb_8c.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
<a name="l01605"></a>01605 
<a name="l01606"></a>01606    <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Channels&quot;</span>, &amp;hKeyRoot) == <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
<a name="l01607"></a>01607       <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l01608"></a>01608          status = <a class="code" href="group__odbfunctionc.html#gac7c23e0ebd6b203c81ca491db5b4753e">db_enum_key</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKeyRoot, i, &amp;hKey);
<a name="l01609"></a>01609          <span class="keywordflow">if</span> (status == <a class="code" href="group__err23.html#gaf2249d36fd8ffb254cd33a3bbc899638">DB_NO_MORE_SUBKEYS</a>)
<a name="l01610"></a>01610             <span class="keywordflow">break</span>;
<a name="l01611"></a>01611 
<a name="l01612"></a>01612          strcpy(str, <span class="stringliteral">&quot;MIDAS&quot;</span>);
<a name="l01613"></a>01613          size = <span class="keyword">sizeof</span>(str);
<a name="l01614"></a>01614          <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, hKey, <span class="stringliteral">&quot;Settings/Format&quot;</span>, str, &amp;size, <a class="code" href="group__mdefineh.html#gab81af1d9631a5c29500d506f0c3470cd">TID_STRING</a>, TRUE);
<a name="l01615"></a>01615 
<a name="l01616"></a>01616          <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga060d9c5ccec906f52a34dc39de6e2069">equal_ustring</a>(str, <span class="stringliteral">&quot;ROOT&quot;</span>))
<a name="l01617"></a>01617             <span class="keywordflow">return</span> TRUE;
<a name="l01618"></a>01618       }
<a name="l01619"></a>01619    }
<a name="l01620"></a>01620 
<a name="l01621"></a>01621    <span class="keywordflow">return</span> FALSE;
<a name="l01622"></a>01622 }
<a name="l01623"></a>01623 
<a name="l01624"></a>01624 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01625"></a>01625 
<a name="l01626"></a><a class="code" href="mfe_8c.html#a6ed70b349943dd2724230ead1d85e4ec">01626</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a6ed70b349943dd2724230ead1d85e4ec">check_polled_events</a>(<span class="keywordtype">void</span>)
<a name="l01627"></a>01627 {
<a name="l01628"></a>01628    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l01629"></a>01629    <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *eq;
<a name="l01630"></a>01630    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent, *pfragment;
<a name="l01631"></a>01631    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> readout_start, sent, size;
<a name="l01632"></a>01632    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, idx, source, events_sent, status;
<a name="l01633"></a>01633    <span class="keywordtype">char</span> *pdata;
<a name="l01634"></a>01634    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pd;
<a name="l01635"></a>01635 
<a name="l01636"></a>01636    events_sent = 0;
<a name="l01637"></a>01637    <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01638"></a>01638 
<a name="l01639"></a>01639    <span class="comment">/*---- loop over equipment table -------------------------------*/</span>
<a name="l01640"></a>01640    <span class="keywordflow">for</span> (idx = 0;; idx++) {
<a name="l01641"></a>01641       eq = &amp;equipment[idx];
<a name="l01642"></a>01642       eq_info = &amp;eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l01643"></a>01643 
<a name="l01644"></a>01644       <span class="comment">/* check if end of equipment list */</span>
<a name="l01645"></a>01645       <span class="keywordflow">if</span> (!eq-&gt;<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0])
<a name="l01646"></a>01646          <span class="keywordflow">break</span>;
<a name="l01647"></a>01647 
<a name="l01648"></a>01648       <span class="keywordflow">if</span> (!eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l01649"></a>01649          <span class="keywordflow">continue</span>;
<a name="l01650"></a>01650 
<a name="l01651"></a>01651       <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l01652"></a>01652          <span class="keywordflow">continue</span>;
<a name="l01653"></a>01653 
<a name="l01654"></a>01654       <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>) == 0)
<a name="l01655"></a>01655          <span class="keywordflow">continue</span>;
<a name="l01656"></a>01656 
<a name="l01657"></a>01657       <span class="comment">/*---- check polled events ----*/</span>
<a name="l01658"></a>01658       readout_start = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01659"></a>01659       pevent = NULL;
<a name="l01660"></a>01660 
<a name="l01661"></a>01661       <span class="keywordflow">while</span> ((source = <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a345e65d8874f6b968bedc00e76d4f431">source</a>, eq-&gt;<a class="code" href="structeqpmnt.html#ae9bf94db8ff48533601c3833b1b20097">poll_count</a>, FALSE)) &gt; 0) {
<a name="l01662"></a>01662          
<a name="l01663"></a>01663          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>)
<a name="l01664"></a>01664             pevent = <a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">frag_buffer</a>;
<a name="l01665"></a>01665          <span class="keywordflow">else</span>
<a name="l01666"></a>01666             pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)<a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668          <span class="comment">/* compose MIDAS event header */</span>
<a name="l01669"></a>01669          pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01670"></a>01670          pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01671"></a>01671          pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l01672"></a>01672          pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="mfe_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l01673"></a>01673          pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> = eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>;
<a name="l01674"></a>01674 
<a name="l01675"></a>01675          <span class="comment">/* put source at beginning of event, will be overwritten by </span>
<a name="l01676"></a>01676 <span class="comment">            user readout code, just a special feature used by some </span>
<a name="l01677"></a>01677 <span class="comment">            multi-source applications */</span>
<a name="l01678"></a>01678          *(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> *) (pevent + 1) = source;
<a name="l01679"></a>01679 
<a name="l01680"></a>01680          <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#ade7b61b85a73ed33545caf31b706acd3">num_subevents</a>) {
<a name="l01681"></a>01681             eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a> = 0;
<a name="l01682"></a>01682             <span class="keywordflow">do</span> {
<a name="l01683"></a>01683                *(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> *) ((<span class="keywordtype">char</span> *) (pevent + 1) + pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>) = source;
<a name="l01684"></a>01684 
<a name="l01685"></a>01685                <span class="comment">/* call user readout routine for subevent indicating offset */</span>
<a name="l01686"></a>01686                size = eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l01687"></a>01687                pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> += size;
<a name="l01688"></a>01688                <span class="keywordflow">if</span> (size &gt; 0) {
<a name="l01689"></a>01689                   <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt;
<a name="l01690"></a>01690                       (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>) {
<a name="l01691"></a>01691                      <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;check_polled_events&quot;</span>,
<a name="l01692"></a>01692                             <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01693"></a>01693                             (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l01694"></a>01694                             max_event_size);
<a name="l01695"></a>01695                   }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697                   eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a>++;
<a name="l01698"></a>01698                   eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01699"></a>01699                }
<a name="l01700"></a>01700 
<a name="l01701"></a>01701                <span class="comment">/* wait for next event */</span>
<a name="l01702"></a>01702                <span class="keywordflow">do</span> {
<a name="l01703"></a>01703                   source = <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a345e65d8874f6b968bedc00e76d4f431">source</a>, eq-&gt;<a class="code" href="structeqpmnt.html#ae9bf94db8ff48533601c3833b1b20097">poll_count</a>, FALSE);
<a name="l01704"></a>01704 
<a name="l01705"></a>01705                   <span class="keywordflow">if</span> (source == FALSE) {
<a name="l01706"></a>01706                      <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01707"></a>01707 
<a name="l01708"></a>01708                      <span class="comment">/* repeat no more than period */</span>
<a name="l01709"></a>01709                      <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - readout_start &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a>)
<a name="l01710"></a>01710                         <span class="keywordflow">break</span>;
<a name="l01711"></a>01711                   }
<a name="l01712"></a>01712                } <span class="keywordflow">while</span> (source == FALSE);
<a name="l01713"></a>01713 
<a name="l01714"></a>01714             } <span class="keywordflow">while</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a> &lt; eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#ade7b61b85a73ed33545caf31b706acd3">num_subevents</a> &amp;&amp; source);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716             <span class="comment">/* notify readout routine about end of super-event */</span>
<a name="l01717"></a>01717             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), -1);
<a name="l01718"></a>01718          } <span class="keywordflow">else</span> {
<a name="l01719"></a>01719             <span class="comment">/* call user readout routine indicating event source */</span>
<a name="l01720"></a>01720             pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l01721"></a>01721 
<a name="l01722"></a>01722             <span class="comment">/* check event size */</span>
<a name="l01723"></a>01723             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>) {
<a name="l01724"></a>01724                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>) {
<a name="l01725"></a>01725                   <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;check_polled_events&quot;</span>,
<a name="l01726"></a>01726                         <span class="stringliteral">&quot;Event size %ld larger than maximum size %d for frag. ev.&quot;</span>,
<a name="l01727"></a>01727                         (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l01728"></a>01728                         max_event_size_frag);
<a name="l01729"></a>01729                   assert(FALSE);
<a name="l01730"></a>01730                }
<a name="l01731"></a>01731             } <span class="keywordflow">else</span> {
<a name="l01732"></a>01732                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>) {
<a name="l01733"></a>01733                   <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;check_polled_events&quot;</span>,
<a name="l01734"></a>01734                         <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01735"></a>01735                         (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l01736"></a>01736                         max_event_size);
<a name="l01737"></a>01737                   assert(FALSE);
<a name="l01738"></a>01738                }
<a name="l01739"></a>01739             }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741             <span class="comment">/* increment serial number if event read out sucessfully */</span>
<a name="l01742"></a>01742             <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>)
<a name="l01743"></a>01743                eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01744"></a>01744          }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746          <span class="comment">/* send event */</span>
<a name="l01747"></a>01747          <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l01748"></a>01748 
<a name="l01749"></a>01749             <span class="comment">/* check for fragmented event */</span>
<a name="l01750"></a>01750             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>) {
<a name="l01751"></a>01751                <span class="comment">/* compose fragments */</span>
<a name="l01752"></a>01752                pfragment = <a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l01753"></a>01753 
<a name="l01754"></a>01754                <span class="comment">/* compose MIDAS event header */</span>
<a name="l01755"></a>01755                memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01756"></a>01756                pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a>;
<a name="l01757"></a>01757 
<a name="l01758"></a>01758                <span class="comment">/* store total event size */</span>
<a name="l01759"></a>01759                pd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) (pfragment + 1);
<a name="l01760"></a>01760                size = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l01761"></a>01761                <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
<a name="l01762"></a>01762                   pd[i] = (<span class="keywordtype">unsigned</span> char) (size &amp; 0xFF);      <span class="comment">/* little endian, please! */</span>
<a name="l01763"></a>01763                   size &gt;&gt;= 8;
<a name="l01764"></a>01764                }
<a name="l01765"></a>01765 
<a name="l01766"></a>01766                pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>);
<a name="l01767"></a>01767 
<a name="l01768"></a>01768                pdata = (<span class="keywordtype">char</span> *) (pevent + 1);
<a name="l01769"></a>01769 
<a name="l01770"></a>01770                <span class="keywordflow">for</span> (i = 0, sent = 0; sent &lt; pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>; i++) {
<a name="l01771"></a>01771                   <span class="keywordflow">if</span> (i &gt; 0) {
<a name="l01772"></a>01772                      pfragment = <a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l01773"></a>01773 
<a name="l01774"></a>01774                      <span class="comment">/* compose MIDAS event header */</span>
<a name="l01775"></a>01775                      memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l01776"></a>01776                      pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>;
<a name="l01777"></a>01777 
<a name="l01778"></a>01778                      <span class="comment">/* copy portion of event */</span>
<a name="l01779"></a>01779                      size = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> - sent;
<a name="l01780"></a>01780                      <span class="keywordflow">if</span> (size &gt; <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l01781"></a>01781                         size = <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01782"></a>01782 
<a name="l01783"></a>01783                      memcpy(pfragment + 1, pdata, size);
<a name="l01784"></a>01784                      pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = size;
<a name="l01785"></a>01785                      sent += size;
<a name="l01786"></a>01786                      pdata += size;
<a name="l01787"></a>01787                   }
<a name="l01788"></a>01788 
<a name="l01789"></a>01789                   <span class="comment">/* send event to buffer */</span>
<a name="l01790"></a>01790                   <span class="keywordflow">if</span> (equipment[idx].buffer_handle) {
<a name="l01791"></a>01791                      status = <a class="code" href="group__rpcfunctionc.html#ga3191feb350dfa7289e8c7cf2f5993222">rpc_send_event</a>(equipment[idx].buffer_handle, pfragment,
<a name="l01792"></a>01792                                              pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a>);
<a name="l01793"></a>01793                      <span class="keywordflow">if</span> (status != <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>) {
<a name="l01794"></a>01794                         <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;check_polled_events&quot;</span>, <span class="stringliteral">&quot;rpc_send_event(SYNC) error %d&quot;</span>, status);
<a name="l01795"></a>01795                         <span class="keywordflow">return</span> status;
<a name="l01796"></a>01796                      }
<a name="l01797"></a>01797 
<a name="l01798"></a>01798                      <span class="comment">/* flush events from buffer */</span>
<a name="l01799"></a>01799                      <a class="code" href="group__rpcfunctionc.html#ga83d80e4f1e8d2a2d7f38e58dcfd3c711">rpc_flush_event</a>();
<a name="l01800"></a>01800                   }
<a name="l01801"></a>01801                }
<a name="l01802"></a>01802             
<a name="l01803"></a>01803             } <span class="keywordflow">else</span> { <span class="comment">/*-------------------*/</span>
<a name="l01804"></a>01804 
<a name="l01805"></a>01805                <span class="comment">/* send unfragmented event */</span>
<a name="l01806"></a>01806 
<a name="l01807"></a>01807                <span class="comment">/* send first event to ODB if logger writes in root format */</span>
<a name="l01808"></a>01808                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> == 0)
<a name="l01809"></a>01809                   <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ace89325172f363d2efd92735e52ec69e">logger_root</a>())
<a name="l01810"></a>01810                      <a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, eq-&gt;<a class="code" href="structeqpmnt.html#ab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>, eq-&gt;<a class="code" href="structeqpmnt.html#acad980d7699722234c72bfca6243203b">format</a>);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812                status = <a class="code" href="group__rpcfunctionc.html#ga3191feb350dfa7289e8c7cf2f5993222">rpc_send_event</a>(eq-&gt;<a class="code" href="structeqpmnt.html#a7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l01813"></a>01813                                        pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>),
<a name="l01814"></a>01814                                        <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a>);
<a name="l01815"></a>01815 
<a name="l01816"></a>01816                <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l01817"></a>01817                   <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;check_polled_events&quot;</span>, <span class="stringliteral">&quot;rpc_send_event error %d&quot;</span>, status);
<a name="l01818"></a>01818                   <span class="keywordflow">break</span>;
<a name="l01819"></a>01819                }
<a name="l01820"></a>01820             }
<a name="l01821"></a>01821 
<a name="l01822"></a>01822             eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l01823"></a>01823 
<a name="l01824"></a>01824             <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#ade7b61b85a73ed33545caf31b706acd3">num_subevents</a>) {
<a name="l01825"></a>01825                eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> += eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a>;
<a name="l01826"></a>01826                events_sent += eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a>;
<a name="l01827"></a>01827             } <span class="keywordflow">else</span> {
<a name="l01828"></a>01828                eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l01829"></a>01829                events_sent++;
<a name="l01830"></a>01830             }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832             <a class="code" href="mfe_8c.html#abb411e407679b5b38f424cc2f9f86b07">rotate_wheel</a>();
<a name="l01833"></a>01833          }
<a name="l01834"></a>01834 
<a name="l01835"></a>01835          <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01836"></a>01836 
<a name="l01837"></a>01837          <span class="comment">/* repeat no more than period */</span>
<a name="l01838"></a>01838          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - readout_start &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a>)
<a name="l01839"></a>01839             <span class="keywordflow">break</span>;
<a name="l01840"></a>01840 
<a name="l01841"></a>01841          <span class="comment">/* quit if event limit is reached */</span>
<a name="l01842"></a>01842          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0 &amp;&amp;
<a name="l01843"></a>01843              eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> + eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt;= eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>)
<a name="l01844"></a>01844             <span class="keywordflow">break</span>;
<a name="l01845"></a>01845       }
<a name="l01846"></a>01846    }
<a name="l01847"></a>01847 
<a name="l01848"></a>01848    <span class="keywordflow">return</span> events_sent;
<a name="l01849"></a>01849 }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l01852"></a>01852 
<a name="l01853"></a><a class="code" href="mfe_8c.html#a94c9987508c91ae4827cc231f43b577e">01853</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a94c9987508c91ae4827cc231f43b577e">scheduler</a>(<span class="keywordtype">void</span>)
<a name="l01854"></a>01854 {
<a name="l01855"></a>01855    <a class="code" href="structEQUIPMENT__INFO.html">EQUIPMENT_INFO</a> *eq_info;
<a name="l01856"></a>01856    <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *eq;
<a name="l01857"></a>01857    <a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *pevent, *pfragment;
<a name="l01858"></a>01858    <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> last_time_network = 0, last_time_display = 0, last_time_flush = 0, 
<a name="l01859"></a>01859       readout_start, sent, size, last_time_rate = 0;
<a name="l01860"></a>01860    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i, j, idx, status = 0, ch, source, state, old_flag;
<a name="l01861"></a>01861    <span class="keywordtype">char</span> str[80], *pdata;
<a name="l01862"></a>01862    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pd;
<a name="l01863"></a>01863    <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> buffer_done, flag, force_update = FALSE;
<a name="l01864"></a>01864 
<a name="l01865"></a>01865    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> opt_max = 0, opt_index = 0, opt_tcp_size = 128, opt_cnt = 0;
<a name="l01866"></a>01866    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> err;
<a name="l01867"></a>01867 
<a name="l01868"></a>01868 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l01869"></a>01869 <span class="preprocessor"></span>   rpc_set_opt_tcp_size(1024);
<a name="l01870"></a>01870 <span class="preprocessor">#ifdef PPCxxx</span>
<a name="l01871"></a>01871 <span class="preprocessor"></span>   rpc_set_opt_tcp_size(<a class="code" href="group__midasincludecode.html#ga31190e25ed33be085ff0af476af2c029">NET_TCP_SIZE</a>);
<a name="l01872"></a>01872 <span class="preprocessor">#endif</span>
<a name="l01873"></a>01873 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01874"></a>01874 <span class="preprocessor"></span>
<a name="l01875"></a>01875    <span class="comment">/*----------------- MAIN equipment loop ------------------------------*/</span>
<a name="l01876"></a>01876 
<a name="l01877"></a>01877    last_time_rate = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01878"></a>01878 
<a name="l01879"></a>01879    <span class="keywordflow">do</span> {
<a name="l01880"></a>01880       <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01881"></a>01881       <a class="code" href="mfe_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a> = <a class="code" href="group__msfunctionc.html#gab7852119bd4dc1e08aa03127d8ca008b">ss_time</a>();
<a name="l01882"></a>01882 
<a name="l01883"></a>01883       <span class="comment">/*---- loop over equipment table -------------------------------*/</span>
<a name="l01884"></a>01884       <span class="keywordflow">for</span> (idx = 0;; idx++) {
<a name="l01885"></a>01885          eq = &amp;equipment[idx];
<a name="l01886"></a>01886          eq_info = &amp;eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>;
<a name="l01887"></a>01887 
<a name="l01888"></a>01888          <span class="comment">/* check if end of equipment list */</span>
<a name="l01889"></a>01889          <span class="keywordflow">if</span> (!eq-&gt;<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0])
<a name="l01890"></a>01890             <span class="keywordflow">break</span>;
<a name="l01891"></a>01891 
<a name="l01892"></a>01892          <span class="keywordflow">if</span> (!eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a512d7966d5f96f8c75fec4ba1b1946c4">enabled</a>)
<a name="l01893"></a>01893             <span class="keywordflow">continue</span>;
<a name="l01894"></a>01894 
<a name="l01895"></a>01895          <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> != <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l01896"></a>01896             <span class="keywordflow">continue</span>;
<a name="l01897"></a>01897 
<a name="l01898"></a>01898          <span class="comment">/*---- call idle routine for slow control equipment ----*/</span>
<a name="l01899"></a>01899          <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) &amp;&amp; eq-&gt;<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>) {
<a name="l01900"></a>01900             <span class="comment">/* if equipment is multi-threaded, read all channel in one loop */</span>
<a name="l01901"></a>01901              
<a name="l01902"></a>01902             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0) {
<a name="l01903"></a>01903                <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - eq-&gt;<a class="code" href="structeqpmnt.html#a8261688ef7d0d371cdf50023cf0447c1">last_idle</a> &gt;= (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>) {
<a name="l01904"></a>01904                   eq-&gt;<a class="code" href="structeqpmnt.html#ae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga433697a25587c6ffe8a14f02e5be9066">CMD_IDLE</a>, eq);
<a name="l01905"></a>01905                   eq-&gt;<a class="code" href="structeqpmnt.html#a8261688ef7d0d371cdf50023cf0447c1">last_idle</a> = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01906"></a>01906                }
<a name="l01907"></a>01907             } <span class="keywordflow">else</span>
<a name="l01908"></a>01908                eq-&gt;<a class="code" href="structeqpmnt.html#ae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga433697a25587c6ffe8a14f02e5be9066">CMD_IDLE</a>, eq);
<a name="l01909"></a>01909          }
<a name="l01910"></a>01910 
<a name="l01911"></a>01911          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga05a5abc619ab24e168695befc7c0b4be">RO_STOPPED</a>) == 0)
<a name="l01912"></a>01912             <span class="keywordflow">continue</span>;
<a name="l01913"></a>01913          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> == <a class="code" href="group__mdefineh.html#gab08c47284371c683ba80d6b3244400f1">STATE_PAUSED</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga8a47b3b86a72a7db84a582277d4b7a39">RO_PAUSED</a>) == 0)
<a name="l01914"></a>01914             <span class="keywordflow">continue</span>;
<a name="l01915"></a>01915          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#gafc5ef41cae398b8500f9c3a42cef6d2c">RO_RUNNING</a>) == 0)
<a name="l01916"></a>01916             <span class="keywordflow">continue</span>;
<a name="l01917"></a>01917 
<a name="l01918"></a>01918          <span class="comment">/*---- check periodic events ----*/</span>
<a name="l01919"></a>01919          <span class="keywordflow">if</span> ((eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga58e919e4e401b299c1834be965c3e78c">EQ_PERIODIC</a>) || (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>)) {
<a name="l01920"></a>01920             <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a> == 0)
<a name="l01921"></a>01921                <span class="keywordflow">continue</span>;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923             <span class="comment">/* check if period over */</span>
<a name="l01924"></a>01924             <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - eq-&gt;<a class="code" href="structeqpmnt.html#a6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt;= (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a>) {
<a name="l01925"></a>01925                <span class="comment">/* disable interrupts or readout thread during this event */</span>
<a name="l01926"></a>01926                old_flag = <a class="code" href="mfe_8c.html#ab6ce300200eebdc71c6a3d5b3760a1ba">readout_enabled</a>();
<a name="l01927"></a>01927                <span class="keywordflow">if</span> (old_flag &amp;&amp; <a class="code" href="mfe_8c.html#ace3256e0c09b9b2d5c109f8dbab3692f">lockout_readout_thread</a>)
<a name="l01928"></a>01928                   <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(FALSE);
<a name="l01929"></a>01929 
<a name="l01930"></a>01930                <span class="comment">/* readout and send event */</span>
<a name="l01931"></a>01931                status = <a class="code" href="mfe_8c.html#a467e7d6c77bcbb9259a7167ae1cdf29a">send_event</a>(idx, FALSE);
<a name="l01932"></a>01932 
<a name="l01933"></a>01933                <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l01934"></a>01934                   <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;send_event error %d&quot;</span>, status);
<a name="l01935"></a>01935                   <span class="keywordflow">goto</span> net_error;
<a name="l01936"></a>01936                }
<a name="l01937"></a>01937 
<a name="l01938"></a>01938                <span class="comment">/* re-enable the interrupt or readout thread after periodic */</span>
<a name="l01939"></a>01939                <span class="keywordflow">if</span> (old_flag)
<a name="l01940"></a>01940                   <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l01941"></a>01941             }
<a name="l01942"></a>01942          }
<a name="l01943"></a>01943 
<a name="l01944"></a>01944          <span class="comment">/*---- check polled events ----*/</span>
<a name="l01945"></a>01945          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga0c716a0a98b5da8bbe8477839d9b0c78">EQ_POLLED</a>) {
<a name="l01946"></a>01946             readout_start = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l01947"></a>01947             pevent = NULL;
<a name="l01948"></a>01948 
<a name="l01949"></a>01949             <span class="keywordflow">while</span> ((source = <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a345e65d8874f6b968bedc00e76d4f431">source</a>, eq-&gt;<a class="code" href="structeqpmnt.html#ae9bf94db8ff48533601c3833b1b20097">poll_count</a>, FALSE)) &gt; 0) {
<a name="l01950"></a>01950                
<a name="l01951"></a>01951                <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>)
<a name="l01952"></a>01952                   pevent = <a class="code" href="mfe_8c.html#aec32e8020846a8167a641ac52c76c5c4">frag_buffer</a>;
<a name="l01953"></a>01953                <span class="keywordflow">else</span>
<a name="l01954"></a>01954                   pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)<a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l01955"></a>01955 
<a name="l01956"></a>01956                <span class="comment">/* compose MIDAS event header */</span>
<a name="l01957"></a>01957                pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a83d6e0d3f9bb5990400d40e84a2be378">event_id</a>;
<a name="l01958"></a>01958                pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a9b4b94f41521f5c188655b7bb0f1ec1b">trigger_mask</a> = eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5744b359b07fc1963dd1a88210d28e6b">trigger_mask</a>;
<a name="l01959"></a>01959                pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = 0;
<a name="l01960"></a>01960                pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a989421ee804ab76a0e11ac1c9c3b0e7a">time_stamp</a> = <a class="code" href="mfe_8c.html#a6431147bd66aebfe3ca728d244da1253">actual_time</a>;
<a name="l01961"></a>01961                pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> = eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>;
<a name="l01962"></a>01962 
<a name="l01963"></a>01963                <span class="comment">/* put source at beginning of event, will be overwritten by </span>
<a name="l01964"></a>01964 <span class="comment">                  user readout code, just a special feature used by some </span>
<a name="l01965"></a>01965 <span class="comment">                  multi-source applications */</span>
<a name="l01966"></a>01966                *(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> *) (pevent + 1) = source;
<a name="l01967"></a>01967 
<a name="l01968"></a>01968                <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#ade7b61b85a73ed33545caf31b706acd3">num_subevents</a>) {
<a name="l01969"></a>01969                   eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a> = 0;
<a name="l01970"></a>01970                   <span class="keywordflow">do</span> {
<a name="l01971"></a>01971                      *(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> *) ((<span class="keywordtype">char</span> *) (pevent + 1) + pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>) = source;
<a name="l01972"></a>01972 
<a name="l01973"></a>01973                      <span class="comment">/* call user readout routine for subevent indicating offset */</span>
<a name="l01974"></a>01974                      size = eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>);
<a name="l01975"></a>01975                      pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> += size;
<a name="l01976"></a>01976                      <span class="keywordflow">if</span> (size &gt; 0) {
<a name="l01977"></a>01977                         <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt;
<a name="l01978"></a>01978                             (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>) {
<a name="l01979"></a>01979                            <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>,
<a name="l01980"></a>01980                                   <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l01981"></a>01981                                   (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l01982"></a>01982                                   max_event_size);
<a name="l01983"></a>01983                         }
<a name="l01984"></a>01984 
<a name="l01985"></a>01985                         eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a>++;
<a name="l01986"></a>01986                         eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l01987"></a>01987                      }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989                      <span class="comment">/* wait for next event */</span>
<a name="l01990"></a>01990                      <span class="keywordflow">do</span> {
<a name="l01991"></a>01991                         source = <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a345e65d8874f6b968bedc00e76d4f431">source</a>, eq-&gt;<a class="code" href="structeqpmnt.html#ae9bf94db8ff48533601c3833b1b20097">poll_count</a>, FALSE);
<a name="l01992"></a>01992 
<a name="l01993"></a>01993                         <span class="keywordflow">if</span> (source == FALSE) {
<a name="l01994"></a>01994                            <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l01995"></a>01995 
<a name="l01996"></a>01996                            <span class="comment">/* repeat no more than period */</span>
<a name="l01997"></a>01997                            <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - readout_start &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a>)
<a name="l01998"></a>01998                               <span class="keywordflow">break</span>;
<a name="l01999"></a>01999                         }
<a name="l02000"></a>02000                      } <span class="keywordflow">while</span> (source == FALSE);
<a name="l02001"></a>02001 
<a name="l02002"></a>02002                   } <span class="keywordflow">while</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a> &lt; eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#ade7b61b85a73ed33545caf31b706acd3">num_subevents</a> &amp;&amp; source);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004                   <span class="comment">/* notify readout routine about end of super-event */</span>
<a name="l02005"></a>02005                   pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), -1);
<a name="l02006"></a>02006                } <span class="keywordflow">else</span> {
<a name="l02007"></a>02007                   <span class="comment">/* call user readout routine indicating event source */</span>
<a name="l02008"></a>02008                   pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = eq-&gt;<a class="code" href="structeqpmnt.html#ab7d302c46bbcfe6151e17bac90451ee3">readout</a>((<span class="keywordtype">char</span> *) (pevent + 1), 0);
<a name="l02009"></a>02009 
<a name="l02010"></a>02010                   <span class="comment">/* check event size */</span>
<a name="l02011"></a>02011                   <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>) {
<a name="l02012"></a>02012                      <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>) {
<a name="l02013"></a>02013                         <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;send_event&quot;</span>,
<a name="l02014"></a>02014                               <span class="stringliteral">&quot;Event size %ld larger than maximum size %d for frag. ev.&quot;</span>,
<a name="l02015"></a>02015                               (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l02016"></a>02016                               max_event_size_frag);
<a name="l02017"></a>02017                         assert(FALSE);
<a name="l02018"></a>02018                      }
<a name="l02019"></a>02019                   } <span class="keywordflow">else</span> {
<a name="l02020"></a>02020                      <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>) {
<a name="l02021"></a>02021                         <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>,
<a name="l02022"></a>02022                               <span class="stringliteral">&quot;Event size %ld larger than maximum size %d&quot;</span>,
<a name="l02023"></a>02023                               (<span class="keywordtype">long</span>) (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>)),
<a name="l02024"></a>02024                               max_event_size);
<a name="l02025"></a>02025                         assert(FALSE);
<a name="l02026"></a>02026                      }
<a name="l02027"></a>02027                   }
<a name="l02028"></a>02028 
<a name="l02029"></a>02029                   <span class="comment">/* increment serial number if event read out sucessfully */</span>
<a name="l02030"></a>02030                   <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>)
<a name="l02031"></a>02031                      eq-&gt;<a class="code" href="structeqpmnt.html#a1eeffec216604567e3ddbed40cbb0a15">serial_number</a>++;
<a name="l02032"></a>02032                }
<a name="l02033"></a>02033 
<a name="l02034"></a>02034                <span class="comment">/* send event */</span>
<a name="l02035"></a>02035                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>) {
<a name="l02036"></a>02036 
<a name="l02037"></a>02037                   <span class="comment">/* check for fragmented event */</span>
<a name="l02038"></a>02038                   <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; <a class="code" href="group__mdefineh.html#ga702ba5dcc4b9f1ccf9a1a37bad62266e">EQ_FRAGMENTED</a>) {
<a name="l02039"></a>02039                      <span class="comment">/* compose fragments */</span>
<a name="l02040"></a>02040                      pfragment = <a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042                      <span class="comment">/* compose MIDAS event header */</span>
<a name="l02043"></a>02043                      memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l02044"></a>02044                      pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#gaae07538917933e32355933ac1e2e3d60">EVENTID_FRAG1</a>;
<a name="l02045"></a>02045 
<a name="l02046"></a>02046                      <span class="comment">/* store total event size */</span>
<a name="l02047"></a>02047                      pd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) (pfragment + 1);
<a name="l02048"></a>02048                      size = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>;
<a name="l02049"></a>02049                      <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
<a name="l02050"></a>02050                         pd[i] = (<span class="keywordtype">unsigned</span> char) (size &amp; 0xFF);      <span class="comment">/* little endian, please! */</span>
<a name="l02051"></a>02051                         size &gt;&gt;= 8;
<a name="l02052"></a>02052                      }
<a name="l02053"></a>02053 
<a name="l02054"></a>02054                      pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = <span class="keyword">sizeof</span>(<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>);
<a name="l02055"></a>02055 
<a name="l02056"></a>02056                      pdata = (<span class="keywordtype">char</span> *) (pevent + 1);
<a name="l02057"></a>02057 
<a name="l02058"></a>02058                      <span class="keywordflow">for</span> (i = 0, sent = 0; sent &lt; pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a>; i++) {
<a name="l02059"></a>02059                         <span class="keywordflow">if</span> (i &gt; 0) {
<a name="l02060"></a>02060                            pfragment = <a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l02061"></a>02061 
<a name="l02062"></a>02062                            <span class="comment">/* compose MIDAS event header */</span>
<a name="l02063"></a>02063                            memcpy(pfragment, pevent, <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>));
<a name="l02064"></a>02064                            pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a107bbb0fbe21582dc0f0e78f60b997b3">event_id</a> |= <a class="code" href="group__mbufferh.html#ga4fb6de5cc7e1f2da82266094a02d0ff7">EVENTID_FRAG</a>;
<a name="l02065"></a>02065 
<a name="l02066"></a>02066                            <span class="comment">/* copy portion of event */</span>
<a name="l02067"></a>02067                            size = pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> - sent;
<a name="l02068"></a>02068                            <span class="keywordflow">if</span> (size &gt; <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>))
<a name="l02069"></a>02069                               size = <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> - <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l02070"></a>02070 
<a name="l02071"></a>02071                            memcpy(pfragment + 1, pdata, size);
<a name="l02072"></a>02072                            pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> = size;
<a name="l02073"></a>02073                            sent += size;
<a name="l02074"></a>02074                            pdata += size;
<a name="l02075"></a>02075                         }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077                         <span class="comment">/* send event to buffer */</span>
<a name="l02078"></a>02078                         <span class="keywordflow">if</span> (equipment[idx].buffer_handle) {
<a name="l02079"></a>02079                            status = <a class="code" href="group__rpcfunctionc.html#ga3191feb350dfa7289e8c7cf2f5993222">rpc_send_event</a>(equipment[idx].buffer_handle, pfragment,
<a name="l02080"></a>02080                                                    pfragment-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a>);
<a name="l02081"></a>02081                            <span class="keywordflow">if</span> (status != <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>) {
<a name="l02082"></a>02082                               <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;rpc_send_event(SYNC) error %d&quot;</span>, status);
<a name="l02083"></a>02083                               <span class="keywordflow">return</span> status;
<a name="l02084"></a>02084                            }
<a name="l02085"></a>02085 
<a name="l02086"></a>02086                            <span class="comment">/* flush events from buffer */</span>
<a name="l02087"></a>02087                            <a class="code" href="group__rpcfunctionc.html#ga83d80e4f1e8d2a2d7f38e58dcfd3c711">rpc_flush_event</a>();
<a name="l02088"></a>02088                         }
<a name="l02089"></a>02089                      }
<a name="l02090"></a>02090                   
<a name="l02091"></a>02091                   } <span class="keywordflow">else</span> { <span class="comment">/*-------------------*/</span>
<a name="l02092"></a>02092 
<a name="l02093"></a>02093                      <span class="comment">/* send unfragmented event */</span>
<a name="l02094"></a>02094 
<a name="l02095"></a>02095                      <span class="comment">/* send first event to ODB if logger writes in root format */</span>
<a name="l02096"></a>02096                      <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a5ed07c075ebce619a8fa47e96f188440">serial_number</a> == 0)
<a name="l02097"></a>02097                         <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ace89325172f363d2efd92735e52ec69e">logger_root</a>())
<a name="l02098"></a>02098                            <a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, eq-&gt;<a class="code" href="structeqpmnt.html#ab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>, eq-&gt;<a class="code" href="structeqpmnt.html#acad980d7699722234c72bfca6243203b">format</a>);
<a name="l02099"></a>02099 
<a name="l02100"></a>02100                      status = <a class="code" href="group__rpcfunctionc.html#ga3191feb350dfa7289e8c7cf2f5993222">rpc_send_event</a>(eq-&gt;<a class="code" href="structeqpmnt.html#a7a77ffb95300f3c7fcc7fbcc141dd820">buffer_handle</a>, pevent,
<a name="l02101"></a>02101                                              pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>),
<a name="l02102"></a>02102                                              <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, <a class="code" href="mfe_8c.html#a1de1daba819451b18ef6974bb6a33a34">rpc_mode</a>);
<a name="l02103"></a>02103 
<a name="l02104"></a>02104                      <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l02105"></a>02105                         <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;rpc_send_event error %d&quot;</span>, status);
<a name="l02106"></a>02106                         <span class="keywordflow">goto</span> net_error;
<a name="l02107"></a>02107                      }
<a name="l02108"></a>02108                   }
<a name="l02109"></a>02109 
<a name="l02110"></a>02110                   eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> += pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>);
<a name="l02111"></a>02111 
<a name="l02112"></a>02112                   <span class="keywordflow">if</span> (eq-&gt;<a class="code" href="structeqpmnt.html#a51afc5b1fc5a6a107cffb9542444b188">info</a>.<a class="code" href="structEQUIPMENT__INFO.html#ade7b61b85a73ed33545caf31b706acd3">num_subevents</a>)
<a name="l02113"></a>02113                      eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> += eq-&gt;<a class="code" href="structeqpmnt.html#a1649c4fed8b7c97441a167a860cae4af">subevent_number</a>;
<a name="l02114"></a>02114                   <span class="keywordflow">else</span>
<a name="l02115"></a>02115                      eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>++;
<a name="l02116"></a>02116 
<a name="l02117"></a>02117                   <a class="code" href="mfe_8c.html#abb411e407679b5b38f424cc2f9f86b07">rotate_wheel</a>();
<a name="l02118"></a>02118                }
<a name="l02119"></a>02119 
<a name="l02120"></a>02120                <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l02121"></a>02121 
<a name="l02122"></a>02122                <span class="comment">/* send event to ODB */</span>
<a name="l02123"></a>02123                <span class="keywordflow">if</span> (pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a>)) {
<a name="l02124"></a>02124                   <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - eq-&gt;<a class="code" href="structeqpmnt.html#a6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt; <a class="code" href="mfe_8c.html#a380a50d445745c2da54a29a1f2e5099e">ODB_UPDATE_TIME</a>) {
<a name="l02125"></a>02125                      eq-&gt;<a class="code" href="structeqpmnt.html#a6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l02126"></a>02126                      <a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, eq-&gt;<a class="code" href="structeqpmnt.html#ab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>, eq-&gt;<a class="code" href="structeqpmnt.html#acad980d7699722234c72bfca6243203b">format</a>);
<a name="l02127"></a>02127                      eq-&gt;<a class="code" href="structeqpmnt.html#a2ba622da82fc7a02605e5f630464b13f">odb_out</a>++;
<a name="l02128"></a>02128                   }
<a name="l02129"></a>02129                }
<a name="l02130"></a>02130 
<a name="l02131"></a>02131                <span class="comment">/* repeat no more than period */</span>
<a name="l02132"></a>02132                <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - readout_start &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a>)
<a name="l02133"></a>02133                   <span class="keywordflow">break</span>;
<a name="l02134"></a>02134 
<a name="l02135"></a>02135                <span class="comment">/* quit if event limit is reached */</span>
<a name="l02136"></a>02136                <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0 &amp;&amp;
<a name="l02137"></a>02137                    eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> + eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt;= eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>)
<a name="l02138"></a>02138                   <span class="keywordflow">break</span>;
<a name="l02139"></a>02139             }
<a name="l02140"></a>02140 
<a name="l02141"></a>02141          }
<a name="l02142"></a>02142 
<a name="l02143"></a>02143          <span class="comment">/*---- send interrupt events ----*/</span>
<a name="l02144"></a>02144          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> &amp; (<a class="code" href="group__mdefineh.html#gad5ba2ec0f5d55139048dbe2d416da6ba">EQ_INTERRUPT</a> | <a class="code" href="group__mdefineh.html#ga7cc85959e8d0c4e476cf659c2cee7a33">EQ_MULTITHREAD</a>)) {
<a name="l02145"></a>02145             readout_start = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l02146"></a>02146 
<a name="l02147"></a>02147             <span class="keywordflow">do</span> {
<a name="l02148"></a>02148                size = <a class="code" href="mfe_8c.html#a9cd62f651300e81799cae815b51ca654">receive_trigger_event</a>(eq);
<a name="l02149"></a>02149                <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)size == -1)
<a name="l02150"></a>02150                   <span class="keywordflow">goto</span> net_error;
<a name="l02151"></a>02151 
<a name="l02152"></a>02152                <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> = <a class="code" href="group__msfunctionc.html#ga999b383482224a5a6c4f5974d2625717">ss_millitime</a>();
<a name="l02153"></a>02153 
<a name="l02154"></a>02154                <span class="comment">/* repeat no more than period */</span>
<a name="l02155"></a>02155                <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - readout_start &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#af7f674490636b6f9736fb680201001c2">period</a>)
<a name="l02156"></a>02156                   <span class="keywordflow">break</span>;
<a name="l02157"></a>02157 
<a name="l02158"></a>02158                <span class="comment">/* quit if event limit is reached */</span>
<a name="l02159"></a>02159                <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0 &amp;&amp;
<a name="l02160"></a>02160                    eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> + eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt;= eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a>)
<a name="l02161"></a>02161                   <span class="keywordflow">break</span>;
<a name="l02162"></a>02162 
<a name="l02163"></a>02163             } <span class="keywordflow">while</span> (size &gt; 0);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165             <span class="comment">/* send event to ODB */</span>
<a name="l02166"></a>02166             pevent = (<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> *)<a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a>;
<a name="l02167"></a>02167             <span class="keywordflow">if</span> (size &gt; 0 &amp;&amp; pevent-&gt;<a class="code" href="structEVENT__HEADER.html#a194220c29419e01ef4cab6d3dd8daedb">data_size</a> &amp;&amp; (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5079d6cb8b770782e0bce5046f476996">read_on</a> &amp; <a class="code" href="group__mdefineh.html#ga2de85e3b635c54456698533ebfc5635d">RO_ODB</a> || eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a2740dd481bbbb7c8e417b5818ff8e064">history</a>)) {
<a name="l02168"></a>02168                <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - eq-&gt;<a class="code" href="structeqpmnt.html#a6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> &gt; <a class="code" href="mfe_8c.html#a380a50d445745c2da54a29a1f2e5099e">ODB_UPDATE_TIME</a> &amp;&amp; pevent != NULL) {
<a name="l02169"></a>02169                   eq-&gt;<a class="code" href="structeqpmnt.html#a6bbbd3b1eb8ab1bbc62aa6e07571866a">last_called</a> = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l02170"></a>02170                   <a class="code" href="mfe_8c.html#acca4a95b509b37c83c2e76cb88de232a">update_odb</a>(pevent, eq-&gt;<a class="code" href="structeqpmnt.html#ab6664c255e4c3fdc58806733ac04503b">hkey_variables</a>, eq-&gt;<a class="code" href="structeqpmnt.html#acad980d7699722234c72bfca6243203b">format</a>);
<a name="l02171"></a>02171                   eq-&gt;<a class="code" href="structeqpmnt.html#a2ba622da82fc7a02605e5f630464b13f">odb_out</a>++;
<a name="l02172"></a>02172                }
<a name="l02173"></a>02173             }
<a name="l02174"></a>02174          }
<a name="l02175"></a>02175 
<a name="l02176"></a>02176          <span class="comment">/*---- check if event limit is reached ----*/</span>
<a name="l02177"></a>02177          <span class="keywordflow">if</span> (eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a5d2b5c1a08c8312e86963499122d3c06">eq_type</a> != <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a> &amp;&amp;
<a name="l02178"></a>02178              eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &gt; 0 &amp;&amp;
<a name="l02179"></a>02179              eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> + eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> &gt;= eq_info-&gt;<a class="code" href="structEQUIPMENT__INFO.html#a4f67b0a6bdc9fd382ea981f6a9dfdfcf">event_limit</a> &amp;&amp;
<a name="l02180"></a>02180              <a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>) {
<a name="l02181"></a>02181             <span class="comment">/* stop run */</span>
<a name="l02182"></a>02182             <span class="keywordflow">if</span> (<a class="code" href="group__cmfunctionc.html#ga376defd443d6bdfcca3830b99986a48d">cm_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, 0, str, <span class="keyword">sizeof</span>(str), <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, FALSE) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02183"></a>02183                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;cannot stop run: %s&quot;</span>, str);
<a name="l02184"></a>02184 
<a name="l02185"></a>02185             <span class="comment">/* check if autorestart, main loop will take care of it */</span>
<a name="l02186"></a>02186             size = <span class="keyword">sizeof</span>(<a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>);
<a name="l02187"></a>02187             flag = FALSE;
<a name="l02188"></a>02188             <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Logger/Auto restart&quot;</span>, &amp;flag, (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> *)&amp;size, <a class="code" href="group__mdefineh.html#ga252eb84661dfaa5959b5cb316117d696">TID_BOOL</a>, TRUE);
<a name="l02189"></a>02189 
<a name="l02190"></a>02190             <span class="keywordflow">if</span> (flag)
<a name="l02191"></a>02191                <a class="code" href="mfe_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = <a class="code" href="group__msfunctionc.html#gab7852119bd4dc1e08aa03127d8ca008b">ss_time</a>() + 20;   <span class="comment">/* restart in 20 sec. */</span>
<a name="l02192"></a>02192 
<a name="l02193"></a>02193             <span class="comment">/* update event display correctly */</span>
<a name="l02194"></a>02194             force_update = TRUE;
<a name="l02195"></a>02195          }
<a name="l02196"></a>02196       }
<a name="l02197"></a>02197 
<a name="l02198"></a>02198       <span class="comment">/*---- check for error messages periodically -------------------*/</span>
<a name="l02199"></a>02199       <a class="code" href="mfe_8c.html#acbf3a0cf2e2a061816bd2d95dd097a20">mfe_error_check</a>();
<a name="l02200"></a>02200 
<a name="l02201"></a>02201       <span class="comment">/*---- call frontend_loop periodically -------------------------*/</span>
<a name="l02202"></a>02202       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a0215c0a842a0e97fe65c7ef5fb7633a5">frontend_call_loop</a>) {
<a name="l02203"></a>02203          status = <a class="code" href="mfe_8c.html#ad902740ed5577f2f940454359ec1df1c">frontend_loop</a>();
<a name="l02204"></a>02204          <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> || status == <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>) {
<a name="l02205"></a>02205             status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l02206"></a>02206             <span class="keywordflow">break</span>;
<a name="l02207"></a>02207          }
<a name="l02208"></a>02208       }
<a name="l02209"></a>02209 
<a name="l02210"></a>02210       <span class="comment">/*---- check for deferred transitions --------------------------*/</span>
<a name="l02211"></a>02211       <a class="code" href="group__cmfunctionc.html#gabc9cc8ea21e435ffff94d359686897e3">cm_check_deferred_transition</a>();
<a name="l02212"></a>02212 
<a name="l02213"></a>02213       <span class="comment">/*---- check for manual triggered events -----------------------*/</span>
<a name="l02214"></a>02214       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a8af66bd2f0727f85b7ba0b1670d90427">manual_trigger_event_id</a>) {
<a name="l02215"></a>02215          old_flag = <a class="code" href="mfe_8c.html#ab6ce300200eebdc71c6a3d5b3760a1ba">readout_enabled</a>();
<a name="l02216"></a>02216          <span class="keywordflow">if</span> (old_flag &amp;&amp; <a class="code" href="mfe_8c.html#ace3256e0c09b9b2d5c109f8dbab3692f">lockout_readout_thread</a>)
<a name="l02217"></a>02217             <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(FALSE);
<a name="l02218"></a>02218 
<a name="l02219"></a>02219          <span class="comment">/* readout and send event */</span>
<a name="l02220"></a>02220          status = <a class="code" href="group__err22.html#ga09095b8ac6e057d3094c99e485c1a74d">BM_INVALID_PARAM</a>;
<a name="l02221"></a>02221          <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l02222"></a>02222             <span class="keywordflow">if</span> (equipment[i].info.event_id == <a class="code" href="mfe_8c.html#a8af66bd2f0727f85b7ba0b1670d90427">manual_trigger_event_id</a>) {
<a name="l02223"></a>02223                status = <a class="code" href="mfe_8c.html#a467e7d6c77bcbb9259a7167ae1cdf29a">send_event</a>(i, TRUE);
<a name="l02224"></a>02224                <span class="keywordflow">break</span>;
<a name="l02225"></a>02225             }
<a name="l02226"></a>02226 
<a name="l02227"></a>02227          <a class="code" href="mfe_8c.html#a8af66bd2f0727f85b7ba0b1670d90427">manual_trigger_event_id</a> = 0;
<a name="l02228"></a>02228 
<a name="l02229"></a>02229          <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l02230"></a>02230             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;send_event error %d&quot;</span>, status);
<a name="l02231"></a>02231             <span class="keywordflow">goto</span> net_error;
<a name="l02232"></a>02232          }
<a name="l02233"></a>02233 
<a name="l02234"></a>02234          <span class="comment">/* re-enable the interrupt after periodic */</span>
<a name="l02235"></a>02235          <span class="keywordflow">if</span> (old_flag)
<a name="l02236"></a>02236             <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l02237"></a>02237       }
<a name="l02238"></a>02238 
<a name="l02239"></a>02239       <span class="comment">/*---- calculate rates and update status page periodically -----*/</span>
<a name="l02240"></a>02240       <span class="keywordflow">if</span> (force_update ||
<a name="l02241"></a>02241           (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>
<a name="l02242"></a>02242            &amp;&amp; <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_display &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>) <a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02243"></a>02243           || (!display_period &amp;&amp; <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_display &gt; 3000)) {
<a name="l02244"></a>02244          force_update = FALSE;
<a name="l02245"></a>02245 
<a name="l02246"></a>02246          <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l02247"></a>02247             eq = &amp;equipment[i];
<a name="l02248"></a>02248             eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a6e140b7938891bd8452fdf0217815ddd">events_sent</a> += eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>;
<a name="l02249"></a>02249             <a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a>[i] += eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a>;
<a name="l02250"></a>02250             eq-&gt;<a class="code" href="structeqpmnt.html#a448c8840590d36b3a828ff1ec0c8a65c">events_sent</a> = 0;
<a name="l02251"></a>02251          }
<a name="l02252"></a>02252 
<a name="l02253"></a>02253          <span class="comment">/* calculate rates after requested period */</span>
<a name="l02254"></a>02254          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_rate &gt; (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>)<a class="code" href="mfe_8c.html#a440b07315fbe46315b56aa8c954952e6">get_rate_period</a>()) {
<a name="l02255"></a>02255             <a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> = 0;
<a name="l02256"></a>02256             <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l02257"></a>02257                eq = &amp;equipment[i];
<a name="l02258"></a>02258                eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a218c744ea441413af262fbd5ddf3780f">events_per_sec</a> =
<a name="l02259"></a>02259                    <a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a>[i] / ((<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_rate) / 1000.0);
<a name="l02260"></a>02260                eq-&gt;<a class="code" href="structeqpmnt.html#a474c4fbb3bad41ba157076e3a86e93ea">stats</a>.<a class="code" href="structEQUIPMENT__STATS.html#a7a7a7d4b78841a36d156a0941616538f">kbytes_per_sec</a> =
<a name="l02261"></a>02261                    eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> / 1024.0 / ((<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_rate) /
<a name="l02262"></a>02262                                               1000.0);
<a name="l02263"></a>02263 
<a name="l02264"></a>02264                <span class="keywordflow">if</span> ((<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> &gt; <a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a>)
<a name="l02265"></a>02265                   <a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> = eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a>;
<a name="l02266"></a>02266 
<a name="l02267"></a>02267                eq-&gt;<a class="code" href="structeqpmnt.html#a2d00b43d76412e41d7f10c1cb786eade">bytes_sent</a> = 0;
<a name="l02268"></a>02268                <a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a>[i] = 0;
<a name="l02269"></a>02269             }
<a name="l02270"></a>02270 
<a name="l02271"></a>02271             <a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> = (<a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>)
<a name="l02272"></a>02272                 ((<span class="keywordtype">double</span>) <a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> /
<a name="l02273"></a>02273                  ((<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_rate) / 1000.0));
<a name="l02274"></a>02274 
<a name="l02275"></a>02275             last_time_rate = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l02276"></a>02276          }
<a name="l02277"></a>02277 
<a name="l02278"></a>02278          <span class="comment">/* tcp buffer size evaluation */</span>
<a name="l02279"></a>02279          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a17033889b9f2e378c3bc26401a399550">optimize</a>) {
<a name="l02280"></a>02280             opt_max = <a class="code" href="group__mmacroh.html#gafa99ec4acc4ecb2dc3c2d05da15d0e3f">MAX</a>(opt_max, (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>) <a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a>);
<a name="l02281"></a>02281             ss_printf(0, opt_index, <span class="stringliteral">&quot;%6d : %5.1lf %5.1lf&quot;</span>, opt_tcp_size,
<a name="l02282"></a>02282                       opt_max / 1024.0, max_bytes_per_sec / 1024.0);
<a name="l02283"></a>02283             <span class="keywordflow">if</span> (++opt_cnt == 10) {
<a name="l02284"></a>02284                opt_cnt = 0;
<a name="l02285"></a>02285                opt_max = 0;
<a name="l02286"></a>02286                opt_index++;
<a name="l02287"></a>02287                opt_tcp_size = 1 &lt;&lt; (opt_index + 7);
<a name="l02288"></a>02288                rpc_set_opt_tcp_size(opt_tcp_size);
<a name="l02289"></a>02289                <span class="keywordflow">if</span> (1 &lt;&lt; (opt_index + 7) &gt; 0x8000) {
<a name="l02290"></a>02290                   opt_index = 0;
<a name="l02291"></a>02291                   opt_tcp_size = 1 &lt;&lt; 7;
<a name="l02292"></a>02292                   rpc_set_opt_tcp_size(opt_tcp_size);
<a name="l02293"></a>02293                }
<a name="l02294"></a>02294             }
<a name="l02295"></a>02295          }
<a name="l02296"></a>02296 
<a name="l02297"></a>02297          <span class="comment">/* propagate changes in equipment to ODB */</span>
<a name="l02298"></a>02298          <a class="code" href="group__rpcfunctionc.html#gaab360e4fd185439b0913c723581115ea">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#gaf80a4b4b5569b25d6e8488a6bafeb347">RPC_FTCP</a>);
<a name="l02299"></a>02299          <a class="code" href="group__odbfunctionc.html#gae5ccb46009b64dbeff8dbc05be27664b">db_send_changed_records</a>();
<a name="l02300"></a>02300          <a class="code" href="group__rpcfunctionc.html#gaab360e4fd185439b0913c723581115ea">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#ga9d0de5957c2c776323a0c74e668f544d">RPC_TCP</a>);
<a name="l02301"></a>02301 
<a name="l02302"></a>02302          <span class="keywordflow">if</span> (display_period) {
<a name="l02303"></a>02303             <a class="code" href="mfe_8c.html#a4d77ab19483f67e8240c29a9ff9ca777">display</a>(FALSE);
<a name="l02304"></a>02304 
<a name="l02305"></a>02305             <span class="comment">/* check keyboard */</span>
<a name="l02306"></a>02306             ch = 0;
<a name="l02307"></a>02307             status = 0;
<a name="l02308"></a>02308             <span class="keywordflow">while</span> (ss_kbhit()) {
<a name="l02309"></a>02309                ch = ss_getchar(0);
<a name="l02310"></a>02310                <span class="keywordflow">if</span> (ch == -1)
<a name="l02311"></a>02311                   ch = getchar();
<a name="l02312"></a>02312 
<a name="l02313"></a>02313                <span class="keywordflow">if</span> (ch == <span class="charliteral">&apos;!&apos;</span>)
<a name="l02314"></a>02314                   status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l02315"></a>02315             }
<a name="l02316"></a>02316 
<a name="l02317"></a>02317             <span class="keywordflow">if</span> (ch &gt; 0)
<a name="l02318"></a>02318                <a class="code" href="mfe_8c.html#a4d77ab19483f67e8240c29a9ff9ca777">display</a>(TRUE);
<a name="l02319"></a>02319             <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l02320"></a>02320                <span class="keywordflow">break</span>;
<a name="l02321"></a>02321          }
<a name="l02322"></a>02322 
<a name="l02323"></a>02323          last_time_display = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l02324"></a>02324       }
<a name="l02325"></a>02325 
<a name="l02326"></a>02326       <span class="comment">/*---- check to flush cache ------------------------------------*/</span>
<a name="l02327"></a>02327       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_flush &gt; 1000) {
<a name="l02328"></a>02328          last_time_flush = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l02329"></a>02329 
<a name="l02330"></a>02330          <span class="comment">/* if cache on server is not filled in one second at current</span>
<a name="l02331"></a>02331 <span class="comment">            data rate, flush it now to make events available to consumers */</span>
<a name="l02332"></a>02332 
<a name="l02333"></a>02333          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a2b17ba35afd9a2623d17e3d3847cd293">max_bytes_per_sec</a> &lt; <a class="code" href="mfe_8c.html#a022c39e327f494dda3664f8888f860f1">SERVER_CACHE_SIZE</a>) {
<a name="l02334"></a>02334             old_flag = <a class="code" href="mfe_8c.html#ab6ce300200eebdc71c6a3d5b3760a1ba">readout_enabled</a>();
<a name="l02335"></a>02335             <span class="keywordflow">if</span> (old_flag &amp;&amp; <a class="code" href="mfe_8c.html#ace3256e0c09b9b2d5c109f8dbab3692f">lockout_readout_thread</a>)
<a name="l02336"></a>02336                <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(FALSE);
<a name="l02337"></a>02337 
<a name="l02338"></a>02338             <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++) {
<a name="l02339"></a>02339                <span class="keywordflow">if</span> (equipment[i].buffer_handle) {
<a name="l02340"></a>02340                   <span class="comment">/* check if buffer already flushed */</span>
<a name="l02341"></a>02341                   buffer_done = FALSE;
<a name="l02342"></a>02342                   <span class="keywordflow">for</span> (j = 0; j &lt; i; j++)
<a name="l02343"></a>02343                      <span class="keywordflow">if</span> (equipment[i].buffer_handle == equipment[j].buffer_handle) {
<a name="l02344"></a>02344                         buffer_done = TRUE;
<a name="l02345"></a>02345                         <span class="keywordflow">break</span>;
<a name="l02346"></a>02346                      }
<a name="l02347"></a>02347 
<a name="l02348"></a>02348                   <span class="keywordflow">if</span> (!buffer_done) {
<a name="l02349"></a>02349                      <a class="code" href="group__rpcfunctionc.html#gaab360e4fd185439b0913c723581115ea">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#gaf80a4b4b5569b25d6e8488a6bafeb347">RPC_FTCP</a>);
<a name="l02350"></a>02350                      <a class="code" href="group__rpcfunctionc.html#ga83d80e4f1e8d2a2d7f38e58dcfd3c711">rpc_flush_event</a>();
<a name="l02351"></a>02351                      err = <a class="code" href="group__bmfunctionc.html#ga9b74b8aa633c942682e642acba93c51d">bm_flush_cache</a>(equipment[i].buffer_handle, <a class="code" href="group__mdefineh.html#gad28b60868b6548c43e7a18f30c9b2022">ASYNC</a>);
<a name="l02352"></a>02352                      <span class="keywordflow">if</span> ((err != <a class="code" href="group__err22.html#gadccfb762fd84f9e33940f3d1204042b0">BM_SUCCESS</a>) &amp;&amp; (err != <a class="code" href="group__err22.html#ga7fb11aaff606b1785cddd205baddbbff">BM_ASYNC_RETURN</a>)) {
<a name="l02353"></a>02353                         <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;bm_flush_cache(ASYNC) error %d&quot;</span>,
<a name="l02354"></a>02354                                err);
<a name="l02355"></a>02355                         <span class="keywordflow">return</span> err;
<a name="l02356"></a>02356                      }
<a name="l02357"></a>02357                      <a class="code" href="group__rpcfunctionc.html#gaab360e4fd185439b0913c723581115ea">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga42ebe781b990fe561db5759b1ce9b633">RPC_OTRANSPORT</a>, <a class="code" href="group__mdefineh.html#ga9d0de5957c2c776323a0c74e668f544d">RPC_TCP</a>);
<a name="l02358"></a>02358                   }
<a name="l02359"></a>02359                }
<a name="l02360"></a>02360             }
<a name="l02361"></a>02361 
<a name="l02362"></a>02362             <span class="keywordflow">if</span> (old_flag)
<a name="l02363"></a>02363                <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l02364"></a>02364          }
<a name="l02365"></a>02365       }
<a name="l02366"></a>02366 
<a name="l02367"></a>02367       <span class="comment">/*---- check for auto restart --------------------------------*/</span>
<a name="l02368"></a>02368       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> &gt; 0 &amp;&amp; <a class="code" href="group__msfunctionc.html#gab7852119bd4dc1e08aa03127d8ca008b">ss_time</a>() &gt; <a class="code" href="mfe_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a>) {
<a name="l02369"></a>02369          <span class="comment">/* check if really stopped */</span>
<a name="l02370"></a>02370          size = <span class="keyword">sizeof</span>(state);
<a name="l02371"></a>02371          status = <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;Runinfo/State&quot;</span>, &amp;state, (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> *)&amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>, TRUE);
<a name="l02372"></a>02372          <span class="keywordflow">if</span> (status != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
<a name="l02373"></a>02373             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;scheduler&quot;</span>, <span class="stringliteral">&quot;cannot get Runinfo/State in database&quot;</span>);
<a name="l02374"></a>02374 
<a name="l02375"></a>02375          <span class="keywordflow">if</span> (state == <a class="code" href="group__mdefineh.html#ga6a8dac64367bd381245f2eb09a7fe919">STATE_STOPPED</a>) {
<a name="l02376"></a>02376             <a class="code" href="mfe_8c.html#a7f7c6b4a8ba5367aa160c2ba35c63f3c">auto_restart</a> = 0;
<a name="l02377"></a>02377             size = <span class="keyword">sizeof</span>(<a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l02378"></a>02378             status =
<a name="l02379"></a>02379                   <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Runinfo/Run number&quot;</span>, &amp;<a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>, (<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>*)&amp;size, <a class="code" href="group__mdefineh.html#gad950d5fde6dd3ea7eba59fb6760a38cb">TID_INT</a>,
<a name="l02380"></a>02380                              TRUE);
<a name="l02381"></a>02381             assert(status == <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>);
<a name="l02382"></a>02382 
<a name="l02383"></a>02383             <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> &lt;= 0) {
<a name="l02384"></a>02384                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;main&quot;</span>, <span class="stringliteral">&quot;aborting on attempt to use invalid run number %d&quot;</span>,
<a name="l02385"></a>02385                       <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a>);
<a name="l02386"></a>02386                abort();
<a name="l02387"></a>02387             }
<a name="l02388"></a>02388 
<a name="l02389"></a>02389             <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gad6a8d32f94873258d0eebcbe5b24a78e">MTALK</a>, <span class="stringliteral">&quot;main&quot;</span>, <span class="stringliteral">&quot;starting new run&quot;</span>);
<a name="l02390"></a>02390             status = <a class="code" href="group__cmfunctionc.html#ga376defd443d6bdfcca3830b99986a48d">cm_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, <a class="code" href="mfe_8c.html#a16695ea2bfd19f294afe066d6007ab36">run_number</a> + 1, NULL, 0, <a class="code" href="group__mdefineh.html#ga9ac82e856c7683e23553431e5224d5f4">SYNC</a>, FALSE);
<a name="l02391"></a>02391             <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>)
<a name="l02392"></a>02392                <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;main&quot;</span>, <span class="stringliteral">&quot;cannot restart run&quot;</span>);
<a name="l02393"></a>02393          }
<a name="l02394"></a>02394       }
<a name="l02395"></a>02395 
<a name="l02396"></a>02396       <span class="comment">/*---- check network messages ----------------------------------*/</span>
<a name="l02397"></a>02397       <span class="keywordflow">if</span> ((<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a> &amp;&amp; interrupt_eq == NULL) || <a class="code" href="mfe_8c.html#a4ab4f1288fd294c7c649291f87355985">slowcont_eq</a>) {
<a name="l02398"></a>02398          <span class="comment">/* only call yield once every 100ms when running */</span>
<a name="l02399"></a>02399          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a> - last_time_network &gt; 100) {
<a name="l02400"></a>02400             status = <a class="code" href="group__cmfunctionc.html#ga115565c5a1d9591fcabf844c1dd624f8">cm_yield</a>(0);
<a name="l02401"></a>02401             last_time_network = <a class="code" href="mfe_8c.html#a74876f64e556e153bb8cce6dfddce810">actual_millitime</a>;
<a name="l02402"></a>02402          } <span class="keywordflow">else</span>
<a name="l02403"></a>02403             status = <a class="code" href="group__err25.html#ga19b06966ce058cda8e5dca8d682b2bd3">RPC_SUCCESS</a>;
<a name="l02404"></a>02404       } <span class="keywordflow">else</span>
<a name="l02405"></a>02405          <span class="comment">/* when run is stopped or interrupts used, </span>
<a name="l02406"></a>02406 <span class="comment">            call yield with 100ms timeout */</span>
<a name="l02407"></a>02407          status = <a class="code" href="group__cmfunctionc.html#ga115565c5a1d9591fcabf844c1dd624f8">cm_yield</a>(100);
<a name="l02408"></a>02408 
<a name="l02409"></a>02409       <span class="comment">/* exit for VxWorks */</span>
<a name="l02410"></a>02410       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a8432f49f703ed2d20248effc3125b0e1">fe_stop</a>)
<a name="l02411"></a>02411          status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l02412"></a>02412 
<a name="l02413"></a>02413       <span class="comment">/* exit if CTRL-C pressed */</span>
<a name="l02414"></a>02414       <span class="keywordflow">if</span> (cm_is_ctrlc_pressed())
<a name="l02415"></a>02415          status = <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>;
<a name="l02416"></a>02416 
<a name="l02417"></a>02417    } <span class="keywordflow">while</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga136923b4499af07f13a3cd631b88ec0e">SS_ABORT</a>);
<a name="l02418"></a>02418 
<a name="l02419"></a>02419  net_error:
<a name="l02420"></a>02420 
<a name="l02421"></a>02421    <span class="keywordflow">return</span> status;
<a name="l02422"></a>02422 }
<a name="l02423"></a>02423 
<a name="l02424"></a>02424 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l02425"></a>02425 
<a name="l02426"></a><a class="code" href="mfe_8c.html#a02d6ae60ddcaddd96c2b7b298eff077e">02426</a> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a02d6ae60ddcaddd96c2b7b298eff077e">get_frontend_index</a>()
<a name="l02427"></a>02427 {
<a name="l02428"></a>02428    <span class="keywordflow">return</span> <a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a>;
<a name="l02429"></a>02429 }
<a name="l02430"></a>02430 
<a name="l02431"></a>02431 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l02432"></a>02432 
<a name="l02433"></a>02433 void (*<a class="code" href="mfe_8c.html#af913cd8ed4c73ffcd762ead3c3c4426b">mfe_error_dispatcher</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *) = NULL;
<a name="l02434"></a>02434 
<a name="l02435"></a><a class="code" href="mfe_8c.html#af37786539963050729ad8fe0696cb29f">02435</a> <span class="preprocessor">#define MFE_ERROR_SIZE 10</span>
<a name="l02436"></a><a class="code" href="mfe_8c.html#ac94b7f26a74ade71dcc2754df3092a6f">02436</a> <span class="preprocessor"></span><span class="keywordtype">char</span> <a class="code" href="mfe_8c.html#ac94b7f26a74ade71dcc2754df3092a6f">mfe_error_str</a>[<a class="code" href="mfe_8c.html#af37786539963050729ad8fe0696cb29f">MFE_ERROR_SIZE</a>][256];
<a name="l02437"></a><a class="code" href="mfe_8c.html#a11d9abe61d69ba03a99f62abadb0c6ad">02437</a> <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a6aa654734441af88ec5dea1877701e49">mfe_error_r</a>, <a class="code" href="mfe_8c.html#a11d9abe61d69ba03a99f62abadb0c6ad">mfe_error_w</a>;
<a name="l02438"></a><a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">02438</a> MUTEX_T *<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a> = NULL;
<a name="l02439"></a>02439 
<a name="l02440"></a><a class="code" href="mfe_8c.html#ac26d0645ab25d03dd40fa9ea8baa7c0d">02440</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#ac26d0645ab25d03dd40fa9ea8baa7c0d">mfe_set_error</a>(<span class="keywordtype">void</span> (*dispatcher) (<span class="keyword">const</span> <span class="keywordtype">char</span> *))
<a name="l02441"></a>02441 {
<a name="l02442"></a>02442    <span class="keywordtype">int</span> status;
<a name="l02443"></a>02443 
<a name="l02444"></a>02444    <a class="code" href="mfe_8c.html#af913cd8ed4c73ffcd762ead3c3c4426b">mfe_error_dispatcher</a> = dispatcher;
<a name="l02445"></a>02445    <a class="code" href="mfe_8c.html#a6aa654734441af88ec5dea1877701e49">mfe_error_r</a> = <a class="code" href="mfe_8c.html#a11d9abe61d69ba03a99f62abadb0c6ad">mfe_error_w</a> = 0;
<a name="l02446"></a>02446    memset(<a class="code" href="mfe_8c.html#ac94b7f26a74ade71dcc2754df3092a6f">mfe_error_str</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="mfe_8c.html#ac94b7f26a74ade71dcc2754df3092a6f">mfe_error_str</a>));
<a name="l02447"></a>02447 
<a name="l02448"></a>02448    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a> == NULL) {
<a name="l02449"></a>02449       status = ss_mutex_create(&amp;<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a>);
<a name="l02450"></a>02450       <span class="keywordflow">if</span> (status != <a class="code" href="group__err24.html#ga0abac6c68d7a79ce83d1a25b2c800321">SS_SUCCESS</a> &amp;&amp; status != <a class="code" href="group__err24.html#ga7440cf35b00082fb16e8584ada5b50e0">SS_CREATED</a>)
<a name="l02451"></a>02451          <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;mfe_set_error&quot;</span>, <span class="stringliteral">&quot;Cannot create mutex\n&quot;</span>);
<a name="l02452"></a>02452    }
<a name="l02453"></a>02453 
<a name="l02454"></a>02454 }
<a name="l02455"></a>02455 
<a name="l02456"></a><a class="code" href="mfe_8c.html#a96aae5fbd4be3618b2fe6f1030d73ab5">02456</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#a96aae5fbd4be3618b2fe6f1030d73ab5">mfe_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *error)
<a name="l02457"></a>02457 <span class="comment">/* central error dispatcher routine which can be called by any device</span>
<a name="l02458"></a>02458 <span class="comment">   or class driver */</span>
<a name="l02459"></a>02459 {
<a name="l02460"></a>02460    <span class="comment">/* put error into FIFO */</span>
<a name="l02461"></a>02461    ss_mutex_wait_for(<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a>, 1000);
<a name="l02462"></a>02462    strlcpy(<a class="code" href="mfe_8c.html#ac94b7f26a74ade71dcc2754df3092a6f">mfe_error_str</a>[<a class="code" href="mfe_8c.html#a11d9abe61d69ba03a99f62abadb0c6ad">mfe_error_w</a>], error, 256);
<a name="l02463"></a>02463    mfe_error_w = (mfe_error_w + 1) % <a class="code" href="mfe_8c.html#af37786539963050729ad8fe0696cb29f">MFE_ERROR_SIZE</a>;
<a name="l02464"></a>02464    ss_mutex_release(<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a>);
<a name="l02465"></a>02465 }
<a name="l02466"></a>02466 
<a name="l02467"></a><a class="code" href="mfe_8c.html#acbf3a0cf2e2a061816bd2d95dd097a20">02467</a> <span class="keywordtype">void</span> <a class="code" href="mfe_8c.html#acbf3a0cf2e2a061816bd2d95dd097a20">mfe_error_check</a>(<span class="keywordtype">void</span>)
<a name="l02468"></a>02468 {
<a name="l02469"></a>02469    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a> != NULL) {
<a name="l02470"></a>02470       ss_mutex_wait_for(<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a>, 1000);
<a name="l02471"></a>02471       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a11d9abe61d69ba03a99f62abadb0c6ad">mfe_error_w</a> != <a class="code" href="mfe_8c.html#a6aa654734441af88ec5dea1877701e49">mfe_error_r</a>) {
<a name="l02472"></a>02472          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#af913cd8ed4c73ffcd762ead3c3c4426b">mfe_error_dispatcher</a> != NULL)
<a name="l02473"></a>02473             <a class="code" href="mfe_8c.html#af913cd8ed4c73ffcd762ead3c3c4426b">mfe_error_dispatcher</a>(<a class="code" href="mfe_8c.html#ac94b7f26a74ade71dcc2754df3092a6f">mfe_error_str</a>[<a class="code" href="mfe_8c.html#a6aa654734441af88ec5dea1877701e49">mfe_error_r</a>]);
<a name="l02474"></a>02474          mfe_error_r = (mfe_error_r + 1) % <a class="code" href="mfe_8c.html#af37786539963050729ad8fe0696cb29f">MFE_ERROR_SIZE</a>;
<a name="l02475"></a>02475       }
<a name="l02476"></a>02476       ss_mutex_release(<a class="code" href="mfe_8c.html#a66752afa6ab28c1816463b7339592e3e">mfe_mutex</a>);
<a name="l02477"></a>02477    }
<a name="l02478"></a>02478 }
<a name="l02479"></a>02479 
<a name="l02480"></a>02480 <span class="comment">/*------------------------------------------------------------------*/</span>
<a name="l02481"></a>02481 
<a name="l02482"></a>02482 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02483"></a>02483 <span class="preprocessor"></span><span class="keywordtype">int</span> mfe(<span class="keywordtype">char</span> *ahost_name, <span class="keywordtype">char</span> *aexp_name, <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> adebug)
<a name="l02484"></a>02484 <span class="preprocessor">#else</span>
<a name="l02485"></a><a class="code" href="mfe_8c.html#a0ddf1224851353fc92bfbff6f499fa97">02485</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l02486"></a>02486 <span class="preprocessor">#endif</span>
<a name="l02487"></a>02487 <span class="preprocessor"></span>{
<a name="l02488"></a>02488    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> status, i, j, size;
<a name="l02489"></a>02489    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> daemon_flag;
<a name="l02490"></a>02490    <span class="keywordtype">int</span> sys_max_event_size = <a class="code" href="group__midasincludecode.html#ga05d5acc365e3342523d84bc4540adc09">MAX_EVENT_SIZE</a>;
<a name="l02491"></a>02491 
<a name="l02492"></a>02492    <a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0] = 0;
<a name="l02493"></a>02493    <a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[0] = 0;
<a name="l02494"></a>02494    <a class="code" href="mfe_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a> = FALSE;
<a name="l02495"></a>02495    daemon_flag = 0;
<a name="l02496"></a>02496 
<a name="l02497"></a>02497    setbuf(stdout, 0);
<a name="l02498"></a>02498    setbuf(stderr, 0);
<a name="l02499"></a>02499 
<a name="l02500"></a>02500 <span class="preprocessor">#ifdef SIGPIPE</span>
<a name="l02501"></a>02501 <span class="preprocessor"></span>   signal(SIGPIPE, SIG_IGN);
<a name="l02502"></a>02502 <span class="preprocessor">#endif</span>
<a name="l02503"></a>02503 <span class="preprocessor"></span>
<a name="l02504"></a>02504 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02505"></a>02505 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (ahost_name)
<a name="l02506"></a>02506       strcpy(<a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, ahost_name);
<a name="l02507"></a>02507    <span class="keywordflow">if</span> (aexp_name)
<a name="l02508"></a>02508       strcpy(<a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, aexp_name);
<a name="l02509"></a>02509    <a class="code" href="mfe_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a> = adebug;
<a name="l02510"></a>02510 <span class="preprocessor">#else</span>
<a name="l02511"></a>02511 <span class="preprocessor"></span>
<a name="l02512"></a>02512    <span class="comment">/* get default from environment */</span>
<a name="l02513"></a>02513    <a class="code" href="group__cmfunctionc.html#gaa483e7c17ff962fd6cdfa581f4989f54">cm_get_environment</a>(<a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>), <a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <span class="keyword">sizeof</span>(<a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>));
<a name="l02514"></a>02514 
<a name="l02515"></a>02515    <span class="comment">/* parse command line parameters */</span>
<a name="l02516"></a>02516    <span class="keywordflow">for</span> (i = 1; i &lt; argc; i++) {
<a name="l02517"></a>02517       <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;d&apos;</span>)
<a name="l02518"></a>02518          <a class="code" href="mfe_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a> = TRUE;
<a name="l02519"></a>02519       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;D&apos;</span>)
<a name="l02520"></a>02520          daemon_flag = 1;
<a name="l02521"></a>02521       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; argv[i][1] == <span class="charliteral">&apos;O&apos;</span>)
<a name="l02522"></a>02522          daemon_flag = 2;
<a name="l02523"></a>02523       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l02524"></a>02524          <span class="keywordflow">if</span> (i + 1 &gt;= argc || argv[i + 1][0] == <span class="charliteral">&apos;-&apos;</span>)
<a name="l02525"></a>02525             <span class="keywordflow">goto</span> usage;
<a name="l02526"></a>02526          <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;e&apos;</span>)
<a name="l02527"></a>02527             strcpy(<a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, argv[++i]);
<a name="l02528"></a>02528          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;h&apos;</span>)
<a name="l02529"></a>02529             strcpy(<a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, argv[++i]);
<a name="l02530"></a>02530          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argv[i][1] == <span class="charliteral">&apos;i&apos;</span>)
<a name="l02531"></a>02531             <a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a> = atoi(argv[++i]);
<a name="l02532"></a>02532          <span class="keywordflow">else</span> {
<a name="l02533"></a>02533           usage:
<a name="l02534"></a>02534             printf
<a name="l02535"></a>02535                 (<span class="stringliteral">&quot;usage: frontend [-h Hostname] [-e Experiment] [-d] [-D] [-O] [-i n]\n&quot;</span>);
<a name="l02536"></a>02536             printf(<span class="stringliteral">&quot;         [-d]     Used to debug the frontend\n&quot;</span>);
<a name="l02537"></a>02537             printf(<span class="stringliteral">&quot;         [-D]     Become a daemon\n&quot;</span>);
<a name="l02538"></a>02538             printf(<span class="stringliteral">&quot;         [-O]     Become a daemon but keep stdout\n&quot;</span>);
<a name="l02539"></a>02539             printf(<span class="stringliteral">&quot;         [-i n]   Set frontend index (used for event building)\n&quot;</span>);
<a name="l02540"></a>02540             <span class="keywordflow">return</span> 0;
<a name="l02541"></a>02541          }
<a name="l02542"></a>02542       }
<a name="l02543"></a>02543    }
<a name="l02544"></a>02544 <span class="preprocessor">#endif</span>
<a name="l02545"></a>02545 <span class="preprocessor"></span>
<a name="l02546"></a>02546    <span class="comment">/* check event and buffer sizes */</span>
<a name="l02547"></a>02547    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a> &lt; 2 * <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>) {
<a name="l02548"></a>02548       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;mainFE&quot;</span>, <span class="stringliteral">&quot;event_buffer_size %d too small for max. event size %d\n&quot;</span>, <a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>, <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02549"></a>02549       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(5000);
<a name="l02550"></a>02550       <span class="keywordflow">return</span> 1;
<a name="l02551"></a>02551    }
<a name="l02552"></a>02552 
<a name="l02553"></a>02553 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02554"></a>02554 <span class="preprocessor"></span>   <span class="comment">/* override event_buffer_size in case of VxWorks</span>
<a name="l02555"></a>02555 <span class="comment">      take remaining free memory and use 20% of it for rb_ */</span>
<a name="l02556"></a>02556    <a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a> = 2 * 10 * (<a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> + <span class="keyword">sizeof</span>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a>) + <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>));
<a name="l02557"></a>02557    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a> &gt; memFindMax()) {
<a name="l02558"></a>02558       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;mainFE&quot;</span>, <span class="stringliteral">&quot;Not enough mem space for event size&quot;</span>);
<a name="l02559"></a>02559       <span class="keywordflow">return</span> 0;
<a name="l02560"></a>02560    }
<a name="l02561"></a>02561    <span class="comment">/* takes overall 20% of the available memory resource for rb_() */</span>
<a name="l02562"></a>02562    <a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a> = 0.2 * memFindMax();
<a name="l02563"></a>02563 <span class="preprocessor">#endif</span>
<a name="l02564"></a>02564 <span class="preprocessor"></span>
<a name="l02565"></a>02565    <span class="comment">/* retrieve frontend index from environment if defined */</span>
<a name="l02566"></a>02566    <span class="keywordflow">if</span> (getenv(<span class="stringliteral">&quot;MIDAS_FRONTEND_INDEX&quot;</span>))
<a name="l02567"></a>02567       <a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a> = atoi(getenv(<span class="stringliteral">&quot;MIDAS_FRONTEND_INDEX&quot;</span>));
<a name="l02568"></a>02568 
<a name="l02569"></a>02569    <span class="comment">/* add frontend index to frontend name if present */</span>
<a name="l02570"></a>02570    strcpy(<a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>, <a class="code" href="mfe_8c.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>);
<a name="l02571"></a>02571    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a> &gt;= 0)
<a name="l02572"></a>02572       sprintf(<a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a> + strlen(<a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>), <span class="stringliteral">&quot;%02d&quot;</span>, <a class="code" href="mfe_8c.html#a922adac2edf2bc75a7d52bc6c5e2aeb4">frontend_index</a>);
<a name="l02573"></a>02573 
<a name="l02574"></a>02574    <span class="comment">/* inform user of settings */</span>
<a name="l02575"></a>02575    printf(<span class="stringliteral">&quot;Frontend name          :     %s\n&quot;</span>, <a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>);
<a name="l02576"></a>02576    printf(<span class="stringliteral">&quot;Event buffer size      :     %d\n&quot;</span>, <a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>);
<a name="l02577"></a>02577    printf(<span class="stringliteral">&quot;User max event size    :     %d\n&quot;</span>, <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02578"></a>02578    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a> &gt; 0)
<a name="l02579"></a>02579       printf(<span class="stringliteral">&quot;User max frag. size    :     %d\n&quot;</span>, <a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>);
<a name="l02580"></a>02580    printf(<span class="stringliteral">&quot;# of events per buffer :     %d\n\n&quot;</span>, <a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a> / <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02581"></a>02581 
<a name="l02582"></a>02582    <span class="keywordflow">if</span> (daemon_flag) {
<a name="l02583"></a>02583       printf(<span class="stringliteral">&quot;\nBecoming a daemon...\n&quot;</span>);
<a name="l02584"></a>02584       ss_daemon_init(daemon_flag == 2);
<a name="l02585"></a>02585    }
<a name="l02586"></a>02586   
<a name="l02587"></a>02587    <span class="comment">/* set default rate period */</span>
<a name="l02588"></a>02588    <a class="code" href="mfe_8c.html#a0a854b7675d4589bce8f016a94b2706c">set_rate_period</a>(3000);
<a name="l02589"></a>02589 
<a name="l02590"></a>02590    <span class="comment">/* now connect to server */</span>
<a name="l02591"></a>02591    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) {
<a name="l02592"></a>02592       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>[0]) {
<a name="l02593"></a>02593          <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[0])
<a name="l02594"></a>02594             printf(<span class="stringliteral">&quot;Connect to experiment %s on host %s...\n&quot;</span>, <a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>);
<a name="l02595"></a>02595          <span class="keywordflow">else</span>
<a name="l02596"></a>02596             printf(<span class="stringliteral">&quot;Connect to experiment on host %s...\n&quot;</span>, <a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>);
<a name="l02597"></a>02597       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>[0])
<a name="l02598"></a>02598          printf(<span class="stringliteral">&quot;Connect to experiment %s...\n&quot;</span>, <a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>);
<a name="l02599"></a>02599       <span class="keywordflow">else</span>
<a name="l02600"></a>02600          printf(<span class="stringliteral">&quot;Connect to experiment...\n&quot;</span>);
<a name="l02601"></a>02601    }
<a name="l02602"></a>02602 
<a name="l02603"></a>02603    status = <a class="code" href="group__cmfunctionc.html#ga4dfbe7e4683c5f1e7f7cc1f6f998bdda">cm_connect_experiment1</a>(<a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, <a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>,
<a name="l02604"></a>02604                                    NULL, <a class="code" href="group__midasincludecode.html#gac5b414ae3a2f854b099c08f5e63e8671">DEFAULT_ODB_SIZE</a>, <a class="code" href="mfe_8c.html#a093e717ef9582e83efcc2550ef0c28cb">DEFAULT_FE_TIMEOUT</a>);
<a name="l02605"></a>02605    <span class="keywordflow">if</span> (status != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l02606"></a>02606       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;mainFE&quot;</span>, <span class="stringliteral">&quot;Cannot connect to experiment \&apos;%s\&apos; on host \&apos;%s\&apos;, status %d&quot;</span>, <a class="code" href="mfe_8c.html#a11eee1a5e2cef985b90bdfe0bfc8cf76">exp_name</a>, <a class="code" href="mfe_8c.html#af65cc3664520b7cd0817adc7106f9624">host_name</a>, status);
<a name="l02607"></a>02607       <span class="comment">/* let user read message before window might close */</span>
<a name="l02608"></a>02608       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(5000);
<a name="l02609"></a>02609       <span class="keywordflow">return</span> 1;
<a name="l02610"></a>02610    }
<a name="l02611"></a>02611 
<a name="l02612"></a>02612    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02613"></a>02613       printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l02614"></a>02614 
<a name="l02615"></a>02615    <span class="comment">/* allocate buffer space */</span>
<a name="l02616"></a>02616    <a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a> = malloc(<a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02617"></a>02617    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ac755035b7fe3f9e7e9c0b9ba691fdf7e">event_buffer</a> == NULL) {
<a name="l02618"></a>02618       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;mainFE&quot;</span>, <span class="stringliteral">&quot;mfe: Cannot allocate event buffer of max_event_size %d\n&quot;</span>, <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>);
<a name="l02619"></a>02619       <span class="keywordflow">return</span> 1;
<a name="l02620"></a>02620    }
<a name="l02621"></a>02621 
<a name="l02622"></a>02622    <span class="comment">/* remomve any dead frontend */</span>
<a name="l02623"></a>02623    <a class="code" href="group__cmfunctionc.html#ga6208deae04212a3f234d80fe3185f86d">cm_cleanup</a>(<a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>, FALSE);
<a name="l02624"></a>02624 
<a name="l02625"></a>02625    <span class="comment">/* shutdown previous frontend */</span>
<a name="l02626"></a>02626    status = <a class="code" href="group__cmfunctionc.html#ga01682993f1aa1d5a4ed22de45ecf45fe">cm_shutdown</a>(<a class="code" href="mfe_8c.html#a98cf62d8ada1b93b7fb57612da25af6a">full_frontend_name</a>, FALSE);
<a name="l02627"></a>02627    <span class="keywordflow">if</span> (status == <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> &amp;&amp; <a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) {
<a name="l02628"></a>02628       printf(<span class="stringliteral">&quot;Previous frontend stopped\n&quot;</span>);
<a name="l02629"></a>02629 
<a name="l02630"></a>02630       <span class="comment">/* let user read message */</span>
<a name="l02631"></a>02631       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(3000);
<a name="l02632"></a>02632    }
<a name="l02633"></a>02633 
<a name="l02634"></a>02634    <span class="comment">/* register transition callbacks */</span>
<a name="l02635"></a>02635    <span class="keywordflow">if</span> (<a class="code" href="group__cmfunctionc.html#ga00950930acadf846be75239b6d0e80dc">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga2abbc514b87837cc235da54a4cf59e09">TR_START</a>, <a class="code" href="mfe_8c.html#a5ed14877e514f13eeb65a16898b2ba32">tr_start</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l02636"></a>02636        <a class="code" href="group__cmfunctionc.html#ga00950930acadf846be75239b6d0e80dc">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#gadd7d0605113ff6e1b4e705d31332a1a0">TR_STOP</a>, <a class="code" href="mfe_8c.html#a5c030a1926f2439e78b7bd0d00221937">tr_stop</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l02637"></a>02637        <a class="code" href="group__cmfunctionc.html#ga00950930acadf846be75239b6d0e80dc">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga11713399cfb35e58b8fae045836c0d88">TR_PAUSE</a>, <a class="code" href="mfe_8c.html#a7b3b6a2f570d0b31b1ad13c34536db5a">tr_pause</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a> ||
<a name="l02638"></a>02638        <a class="code" href="group__cmfunctionc.html#ga00950930acadf846be75239b6d0e80dc">cm_register_transition</a>(<a class="code" href="group__mdefineh.html#ga0b69b728877f100fe6ff76e667ff8831">TR_RESUME</a>, <a class="code" href="mfe_8c.html#ac69f1c3106f3389ed0dde43e7b86e54d">tr_resume</a>, 500) != <a class="code" href="group__err21.html#ga0180947941230d805f5dbb6f1801c17c">CM_SUCCESS</a>) {
<a name="l02639"></a>02639       printf(<span class="stringliteral">&quot;Failed to start local RPC server&quot;</span>);
<a name="l02640"></a>02640       <a class="code" href="group__cmfunctionc.html#ga7d5a287821786e8dde3d2340826215b2">cm_disconnect_experiment</a>();
<a name="l02641"></a>02641 
<a name="l02642"></a>02642       <span class="comment">/* let user read message before window might close */</span>
<a name="l02643"></a>02643       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(5000);
<a name="l02644"></a>02644       <span class="keywordflow">return</span> 1;
<a name="l02645"></a>02645    }
<a name="l02646"></a>02646 
<a name="l02647"></a>02647    <a class="code" href="group__cmfunctionc.html#ga16b33b70783a3f5ba98b4094149d12b7">cm_get_experiment_database</a>(&amp;<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, &amp;status);
<a name="l02648"></a>02648    <span class="comment">/* set time from server */</span>
<a name="l02649"></a>02649 <span class="preprocessor">#ifdef OS_VXWORKS</span>
<a name="l02650"></a>02650 <span class="preprocessor"></span>   <a class="code" href="group__cmfunctionc.html#ga89d09a1a52a983be86ef502614fe555c">cm_synchronize</a>(NULL);
<a name="l02651"></a>02651 <span class="preprocessor">#endif</span>
<a name="l02652"></a>02652 <span class="preprocessor"></span>
<a name="l02653"></a>02653    size = <span class="keyword">sizeof</span>(sys_max_event_size);
<a name="l02654"></a>02654    status = <a class="code" href="group__odbfunctionc.html#gaf3958854e073e1ddbb43324e07a6287f">db_get_value</a>(<a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, 0, <span class="stringliteral">&quot;/Experiment/MAX_EVENT_SIZE&quot;</span>, &amp;sys_max_event_size, &amp;size, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, TRUE);
<a name="l02655"></a>02655 
<a name="l02656"></a>02656    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a> &gt; sys_max_event_size) {
<a name="l02657"></a>02657       <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;mainFE&quot;</span>, <span class="stringliteral">&quot;Requested max_event_size (%d) exceeds max. system event size (%d)&quot;</span>,
<a name="l02658"></a>02658              <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>, sys_max_event_size);
<a name="l02659"></a>02659       <span class="keywordflow">return</span> 1;
<a name="l02660"></a>02660    }
<a name="l02661"></a>02661 
<a name="l02662"></a>02662    <span class="comment">/* turn off watchdog if in debug mode */</span>
<a name="l02663"></a>02663    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a81f0a890e023743f1b88d0cb7d4f74db">debug</a>)
<a name="l02664"></a>02664       <a class="code" href="group__cmfunctionc.html#gaf98a4288e4c02da7c75f3e0326ff0e72">cm_set_watchdog_params</a>(FALSE, 0);
<a name="l02665"></a>02665 
<a name="l02666"></a>02666    <span class="comment">/* increase RPC timeout to 2min for logger with exabyte or blocked disk */</span>
<a name="l02667"></a>02667    <a class="code" href="group__rpcfunctionc.html#gaab360e4fd185439b0913c723581115ea">rpc_set_option</a>(-1, <a class="code" href="group__mdefineh.html#ga9d274f0e5944be5b429d6c1bacfe1db0">RPC_OTIMEOUT</a>, 120000);
<a name="l02668"></a>02668 
<a name="l02669"></a>02669    <span class="comment">/* set own message print function */</span>
<a name="l02670"></a>02670    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02671"></a>02671       <a class="code" href="group__msgfunctionc.html#gafe6ff62436845805cd87a7ea1bd3b4dd">cm_set_msg_print</a>(<a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="group__mdefineh.html#ga3378bf6f53a24392145df33c8acc9c0c">MT_ALL</a>, <a class="code" href="mfe_8c.html#a4186dc25477a1b947c5d6ef64bcc4da0">message_print</a>);
<a name="l02672"></a>02672 
<a name="l02673"></a>02673    <span class="comment">/* reqister equipment in ODB */</span>
<a name="l02674"></a>02674    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab834073e5b665fccaa4eff2a61bc9372">register_equipment</a>() != <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l02675"></a>02675       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02676"></a>02676          printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02677"></a>02677       <a class="code" href="group__cmfunctionc.html#ga7d5a287821786e8dde3d2340826215b2">cm_disconnect_experiment</a>();
<a name="l02678"></a>02678 
<a name="l02679"></a>02679       <span class="comment">/* let user read message before window might close */</span>
<a name="l02680"></a>02680       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(5000);
<a name="l02681"></a>02681       <span class="keywordflow">return</span> 1;
<a name="l02682"></a>02682    }
<a name="l02683"></a>02683 
<a name="l02684"></a>02684    <span class="comment">/* call user init function */</span>
<a name="l02685"></a>02685    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02686"></a>02686       printf(<span class="stringliteral">&quot;Init hardware...\n&quot;</span>);
<a name="l02687"></a>02687    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a802849119d469feb2d1deee1be9593ac">frontend_init</a>() != <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {
<a name="l02688"></a>02688       <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02689"></a>02689          printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02690"></a>02690       <a class="code" href="group__cmfunctionc.html#ga7d5a287821786e8dde3d2340826215b2">cm_disconnect_experiment</a>();
<a name="l02691"></a>02691 
<a name="l02692"></a>02692       <span class="comment">/* let user read message before window might close */</span>
<a name="l02693"></a>02693       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(5000);
<a name="l02694"></a>02694       <span class="keywordflow">return</span> 1;
<a name="l02695"></a>02695    }
<a name="l02696"></a>02696 
<a name="l02697"></a>02697    <a class="code" href="mfe_8c.html#a7755389a61fd0afb9b11bc68a2218058">initialize_equipment</a>();
<a name="l02698"></a>02698 
<a name="l02699"></a>02699    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>)
<a name="l02700"></a>02700       printf(<span class="stringliteral">&quot;OK\n&quot;</span>);
<a name="l02701"></a>02701 
<a name="l02702"></a>02702    <span class="comment">/* initialize screen display */</span>
<a name="l02703"></a>02703    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) {
<a name="l02704"></a>02704       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(300);
<a name="l02705"></a>02705       <a class="code" href="mfe_8c.html#a4d77ab19483f67e8240c29a9ff9ca777">display</a>(TRUE);
<a name="l02706"></a>02706    }
<a name="l02707"></a>02707 
<a name="l02708"></a>02708    <span class="comment">/* switch on interrupts or readout thread if running */</span>
<a name="l02709"></a>02709    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#a81f01ccafac403262a2e430c118516a3">run_state</a> == <a class="code" href="group__mdefineh.html#gac4c0304c569818c811515e24523c3150">STATE_RUNNING</a>)
<a name="l02710"></a>02710       <a class="code" href="mfe_8c.html#a1f7c4819ed16e337192ca7426ae273ca">readout_enable</a>(TRUE);
<a name="l02711"></a>02711 
<a name="l02712"></a>02712    <span class="comment">/* initialize ss_getchar */</span>
<a name="l02713"></a>02713    ss_getchar(0);
<a name="l02714"></a>02714 
<a name="l02715"></a>02715    <span class="comment">/* call main scheduler loop */</span>
<a name="l02716"></a>02716    status = <a class="code" href="mfe_8c.html#a94c9987508c91ae4827cc231f43b577e">scheduler</a>();
<a name="l02717"></a>02717 
<a name="l02718"></a>02718    <span class="comment">/* stop readout thread */</span>
<a name="l02719"></a>02719    <a class="code" href="mfe_8c.html#ab8d6a79a86973098e87386a79dfc4bc7">stop_all_threads</a> = 1;
<a name="l02720"></a>02720    <a class="code" href="group__rbfunctionc.html#gaabc49ab7300eae65b5cbdbaa00921a5d">rb_set_nonblocking</a>();
<a name="l02721"></a>02721    <span class="keywordflow">while</span> (<a class="code" href="mfe_8c.html#a0e0b5bde115b046964736980402f114e">readout_thread_active</a>)
<a name="l02722"></a>02722       <a class="code" href="group__msfunctionc.html#gaf877acb3de6be606dd427a84aa7b6dda">ss_sleep</a>(100);
<a name="l02723"></a>02723 
<a name="l02724"></a>02724    <span class="comment">/* reset terminal */</span>
<a name="l02725"></a>02725    ss_getchar(TRUE);
<a name="l02726"></a>02726 
<a name="l02727"></a>02727    <span class="comment">/* switch off interrupts and detach */</span>
<a name="l02728"></a>02728    <span class="keywordflow">if</span> (interrupt_eq) {
<a name="l02729"></a>02729       <a class="code" href="mfe_8c.html#a681a5d1fe2e8a4735bcf03824ffb3e81">interrupt_configure</a>(<a class="code" href="group__err26.html#gaa12884ae2e3cbffa489d7c5074a029f7">CMD_INTERRUPT_DISABLE</a>, 0, 0);
<a name="l02730"></a>02730       <a class="code" href="mfe_8c.html#a681a5d1fe2e8a4735bcf03824ffb3e81">interrupt_configure</a>(<a class="code" href="group__err26.html#gae055008eb0238aaf491eda741abcd26d">CMD_INTERRUPT_DETACH</a>, 0, 0);
<a name="l02731"></a>02731    }
<a name="l02732"></a>02732    
<a name="l02733"></a>02733    <span class="comment">/* call user exit function */</span>
<a name="l02734"></a>02734    <a class="code" href="mfe_8c.html#a3b682405038cc4f6af505d7ca6367a4f">frontend_exit</a>();
<a name="l02735"></a>02735 
<a name="l02736"></a>02736    <span class="comment">/* close slow control drivers */</span>
<a name="l02737"></a>02737    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l02738"></a>02738       <span class="keywordflow">if</span> ((equipment[i].info.eq_type &amp; <a class="code" href="group__mdefineh.html#gafffdc5135b2e8f3c6bc61b8701084df6">EQ_SLOW</a>) &amp;&amp; equipment[i].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>) {
<a name="l02739"></a>02739 
<a name="l02740"></a>02740          <span class="keywordflow">for</span> (j = 0; equipment[i].<a class="code" href="structeqpmnt.html#af19c464fc7092048c9418328ca4e4afc">driver</a>[j].<a class="code" href="structDEVICE__DRIVER.html#a3c47bfe572999fec51df9c6072d6c6d7">name</a>[0]; j++)
<a name="l02741"></a>02741             <span class="keywordflow">if</span> (equipment[i].driver[j].flags &amp; <a class="code" href="group__mequipment.html#ga2499f0abd1f0577de72d1d5645fc7713">DF_MULTITHREAD</a>)
<a name="l02742"></a>02742                <span class="keywordflow">break</span>;
<a name="l02743"></a>02743 
<a name="l02744"></a>02744          <span class="comment">/* stop all threads if multithreaded */</span>
<a name="l02745"></a>02745          <span class="keywordflow">if</span> (equipment[i].driver[j].name[0] &amp;&amp; equipment[i].status == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l02746"></a>02746             equipment[i].<a class="code" href="structeqpmnt.html#ae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#ga46dc7ae84992bfe62cc00731959a67f4">CMD_STOP</a>, &amp;equipment[i]);   <span class="comment">/* stop all threads */</span>
<a name="l02747"></a>02747       }
<a name="l02748"></a>02748    <span class="keywordflow">for</span> (i = 0; equipment[i].<a class="code" href="structeqpmnt.html#a80db04cadcc657d17e5ba6f742d6fbc6">name</a>[0]; i++)
<a name="l02749"></a>02749       <span class="keywordflow">if</span> ((equipment[i].info.eq_type &amp; EQ_SLOW) &amp;&amp; equipment[i].<a class="code" href="structeqpmnt.html#af498c07c0758b46649715eead4627874">status</a> == <a class="code" href="group__err26.html#ga23395a243c74edd61ed4ce0df1256419">FE_SUCCESS</a>)
<a name="l02750"></a>02750          equipment[i].<a class="code" href="structeqpmnt.html#ae263c2d6a07b0aeb17b85ee3ea042220">cd</a>(<a class="code" href="group__err26.html#gacfa1d482ab47b3ceebb9717007111649">CMD_EXIT</a>, &amp;equipment[i]);      <span class="comment">/* close physical connections */</span>
<a name="l02751"></a>02751 
<a name="l02752"></a>02752    free(<a class="code" href="mfe_8c.html#a227a2ea01e3cfdb42d885e9314ca304e">n_events</a>);
<a name="l02753"></a>02753 
<a name="l02754"></a>02754    <span class="comment">/* close network connection to server */</span>
<a name="l02755"></a>02755    <a class="code" href="group__cmfunctionc.html#ga7d5a287821786e8dde3d2340826215b2">cm_disconnect_experiment</a>();
<a name="l02756"></a>02756 
<a name="l02757"></a>02757    <span class="keywordflow">if</span> (<a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>) {
<a name="l02758"></a>02758       <span class="keywordflow">if</span> (status == <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>) {
<a name="l02759"></a>02759          ss_clear_screen();
<a name="l02760"></a>02760          ss_printf(0, 0, <span class="stringliteral">&quot;Frontend shut down.&quot;</span>);
<a name="l02761"></a>02761          ss_printf(0, 1, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02762"></a>02762       }
<a name="l02763"></a>02763    }
<a name="l02764"></a>02764 
<a name="l02765"></a>02765    <span class="keywordflow">if</span> (status != <a class="code" href="group__err25.html#ga0406ee07e8c5afbf8e46cb0eed698bcd">RPC_SHUTDOWN</a>)
<a name="l02766"></a>02766       printf(<span class="stringliteral">&quot;Network connection aborted.\n&quot;</span>);
<a name="l02767"></a>02767 
<a name="l02768"></a>02768    <span class="keywordflow">return</span> 0;
<a name="l02769"></a>02769 }
<a name="l02770"></a>02770 
<a name="l02771"></a>02771 <span class="preprocessor">#ifdef LINK_TEST</span>
<a name="l02772"></a>02772 <span class="preprocessor"></span><span class="keywordtype">char</span>* <a class="code" href="mfe_8c.html#ac1f0c6df66e35778b61c611107501ec4">frontend_name</a>;
<a name="l02773"></a>02773 <span class="keywordtype">char</span>* <a class="code" href="mfe_8c.html#ac7fc683b5a25d9607abc270a54db6d97">frontend_file_name</a>;
<a name="l02774"></a>02774 <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>  <a class="code" href="mfe_8c.html#a0215c0a842a0e97fe65c7ef5fb7633a5">frontend_call_loop</a>;
<a name="l02775"></a>02775 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a4411d7db6f901c968b946ed659d202f6">event_buffer_size</a>;
<a name="l02776"></a>02776 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a13adb6e6b95ca2a62bbfe2453d71a1cd">max_event_size</a>;
<a name="l02777"></a>02777 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a5593758d19398ebc7c3d58d7f05ec160">max_event_size_frag</a>;
<a name="l02778"></a>02778 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ab9cdcefda91459091b0ed33011d0d18c">display_period</a>;
<a name="l02779"></a>02779 <a class="code" href="structeqpmnt.html">EQUIPMENT</a> equipment[1];
<a name="l02780"></a>02780 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a802849119d469feb2d1deee1be9593ac">frontend_init</a>() { <span class="keywordflow">return</span> 0; };
<a name="l02781"></a>02781 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a3b682405038cc4f6af505d7ca6367a4f">frontend_exit</a>() { <span class="keywordflow">return</span> 0; };
<a name="l02782"></a>02782 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ad8bfe703c49342b9f0275aba77dc7758">begin_of_run</a>(<span class="keywordtype">int</span> runno,<span class="keywordtype">char</span>* errstr) { <span class="keywordflow">return</span> 0; };
<a name="l02783"></a>02783 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ae6d798649008b7523c77222bae2d4187">end_of_run</a>(<span class="keywordtype">int</span> runno,<span class="keywordtype">char</span>* errstr) { <span class="keywordflow">return</span> 0; };
<a name="l02784"></a>02784 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a164db20cf6c8c81e8c8ca50a590de436">pause_run</a>(<span class="keywordtype">int</span> runno,<span class="keywordtype">char</span>* errstr) { <span class="keywordflow">return</span> 0; };
<a name="l02785"></a>02785 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a6cada7e3f07b9fc2b9886263223661d4">resume_run</a>(<span class="keywordtype">int</span> runno,<span class="keywordtype">char</span>* errstr) { <span class="keywordflow">return</span> 0; };
<a name="l02786"></a>02786 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a681a5d1fe2e8a4735bcf03824ffb3e81">interrupt_configure</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> cmd, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> source, POINTER_T adr) { <span class="keywordflow">return</span> 0; };
<a name="l02787"></a>02787 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#ad902740ed5577f2f940454359ec1df1c">frontend_loop</a>() { <span class="keywordflow">return</span> 0; };
<a name="l02788"></a>02788 <span class="keywordtype">int</span> <a class="code" href="mfe_8c.html#a98cc3257284af91fa0e8da10ddf227c8">poll_event</a>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> source, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> count, <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a> <a class="code" href="sis3803_8c.html#a8fa8e4c8bef10b038f6a033f736d5bce">test</a>) { <span class="keywordflow">return</span> 0; };
<a name="l02789"></a>02789 <span class="preprocessor">#endif</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

