<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: Examples of accessing ODB from a Custom page</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="RunControl.html">SECTION 5: Run Control</a>&nbsp;&raquo&nbsp;<a class="el" href="RC_run_control.html">Run Control Programs</a>&nbsp;&raquo&nbsp;<a class="el" href="RC_mhttpd.html">mhttpd: the MIDAS Web-based Run Control utility</a>&nbsp;&raquo&nbsp;<a class="el" href="RC_mhttpd_Custom_page.html">Custom pages</a>&nbsp;&raquo&nbsp;<a class="el" href="RC_mhttpd_custom_features.html">Features available on custom pages</a>&nbsp;&raquo&nbsp;<a class="el" href="RC_mhttpd_custom_ODB_access.html">Access to the ODB from a Custom page</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="RC_mhttpd_custom_ODB_access_examples">Examples of accessing ODB from a Custom page </a></h1><p><br/>
</p>
 <script type="text/javascript">
// pages parameters: back index next {top bottom}
pages( "RC_mhttpd_custom_ODB_access", "RunControl", "RC_mhttpd_custom_ODB_access_features","RC_mhttpd_custom_ODB_access_examples",  "end" );
sections("Features", "RunControl","FrontendOperation"); // last section; top of this section; next section
</script> <p><br/>
 </p>
<h2><a class="anchor" id="RC_mhttpd_js_example1">
Example of ODB access with HTML and JavaScript equivalent</a></h2>
<p>The following simple HTML code shows ODB access using JavaScript (<span class="js">ODBGet, ODBEdit</span>) and using the HTML <span class="odbtag"> &lt;odb&gt;</span> tag . The output produced by this code is shown below. </p>
<div class="fragment"><pre class="fragment">&lt;!DOCTYPE HTML PUBLIC <span class="stringliteral">&quot;-//W3C//DTD HTML 4.0 TRANSITIONAL//EN&quot;</span>&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt; ODBEdit test&lt;/title&gt;
&lt;!-- include the mhttpd JS library --&gt;
\htmlonly &lt;script src=<span class="stringliteral">&quot;/js/mhttpd.js&quot;</span> type=<span class="stringliteral">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt; \endhtmlonly

\htmlonly &lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span>&gt;
var my_action = <span class="stringliteral">&apos;&quot;/CS/try&amp;&quot;&apos;</span>
var rn
var path
var my_expt=<span class="stringliteral">&quot;midas&quot;</span>;

document.write(<span class="stringliteral">&apos;&lt;/head&gt;&lt;body&gt;&apos;</span>)
document.write(<span class="stringliteral">&apos;&lt;form method=&quot;get&quot; name=&quot;form2&quot; action=&apos;</span>+my_action+<span class="stringliteral">&apos;&gt; &apos;</span>)
document.write(<span class="stringliteral">&apos;&lt;input name=&quot;exp&quot; value=&quot;&apos;</span>+my_expt+<span class="stringliteral">&apos;&quot; type=&quot;hidden&quot;&gt;&apos;</span>);

document.write(<span class="stringliteral">&apos;Using Javascript and ODBEdit:&lt;br&gt;&apos;</span>)
path=<span class="stringliteral">&apos;/runinfo/run number&apos;</span>
rn = ODBGet(path,<span class="stringliteral">&quot;Run Number with format: %d&quot;</span>)
document.writeln(&apos;Run Number: &apos;+rn+&apos;&lt;br&gt;&apos;)
document.writeln(&apos;Edit Run Number:&apos;)
document.writeln(&apos;&lt;a href=&quot;<span class="preprocessor">#&quot; onclick=&quot;ODBEdit(path)&quot; &gt;&apos;)</span>
<span class="preprocessor"></span>document.writeln(rn)
document.writeln(<span class="stringliteral">&apos;&lt;/a&gt;&apos;</span>);
&lt;/script&gt; \endhtmlonly
&lt;br&gt;
Using HTML :
&lt;br&gt;
Using edit=2 ...  Run Number:
&lt;odb src=<span class="stringliteral">&quot;/runinfo/run number&quot;</span> edit=2&gt;
&lt;br&gt;
Using edit=1 ...  Run Number:
&lt;odb src=<span class="stringliteral">&quot;/runinfo/run number&quot;</span> edit=1&gt;
&lt;br&gt;
&lt;/form&gt;
&lt;/html&gt;
</pre></div><p> <br/>
</p>
<p>This code produces the output shown in Figures 1 and 2 below. In Figure 1, a value has been entered using the hyperlink created by the <b>Javascript</b> function <span class="js">ODBEdit.</span> A <b>popup</b> box appears in which the user may enter a new value.</p>
<p><br/>
<br/>
<br/>
 </p>
<center> <span class="image">Figure 1: ODB tags under html and javascript - entering an ODB value using Javascript <br/>
<br/>
<br/>
 </p>
<div align="center">
<img src="popups_js.png" alt="popups_js.png"/>
</div>
<p> </span></center><p> <br/>
<br/>
<br/>
</p>
<p>Figure 2 shows entering a value using the <b>HTML</b> tags. The two different styles are shown.</p>
<ul>
<li><b>edit=2</b> type produces a pop-up box as in the Javascript version</li>
<li><b>edit=1</b> type produces an in-line input box</li>
</ul>
<p><br/>
<br/>
<br/>
 </p>
<center> <span class="image">Figure 2: ODB tags under html and javascript - entering an ODB value using HTML <br/>
<br/>
<br/>
 </p>
<div align="center">
<img src="popups_html.png" alt="popups_html.png"/>
</div>
<p> <br/>
<br/>
<br/>
 </span></center><h2><a class="anchor" id="RC_mhttpd_js_example2">
Example of ODB access with JavaScript functions ODBSet and ODBKey</a></h2>
<p>The following HTML code shows an example using the JavaScript functions <span class="js">ODBSet and ODBKey</span>. There is no equivalent to these functions available in HTML. The output from this example is shown in Figure 3.</p>
<div class="fragment"><pre class="fragment">&lt;!DOCTYPE HTML PUBLIC <span class="stringliteral">&quot;-//W3C//DTD HTML 4.0 TRANSITIONAL//EN&quot;</span>&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt; ODBEdit test&lt;/title&gt;
\htmlonly &lt;script src=<span class="stringliteral">&quot;/js/mhttpd.js&quot;</span> type=<span class="stringliteral">&quot;text/javascript&quot;</span>&gt;&lt;/script&gt; \endhtmlonly

\htmlonly &lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span>&gt;
var my_action = <span class="stringliteral">&apos;&quot;/CS/try&amp;&quot;&apos;</span>
var rn,ival,irn
var path=<span class="stringliteral">&quot;/runinfo/run number&quot;</span>;
var my_expt=<span class="stringliteral">&quot;midas&quot;</span>;
var message;

function <a class="code" href="sis3803_8c.html#a8fa8e4c8bef10b038f6a033f736d5bce">test</a>(path,value)
{
var pattern=/<a class="code" href="group__err23.html#ga8c6c8ed2099cf2468f0c7c6cd475fe7e">DB_NO_KEY</a>/;
var ival,key

document.write(<span class="stringliteral">&apos;Function test starting with path: &apos;</span>+path+<span class="stringliteral">&apos; value: &apos;</span>+value+<span class="stringliteral">&apos;&lt;br&gt;&apos;</span>);
document.write(<span class="stringliteral">&apos;ODBGet with a format parameter:  &lt;br&gt;&apos;</span>);
ival = ODBGet(path,<span class="stringliteral">&quot;read:%4.4d&quot;</span>);
document.write(ival+<span class="stringliteral">&apos;&lt;br&gt;&apos;</span>);

document.write(<span class="stringliteral">&apos;&lt;br&gt;Now using ODBSet to set a value: &lt;br&gt;&apos;</span>);
document.write(<span class="stringliteral">&apos;Setting &apos;</span>+path+<span class="stringliteral">&apos; to &apos;</span>+value+<span class="stringliteral">&apos; with ODBSet&lt;br&gt;&apos;</span>) ;
ODBSet(path,value);
ival = ODBGet(path)
document.writeln(&apos;Value: &apos;+ival+&apos;&lt;br&gt;&apos;)

document.write(&apos;&lt;br&gt;Now using ODBKey to get a key using path: &apos;+path+&apos; &lt;br&gt;&apos;);
key = ODBKey(path);
document.write(&apos;&lt;br&gt;Testing response for the pattern: &apos;+pattern+&apos;...&apos;);
 if ( pattern.test(key))
      document.write(&apos;test is TRUE &lt;br&gt;&apos;);
 else
      document.write(&apos;test is FALSE&lt;br&gt;&apos;);
document.write(&apos;key array : &apos;+key+&apos;&lt;br&gt;&apos;);
document.write(&apos;<a class="code" href="fevmemodules_8c.html#a5992b274cfdcacdbc1fa8347fd01ebde">done</a>&lt;br&gt;&apos;);
return;
}


document.write(&apos;&lt;/head&gt;&lt;body&gt;&apos;)
document.write(&apos;&lt;form method=&quot;get&quot; name=&quot;form2&quot; action=&apos;+my_action+&apos;&gt; &apos;)
document.write(&apos;&lt;input name=&quot;exp&quot; value=&quot;&apos;+my_expt+&apos;&quot; type=&quot;hidden&quot;&gt;&apos;);

irn=ODBGet(path); <span class="comment">// remember initial run number</span>
ODBSet(path,70); <span class="comment">// initialize the run number to 70</span>

document.write(&apos;Example showing use of ODBGet, ODBSet, ODBKey, ODBGetMsg &lt;br&gt;&apos;);
document.write(&apos;First with a good path...&lt;br&gt;&apos;);
document.write(&apos;&lt;span style= &quot;color: green;&quot;&gt;&apos;)
test(&quot;/<a class="code" href="analyzer_8c.html#ade46d29add32a0b6910ebc8da0fea69b">runinfo</a>/run number&quot;, 76);
document.write(&apos;&lt;/span&gt;&apos;)
document.write(&apos;&lt;br&gt;Then with bad path to show the difference....&lt;br&gt;&apos;);
document.write(&apos;&lt;span style= &quot;color: red;&quot;&gt;&apos;)
test(&quot;/nopath/nokey&quot;, 79);
document.write(&apos;&lt;/span&gt;&apos;)
message= ODBGetMsg(1);
document.write(&apos;Last message:&apos;+message+&apos;&lt;br&gt;&apos;);

ODBSet(path,irn); <span class="comment">// rewrite initial run number</span>
&lt;/script&gt; \endhtmlonly
&lt;/form&gt;
&lt;/html&gt;
</pre></div><p><br/>
<br/>
<br/>
 </p>
<center> <span class="image">Figure 3 Output from above example code showing ODB access with JS built-in functions <br/>
<br/>
<br/>
 </p>
<div align="center">
<img src="Odbget.png" alt="Odbget.png"/>
</div>
<p> <br/>
<br/>
<br/>
 </span></center><h2><a class="anchor" id="RC_mhttpd_js_example3">
Example of ODB access with arrays</a></h2>
<p>Accessing ODB values can slow the page update considerably where there are many values to access. The access time can be cut considerably by having most of the input and output data in arrays.</p>
<p><span class="new"> Note that writing arrays with ODBSet has been supported since <a class="el" href="NDF.html#ndf_may_2010">May 2010</a> . </span></p>
<p>In the following example, the raw data is provided in two large arrays. Some of this data is used in logical calculations (done in JavaScript) to determine the state of various devices, and the result is output into an array in the ODB in order to colour various items with the use of "fills" on the image pages. <br/>
 In this example, the arrays PLCR,PLCA in the odb are read into arrays in JavaScript in the function get_PLC_arrays in the file custom_functions.js. Calculated data stored as an array in the odb are read into an array CAL. </p>
<div class="fragment"><pre class="fragment"><span class="comment">// custom_fuctions.js</span>
<span class="comment">// globals</span>
var equipment_path=<span class="stringliteral">&apos;/Equipment/TpcGasPlc/&apos;</span>;
var gascalc_array = equipment_path + <span class="stringliteral">&apos;GasCalc/Variables/Calculated[*]&apos;</span>;
var variables_path = equipment_path + <span class="stringliteral">&apos;Variables/&apos;</span>;
var plcr_path = variables_path + <span class="stringliteral">&apos;PLCR&apos;</span>; <span class="comment">// indices of these PLC arrays are in names.js</span>
var plca_path = variables_path + <span class="stringliteral">&apos;PLCA&apos;</span>;

var PLCR=[];
var PLCA=[];
var CAL=[];

function get_PLC_arrays()
{  <span class="comment">// get the arrays in one go</span>
   <span class="comment">// returns 0=success or 1=failure</span>
 
  var pattern1=/<a class="code" href="group__err23.html#ga8c6c8ed2099cf2468f0c7c6cd475fe7e">DB_NO_KEY</a>/;
  var pattern2=/undefined/;

  var i,idx;
    
  PLCR =     ODBGet(plcr_path+ <span class="stringliteral">&apos;[*]&apos;</span>);
  <span class="keywordflow">if</span> ( pattern1.test(PLCR) ||  pattern2.test(PLCR)  )
  {
      alert (<span class="stringliteral">&apos;get_PLCR_array: ERROR &apos;</span>+PLCR+<span class="stringliteral">&apos; from ODBGet(&apos;</span>+plcr_path+<span class="stringliteral">&apos;[*])&apos;</span> );
      <span class="keywordflow">return</span> 1;
  } 
  
   PLCA = ODBGet(plca_path+ <span class="stringliteral">&apos;[*]&apos;</span>, <span class="stringliteral">&quot;%9.5f&quot;</span>); <span class="comment">// the required values are float</span>
   <span class="keywordflow">if</span> ( pattern1.test(PLCA) ||  pattern2.test(PLCA)  )
   {
      alert (<span class="stringliteral">&apos;get_PLCA_array: ERROR &apos;</span>+PLCA+<span class="stringliteral">&apos; from ODBGet(&apos;</span>+plca_path+<span class="stringliteral">&apos;[*])&apos;</span> );
      <span class="keywordflow">return</span> 1;
   }
              
<span class="comment">// get Calculated array</span>
   CAL = ODBGet(gascalc_array, <span class="stringliteral">&quot;%d&quot;</span>); <span class="comment">// the required values are INT</span>
   <span class="keywordflow">if</span> ( pattern1.test(CAL) ||  pattern2.test(CAL)  )
   {
      alert (<span class="stringliteral">&apos;get_CAL_array: ERROR &apos;</span>+CAL+<span class="stringliteral">&apos; from ODBGet(&apos;</span>+gascalc_array+<span class="charliteral">&apos;)&apos;</span> );
      <span class="keywordflow">return</span> 1;
   }

   <span class="keywordflow">return</span> 0; <span class="comment">// success</span>
}

..........
</pre></div><p>For each of the gas pages, various items are calculated and the CAL array is updated for each item. At the end of all calculations, the CAL array is written back into the ODB.</p>
<div class="fragment"><pre class="fragment">&lt;!-- GasPage.html --&gt;
.......

&lt;!-- js_functions!   custom_functions.js defined by  ODB key  /custom/js_functions!  --&gt;
\htmlonly &lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span>  src=<span class="stringliteral">&quot;js_functions!&quot;</span>&gt;
&lt;/script&gt; \endhtmlonly
&lt;/head&gt;&lt;body&gt;


\htmlonly &lt;script&gt;
<span class="comment">//Read all the arrays from the ODB</span>
var plc_error = get_PLC_arrays();
.....
calculate_device(G2VA1_STAT,G2VA1,plc_error); <span class="comment">// saves result to CAL array</span>
......
calculate_logical(17,PU_Box,plc_error); <span class="comment">// saves result to CAL array</span>
......
ODBSet(gascalc_array, CAL); <span class="comment">// write CAL array into ODB after all calculations</span>
&lt;/script&gt; \endhtmlonly
&lt;/body&gt;
&lt;/html&gt;
</pre></div> <script type="text/javascript">
// pages parameters: back index next {top bottom}
pages( "RC_mhttpd_custom_ODB_access", "RunControl", "RC_mhttpd_custom_ODB_access_features","RC_mhttpd_custom_ODB_access_examples",  "" );
sections("Features", "RunControl","FrontendOperation"); // last section; top of this section; next section
</script> <p><br/>
 <a class="anchor" id="end"></a> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

