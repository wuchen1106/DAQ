<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: SECTION 7: Data Analysis</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="DataAnalysis">SECTION 7: Data Analysis </a></h1><p><br/>
  
<script type="text/javascript">
// pages parameters: back index next {top bottom}
pages("FE_utils","DataAnalysis", "Performance","DataAnalysis","end" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("FrontendOperation","DataAnalysis","Performance"); // last section; top of this section; next section
</script>
 <br/>
</p>
<p><a class="anchor" id="idx_analyzers"></a> <a class="anchor" id="idx_analyzer_documentation_ROME"></a> <a class="anchor" id="idx_analyzer_documentation_Rootana"></a> <a class="anchor" id="idx_analyzer_documentation_Roody"></a></p>
<h2><a class="anchor" id="DA_Data_analyzers">
Data Analyzers</a></h2>
<p>The following are available for MIDAS Data Analysis: </p>
<ul>
<li>
<a class="el" href="DataAnalysis.html#DA_Midas_Analyzer">MIDAS Analyzer</a> </li>
<li>
<b><a href="http://midas.psi.ch/rome">ROME</a></b> analyzer framework. </li>
<li>
<b><a href="http://ladd00.triumf.ca/%7Eolchansk/rootana/">Rootana</a></b> Root analyser </li>
<li>
<b><a href="http://ladd00.triumf.ca/~daqweb/doc/roody/html/">Roody</a></b> GUI histogram visualizer application. </li>
</ul>
<p><a class="anchor" id="idx_analyzer_utility"></a> </p>
<h2><a class="anchor" id="DA_analyzer_utility">
analyzer    - event analysis</a></h2>
<p>A template for an <b>"analyzer"</b> utility is provided so that the users may customize it to fit their own experiments, and so build their own custom data analyzer.</p>
<p>The <span class="utility">analyzer</span> utility is the main online/offline event analysis application. The <span class="utility">analyzer</span> uses fully the <b>ODB</b> capabilities, as all the analyzer <a class="el" href="structparameters.html">parameters</a> are dynamically controllable from the ODB editor <a class="el" href="RC_odbedit_utility.html">odbedit</a> or <a class="el" href="RC_mhttpd_utility.html">mhttpd</a>.</p>
<p>For more detailed information on the analyzers available see <a class="el" href="DataAnalysis.html#DA_Data_analyzers">list above</a>.</p>
<ul>
<li><b> Arguments </b><ul>
<li><b>-c</b> &lt;filename1&gt; &lt;filename2&gt; Configuration file name(s). May contain a '%05d' to be replaced by the run number. Up to ten files can be specified in one "-c" statement.</li>
<li><b>-d</b> Debug flag should be set when starting the analyzer from a debugger. Prevents the system from killing the analyzer when the debugger stops at a breakpoint</li>
<li><b>-D</b> Start analyzer as a daemon in the background (UNIX only).</li>
<li><b>-e</b> &lt;experiment&gt; <a class="el" href="F_Utilities_List.html#F_utilities_params">MIDAS experiment</a> to connect to.</li>
<li><b>-f</b> Filter mode. Write original events to output file only if the analyzer accepts them (doesn't return ANA_SKIP).</li>
<li><b>-h</b> &lt;hostname&gt; <a class="el" href="F_Utilities_List.html#F_utilities_params">MIDAS host</a> to connect to when running the analyzer online, connecting to a <b>remote</b> experiment.</li>
<li>-i &lt;filename1&gt; &lt;filename2&gt; Input file name. May contain a '05d' to be replaced by the run number. Up to ten input files can be specified in one "-i" statement.</li>
<li>-l If set, don't load histos from last histo file when running online.</li>
<li>-L HBOOK LREC size. Default is 8190.</li>
<li>-n &lt;count&gt; Analyze only "count" events.</li>
<li>-n &lt;first&gt; &lt;last&gt; Analyze only events from "first" to "last".</li>
<li>-n &lt;first&gt; &lt;last&gt; &lt;n&gt; Analyze every n-th event from "first" to "last".</li>
<li>-o &lt;filename&gt; Output file name. Extension may be .mid (MIDAS binary), .asc (ASCII) or .rz (HBOOK). If the name contains a '05d', one output file is generated for each run. Use "OFLN" as output file name to creaate a HBOOK shared memory instead of a file.</li>
<li>-p &lt;param=value&gt; Set individual <a class="el" href="structparameters.html">parameters</a> to a specific value. Overrides any setting in configuration files</li>
<li>-P &lt;ODB tree&gt; Protect an ODB subtree from being overwritten with the online data when ODB gets loaded from .mid file</li>
<li>-q Quiet flag. If set, don't display run progress in offline mode.</li>
<li>-r &lt;range&gt; Range of run numbers to analyzer like "-r 120 125" to analyze runs 120 to 125 (inclusive). The "-r" flag must be used with a '05d' in the input file name.</li>
<li>-s &lt;port#&gt; Specify the ROOT server TCP/IP port number (default 9090).</li>
<li>-v Verbose output.</li>
<li>-w Produce row-wise N-tuples in outpur .rz file. By default, column-wise N-tuples are used.</li>
</ul>
</li>
<li><b> Remarks </b><ul>
<li>The creation of the <b><a class="el" href="experim_8h.html">experim.h</a></b> is done through the <a class="el" href="RC_odbedit_examples.html#RC_odbedit_make">odbedit make</a> command.</li>
</ul>
</li>
</ul>
<ul>
<li><b> Usage </b> <div class="fragment"><pre class="fragment">  &gt;analyzer
  &gt;analyzer -D -r 9092
  &gt;analyzer -i run00023.mid -o run00023.rz -w
  &gt;analyzer -i run%05d.mid -o runall.rz -r 23 75 -w 
</pre></div></li>
</ul>
<p><br/>
<hr/>
<br/>
 <a class="anchor" id="idx_analyzer_HBOOK"></a> <a class="anchor" id="idx_analyzer_PAW"></a> <a class="anchor" id="idx_analyzer_ROOT"></a> <a class="anchor" id="idx_analyzer_MIDAS"></a> <a class="anchor" id="idx_analyzer_demo"></a> </p>
<h2><a class="anchor" id="DA_Midas_Analyzer">
MIDAS Analyzer</a></h2>
<ul>
<li>The MIDAS Analyzer application is composed of a collection of files providing a framework in which the user can gain access to the online data during data acquisition or offline data through a replay of a stored data save-set.</li>
</ul>
<ul>
<li>The analyzer core code is <b>mana.c</b>.</li>
</ul>
<ul>
<li>The MIDAS distribution contains 2 directories where predefined set of analyzer files and their corresponding working demo code are available. The internal functionality of both example is similar and differ only on the histogram tool used for the data representation. These analyzer set are specific to 2 major data analysis tools i.e: <b>ROOT</b>, <b>HBOOK:</b> <ul>
<li><b>examples/experiment</b>: Analyzer tailored towards <b>ROOT</b> analysis</li>
<li><b>examples/hbookexpt</b>: Analyzer tailored towards <b>HBOOK</b> with <b>PAW</b>.</li>
</ul>
</li>
</ul>
<ul>
<li>The purpose of the demo analyzer is to demonstrate the analyzer structure and to provide the user a set of code "templates" for further development. The demo will run online or offline following the information given further down. The analysis goal is to:<ol type="a">
<li>Initialize the ODB with predefined (user specific) structure (<a class="el" href="experim_8h.html">experim.h</a>).</li>
<li>Allocate memory space for histogram definition (booking).</li>
<li>Acquire data from the frontend (or data file).</li>
<li>Process the incoming data bank(s) event-by-event through user specific code (module).</li>
<li>Generate computed quantitied banks (in module).</li>
<li>Fill (increment) predefined histogram with data available within the user code.</li>
<li>Produce a result file containing histogram results and computed data (if possible) for further replay through dedicated analysis tool (PAW, ROOT).</li>
</ol>
</li>
</ul>
<ul>
<li>The analyzer is structured with the following files:<ul>
<li><a class="el" href="experim_8h.html">experim.h</a><ul>
<li>ODB experiment include file defining the ODB structure required by the analyzer.</li>
</ul>
</li>
<li><a class="el" href="analyzer_8c.html">analyzer.c</a>: main user core code.<ul>
<li>Defines the incoming bank structures</li>
<li>Defines the analyzer modules</li>
<li>Initialize the ODB structure requirements</li>
<li>Provides Begin_of_Run and End_of_Run functions with run info logging example.</li>
</ul>
</li>
<li><a class="el" href="adccalib_8c.html">adccalib.c</a>, <a class="el" href="adcsum_8c.html">adcsum.c</a>, <a class="el" href="scaler_8c.html">scaler.c</a> (Root example)<ul>
<li>Three user analysis modules to where events from the demo <a class="el" href="frontend_8c.html">frontend.c</a> sends data to.</li>
</ul>
</li>
<li><b>Makefile</b> <ul>
<li>Specific makefile for building the corresponding frontend and analyzer code. The frontend code is build against the <b>camacnul.c</b> driver providing a simulated data stream.</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><b>ROOT</b> histogram booking code (excerpt of <a class="el" href="adcsum_8c.html">experiment/adcsum.c</a>)<ul>
<li><a class="anchor" id="Folder"></a> Histogram under ROOT is supported from version 1.9.5. This provides a cleaner way to organize the histogram grouping. This functionality is implemented with the function open_subfolder() and close_subfolder(). Dedicated Macro is also now available for histogram booking. <div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="adcsum_8c.html#a51c765a64de2c9724513173b04621120">adc_summing_init</a>(<span class="keywordtype">void</span>)
{
   <span class="comment">/* book ADC sum histo */</span>
   <a class="code" href="adcsum_8c.html#aba6afd881740f71b5a57bd2a9257b7b5">hAdcSum</a> = H1_BOOK(<span class="stringliteral">&quot;ADCSUM&quot;</span>, <span class="stringliteral">&quot;ADC sum&quot;</span>, 500, 0, 10000);

   <span class="comment">/* book ADC average in separate subfolder */</span>
   open_subfolder(<span class="stringliteral">&quot;Average&quot;</span>);
   <a class="code" href="adcsum_8c.html#a9f9e9d41dc2d6fe9be3a458841d40666">hAdcAvg</a> = H1_BOOK(<span class="stringliteral">&quot;ADCAVG&quot;</span>, <span class="stringliteral">&quot;ADC average&quot;</span>, 500, 0, 10000);
   close_subfolder();

   <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
}
</pre></div></li>
</ul>
</li>
<li><b>HBOOK</b> histogram booking code (excerpt of hbookexpt/adccalib.c) <div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="adccalib_8c.html#adf3cd7b1ae0f16be900debc52adf49da">adc_calib_init</a>(<span class="keywordtype">void</span>)
{
   <span class="keywordtype">char</span> name[256];
   <span class="keywordtype">int</span> i;

   <span class="comment">/* book CADC histos */</span>
   <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="fevmemodules_8c.html#aeac9187aeffc031aa4adaf856d17093b">N_ADC</a>; i++) {
      sprintf(name, <span class="stringliteral">&quot;CADC%02d&quot;</span>, i);
      HBOOK1(ADCCALIB_ID_BASE + i, name, <a class="code" href="adccalib_8c.html#a00d3bd7d1b0b20922574469f786fb42b">ADC_N_BINS</a>,
             (<span class="keywordtype">float</span>) <a class="code" href="adccalib_8c.html#a5bc8020f1ec2ea1e071ec2e45748ac52">ADC_X_LOW</a>, (<span class="keywordtype">float</span>) <a class="code" href="adccalib_8c.html#aba2e3a40c26f6a8950bb6428e4a28818">ADC_X_HIGH</a>, 0.f);
   }

   <span class="keywordflow">return</span> <a class="code" href="group__err21.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;
}
</pre></div></li>
</ul>
<ul>
<li>The build is also specific to the type of histogram package involved and requires the proper libraries to generate the executable. Each directory has its own <b>Makefile:</b> <ul>
<li><b>ROOT</b> (examples/experiment)<ul>
<li>The environment variable <b>$ROOTSYS</b> is expected to point to a valid ROOT installed path.</li>
<li>The analyzer build requires a MIDAS core analyzer object file which should be present in the standard midas/&lt;os&gt;/lib directory. In order to have this file <b></b>(rmana.o), the ROOTSYS had to be valid at the time of the MIDAS build too (See <a class="el" href="BuildingOptions.html#BO_HAVE_ROOT">HAVE_ROOT</a>).</li>
</ul>
</li>
<li><b>HBOOK</b> - see <a class="el" href="BuildingOptions.html#BO_HAVE_HBOOK">HAVE_HBOOK</a> (examples/hbookexpt)<ul>
<li>The analyzer build requires a MIDAS core analyzer object file which should be present in the standatd midas/&lt;os&gt;/lib directory. This file <b></b>(hmana.o) doesn't require any specific library.</li>
<li>The analyzer build requires also at that stage to have access to some of the cernlib library files (See <a class="el" href="BuildingOptions.html#BO_HAVE_HBOOK">HAVE_HBOOK</a>).</li>
</ul>
</li>
<li><b>Analyzer</b> <b>Lite</b> <ul>
<li>In the case that private histogramming or simple analyzed data storage is requested, ROOT and HBOOK can be disabled by undefining both HAVE_ROOT and HAVE_HBOOK during the build.</li>
<li>This Lite version does't require any reference to the external histogramming package. Removal of specific definition histogram statement, function call from all the demo code (<a class="el" href="analyzer_8c.html">analyzer.c</a>, <a class="el" href="adccalib_8c.html">adccalib.c</a>, <a class="el" href="adcsum_8c.html">adcsum.c</a>) needs to be done for successful build.</li>
<li>This Lite version will have no option of saving computed data from within the system analyzer framework, therefore this operation has to be performed by the user in the user code (module).</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The following <a class="el" href="DataAnalysis.html#DA_Multi_Stage_Concept">MultiStage Concept</a> section describes in more details the analyzer concept and specific of the operation of the demo.</p>
<p><a class="anchor" id="idx_analyzer_multi-stage-concept"></a> <hr/>
 <h2><a class="anchor" id="DA_Multi_Stage_Concept">
MultiStage Concept</a></h2>
<p>In order to make data analysis more flexible, a multi-stage concept has been chosen for the analyzer. A raw event is passed through several stages in the analyzer, where each stage has a specific task. The stages read part of the event, analyze it and can add the results of the analysis back to the event. Therefore each stage in the chain can read all results from previous stages. The first stages in the chain typically deal with data calibration (<a class="el" href="adccalib_8c.html">adccalib.c</a>), while the last stages contain the code which produces "physical" (<a class="el" href="adcsum_8c.html">adcsum.c</a>) results like particle energies etc. The multi stage concept allows collaborations of people to use standard modules for the calibration stages which ensures that all members deal with the identical calibrated data, while the last stages can be modified by individuals to look at different aspects of the data. The stage system makes use of the MIDAS bank system. Each stage can read existing banks from an event and add more banks with calculated data. The following picture gives an example of an analyzer consisting of three stages where the first two stages make an ADC and a MWPC calibration, respectively. They add a "Calibrated ADC" bank and a "MWPC" bank which are used by the third stage which calculates angles between particles:</p>
<center> <div align="center">
<img src="multistage.jpg" alt="multistage.jpg"/>
</div>
 </center><p>Since data is contained in MIDAS banks, the system knows how to interpret the data. By declaring a new bank name in the <a class="el" href="analyzer_8c.html">analyzer.c</a> as a possible production data bank, a simple switch in the ODB gives the option to enable the recording of this bank into the results file. The user code for each stage is contained in a "module". Each module has a begin-of-run, end-of-run and an event routine. The BOR routine is typically used to book histograms, the EOR routine can do peak fitting etc. The event routine is called for each event that is received online or off-line.</p>
<h3><a class="anchor" id="Analyzer_parameters">
Analyzer parameters</a></h3>
<p>Each analyzer has a dedicated directory in the ODB under which all the <a class="el" href="structparameters.html">parameters</a> realitve to this analyzer can be accessed. The path name is given from the "Analyzer name" specified in the <a class="el" href="analyzer_8c.html">analyzer.c</a> under the analyzer_name. In case of concurrent analyzer, make sure that no conflict in name is present. By default the name is "Analyzer". </p>
<div class="fragment"><pre class="fragment"><span class="comment">/* The analyzer name (client name) as seen by other MIDAS clients   */</span>
<span class="keywordtype">char</span> *<a class="code" href="analyzer_8c.html#ac0643332f28f071aea7b0bd6c8d49a0c">analyzer_name</a> = <span class="stringliteral">&quot;Analyzer&quot;</span>;
</pre></div><p>The ODB structure under it has the following fields </p>
<div class="fragment"><pre class="fragment">[host:expt:S]/Analyzer&gt;ls -l
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
Parameters                      DIR
Output                          DIR
Book N-tuples                   <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     1m   0   RWD  y
Bank switches                   DIR
Module switches                 DIR
ODB Load                        <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     19h  0   RWD  n
Trigger                         DIR
Scaler                          DIR
</pre></div><ul>
<li><b>Parameters</b> : Created by the analyzer, contains all references to user <a class="el" href="structparameters.html">parameters</a> section.</li>
<li><b>Output</b> : System directory providing output control of the analyzer results. <div class="fragment"><pre class="fragment">[local:midas:S]/Analyzer&gt;ls -lr output
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
Output                          DIR
    Filename                    STRING  1     256   47h  0   RWD  run01100.root
    RWNT                        <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     47h  0   RWD  n
    Histo Dump                  <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     47h  0   RWD  n
    Histo Dump Filename         STRING  1     256   47h  0   RWD  his%05d.root
    Clear histos                <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     47h  0   RWD  y
    Last Histo Filename         STRING  1     256   47h  0   RWD  last.root
    Events to ODB               <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     47h  0   RWD  y
    Global Memory Name          STRING  1     8     47h  0   RWD  ONLN
</pre></div><ul>
<li><b>Filename</b> : Replay result file name.</li>
<li><b>RWNT</b> : To be ignored for <b>ROOT</b>, N-Tuple Raw-wise data type.</li>
<li><b>Histo</b> <b>Dump</b> : Enable the saving of the run results (see next field)</li>
<li><b>Histo</b> <b>Dump</b> <b>Filename</b> : Online Result file name</li>
<li><b>Clear</b> <b>Histos</b> : Boolean flag to enable the clearing of all histograms at the begining of each run (online or offline).</li>
<li><b>Last</b> <b>Histo</b> <b>Filename</b> : Temporary results file for recovery procedure.</li>
<li><b>Event</b> <b>to</b> <b>ODB</b> : Boolean flag for debugging purpose allowing a copy of the data to be sent to the ODB at regular time interval (1 second).</li>
<li><b>Global</b> <b>Memory</b> <b>Name</b> : Shared memory name for communication between MIDAS and HBOOK. To be ignored for <b>ROOT</b> as the data sharing is done through a TCP/IP channel.</li>
</ul>
</li>
</ul>
<ul>
<li><b>Bank</b> <b>switches</b> : Contains the list of all declared banks (<a class="el" href="structBANK__LIST.html">BANK_LIST</a> in <a class="el" href="analyzer_8c.html">analyzer.c</a>) to be enabled for writing to the output result file. By default all the banks are disabled. <div class="fragment"><pre class="fragment"> [local:midas:S]/Analyzer&gt;ls <span class="stringliteral">&quot;Bank switches&quot;</span> -l
 Key name                        Type    #Val  Size  Last Opn Mode Value
 ---------------------------------------------------------------------------
 ADC0                            <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>   1     4     1h   0   RWD  0
 TDC0                            <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>   1     4     1h   0   RWD  0
 CADC                            <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>   1     4     1h   0   RWD  0
 ASUM                            <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>   1     4     1h   0   RWD  0
 SCLR                            <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>   1     4     1h   0   RWD  0
 ACUM                            <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>   1     4     1h   0   RWD  0
</pre></div></li>
<li><b>Module</b> <b>switches</b> : Contains the list of all declared module (<a class="el" href="structANA__MODULE.html">ANA_MODULE</a> in <a class="el" href="analyzer_8c.html">analyzer.c</a>) to be controlled (by default all modules are enabled) <div class="fragment"><pre class="fragment"> [local:midas:S]/Analyzer&gt;ls <span class="stringliteral">&quot;module switches&quot;</span> -l
 Key name                        Type    #Val  Size  Last Opn Mode Value
 ---------------------------------------------------------------------------
 ADC calibration                 <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     1h   0   RWD  y
 ADC summing                     <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     1h   0   RWD  y
 Scaler accumulation             <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     1h   0   RWD  y
</pre></div></li>
<li><b>ODB</b> <b>Load</b> : Boolean switch to allow retrieval of the entire ODB structure from the input data file. Used only during offline, this option permits to replay the data in the same exact condition as during online. All the ODB parameter settings will be restored to their last value as at the end of the data acquisition of this particular run.</li>
<li><b>Trigger</b>, <b>Scaler</b> : Subdirectories of all the declared requested event. (<a class="el" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> in <a class="el" href="analyzer_8c.html">analyzer.c</a>)</li>
<li><b>BOOK</b> <b>N_tuples</b> : Boolean flag for booking N-Tuples at the initialization of the module. This flag is specific to the <b>HBOOK</b> analyzer.</li>
<li><b>BOOK</b> <b>TTree</b> : Boolean flag for booking TTree at the initialization of the module. This flag is specific to the <b>ROOT</b> analyzer.</li>
</ul>
<h3><a class="anchor" id="Analyzer_module_parameters">
Analyzer Module parameters</a></h3>
<p>Each analyzer module can contain a set of <a class="el" href="structparameters.html">parameters</a> to either control its behavior, . These <a class="el" href="structparameters.html">parameters</a> are kept in the ODB under /Analyzer/Parameters/&lt;module name&gt; and mapped automatically to C structures in the analyzer modules. Changing these values in the ODB can therefore control the analyzer. In order to keep the ODB variables and the C structure definitions matched, the ODBEdit command <b>make</b> generates the file <a class="el" href="experim_8h.html">experim.h</a> which contains C structures for all the analyzer <a class="el" href="structparameters.html">parameters</a>. This file is included in all analyzer source code files and provides access to the <a class="el" href="structparameters.html">parameters</a> from within the module file under the name &lt;module name&gt;_param.</p>
<ul>
<li>Module name: adc_calib_module (extern <a class="el" href="structANA__MODULE.html">ANA_MODULE</a> adc_calib_module from <a class="el" href="analyzer_8c.html">analyzer.c</a>)</li>
<li>Module file name: <a class="el" href="adccalib_8c.html">adccalib.c</a></li>
<li>Module structure declaration in <a class="el" href="adccalib_8c.html">adccalib.c</a>: <div class="fragment"><pre class="fragment"><a class="code" href="structANA__MODULE.html">ANA_MODULE</a> <a class="code" href="analyzer_8c.html#a6316036c6b9ab6ab3d9932cfa86e1ae5">adc_calib_module</a> = {
   <span class="stringliteral">&quot;ADC calibration&quot;</span>,           <span class="comment">/* module name           */</span>
   <span class="stringliteral">&quot;Stefan Ritt&quot;</span>,               <span class="comment">/* author                */</span>
   <a class="code" href="adccalib_8c.html#a21e1931a7c367947aeec0daa9548b6e7">adc_calib</a>,                   <span class="comment">/* event routine         */</span>
   <a class="code" href="adccalib_8c.html#ad0c45258e6a5ff1cf274ca70e77cc2b1">adc_calib_bor</a>,               <span class="comment">/* BOR routine           */</span>
   <a class="code" href="adccalib_8c.html#afe5e825c262fc181d5213c0ffee2ce47">adc_calib_eor</a>,               <span class="comment">/* EOR routine           */</span>
   <a class="code" href="adccalib_8c.html#adf3cd7b1ae0f16be900debc52adf49da">adc_calib_init</a>,              <span class="comment">/* init routine          */</span>
   NULL,                        <span class="comment">/* exit routine          */</span>
   &amp;<a class="code" href="adccalib_8c.html#a5b84b1ab630f7d978e438624d9ca560a">adccalib_param</a>,             <span class="comment">/* parameter structure   */</span>
   <span class="keyword">sizeof</span>(adccalib_param),      <span class="comment">/* structure size        */</span>
   adc_calibration_param_str,   <span class="comment">/* initial parameters    */</span>
};
</pre></div><ul>
<li>ODB parameter variable in the code: &lt;module name&gt;_param -&gt; adccalib_param ( from adc_calib_module, the _ is dropped, module is removed)</li>
<li>ODB parameter path: /&lt;Analyzer&gt;/Parameters/ADC calibration/ (using the module name from the structure)</li>
<li>Access to the module parameter: <div class="fragment"><pre class="fragment">     <span class="comment">/* subtract pedestal */</span>
    <span class="keywordflow">for</span> (i = 0; i &lt; N_ADC; i++)
       cadc[i] = (<span class="keywordtype">float</span>) ((double) pdata[i] - adccalib_param.pedestal[i] + 0.5);
</pre></div></li>
<li>ODB module parameter declaration <div class="fragment"><pre class="fragment">  [local:midas:S]Parameters&gt;pwd
 /Analyzer/Parameters
 [local:midas:S]Parameters&gt;ls -lr
 Key name                        Type    #Val  Size  Last Opn Mode Value
 ---------------------------------------------------------------------------
 Parameters                      DIR
     ADC calibration             DIR
         Pedestal                <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     8     4     47h  0   RWD
                                         [0]             174
                                         [1]             194
                                         [2]             176
                                         [3]             182
                                         [4]             185
                                         [5]             215
                                         [6]             202
                                         [7]             202
         Software Gain           FLOAT   8     4     47h  0   RWD
                                         [0]             1
                                         [1]             1
                                         [2]             1
                                         [3]             1
                                         [4]             1
                                         [5]             1
                                         [6]             1
                                         [7]             1
         Histo threshold         DOUBLE  1     8     47h  0   RWD  20
     ADC summing                 DIR
         ADC threshold           FLOAT   1     4     47h  0   RWD  5
     Global                      DIR
        ADC Threshold           FLOAT   1     4     47h  0   RWD  5
</pre></div></li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="Analyzer_flow_chart">
Analyzer Flow chart</a></h3>
<p>The general operation of the analyzer can be summarized as follow:</p>
<ul>
<li>The analyzer is a MIDAS client at the same level as the odb or any other MIDAS applications.</li>
<li>When the analyzer is started with the proper argument (experiment, host for remote connection or -i input_file, -o output_file for off-line use), the initialization phase will setup the following items:<ol type="a">
<li>Setup the internal list of defined module. <div class="fragment"><pre class="fragment"> <a class="code" href="structANA__MODULE.html">ANA_MODULE</a> *<a class="code" href="analyzer_8c.html#a7fb218f74c1e8f307575341fd4d8ba3f">trigger_module</a>[] = {
    &amp;adc_calib_module,
    &amp;<a class="code" href="analyzer_8c.html#a5304a76f0819218c694defe1e049c584">adc_summing_module</a>,
    NULL
 };
</pre></div></li>
<li>Setup the internal list of banks. <div class="fragment"><pre class="fragment"> <a class="code" href="structBANK__LIST.html">BANK_LIST</a> <a class="code" href="analyzer_8c.html#ad663afbb61c41483d6641b5062974689">ana_trigger_bank_list</a>[] = {
 
    <span class="comment">/* online banks */</span>
    {<span class="stringliteral">&quot;ADC0&quot;</span>, <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>, <span class="keyword">sizeof</span>(ADC0_BANK), ana_adc0_bank_str}
    ,
    {<span class="stringliteral">&quot;TDC0&quot;</span>, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, <a class="code" href="fevmemodules_8c.html#a7e9c82b300255f54b1528c66fdcdfafd">N_TDC</a>, NULL}
    , ...
</pre></div></li>
<li>Define the internal event request structure and attaching the corresponding module and bank list. <div class="fragment"><pre class="fragment">   <a class="code" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> <a class="code" href="analyzer_8c.html#ab1be3d7f64edcbf386bfd220bc7bda9b">analyze_request</a>[] = {
   {<span class="stringliteral">&quot;Trigger&quot;</span>,                  <span class="comment">/* equipment name */</span>
    {1,                         <span class="comment">/* event ID */</span>
     <a class="code" href="group__mdefineh.html#ga26aa4bcea89857cb7ca669339695ceac">TRIGGER_ALL</a>,               <span class="comment">/* trigger mask */</span>
     GET_SOME,                  <span class="comment">/* get some events */</span>
     <span class="stringliteral">&quot;SYSTEM&quot;</span>,                  <span class="comment">/* event buffer */</span>
     TRUE,                      <span class="comment">/* enabled */</span>
     <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>,}
    ,
    NULL,                       <span class="comment">/* analyzer routine */</span>
    trigger_module,             <span class="comment">/* module list */</span>
    ana_trigger_bank_list,      <span class="comment">/* bank list */</span>
    1000,                       <span class="comment">/* RWNT buffer size */</span>
    TRUE,                       <span class="comment">/* Use tests for this event */</span>
    }
   , ...
</pre></div></li>
<li>Setup the ODB path for each defined module.</li>
<li>Book the defined histograms of each module.</li>
<li>Book memory for N-Tuples or TTree.</li>
<li>Initialize the internal "hotlinks" to the defined ODB analyzer module parameter path.<ul>
<li>Once the analyzer is in idle state (for online only), it will wakeup on the transition "Begin-of-Run" and go sequencially through all the modules BOR functions. which generally will ensure proper histogramming booking and possible clearing. It will resume its idle state waiting for the arrival of an event matching one of the event request structure declared during initialization (<a class="el" href="analyzer_8c.html">analyzer.c</a>)</li>
</ul>
</li>
</ol>
<ul>
<li>In case of off-line analysis, once the initialization phase successfully complete, it will go through the BOR and start the event-by-event acquisition. <div class="fragment"><pre class="fragment"> <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="analyzer_8c.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init</a>()
 {
   HNDLE <a class="code" href="mfe_8c.html#ab1f60c53f74e806a3b9f687af38d7421">hDB</a>, <a class="code" href="mevb_8c.html#a8cd567d23219ba7fc83280cf20caf1c2">hKey</a>;
   <span class="keywordtype">char</span> str[80];

   <a class="code" href="group__modbh.html#gae26d58f1036d07ca15fc73a991ccadc2">RUNINFO_STR</a>(runinfo_str);
   <a class="code" href="experim_8h.html#a71c259065113884e6324e46c807d0967">EXP_PARAM_STR</a>(exp_param_str);
   <a class="code" href="experim_8h.html#a9ec317a7e9b2c6bbe11279b5c63d3596">GLOBAL_PARAM_STR</a>(global_param_str);
   <a class="code" href="experim_8h.html#aba8c5b4adf8180aae43451def4ed3c0c">TRIGGER_SETTINGS_STR</a>(trigger_settings_str);

   <span class="comment">/* open ODB structures */</span>
   <a class="code" href="group__cmfunctionc.html#ga16b33b70783a3f5ba98b4094149d12b7">cm_get_experiment_database</a>(&amp;hDB, NULL);
   <a class="code" href="group__odbfunctionc.html#ga59b971e77416b2b463e2e63f1b05342b">db_create_record</a>(hDB, 0, <span class="stringliteral">&quot;/Runinfo&quot;</span>, strcomb(runinfo_str));
   <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(hDB, 0, <span class="stringliteral">&quot;/Runinfo&quot;</span>, &amp;hKey);
   <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga852bc9fa8ee4d0884b328aeb0b0cfd63">db_open_record</a>(hDB, hKey, &amp;<a class="code" href="analyzer_8c.html#ade46d29add32a0b6910ebc8da0fea69b">runinfo</a>, <span class="keyword">sizeof</span>(<a class="code" href="analyzer_8c.html#ade46d29add32a0b6910ebc8da0fea69b">runinfo</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL) !=
     <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
    <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;analyzer_init&quot;</span>, <span class="stringliteral">&quot;Cannot open \&quot;/Runinfo\&quot; tree in ODB&quot;</span>);
    <span class="keywordflow">return</span> 0;
   }
</pre></div></li>
</ul>
<ol type="a">
<li>When an event is received and matches one the the event request structure, it is passed in sequence to all the defined module for that event request (see in the ANALYZER_REQUEST structure the line containing the comment module list.<ul>
<li>If some of the module don't need to be invoked by the incoming event, it can be disabled interactively through ODB from the /analyzer/Module switches directory <div class="fragment"><pre class="fragment">   [ladd00:p3a:Stopped]Module switches&gt;ls
   ADC calibration                 y
   ADC summing                     y
   Scaler accumulation             y
   [ladd00:p3a:Stopped]Module switches&gt;
</pre></div></li>
<li>if the module switch is enabled, the event will be presented in the module at the defined event-by-event function declared in the module structure (<a class="el" href="adccalib_8c.html">adccalib.c</a>) in this case the function is <a class="el" href="adccalib_8c.html#a21e1931a7c367947aeec0daa9548b6e7">adc_calib()</a>.</li>
<li>The MIDAS event header is accessible through the pointer <b>pheader</b> while the data is located by the pointer <b>pevent</b> <div class="fragment"><pre class="fragment">  <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="adccalib_8c.html#a21e1931a7c367947aeec0daa9548b6e7">adc_calib</a>(<a class="code" href="structEVENT__HEADER.html">EVENT_HEADER</a> * pheader, <span class="keywordtype">void</span> *pevent)
  {
   <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> i;
   <a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> *pdata;
   <span class="keywordtype">float</span> *cadc;

   <span class="comment">/* look for ADC0 bank, return if not present */</span>
   <span class="keywordflow">if</span> (!<a class="code" href="group__bkfunctionc.html#gafe085ddb11bdcff4ca461224254289ef">bk_locate</a>(pevent, <span class="stringliteral">&quot;ADC0&quot;</span>, &amp;pdata))
    <span class="keywordflow">return</span> 1;
</pre></div></li>
</ul>
</li>
</ol>
</li>
</ul>
<ul>
<li>Refer to the example found under <b>examples/experiment</b> directory for <b>ROOT</b> analyzer and <b>examples/hbookexpt</b> directory for <b>HBOOK</b> analyzer.</li>
</ul>
<h3><a class="anchor" id="HBOOK_analyzer">
HBOOK analyzer description (old doc)</a></h3>
<p>PAWC_DEFINE(8000000);</p>
<p>This defines a section of 8 megabytes or 2 megawords of share memory for HBOOK/MIDAS data storage. This definition is found in <a class="el" href="analyzer_8c.html">analyzer.c</a>. In case many histograms are booked in the user code, this value probably has to be increased in order not to crash HBOOK. If the analyzer runs online, the section is kept in shared memory. In case the operating system only supports a smaller amount of shared memory, this value has to be decreased. Next, the file contains the analyzer name</p>
<p>char *analyzer_name = "Analyzer";</p>
<p>under which the analyzer appears in the ODB (via the ODBEdit command scl). This also determines the analyzer root tree name as /Analyzer. In case several analyzers are running simultaneously (in case of distributed analysis on different machines for example), they have to use different names like Analyzer1 and Analyzer2 which then creates two separate ODB trees /Analyzer1 and /Analyzer2 which is necessary to control the analyzers individually. Following structures are then defined in <a class="el" href="analyzer_8c.html">analyzer.c</a>: runinfo, global_param, exp_param and trigger_settings. They correspond to the ODB trees /Runinfo, /Analyzer/Parameters/Global, /Experiment/Run <a class="el" href="structparameters.html">parameters</a> and /Equipment/Trigger/Settings, respectively. The mapping is done in the <a class="el" href="analyzer_8c.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init()</a> routine. Any analyzer module (via an extern statement) can use the contents of these structures. If the experiment <a class="el" href="structparameters.html">parameters</a> contain an flag to indicate the run type for example, the analyzer can analyze calibration and data runs differently. The module declaration section in <a class="el" href="analyzer_8c.html">analyzer.c</a> defines two "chains" of modules, one for trigger events and one for scaler events. The framework calls these according to their order in these lists. The modules of type <a class="el" href="structANA__MODULE.html">ANA_MODULE</a> are defined in their source code file. The enabled flag for each module is copied to the ODB under /Analyzer/Module switches. By setting this flag zero in the ODB, modules can be disabled temporarily. Next, all banks have to be defined. This is necessary because the framework automatically books N-tuples for all banks at startup before any event is received. Online banks which come from the frontend are first defined, then banks created by the analyzer: </p>
<div class="fragment"><pre class="fragment"> ...
 <span class="comment">// online banks </span>
 { <span class="stringliteral">&quot;ADC0&quot;</span>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, N_ADC, NULL },
 { <span class="stringliteral">&quot;TDC0&quot;</span>, <a class="code" href="group__mdefineh.html#gafed9e8d519719d7347f9fdb3031201d1">TID_DWORD</a>, <a class="code" href="fevmemodules_8c.html#a7e9c82b300255f54b1528c66fdcdfafd">N_TDC</a>, NULL },

 <span class="comment">// calculated banks  </span>
 { <span class="stringliteral">&quot;CADC&quot;</span>, <a class="code" href="group__mdefineh.html#gae932ec1b283f6c4b9c30a6d489beea7f">TID_FLOAT</a>, N_ADC, NULL },
 { <span class="stringliteral">&quot;ASUM&quot;</span>, <a class="code" href="group__mdefineh.html#ga8d82076a05b53876103e1c53d5878b75">TID_STRUCT</a>, <span class="keyword">sizeof</span>(<a class="code" href="structASUM__BANK.html">ASUM_BANK</a>),
  asum_bank_str },
</pre></div><p>The first entry is the bank name, the second the bank type. The type has to match the type which is created by the frontend. The type TID_STRUCT is a special bank type. These banks have a fixed length which matches a C structure. This is useful when an analyzer wants to access named variables inside a bank like asum_bank.sum. The third entry is the size of the bank in bytes in case of structured banks or the maximum number of items (not bytes!) in case of variable length banks. The last entry is the ASCII representation of the bank in case of structured banks. This is used to create the bank on startup under /Equipment/Trigger/Variables/&lt;bank name&gt;.</p>
<p>The next section in <a class="el" href="analyzer_8c.html">analyzer.c</a> defines the <a class="el" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> list. This determines which events are received and which routines are called to analyze these events. A request can either contain an "analyzer routine" which is called to analyze the event or a "module list" which has been defined above. In the latter case all modules are called for each event. The requests are copied to the ODB under /Analyzer/&lt;equipment name&gt;/Common. Statistics like number of analyzed events is written under /Analyzer/&lt;equipment name&gt;/Statistics. This scheme is very similar to the frontend Common and Statistics tree under /Equipment/&lt;equipment name&gt;/. The last entry of the analyzer request determines the HBOOK buffer size for online N-tuples. The <a class="el" href="analyzer_8c.html#afeea792d4dbe0001bd025397e494ab5b">analyzer_init()</a> and <a class="el" href="analyzer_8c.html#a7738840c25fb678186362479850b4df6">analyzer_exit()</a> routines are called when the analyzer starts or exits, while the <a class="el" href="analyzer_8c.html#a22c6bd312e4f7ffd79162e64835cfd42">ana_begin_of_run()</a> and <a class="el" href="analyzer_8c.html#a8e03cbe2637bd6f4488a659c9f23d29e">ana_end_of_run()</a> are called at the beginning and end of each run. The <a class="el" href="analyzer_8c.html#a8e03cbe2637bd6f4488a659c9f23d29e">ana_end_of_run()</a> routine in the example code writes a <a class="anchor" id="DA_run_log_file"></a> run log file <b>runlog.txt</b> which contains the current time, run number, run start time and number of received events.</p>
<p>If more <a class="el" href="structparameters.html">parameters</a> are necessary, perform the following procedure:</p>
<ol type="1">
<li>modify/add new <a class="el" href="structparameters.html">parameters</a> in the current ODB. <div class="fragment"><pre class="fragment">[host:expt:S]ADC calibration&gt;<span class="keyword">set</span> Pedestal[9] 3
[host:expt:S]ADC calibration&gt;<span class="keyword">set</span> <span class="stringliteral">&quot;Software Gain[9]&quot;</span> 3
[host:expt:S]ADC calibration&gt;create <span class="keywordtype">double</span> <span class="stringliteral">&quot;Upper threshold&quot;</span>
[host:expt:S]ADC calibration&gt;<span class="keyword">set</span> <span class="stringliteral">&quot;Upper threshold&quot;</span> 400
[host:expt:S]ADC calibration&gt;ls -lr
Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
ADC calibration                 DIR
    Pedestal                    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     10    4     2m   0   RWD
                                        [0]             174
                                        [1]             194
                                        [2]             176
                                        [3]             182
                                        [4]             185
                                        [5]             215
                                        [6]             202
                                        [7]             202
                                        [8]             0
                                        [9]             3
    Software Gain               FLOAT   10    4     2m   0   RWD
                                        [0]             1
                                        [1]             1
                                        [2]             1
                                        [3]             1
                                        [4]             1
                                        [5]             1
                                        [6]             1
                                        [7]             1
                                        [8]             0
                                        [9]             0
    Histo threshold             DOUBLE  1     8     53m  0   RWD  20
    Upper threshold             DOUBLE  1     4     3s   0   RWD  400
</pre></div></li>
<li>Generate <a class="el" href="experim_8h.html">experim.h</a> <div class="fragment"><pre class="fragment">[host:expt:S]ADC calibration&gt;make
<span class="stringliteral">&quot;experim.h&quot;</span> has been written to /home/midas/online
</pre></div></li>
<li>Update the module with the new <a class="el" href="structparameters.html">parameters</a>. <div class="fragment"><pre class="fragment">---&gt; adccalib.c
...
fill ADC histos <span class="keywordflow">if</span> above threshold 
<span class="keywordflow">for</span> (i=0 ; i&lt;n_adc ; i++)
<span class="keywordflow">if</span> ((cadc[i] &gt; (<span class="keywordtype">float</span>) adccalib_param.histo_threshold)
 &amp;&amp; (cadc[i] &lt; (<span class="keywordtype">float</span>) adccalib_param.upper_threshold))
    HF1(ADCCALIB_ID_BASE+i, cadc[i], 1.f);
</pre></div></li>
<li>Rebuild the analyzer.</li>
</ol>
<p>In the case global parameter is necessary for several modules, start by doing the step 1 &amp; 2 from the enumeration above and carry on with the following procedure below:</p>
<ol type="1">
<li>Declare the parameter global in <a class="el" href="analyzer_8c.html">analyzer.c</a> <div class="fragment"><pre class="fragment"><span class="comment">// ODB structures </span>
...
GLOBAL_PARAM     <a class="code" href="analyzer_8c.html#a458ba14b3bed4beeb1e079a0e0aa8eca">global_param</a>;
...
</pre></div></li>
<li>Update ODB structure and open record for that parameter (hot link). <div class="fragment"><pre class="fragment">---&gt; analyzer.c
...
sprintf(str, <span class="stringliteral">&quot;/%s/Parameters/Global&quot;</span>, analyzer_name);
<a class="code" href="group__odbfunctionc.html#ga59b971e77416b2b463e2e63f1b05342b">db_create_record</a>(hDB, 0, str, strcomb(global_param_str));
<a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(hDB, 0, str, &amp;hKey);
<span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga852bc9fa8ee4d0884b328aeb0b0cfd63">db_open_record</a>(hDB, hKey, &amp;<a class="code" href="analyzer_8c.html#a458ba14b3bed4beeb1e079a0e0aa8eca">global_param</a>
    , <span class="keyword">sizeof</span>(<a class="code" href="analyzer_8c.html#a458ba14b3bed4beeb1e079a0e0aa8eca">global_param</a>), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>, NULL, NULL) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>) {
  <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;analyzer_init&quot;</span>, <span class="stringliteral">&quot;Cannot open \&quot;%s\&quot; tree in ODB&quot;</span>, str);
  <span class="keywordflow">return</span> 0;
}
</pre></div></li>
<li>Declare the parameter <b>extern</b> in the required module <div class="fragment"><pre class="fragment">---&gt; adccalib.c
...
extern <a class="code" href="structGLOBAL__PARAM.html">GLOBAL_PARAM</a>  <a class="code" href="analyzer_8c.html#a458ba14b3bed4beeb1e079a0e0aa8eca">global_param</a>;
...
</pre></div></li>
</ol>
<h3><a class="anchor" id="PAW_Online_usage">
Online usage with PAW</a></h3>
<p>Once the analyzer is build, run it by entering: <b> analyzer [-h &lt;host name&gt;] [-e &lt;exp name&gt;] </b></p>
<p>where &lt;host name&gt; and &lt;exp name&gt; are optional <a class="el" href="structparameters.html">parameters</a> to connect the analyzer to a remote back-end computer. This attaches the analyzer to the ODB, initializes all modules, creates the PAW shared memory and starts receiving events from the system buffer. Then start PAW and connect to the shared memory and display its contents</p>
<div class="fragment"><pre class="fragment">PAW &gt; global_s onln
PAW &gt; hist/list
    1  Trigger
    2  Scaler
 1000  CADC00
 1001  CADC01
 1002  CADC02
 1003  CADC03
 1004  CADC04
 1005  CADC05
 1006  CADC06
 1007  CADC07
 2000  ADC sum
</pre></div><p>For each equipment, a N-tuple is created with a N-tuple ID equal to the event ID. The CADC histograms are created from the <a class="el" href="adccalib_8c.html#ad0c45258e6a5ff1cf274ca70e77cc2b1">adc_calib_bor()</a> routine in <a class="el" href="adccalib_8c.html">adccalib.c</a>. The N-tuple contents is derived from the banks of the trigger event. Each bank has a switch under /Analyzer/Bank switches. If the switch is on (1), the bank is contained in the N-tuple. The switches can be modified during runtime causing the N-tuples to be rebooked. The N-tuples can be plotted with the standard PAW commands:</p>
<div class="fragment"><pre class="fragment">PAW &gt; nt/print 1
...
PAW &gt; nt/plot 1.sum
PAW &gt; nt/plot 1.sum cadc0&gt;3000
</pre></div><center> <div align="center">
<img src="paw01.jpg" alt="paw01.jpg"/>
</div>
 </center><p>While histograms contain the full statistics of a run, N-tuples are kept in a ring-buffer. The size of this buffer is defined in the <a class="el" href="structANALYZE__REQUEST.html">ANALYZE_REQUEST</a> structure as the last parameter. A value of 10000 creates a buffer which contains N-tuples for 10000 events. After 10000 events, the first events are overwritten. If the value is increased, it might be that the PAWC size (PAWC_DEFINE in <a class="el" href="analyzer_8c.html">analyzer.c</a>) has to be increased, too. An advantage of keeping the last 10000 events in a buffer is that cuts can be made immediately without having to wait for histograms to be filled. On the other hand care has to be taken in interpreting the data. If modifications in the hardware are made during a run, events which reflect the modifications are mixed with old data. To clear the ring-buffer for a N-tuple or a histogram during a run, the ODBEdit command <b> [local]/&gt;hi analyzer &lt;id&gt; </b></p>
<p>where &lt;id&gt; is the N-tuple ID or histogram ID. An ID of zero clears all histograms but no N-tuples. The analyzer has two more ODB switches of interest when running online. The /Analyzer/Output/Histo Dump flag and /Analyzer/Output/Histo Dump Filename determine if HBOOK histograms are written after a run. This file contains all histograms and the last ring-buffer of N-tuples. It can be read in with PAW:</p>
<div class="fragment"><pre class="fragment">PAW &gt;hi/file 1 run00001.rz 8190
PAW &gt; ldir
</pre></div><p>The /Analyzer/Output/Clear histos flag tells the analyzer to clear all histograms and N-tuples at the beginning of a run. If turned off, histograms can be accumulated over several runs.</p>
<h3><a class="anchor" id="PAW_Offline_usage">
Offline usage with PAW</a></h3>
<p>The analyzer can be used for off-line analysis without recompilation. It can read from MIDAS binary files (*.mid), analyze the data the same way as online, and the write the result to an output file in MIDAS binary format, ASCII format or HBOOK RZ format. If written to a RZ file, the output contains all histograms and N-tuples as online, with the difference that the N-tuples contain all events, not only the last 10000. The contents of the N-tuples can be a combination of raw event data and calculated data. Banks can be turned on and off in the output via the /Analyzer/Bank switches flags. Individual modules can be activated/deactivated via the /Analyzer/Module switches flags.</p>
<p>The RZ files can be analyzed and plotted with PAW. Following flags are available when the analyzer is started off-line:</p>
<ul>
<li>-i [filename1] [filename2] ... Input file name(s). Up to ten different file names can be specified in a -i statement. File names can contain the sequence "%05d" which is replaced with the current run number in conjunction with the -r flag. Following filename extensions are recognized by the analyzer: .mid (MIDAS binary), .asc (ASCII data), .mid.gz (MIDAS binary gnu-zipped) and .asc.gz (ASCII data gnu-zipped). Files are un-zipped on-the-fly.</li>
<li>-o [filename] Output file name. The file names can contain the sequence "%05d" which is replaced with the current run number in conjunction with the -r flag. Following file formats can be generated: .mid (MIDAS binary), .asc (ASCII data), .rz (HBOOK RZ file), .mid.gz (MIDAS binary gnu-zipped) and .asc.gz (ASCII data gnu-zipped). For HBOOK files, CWNT are used by default. RWNT can be produced by specifying the -w flag. Files are zipped on-the-fly.</li>
<li>-r [range] Range of run numbers to be analyzed like -r 120 125 to analyze runs 120 to 125 (inclusive). The -r flag must be used with a "%05d" in the input file name.</li>
<li>-n [count] Analyze only count events. Since the number of events for all event types is considered, one might get less than count trigger events if some scaler or other events are present in the data.</li>
<li>-n [first] [last] Analyze only events with serial numbers between first and last.</li>
<li>-n [first] [last] [n] Analyze every n-th event from first to last.</li>
<li>-c [filename1] [filename2] ... Load configuration file name(s) before analyzing a run. File names may contain a "%05d" to be replaced with the run number. If more than one file is specified, <a class="el" href="structparameters.html">parameters</a> from the first file get superseded from the second file and so on. Parameters are stored in the ODB and can be read by the analyzer modules. They are conserved even after the analyzer has stopped. Therefore, only <a class="el" href="structparameters.html">parameters</a> which change between runs have to be loaded every time. To set a parameter like /Analyzer/Parameters/ADC summing/offset one would load a configuration file which contains: <div class="fragment"><pre class="fragment"> [Analyzer/Parameters/ADC summing]
Offset = FLOAT : 123
</pre></div> Loaded <a class="el" href="structparameters.html">parameters</a> can be inspected with ODBEdit after the analyzer has been started.</li>
<li>-p [param=value] Set individual <a class="el" href="structparameters.html">parameters</a> to a specific value. Overrides any setting in configuration files. Parameter names are relative to the /Analyzer/Parameters directory. To set the key /Analyzer/Parameters/ADC summing/offset to a specific value, one uses -p "ADC summing/offset"=123. The quotation marks are necessary since the key name contains a blank. To specify a parameter which is not under the /Analyzer/Parameters tree, one uses the full path (including the initial "/") of the parameter like -p "/Experiment/Run Parameters/Run mode"=1.</li>
<li>-w Produce row-wise N-tuples in output RZ file. By default, column-wise N-tuples are used.</li>
<li>-v Convert only input file to output file. Useful for format conversions. No data analysis is performed.</li>
<li>-d Debug flag when started the analyzer from a debugger. Prevents the system to kill the analyzer when the debugger stops at a breakpoint.</li>
</ul>
<p><br/>
<hr/>
<br/>
</p>
<h2><a class="anchor" id="DA_Byte_Swap_Macros">
Byte Swap Macros</a></h2>
<p>These Macros can be used in the backend analyzer for <b>BYTE swap manipulation</b></p>
<p>when <b> little-endian/big-endian </b> are mixed in the event.</p>
<ul>
<li><a class="el" href="group__msmacroh.html#ga4670ac841b4b8e3c3141a91a743bc61d">WORD_SWAP</a></li>
<li><a class="el" href="group__msmacroh.html#gadb40ea04e4e009bbde68c027a8f95039">DWORD_SWAP</a></li>
<li><a class="el" href="group__msmacroh.html#ga8c6db33e3f8af89e87556d9f7a9b32a8">QWORD_SWAP</a></li>
</ul>
<p><a class="anchor" id="end"></a></p>
<p><br/>
  
<script type="text/javascript">
// pages parameters: back index next {top bottom}
pages("FE_utils","DataAnalysis", "Performance","DataAnalysis","" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("FrontendOperation","DataAnalysis","Performance"); // last section; top of this section; next section
</script>
 </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

