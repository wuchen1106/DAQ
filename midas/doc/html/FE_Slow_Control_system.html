<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: Slow Control System</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="FrontendOperation.html">SECTION 6: Frontend Operation</a>&nbsp;&raquo&nbsp;<a class="el" href="Frontend_code.html">Frontend code</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="FE_Slow_Control_system">Slow Control System </a></h1><p><a class="anchor" id="idx_slow-control_system"></a> <br/>
  
 
<script type="text/javascript">
pages("FE_Event_Builder", "FrontendOperation","FE_event_buffer_size","FE_Slow_Control_system", "end" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("RunControl","FrontendOperation","DataAnalysis");
</script>
<p><br/>
</p>
<p>Slow Control Systems are used for setup and monitoring of hardware that is not time-critical, and can be run at a low priority. Slow Control systems in a typical experiment are often used to setup and/or monitor components such as high voltage modules, temperature sensors, pressure gauges, leak detectors, RF generators, PID controllers etc. often from a large number of hardware vendors.</p>
<p>In the Midas Slow Control System, instead of talking directly to each other, frontend and control programs exchange information through the ODB. If several types of hardware are to be included in a Slow Control System, they may be assigned to a separate Slow Control Equipments. Each Slow Control Equipment is assigned a corresponding ODB subtree under <span class="odb">/Equipment</span>. This tree contains variables needed to control the equipment as well as variables measured by the equipment.</p>
<p>In the case of a high voltage equipment this is</p>
<ul>
<li>a <b>Demand</b> array which contains voltages to be set,</li>
<li>a <b>Measured</b> array which contains read back voltages and</li>
<li>a <b>Current</b> array which contains the current drawn from each channel.</li>
</ul>
<p>To change the voltage of a channel, a control program writes the desired value to the Demand array. This array is connected to the high voltage frontend via an ODB <a class="el" href="RC_Hot_Link.html">hot-link</a>. Each time the Demand value is modified, the frontend receives a notification and sets the new value. In the other direction, the frontend continuously reads the voltage and current values from all channels and updates the appropriate ODB array(s) if there has been a significant change.</p>
<p>This design has a possible drawback due to the fact that the ODB is the key element of that control. Any failure or corruption of the database can result in incorrect driver control. Therefore it is not recommended to use this system to control systems that need redundancy for safety purposes. On the other hand, this system has several advantages:</p>
<ul>
<li>The control program does not need any knowledge of the frontend, it only talks to the ODB.</li>
<li>The control variables only exist at one place that guarantees consistency among all clients.</li>
<li>Basic control can be done through <a class="el" href="RC_odbedit_utility.html">ODBEdit</a> (or using mhttpd <a class="el" href="RC_mhttpd_ODB_page.html">ODB page</a>) without the need of a special control program.</li>
<li>A special control program can be tested without having a frontend running.</li>
<li>In case of n frontend and m control programs, only n+m network connections are needed instead of n*m connection for point-to-point connections.</li>
</ul>
<p>Since all slow control values are contained in the ODB, they are automatically dumped to the logging channels. The slow control frontend uses the same framework as the normal frontend, and behaves similarly in many respects. They also create periodic events that contain the slow control variables and are logged together with trigger and scaler events. The only difference is that a routine is called periodically from the framework that has the task of reading channels and updating the ODB. <br/>
 <a class="anchor" id="idx_slow-control_drivers"></a> To access slow control hardware, a two-layer driver concept is used. The upper layer is a <b>"class driver"</b>, which establishes the connection to the ODB variables and contains high level functionality like channel limits, ramping etc. It uses a <b>"device driver"</b> to access the channels. These drivers implement only very simple commands like "set channel" and "read channel". The device drivers themselves can use bus drivers like RS232 or GPIB to control the actual device.</p>
<center> <span class="image"> Class driver, Device and Bus driver in the slow control system <br/>
<br/>
<br/>
 </p>
<div align="center">
<img src="classes2.jpg" alt="classes2.jpg"/>
</div>
<p> </span></center><p> <br/>
<br/>
<br/>
</p>
<p>The separation into class and device drivers has the advantage that it is very easy to add new devices, because only the simple device driver needs to be written. All higher functionality is inherited from the class driver. The device driver can implement richer functionality, depending on the hardware. For some high voltage devices there is a current read-back for example. This is usually reflected by additional variables in the ODB, i.e. a Current array. Frontend equipment uses exactly one class driver, but a class driver can use more than one device driver. This makes it possible to control several high voltage devices for example with one frontend in one equipment. The number of channels for each device driver is defined in the slow control frontend. Several equipments with different class drivers can be defined in a single frontend.</p>
<p>Slow Control variables can be accessed later through the web using the mhttpd <a class="el" href="RC_mhttpd_Equipment_page.html">Equipment page</a> and <span class="new"> the new <a class="el" href="RC_mhttpd_MSCB_page.html">MSCB Page</a> (since <a class="el" href="NDF.html#ndf_dec_2009">Dec 2009</a>) </span>.</p>
<p>This can be done by setting the variable names under the <span class="odb">Settings</span> subdirectory of the corresponding Equipment in the ODB. The variable description is given under <a class="el" href="F_History_logging.html#F_History_System">MIDAS History System</a> . The <a class="el" href="RC_mhttpd_History_page.html">History page</a> will also be automatically activated if the <a class="el" href="F_Logging.html#F_mlogger_utility">mlogger utility</a> is running.</p>
<div class="fragment"><pre class="fragment">Key name                        Type    #Val  Size  Last Opn Mode Value
---------------------------------------------------------------------------
Epics                           DIR
    Settings                    DIR
        Channels                DIR
            Epics               <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     25h  0   RWD  3
        Devices                 DIR
            Epics               DIR
                Channel name    STRING  10    32    25h  0   RWD  
                                        [0]             GPS:VAR1
                                        [1]             GPS:VAR2
                                        [2]             GPS:VAR3
        Names                   STRING  10    32    17h  1   RWD  
                                        [0]             Current
                                        [1]             Voltage
                                        [2]             Watchdog
        Update Threshold MeasureFLOAT   10    4     17h  0   RWD  
                                        [0]             2
                                        [1]             2
                                        [2]             2
    Common                      DIR
        Event ID                <a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>    1     2     17h  0   RWD  3
        Trigger mask            <a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>    1     2     17h  0   RWD  0
        Buffer                  STRING  1     32    17h  0   RWD  SYSTEM
        Type                    <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     17h  0   RWD  4
        Source                  <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     17h  0   RWD  0
        Format                  STRING  1     8     17h  0   RWD  FIXED
        Enabled                 <a class="code" href="vt2_8h.html#a239c7f0d40651c3e419c5b9651507d14">BOOL</a>    1     4     17h  0   RWD  y
        Read on                 <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     17h  0   RWD  121
        Period                  <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     17h  0   RWD  60000
        Event limit             DOUBLE  1     8     17h  0   RWD  0
        Num subevents           <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a>   1     4     17h  0   RWD  0
        Log history             <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>     1     4     17h  0   RWD  1
        Frontend host           STRING  1     32    17h  0   RWD  hostname
        Frontend name           STRING  1     32    17h  0   RWD  Epics
        Frontend file name      STRING  1     256   17h  0   RWD  feepic.c
    Variables                   DIR
        Demand                  FLOAT   10    4     0s   1   RWD  
                                        [0]             1.56
                                        [1]             120
                                        [2]             87
        Measured                FLOAT   10    4     2s   0   RWD  
                                        [0]             1.56
                                        [1]             120
                                        [2]             87
    Statistics                  DIR
        Events sent             DOUBLE  1     8     17h  0   RWDE 26
        Events per sec.         DOUBLE  1     8     17h  0   RWDE 0
        kBytes per sec.         DOUBLE  1     8     17h  0   RWDE 0
</pre></div><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000014">Todo:</a></b></dt><dd>more recent examples, description needed for slow control system</dd></dl>
<p>Example of readout code:</p>
<div class="fragment"><pre class="fragment">    ...
    <span class="stringliteral">&quot;FIXED&quot;</span>,                   <span class="comment">/* format */</span>
    ...
    <a class="code" href="hv_8c.html#aa5383a81945ebd5e43ca55dcd4d6b07b">cd_hv_read</a>,                 <span class="comment">/* readout routine */</span>
    <a class="code" href="hv_8c.html#af6fe77dbe946ebf6e925982d50d0db3c">cd_hv</a>,                      <span class="comment">/* class driver main routine */</span>
    hv_driver,                  <span class="comment">/* device driver list */</span>
    NULL,                       <span class="comment">/* init string */</span>
    },


<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="hv_8c.html#aa5383a81945ebd5e43ca55dcd4d6b07b">cd_hv_read</a>(<span class="keywordtype">char</span> *pevent, <span class="keywordtype">int</span> offset)
{
   <span class="keywordtype">float</span> *pdata;
   <a class="code" href="sis3801_8h.html#a408a2366473807fbe658ba18e75dea66">DWORD</a> *pdw;
   <a class="code" href="structHV__INFO.html">HV_INFO</a> *hv_info;
   <a class="code" href="structeqpmnt.html">EQUIPMENT</a> *pequipment;

   pequipment = *((<a class="code" href="structeqpmnt.html">EQUIPMENT</a> **) pevent);
   hv_info = (<a class="code" href="structHV__INFO.html">HV_INFO</a> *) pequipment-&gt;<a class="code" href="structeqpmnt.html#ac88537c1672f32d13a99ce6822fc4d46">cd_info</a>;

   if (hv_info-&gt;<a class="code" href="structHV__INFO.html#a04325175603b708132a47b04d699b1a8">format</a> == <a class="code" href="group__mdefineh.html#ga44835dd4c169e13e0fedf8c01a54dc2b">FORMAT_FIXED</a>) {
      memcpy(pevent, hv_info-&gt;<a class="code" href="structHV__INFO.html#ac2f4df0be0ef80b9448fa003cf3c00a5">demand</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * hv_info-&gt;<a class="code" href="structHV__INFO.html#aeb36315d8c77519e4e855a32174fb190">num_channels</a>);
      pevent += <span class="keyword">sizeof</span>(float) * hv_info-&gt;<a class="code" href="structHV__INFO.html#aeb36315d8c77519e4e855a32174fb190">num_channels</a>;

    memcpy(pevent, hv_info-&gt;<a class="code" href="structHV__INFO.html#a13349cbb396a9eb7bc736c33f42b2288">measured</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * hv_info-&gt;<a class="code" href="structHV__INFO.html#aeb36315d8c77519e4e855a32174fb190">num_channels</a>);
      pevent += <span class="keyword">sizeof</span>(float) * hv_info-&gt;<a class="code" href="structHV__INFO.html#aeb36315d8c77519e4e855a32174fb190">num_channels</a>;

      memcpy(pevent, hv_info-&gt;<a class="code" href="structHV__INFO.html#aed0c3771d4b42de6ab316500e40eb09d">current</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * hv_info-&gt;<a class="code" href="structHV__INFO.html#aeb36315d8c77519e4e855a32174fb190">num_channels</a>);
      pevent += <span class="keyword">sizeof</span>(float) * hv_info-&gt;<a class="code" href="structHV__INFO.html#aeb36315d8c77519e4e855a32174fb190">num_channels</a>;

      <span class="keywordflow">return</span> 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * hv_info-&gt;<a class="code" href="structHV__INFO.html#aeb36315d8c77519e4e855a32174fb190">num_channels</a>;
   }
 ....
}
</pre></div><p> <br/>
</p>
<p><br/>
  
<script type="text/javascript">
pages("FE_Event_Builder", "FrontendOperation","FE_event_buffer_size","FE_Slow_Control_system", "" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("RunControl","FrontendOperation","DataAnalysis");
</script>
<p><br/>
</p>
<p><a class="anchor" id="end"></a> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

