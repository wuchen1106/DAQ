<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: Super-Event</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="FrontendOperation.html">SECTION 6: Frontend Operation</a>&nbsp;&raquo&nbsp;<a class="el" href="Frontend_code.html">Frontend code</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="FE_Super_Event">Super-Event </a></h1><p><br/>
  
 
<script type="text/javascript">
pages( "FE_bank_construction",  "FrontendOperation","FE_Event_Builder","FE_Super_Event", "end" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("RunControl","FrontendOperation","DataAnalysis");
</script>
<p><br/>
 <a class="anchor" id="idx_event_readout_super-event"></a> <a class="anchor" id="idx_super-event"></a></p>
<p>The Super-Event is an option implemented in the frontend code in order to reduce the amount of data to be transfered to the backend computer(s) by removing the bank header for each event constructed. It is not applicable to FIXED format events.</p>
<p>In other words, when an equipment readout in <em>MIDAS</em> bank format is complete, the event is composed of the bank header followed by the data section.</p>
<p>The overhead in bytes of the bank structure is 16 bytes for <a class="el" href="group__bkfunctionc.html#gac6fadde40824dbf7bd70abedd29be2bd">bk_init()</a>, 20 bytes for <a class="el" href="group__bkfunctionc.html#gae7cbf587db63fcdf66dd18b29f08b6d2">bk_init32()</a> and ybk_init(). If the data section size is close to the number above, the data transfer as well as the data storage has an non-negligible overhead. To address this problem, the equipment can be set up to generate a so called <b> Super-Event </b> which is an event composed of the initial standard bank header for the first event of the super-event, and up to the <a class="el" href="FE_table.html#FE_tbl_NumSubevents">number of sub-events</a> maximum successive data sections before the closing of the bank.</p>
<h2><a class="anchor" id="FE_Super_Event_example">
Super-Event Example</a></h2>
<p>To demonstrate the use of the super-event, consider the following example:</p>
<ul>
<li>Define equipment to be able to generate the <b>Super-Event</b> <div class="fragment"><pre class="fragment">  { <span class="stringliteral">&quot;GE&quot;</span>,                 <span class="comment">// equipment name </span>
      2, 0x0002,            <span class="comment">// event ID, trigger mask </span>
      <span class="stringliteral">&quot;SYSTEM&quot;</span>,             <span class="comment">// event buffer </span>
<span class="preprocessor">  #ifdef USE_INT</span>
<span class="preprocessor"></span>      EQ_INTERRUPT,         <span class="comment">// equipment type </span>
<span class="preprocessor">  #else</span>
<span class="preprocessor"></span>      EQ_POLLED,            <span class="comment">// equipment type </span>
<span class="preprocessor">  #endif</span>
<span class="preprocessor"></span>      <a class="code" href="group__midasincludecode.html#ga93fde3913a488880c4f96267e24579ee">LAM_SOURCE</a>(GE_C, <a class="code" href="group__midasincludecode.html#ga479219e07f43223f74ff8638705a804e">LAM_STATION</a>(GE_N)), <span class="comment">// interrupt source </span>
      <span class="stringliteral">&quot;MIDAS&quot;</span>,              <span class="comment">// format </span>
      TRUE,                 <span class="comment">// enabled </span>
      RO_RUNNING,           <span class="comment">// read only when running </span>
      200,                  <span class="comment">// poll for 200ms </span>
      0,                    <span class="comment">// stop run after this event limit </span>
      1000,                 <span class="comment">// -----&gt; number of sub events &lt;-----  enable Super-event</span>
      0,                    <span class="comment">// don&apos;t log history </span>
      <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>,
      read_ge_event,        <span class="comment">// readout routine </span>
       ,
      ...
</pre></div></li>
</ul>
<h2><a class="anchor" id="FE_Super_Event_readout">
Example Readout code for Super-Event</a></h2>
<p>Set up the readout function for Super-Event collection, e.g. </p>
<div class="fragment"><pre class="fragment">  <span class="comment">//-- Event readout</span>
  <span class="comment">// Global and fixed -- Expect NWORDS 16bits data readout per sub-event</span>
<span class="preprocessor">  #define NWORDS 3</span>
<span class="preprocessor"></span>
  <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> read_ge_event(<span class="keywordtype">char</span> *pevent, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> offset)
  {
    <span class="keyword">static</span> <a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a> *pdata;

    <span class="comment">// Super-event structure </span>
    <span class="keywordflow">if</span> (offset == 0)
    {
      <span class="comment">// FIRST event of the Super-event </span>
      <a class="code" href="group__bkfunctionc.html#gac6fadde40824dbf7bd70abedd29be2bd">bk_init</a>(pevent);
      <a class="code" href="group__bkfunctionc.html#ga4bb781187e18834136ed8ac368d53413">bk_create</a>(pevent, <span class="stringliteral">&quot;GERM&quot;</span>, <a class="code" href="group__mdefineh.html#ga681cbe2c114c62cecccb882544d2debb">TID_WORD</a>, &amp;pdata);

    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (offset == -1)
    {
      <span class="comment">// close the Super-event if offset is -1</span>
      <a class="code" href="group__bkfunctionc.html#ga132dc71c8f74b478cdcc59bc1d9f6a26">bk_close</a>(pevent, pdata);

      <span class="comment">// End of Super-Event</span>
      <span class="keywordflow">return</span> <a class="code" href="group__bkfunctionc.html#ga8fc93de36e62c4328cb6581be7f42a0f">bk_size</a>(pevent);


    <span class="comment">// read GE sub-event (ADC) </span>
    <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(GE_C, GE_N, 0, GE_READ, pdata++);
    <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(GE_C, GE_N, 1, GE_READ, pdata++);
    <a class="code" href="group__mcstdfunctionh.html#gad17f339ee8254f1aad6b406e50ebd4a8">cam16i</a>(GE_C, GE_N, 2, GE_READ, pdata++);

    <span class="comment">// clear hardware </span>
    re_arm_ge(); 

    <span class="keywordflow">if</span> (offset == 0)
    {
      <span class="comment">// Compute the proper event length on the FIRST event in the Super-Event</span>
      <span class="comment">// NWORDS correspond to the !! NWORDS WORD above !!</span>
      <span class="comment">// sizeof(BANK_HEADER) + sizeof(BANK) will make the 16 bytes header</span>
      <span class="comment">// sizeof(WORD) is defined by the TID_WORD in bk_create()</span>

      <span class="keywordflow">return</span> NWORDS * <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>) + <span class="keyword">sizeof</span>(<a class="code" href="structBANK__HEADER.html">BANK_HEADER</a>) + <span class="keyword">sizeof</span>(<a class="code" href="structBANK.html">BANK</a>);

    <span class="keywordflow">else</span>
      <span class="comment">// Return the data section size only</span>
      <span class="comment">// sizeof(WORD) is defined by the TID_WORD in bk_create()</span>

      <span class="keywordflow">return</span> NWORDS * <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a2b0e863dadf920709ec53d9088ee7c91">WORD</a>);
</pre></div><p> <br/>
</p>
<p>As shown in the example above: </p>
<ul>
<li>
For the <b>first</b> event, the correct size of the event <b>including the header</b> must be calculated and returned </li>
<li>
<b>Subsequent</b> events return the size of the <b>data only</b>, not the header. </li>
</ul>
<p>The input parameter "offset" is used to indicate whether the event is the first, last or intermediate. After the last event, the bank is closed. <br/>
 The encoding of the data section is left to the user. If the number of words per sub-event is fixed (i.e. NWORDS in the above example), the sub-event extraction by an analyzer is simple. In the case of variable sub-event length, it is necessary to tag the first or the last word of each sub-event.The contents of the sub-event is the choice of the user.</p>
<p><b>Note:</b> </p>
<ul>
<li>Since no particular tagging is applied to the Super-Event by the Midas transfer mechanism, <em> the user must provide code in the backend analyzer to interpret the contents of the Super-Event bank(s)</em>.</li>
</ul>
<ul>
<li>If the Super-Event is composed by an equipment on a remote processor running a different <em>Endian</em> mode than the backend processor, it would be necessary to <em>ensure the data type consistency throughout the <b> Super-Event </b> </em> in order to guarantee the proper byte-swapping of the data content. <a class="el" href="DataAnalysis.html#DA_Byte_Swap_Macros">Byte Swap Macros</a> are available for this purpose.</li>
</ul>
<ul>
<li>It may be convenient to change the <b>time-stamp</b> of the super-event (see <a class="el" href="FE_bank_construction.html#timestamp">example</a> of use of Macro)</li>
</ul>
<ul>
<li>The <b> event rate </b> in the equipment statistics will <em> indicate the rate of sub-events</em>.</li>
</ul>
<p><br/>
  
<script type="text/javascript">
pages( "FE_bank_construction",  "FrontendOperation","FE_Event_Builder","FE_Super_Event", "" ); // back index next {top bottom}
// section parameters: last section; top of this section; next section
sections("RunControl","FrontendOperation","DataAnalysis");
</script>
<p><br/>
 <a class="anchor" id="end"></a> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

