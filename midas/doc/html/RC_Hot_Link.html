<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: Event Notification (Hot-Link)</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="RunControl.html">SECTION 5: Run Control</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="RC_Hot_Link">Event Notification (Hot-Link) </a></h1><p><br/>
  
<script type="text/javascript">
pages("RC_customize_ODB", "RunControl","FrontendOperation", "RC_Hot_Link", "end" ); // back index next {top bottom}
sections("Features", "RunControl","FrontendOperation"); // last section; top of this section; next section
</script>
<p><br/>
 <a class="anchor" id="idx_hotlink"></a> <a class="anchor" id="idx_event_notification-see-hotlink"></a> </p>
<h2><a class="anchor" id="RC_Hot_Link_Intro">
Introduction</a></h2>
<p>MIDAS implements event notification through <b> "hot-links" </b>. Once a hot-link is established to a key in the ODB, <b>immediately</b> that key is accessed, a call-back routine associated with the hot-link is called to perform whatever action has been programmed. The MIDAS system uses hot-links to update keys in the ODB for communication between system clients (e.g. <a class="el" href="F_History_logging.html#F_Frontend_History_Event">history system</a>).</p>
<p>Users often use hot-links to immediately set some hardware to a new value. The new value may have been input into the ODB, either by the user or another client. Without a hot-link, the program setting the hardware values would have to continually poll the ODB to see if any values had changed; otherwise the new value would not be transmitted to the hardware until the next time the ODB set values were read and applied (for example, at the beginning of a run). <br/>
</p>
<hr/>
<h2><a class="anchor" id="RC_Example_Hot_Link">
How to set up a Hot-Link</a></h2>
<p>It is often desirable to modify hardware <a class="el" href="structparameters.html">parameters</a> (such as discriminator levels or trigger logic) connected to the frontend computer. Assuming that the required hardware is accessible from the frontend code, these <a class="el" href="structparameters.html">parameters</a> are easily controllable when a hot-link is established between the frontend and the ODB itself.</p>
<center> Hot-Link process </p>
<div align="center">
<img src="hotlink.gif" alt="hotlink.gif"/>
</div>
 </center><p>First the <a class="el" href="structparameters.html">parameters</a> have to be defined in the ODB under the Settings tree for the given equipment. Let's assume we have two discriminator levels belonging to the trigger electronics, which should be controllable. The following commands define these levels in the ODB: </p>
<div class="fragment"><pre class="fragment">[local]/&gt;cd /Equipment/Trigger/
[local]Trigger&gt;create key Settings
[local]Trigger&gt;cd Settings
[local]Settings&gt;create <span class="keywordtype">int</span> level1
[local]Settings&gt;create <span class="keywordtype">int</span> level2
[local]Settings&gt;ls
</pre></div><p><a class="anchor" id="idx_experim-dot-h"></a> <a class="anchor" id="RC_experim_dot_h"></a> The frontend can now map a C structure to these settings. In order to simplify this process, <a class="el" href="RC_odbedit.html">ODBEdit</a> can be requested to generate a header file containing this C structure. The odbedit command <a class="el" href="RC_odbedit_examples.html#RC_odbedit_make">make</a> generates in the current directory the header file <b><a class="el" href="experim_8h.html">experim.h</a></b> . <br/>
 This file can be copied to the frontend directory (if necessary) and included in the frontend source code. It contains a section with a C structure of the trigger settings and an ASCII representation: </p>
<div class="fragment"><pre class="fragment"><span class="keyword">typedef</span> <span class="keyword">struct </span>{
  <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>       level1;
  <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>       level2;
  <a class="code" href="structTRIGGER__SETTINGS.html">TRIGGER_SETTINGS</a>;

<span class="preprocessor">#define TRIGGER_SETTINGS_STR(_name) char *_name[] = {\</span>
<span class="preprocessor">&quot;[.]&quot;,\</span>
<span class="preprocessor">&quot;level1 = INT : 0&quot;,\</span>
<span class="preprocessor">&quot;level2 = INT : 0&quot;,\</span>
<span class="preprocessor"></span>
<span class="preprocessor"></span><span class="stringliteral">&quot;&quot;</span>,\
NULL  
</pre></div><p>This definition can be used to define a C structure containing the <a class="el" href="structparameters.html">parameters</a> in <a class="el" href="frontend_8c.html">frontend.c</a>: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;<a class="code" href="experim_8h.html">experim.h</a>&gt;</span>

<a class="code" href="structTRIGGER__SETTINGS.html">TRIGGER_SETTINGS</a> trigger_settings;
</pre></div><p>A hot-link between the ODB values and the C structure is established in the <a class="el" href="mfe_8c.html#a802849119d469feb2d1deee1be9593ac">frontend_init()</a> routine: </p>
<div class="fragment"><pre class="fragment"><a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> <a class="code" href="mfe_8c.html#a802849119d469feb2d1deee1be9593ac">frontend_init</a>()
{HNDLE hDB, hkey;
<a class="code" href="experim_8h.html#aba8c5b4adf8180aae43451def4ed3c0c">TRIGGER_SETTINGS_STR</a>(trigger_settings_str);

  <a class="code" href="group__cmfunctionc.html#ga16b33b70783a3f5ba98b4094149d12b7">cm_get_experiment_database</a>(&amp;hDB, NULL);

  <a class="code" href="group__odbfunctionc.html#ga59b971e77416b2b463e2e63f1b05342b">db_create_record</a>(hDB, 0,
    <span class="stringliteral">&quot;/Equipment/Trigger/Settings&quot;</span>,
    strcomb(trigger_settings_str));

  <a class="code" href="group__odbfunctionc.html#ga321df44195a9cbc83dbf10e32e32fd5b">db_find_key</a>(hDB, 0, <span class="stringliteral">&quot;/Equipment/Trigger/Settings&quot;</span>, &amp;hkey);

  <span class="keywordflow">if</span> (<a class="code" href="group__odbfunctionc.html#ga852bc9fa8ee4d0884b328aeb0b0cfd63">db_open_record</a>(hDB, hkey,
      &amp;trigger_settings,
      <span class="keyword">sizeof</span>(trigger_settings), <a class="code" href="group__mdefineh.html#gac4d1baf108e9ce6414088db508d7c182">MODE_READ</a>,
      trigger_update, NULL) != <a class="code" href="group__err23.html#ga4d6ab4d32144d851ddeb7931b81a63e3">DB_SUCCESS</a>)
    {
    <a class="code" href="group__msgfunctionc.html#gaac032ca2438c47466bfc9722de6746ea">cm_msg</a>(<a class="code" href="group__mdefineh.html#gac2d967025ca0f84f611d568f4ede934a">MERROR</a>, <span class="stringliteral">&quot;frontend_init&quot;</span>,
      <span class="stringliteral">&quot;Cannot open Trigger Settings in ODB&quot;</span>);
    <span class="keywordflow">return</span> -1;
     
  <span class="keywordflow">return</span> SUCCESS;
</pre></div><p>The <a class="el" href="group__odbfunctionc.html#ga59b971e77416b2b463e2e63f1b05342b">db_create_record()</a> function re-creates the settings sub-tree in the ODB from the ASCII representation in case it has been corrupted or deleted. The <a class="el" href="group__odbfunctionc.html#ga852bc9fa8ee4d0884b328aeb0b0cfd63">db_open_record()</a> now establishes the hot-link between the settings in the ODB and the trigger_settings structure. Each time the ODB settings are modified, the changes are written to the trigger_settings structure and the callback routine trigger_update() is executed afterwards. This routine has the task to set the hardware according to the settings in the trigger_settings structure.</p>
<p>It may look like: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> trigger_update(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hDB, <a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a> hkey)
{
  printf(<span class="stringliteral">&quot;New levels: %d %d&quot;</span>,
    trigger_settings.level1,
    trigger_settings.level2);
</pre></div><p>Of course the printf() function should be replaced by a function which accesses</p>
<p>the hardware properly. Modifying the trigger values with ODBEdit can test the whole scheme: </p>
<div class="fragment"><pre class="fragment">[local]/&gt;cd /Equipment/Trigger/Settings
[local]Settings&gt;<span class="keyword">set</span> level1 123
[local]Settings&gt;<span class="keyword">set</span> level2 456
</pre></div><p> Immediately after each modification the frontend should display the new values. The settings can be saved to a file and loaded back later: </p>
<div class="fragment"><pre class="fragment">[local]/&gt;cd /Equipment/Trigger/Settings
[local]Settings&gt;save settings.odb
[local]Settings&gt;<span class="keyword">set</span> level1 789
[local]Settings&gt;load settings.odb
</pre></div><p> The settings can also be modified from any application just by accessing the ODB. Following listing is a complete user application that modifies the trigger level: </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;<a class="code" href="midas_8h.html">midas.h</a>&gt;</span>

<a class="code" href="mfe_8c.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>()
{
HNDLE hDB;
<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>   level;
  <a class="code" href="group__cmfunctionc.html#ga1e96495bb5b89e4ea770a1ea7bc7787b">cm_connect_experiment</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;Sample&quot;</span>, <span class="stringliteral">&quot;Test&quot;</span>,
                        NULL);
  <a class="code" href="group__cmfunctionc.html#ga16b33b70783a3f5ba98b4094149d12b7">cm_get_experiment_database</a>(&amp;hDB, NULL);

  level = 321;
  <a class="code" href="group__odbfunctionc.html#gaf0b052657ba1d4f4a8b6d47dbc70008c">db_set_value</a>(hDB, 0,
    <span class="stringliteral">&quot;/Equipment/Trigger/Settings/Level1&quot;</span>,
    &amp;level, <span class="keyword">sizeof</span>(<a class="code" href="sis3803_8h.html#a09fddde158a3a20bd2dcadb609de11dc">INT</a>), 1, TID_INT);

  <a class="code" href="group__cmfunctionc.html#ga7d5a287821786e8dde3d2340826215b2">cm_disconnect_experiment</a>();
</pre></div><p> The following figure summarizes the involved components:</p>
<p>To make sure a hot-link exists, one can use the <a class="el" href="RC_odbedit.html">odbedit</a> command <a class="el" href="RC_odbedit_examples.html#RC_odbedit_sor">sor - show open records</a> : </p>
<div class="fragment"><pre class="fragment"> [local]Settings&gt;cd /
[local]/&gt;sor
/Equipment/Trigger/Settings open 1 times by ...
</pre></div><p><br/>
 <a class="anchor" id="end"></a></p>
 
<script type="text/javascript">
pages("RC_customize_ODB" , "RunControl","FrontendOperation", "RC_Hot_Link", "" ); // back index next {top bottom}
sections("Features", "RunControl","FrontendOperation"); // last section; top of this section; next section
</script>
 <br/>
 </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

