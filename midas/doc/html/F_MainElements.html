<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Midas: Overview of the Main Elements of the MIDAS DAQ System</title>
<link href="midox.css" rel="stylesheet" type="text/css">
<!--
<link href="doxygen.css" rel="stylesheet" type="text/css">
-->
<link href="tabs.css" rel="stylesheet" type="text/css">

<script type="text/javascript"  src="navigation.js">
</script>

</head>

<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">Midas Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="Features.html">SECTION 4: Features</a>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="F_MainElements">Overview of the Main Elements of the MIDAS DAQ System </a></h1> 
<script type="text/javascript">
// pages params : back index next {top bottom}
pages( "Features",  "Features","F_ODB_Structure","F_MainElements", "end"); // back index next {top bottom}
// sections params:   last section; top of this section; next section
sections("Quickstart", "Features", "RunControl");
</script>
<p><br/>
</p>
<p>The main elements of the <b>MIDAS</b> package are listed below with a short description of their function. Please refer to the <a class="el" href="I_Midas_system_picture.html">diagram of the MIDAS system</a> to see how these elements interract to form the MIDAS system.</p>
<p><a class="anchor" id="idx_midas_features"></a></p>
<ul>
<li><a class="el" href="F_MainElements.html#F_Buffer_Manager_overview">The Buffer Manager</a></li>
<li><a class="el" href="F_MainElements.html#F_Message_System_overview">Message System</a></li>
<li><a class="el" href="F_MainElements.html#F_Online_Database_overview">Online Database (ODB)</a></li>
<li><a class="el" href="F_MainElements.html#F_Frontend_sec_overview">Frontend</a> Acquisition code.</li>
<li><a class="el" href="F_MainElements.html#F_Midas_Server_overview">MIDAS Server</a> Remote access server (RPC server).</li>
<li><a class="el" href="F_MainElements.html#F_Data_Logger_overview">Data Logger</a> Data storage.</li>
<li><a class="el" href="F_MainElements.html#F_Analyzer_sec_overview">Analyzer</a> Data analyzer.</li>
<li><a class="el" href="F_MainElements.html#F_Run_Control_overview">Run Control</a> Data flow control.</li>
<li><a class="el" href="F_MainElements.html#F_Slow_Control_overview">Slow Control</a> system Device monitoring and control.</li>
<li><a class="el" href="F_MainElements.html#F_History_System_overview">History system</a> Event history storage and retrival.</li>
<li><a class="el" href="F_MainElements.html#F_Alarm_System_overview">Alarm System</a> Overall system and user alarm.</li>
<li><a class="el" href="F_MainElements.html#F_Electronic_Logbook_overview">Electronic Logbook</a> Online User Logbook.</li>
</ul>
<p><a class="anchor" id="idx_buffer_manager"></a> <a class="anchor" id="idx_shared_memory"></a> </p>
<h2><a class="anchor" id="F_Buffer_Manager_overview">
The Buffer Manager</a></h2>
<p>The "buffer manager" consists of a set of library functions for event collection and distribution. A buffer is a shared memory region in RAM, which can be accessed by several processes, called <b>"clients"</b>. Processes <b>sending</b> events to a buffer are called <b>"producers"</b>. Processes <b>reading</b> events from the buffer are called <b>"consumers"</b>.</p>
<p>A buffer is organized as a FIFO (First-In-First-Out) memory. Consumers can specify which type of events they want to receive from a buffer. For this purpose each event contains a MIDAS header with an event ID and other pertinent information.</p>
<p>Buffers can be accessed <b>locally</b> through the shared memory or <b>remotely</b> via the MIDAS server acting as an interface to that same shared memory.</p>
<p><a class="anchor" id="idx_watchdog"></a> A common problem in DAQ systems is the possible crash of a client, such as a user analyzer. This can cause the whole system to hang up, and may require a restart of the DAQ causing a loss of both time and, eventually, precious data. In order to address this problem, a special <b> watchdog scheme </b> has been implemented. Each client attached to the buffer manager signals its presence periodically by storing a time-stamp in the shared memory. Every other client connected to the same buffer manager can then check if the other parties are still alive. If not, proper action is taken consisting in removing the dead client hooks from the system, leaving the system in a working condition.</p>
<p><a class="anchor" id="idx_message_system-overview"></a> </p>
<h2><a class="anchor" id="F_Message_System_overview">
Message System</a></h2>
<p>Any client can produce status or error messages with a single call using the MIDAS library. These messages are then forwarded to any other clients who may be available to receive these messages, as well as to a central log file system. The message system is based on the buffer manager scheme, but with a dedicated header to identify the type of message. A dedicated buffer (i.e. shared memory) is used to receive and distribute messages. Predefined message types contained in the MIDAS library cover most of the message requirements. See <a class="el" href="F_Logging.html">Logging in MIDAS</a> and <a class="el" href="F_Logging_Data.html">Customizing the MIDAS data logging</a> for more details.</p>
<p><a class="anchor" id="idx_ODB_overview"></a> </p>
<h2><a class="anchor" id="F_Online_Database_overview">
Online Database (ODB)</a></h2>
<p>In a distributed DAQ environment, configuration data is usually stored in several files on different computers. MIDAS, however, uses a different approach: all relevant data for a given experiment are stored in a central database called the "Online DataBase" (ODB). This database contains run <a class="el" href="structparameters.html">parameters</a>; logging channel information; condition <a class="el" href="structparameters.html">parameters</a> for front-ends and analyzers; slow control values; status and performance data; and any information defined by the user.</p>
<p>The main advantage of this concept is that all programs participating in an experiment have full access to these data without having to contact different computers. A possible disadvantage could be the extra load put on the particular host serving the ODB. As the access to such a database can be remote, the connection is performed through an RPC layer. MIDAS includes its own RPC which has been optimized for speed. Byte ordering (i.e. big/little endian) is taken care of, such that cross-platform database access is possible, with the advantage that the RPC doesn't define a byte ordering. Instead it uses the transmitter type, and converts to the required byte ordering only if needed by the receiver. Measurement shows that up to 50,000 accesses per second with a local connection, and around 500 accesses per second remotely over the MIDAS server, can be obtained (numbers from 1990).</p>
<p>The ODB is hierarchically structured, similar to a file system, with directories and sub-directories (see <a class="el" href="F_ODB_Structure.html">ODB Structure</a>) . The data are stored in key/data pairs, similar to the Windows NT registry. Keys can be dynamically created and deleted. The data associated with a key can be of different types such as: byte, words, double words, float, strings, etc. or arrays of any of those. A key can also be a directory or a symbolic link (c.f. Unix).</p>
<p><a class="anchor" id="idx_hotlink_overview"></a> The MIDAS library provides a complete set of functions to manage and operate on these keys. <br/>
 Any ODB client can register a "hot-link" between a local C-structure and any element of the ODB. The hot-link mechanism ensures that whenever a client (program) changes a value in this ODB sub-tree, the local C-structure automatically receives an update of the changed data. Additionally, a client can register a callback function which will be executed as soon as the hot-link's update has been received. For more information see <a class="el" href="RC_Hot_Link.html">Event Notification (Hot-Link)</a> .</p>
<p><a class="anchor" id="idx_midas_server"></a> </p>
<h2><a class="anchor" id="F_Midas_Server_overview">
MIDAS Server</a></h2>
<p>For remote access to a MIDAS experiment, a remote procedure call (RPC) server is available (<a class="el" href="RC_customize_ODB.html#RC_mserver_utility">mserver</a>). It uses an optimized MIDAS RPC scheme for improved access speed. The server can be started manually or via inetd (UNIX) or as a service under Windows NT. For each incoming connection it creates a new sub-process which serves this connection over a TCP link. The MIDAS server not only serves client connections to a given experiment, but takes the experiment's name as a parameter meaning that only one MIDAS server is necessary to manage several experiments on the same node.</p>
<p><a class="anchor" id="idx_frontend_program_overview"></a> </p>
<h2><a class="anchor" id="F_Frontend_sec_overview">
Frontend</a></h2>
<p>The <em>frontend</em> program refers to a task running on a particular computer which has access to hardware equipment. Several <em>frontends</em> can be attached simultaneously to a given experiment. Each <em>frontend</em> can be composed of multiple <a class="el" href="FrontendOperation.html#Equipment_definition">Equipments</a>. <em>The</em> term "Equipment" refers to a single or a collection of sub-task(s) meant to collect and regroup logical or physical data under a single and uniquely identified event.</p>
<p>The frontend program is composed of a general framework which is experiment-independent, and a set of template routines for the user to fill in. This program will:</p>
<ul>
<li>Register the given <em>Equipment(s)</em> list to a specific MIDAS experiment.</li>
<li>Provide the means of collecting data from hardware sources defined by each Equipment Read function.</li>
<li>Gather these data in a known format (e.g. Fixed, MIDAS) for each equipment.</li>
<li>Send these data to the buffer manager either locally or remotely.</li>
<li>Periodically collect statistics of the acquisition task, and send them to the Online Database.</li>
</ul>
<p>The frontend framework sends events to the buffer manager and optionally a copy to the ODB. A "Data cache" in the frontend and on the server side reduces the amount of network operations, pushing the transfer speed closer to the physical limit of the network configuration.</p>
<p>The data collection in the frontend framework can be triggered by several mechanisms. Currently the frontend supports four different kind of event trigger:</p>
<ul>
<li><em> Periodic events</em>: scheduled event based on a fixed time interval. They can be used to read information such as scaler values, temperatures etc.</li>
<li><em> Polled events</em>: hardware trigger information read continuously which in turns if the signal is asserted will trigger the equipment readout.<ul>
<li><em> LAM events</em>: generated only when pre-defined LAM is asserted (CAMAC).</li>
</ul>
</li>
<li><em> Interrupt events</em>: generated by particular hardware device supporting interrupt mode.</li>
<li><em> Slow Control events</em>: special class of events that are used in the slow control system.</li>
</ul>
<p>Each of these types of trigger can be enabled/activated for a particular experimental State, Transition State, or a combination of any of them. Examples such as "read scaler event
only when running" or "read periodic event if the run state is not paused and on all
transitions" are possible.</p>
<p>Dedicated header and library files for hardware access to CAMAC, VME, Fastbus, GPIB and RS232 are part of the MIDAS distribution set. <br/>
 For full details see <a class="el" href="FrontendOperation.html">SECTION 6: Frontend Operation</a> .</p>
<p><a class="anchor" id="idx_data_logger_overview"></a> </p>
<h2><a class="anchor" id="F_Data_Logger_overview">
Data Logger</a></h2>
<p>The data logger is a client running on the backend computer receiving events from the buffer manager and saving them onto disk, tape or via FTP to a remote computer. It supports several parallel logging channels with individual event selection criteria. Data can currently be written in five different formats: <em> MIDAS binary, ASCII, ROOT and DUMP </em> (see <a class="el" href="FE_Data_format.html#FE_Midas_format">MIDAS format</a>).</p>
<p>Basic functionality of the logger includes:</p>
<ul>
<li>Run Control based on:<ul>
<li>event limit not reached yet.</li>
<li>recorded byte limit not reached yet.</li>
<li>logging device not full.</li>
</ul>
</li>
<li>Logging selection of particular events based on Event Identifier.</li>
<li>Auto restart feature allowing logging of several runs of a given size or duration without user intervention.</li>
<li>Recording of ODB values to a so-called <a class="el" href="F_History_logging.html#F_History_System">MIDAS History System</a></li>
<li>Recording of the ODB to all or individual logging channels at the begin-of-run and end-of-run States, as well as to a separate disk file in XML or ASCII format. <br/>
 For more information see <a class="el" href="F_Logging.html">Logging in MIDAS</a> .</li>
</ul>
<p><a class="anchor" id="idx_analyzer_overview"></a> </p>
<h2><a class="anchor" id="F_Analyzer_sec_overview">
Analyzer</a></h2>
<p>The Analyzer is a <em>backend</em> task (as opposed to the frontend). As in the front-end section, the analyzer provided by MIDAS is a framework on which the user can develop his/her own applications. This framework can be built for private analysis (no external analyzer hooks) or specific analysis packages such as HBOOK, ROOT from the CERN (none of those libraries are included in the MIDAS distribution). See <a class="el" href="DataAnalysis.html">SECTION 7: Data Analysis</a> for more information.</p>
<p>The analyzer takes care of receiving events (a few lines of code are necessary to receive events from the buffer manager); initializing the HBOOK or ROOT system; and automatically booking N-tuples/TTree for all events. Interface to user routines for event analysis is provided.</p>
<p>The analyzer is structured into "stages", where each stage analyses a subset of the event data. Low level stages can perform ADC and TDC calibration, while high level stages can calculate "physics" results. The same analyzer executable can be used to run online (where events are received from the buffer manager) and off-line (where events are read from file). When running online, generated N-tuples/TTree are stored in a ring-buffer in shared memory. They can be analysed with PAW without stopping the run.</p>
<p>When running off-line, the analyzer can read MIDAS binary files, analyse the events, add calculated data for each event and produce a HBOOK RZ output file which can be read in by PAW later. The analyzer framework also supports analyzer <a class="el" href="structparameters.html">parameters</a>. It automatically maps C-structures used in the analyzer to ODB records via <a class="el" href="RC_Hot_Link.html">Event Notification (Hot-Link)</a>. To control the analyzer, only the values in the ODB have to be changed, which are automatically propagated to the analyzer <a class="el" href="structparameters.html">parameters</a>. If analysis software has been already developed, MIDAS provides the functionality necessary to interface the analyzer code to the MIDAS data channel. Support for languages such as C, C++ is available.</p>
<p><a class="anchor" id="idx_run-control_overview"></a> </p>
<h2><a class="anchor" id="F_Run_Control_overview">
Run Control</a></h2>
<p>As mentioned earlier, the Online Database (ODB) contains all the pertinent information regarding an experiment. For that reason a run control program requires only to access the ODB. A basic program supplied in the package called ODBEdit provides a simple and safe mean for interacting with ODB. Through ODBEdit essentially all the MIDAS capability are available to the user's fingertips.</p>
<p>Three "Run States" define the state of the MIDAS data acquisition system: <em>Stopped</em>, <em>Paused</em>, and <em>Running</em>. In order to change from one state to another, MIDAS provides four basic "Transition" functions: <em>Tr_Start</em>, <em>Tr_pause</em>, <em>Tr_resume</em>, and <em>Tr_Stop</em>. During these transition periods, any MIDAS client registered to receive notification of such a transition will be able to perform dedicated tasks in either synchronized or asynchronized mode, within the overall run control of the experiment.</p>
<p>In order to provide more flexibility to the transition sequence of all the MIDAS clients connected to a given experiment, each transition function has a <em>transition</em> <em>sequence</em> <em>number</em> attached to it. This transition sequence is used to establish within a given transition the order of the invocation of the MIDAS clients (from the lowest sequence number to the highest). See <a class="el" href="RC_Run_States_and_Transitions.html#RC_Transition_priority">Run Transition Priority</a> for details.</p>
<center> Transitions </p>
<div align="center">
<img src="transition.gif" alt="transition.gif"/>
</div>
 </center><p><a class="anchor" id="idx_slow-control_overview"></a> </p>
<h2><a class="anchor" id="F_Slow_Control_overview">
Slow Control</a></h2>
<p>The Slow Control system is a special front-end equipment or program dedicated to the control of hardware modules based on user <a class="el" href="structparameters.html">parameters</a>. It takes advantage of the Online Database and its <a class="el" href="RC_Hot_Link.html">hot-link</a> capability. Demand and Measured values from Slow Control system equipment like high voltage power supplies or beam line magnets are stored directly in the ODB.</p>
<p>To control a device it is then enough to modify the demand values in the database. The modified value is automatically propagated to the slow control system, which in turn uses the specific device driver to apply the change to the particular hardware. Measured values from the hardware are periodically sent back to the ODB to reflect the current status of the sub-system.</p>
<p>The Slow Control system is organized in a Object Oriented way with 3 levels of calls such <em>Class</em>, <em>Device</em> and <em>Bus</em> drivers. Each Class driver refers to a particular set of functionality of that class i.e. High-Voltage, Temperature, General I/O, Magnet etc. The implementation of the device-specific calls is done in a second stage "Device Driver" while the actual hardware implementation is done in a third layer "Bus Driver". The current MIDAS distribution already has some device driver for general I/O and commercial High Voltage power supply systems (see <a class="el" href="FE_Hardware.html">supported hardware</a> ). The necessary code composing the hardware device driver is kept simple by only requiring a "set channel value" and "read channel value" for example. For the High Voltage class driver, a GUI (graphical user interface) under Windows or Qt is already available. It can set, load and print high voltages for any devices of that class.</p>
<p><a class="anchor" id="idx_history_system_overview"></a> </p>
<h2><a class="anchor" id="F_History_System_overview">
History system</a></h2>
<p>The MIDAS history system is a recording function embedded in the <a class="el" href="F_Logging.html#F_mlogger_utility">MIDAS logger</a>. Parallel to its main data logging function of defined channels, the MIDAS logger can store slow control data and/or periodic events on disk file. Each history entry consists of the time-stamp at which the event has occurred, and the value[s] of the parameter to be recorded.</p>
<p>The activation of a recording is not controlled by the history function, but by the actual equipment (see <a class="el" href="F_History_logging.html#F_History_System">MIDAS History System</a>). This permits a higher flexibility of the history system such as dynamic modification of the event structure without restarting the MIDAS logger. At any given time, data-over-time relations can be displayed through the web with the MIDAS <a class="el" href="RC_mhttpd_utility.html">mhttpd</a> utility or queried from the disk file through the MIDAS <a class="el" href="F_History_logging.html#F_mhist_utility">mhist</a> utility,</p>
<p>The history data extraction from the disk file is done using low level file functions giving similar results as a standard database mechanism but with faster access time. Due to its simple use and good display quality, this section has been reworked to be able to handle larger number of <a class="el" href="structparameters.html">parameters</a> (see <a class="el" href="F_History_logging.html#F_History_System">MIDAS History System</a> ).</p>
<p><a class="anchor" id="idx_alarm_system_overview"></a> </p>
<h2><a class="anchor" id="F_Alarm_System_overview">
Alarm System</a></h2>
<p>The MIDAS alarm mechanism is a built-in feature of the MIDAS server. It acts upon the description of the required alarm defined in the Online Database (ODB). Currently the internal alarms supports the following mechanism:</p>
<ul>
<li>ODB value over fixed threshold at regular time interval, a pre-defined ODB value will be compared to a fixed value.</li>
<li>MIDAS client control During Run State transitions, pre-defined MIDAS client names will be checked if currently present.</li>
<li>General C-code alarm setting Alarm C function permitting to issue user defined alarm.</li>
</ul>
<p>The action triggered by the alarm is left to the user through the means of a detached script. But basic alarm report is available such as:</p>
<ul>
<li>Logging the alarm message to the experiment log file.</li>
<li>Sending an "Electronic Log message" (see <a class="el" href="F_Elog.html">Electronic logbook (Elog)</a>).</li>
<li>Interrupt data acquisition. For more information see <a class="el" href="RC_customize_ODB.html#RC_Alarm_System">MIDAS Alarm System</a> and <a class="el" href="RC_customize_ODB.html#RC_ODB_Alarms_Tree">ODB /Alarms Tree</a> .</li>
</ul>
<p><a class="anchor" id="idx_Elog_overview"></a> </p>
<h2><a class="anchor" id="F_Electronic_Logbook_overview">
Electronic Logbook</a></h2>
<p>The Electronic logbook is a feature which provides the experimenter an alternative way of logging his/her own information related to the current experiment. This electronic logbook may supplement or complement the standard paper logbook and in the mean time allow "web publishing" of this information. Indeed the electronic logbook information is accessible from any web browser as long as the MIDAS web server ( <a class="el" href="RC_mhttpd_utility.html">mhttpd</a>) is running in the background of the system. For more information see <a class="el" href="F_Elog.html">Electronic Logbook</a> and <a class="el" href="RC_mhttpd_Elog_page.html">mhttpd Elog page</a>.</p>
 
<script type="text/javascript">
// pages params : back index next {top bottom}
pages( "Features",  "Features","F_ODB_Structure","F_MainElements", ""); // back index next {top bottom}
// sections params:   last section; top of this section; next section
sections("Quickstart", "Features", "RunControl");
</script>
<p><a class="anchor" id="end"></a> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<br>
<hr WIDTH="100%">
Midas DOC Version 2.3.0&nbsp;----&nbsp;PSI Stefan Ritt&nbsp;----
<br>
Contributions: Pierre-Andre Amaudruz - Sergio Ballestrero - Suzannah Daviel -
<a href=http://www.stack.nl/~dimitri/doxygen/features.html>Doxygen</a> - Peter Green -
Qing Gu - Greg Hackman - Gertjan Hofman - Paul Knowles - Exaos Lee - Rudi Meier - Glenn
Moloney - Dave Morris - John M O'Donnell - Konstantin Olchanski - Chris Pearson - Renee Poutissou
- Tamsen Schurman - Andreas Suter - Jan M.Wouters - Piotr Adam Zolnierczuk
<hr WIDTH="100%">

